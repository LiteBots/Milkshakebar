<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#FFC107" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="eatmi" />
  <link rel="icon" type="image/png" sizes="112x112" href="/logo-112x112.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/logo-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/logo-512x512.png">

  <title>eatmi.pl â€” ZamÃ³w online</title>
  <meta name="description" content="eatmi.pl â€” Boxy Å›niadaniowe, lunche, kanapki, zdrowe, sÅ‚odkie i napoje." />

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="appicon.png">

  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              yellow: '#FFC107',
              dark: '#111827',
              light: '#F9FAFB'
            },
            kiosk: {
              bg: '#0B0F1A',
              card: '#0F1629',
              card2: '#111B34',
              green: '#22C55E',
              red: '#EF4444',
              blue: '#3B82F6',
              violet: '#8B5CF6',
              orange: '#F59E0B',
              gray: '#94A3B8'
            }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.08)',
            glass: '0 8px 25px rgba(0,0,0,.12)',
            kiosk: '0 14px 50px rgba(0,0,0,.35)'
          },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --tabbar-h: 72px;
      --cta-h: 56px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }

    html, body { height: 100%; }
    body { overscroll-behavior-y: none; }

    .liquid { background: rgba(255,255,255,.75); backdrop-filter: blur(12px); }
    .logo-glow { box-shadow: 0 12px 30px rgba(255,193,7,.18); }
    .toast-enter { animation: toastIn .18s ease-out; }
    .toast-bar { animation: toastBar 2.4s linear; transform-origin: left; }
    @keyframes toastIn { from { transform: translateY(8px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    @keyframes toastBar { from { transform: scaleX(1) } to { transform: scaleX(0) } }

    .input-focus { outline: none; }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(255,193,7,.35); border-color: rgba(255,193,7,.75); }

    /* Wymuszenie Å¼Ã³Å‚tego dla 2 CTA w HERO */
    .btn-yellow{
      background:#FFC107 !important;
      color:#111827 !important;
      border-color: rgba(0,0,0,.08) !important;
    }
    .btn-yellow:hover{
      filter: brightness(.98);
      box-shadow: 0 0 0 3px rgba(255,193,7,.30);
    }

    /* App-like: treÅ›Ä‡ nie moÅ¼e chowaÄ‡ siÄ™ pod tabbarem (i CTA) */
    .app-content-pad {
      padding-bottom: calc(var(--tabbar-h) + var(--safe-b) + 18px);
    }
    .app-content-pad.has-cta {
      padding-bottom: calc(var(--tabbar-h) + var(--safe-b) + var(--cta-h) + 22px);
    }
    /* JeÅ›li jest aktywny tracker, dodajemy wiÄ™cej miejsca na dole */
    .app-content-pad.has-tracker {
      padding-bottom: calc(var(--tabbar-h) + var(--safe-b) + 200px); 
    }

    .no-overscroll { overscroll-behavior: none; }

    /* Simple spinner */
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
    .spin { animation: spin 1s linear infinite; }

    .kbd-hint {
      background: rgba(255,193,7,.12);
      border: 1px solid rgba(255,193,7,.35);
      color: #111827;
    }

    /* =======================
       Left slide-in account nudge
       ======================= */
    @keyframes nudgeIn {
      from { transform: translateX(-110%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    @keyframes nudgeOut {
      from { transform: translateX(0); opacity: 1; }
      to   { transform: translateX(-110%); opacity: 0; }
    }
    .nudge-in { animation: nudgeIn .38s cubic-bezier(.2,.9,.2,1) both; }
    .nudge-out { animation: nudgeOut .26s ease-in both; }

    /* =======================
       Add-ons modal (fade)
       ======================= */
    @keyframes popIn {
      from { transform: translateY(10px) scale(.98); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    .pop-in { animation: popIn .18s ease-out both; }
      
    /* =======================
       Order Tracker Animation
       ======================= */
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .tracker-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; }

    /* =======================
       PWA Header Fix
       Dodajemy extra padding od gÃ³ry, aby ominÄ…Ä‡ zegarek/status bar
       ======================= */
    .header-pwa-fix {
       padding-top: calc(env(safe-area-inset-top) + 12px);
    }

    /* Custom scrollbar hide for calendar grid */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-brand-light text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, createContext, useContext } = React;

    /* =======================
       PWA HELPER: VAPID CONVERSION
       ======================= */
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    /* =======================
       MENU - DEFINICJE KATEGORII
       ======================= */

    const PRODUCT_CATEGORIES = [
      { id: 'boxy-sniadaniowe', name: 'Boxy Å›niadaniowe', icon: 'package-open', description: 'MaÅ‚e, Å›rednie i duÅ¼e zestawy. TakÅ¼e VEGE.', image: 'https://i.imgur.com/qtZTWY1.jpeg' },
      { id: 'lunche', name: 'Lunche', icon: 'utensils-crossed', description: 'Lunch tygodnia, miesiÄ…ca i vege (12:00â€“16:00).', image: 'https://i.imgur.com/sn5VMfS.jpeg' },
      { id: 'kanapki', name: 'Kanapki', icon: 'sandwich', description: 'Kanapki i buritto na maÅ›lanym pieczywie.', image: 'https://i.imgur.com/PFoY1Oc.jpeg' },
      { id: 'zdrowe', name: 'Zdrowe', icon: 'leaf', description: 'Granola i saÅ‚atki w wersjach fit.', image: 'https://i.imgur.com/RmVJ6d6.jpeg' },
      { id: 'slodkie', name: 'SÅ‚odkie', icon: 'ice-cream', description: 'Desery, pancakes, tost francuski i smoothie.', image: 'https://i.imgur.com/yKYFN0z.jpeg' },
      { id: 'napoje', name: 'Napoje', icon: 'cup-soda', description: 'Kawy, herbaty, lemoniada i sok.', image: 'https://i.imgur.com/QiPsFDo.jpeg' },
    ];

    /* =======================
       MENU - DANE STATYCZNE (Poza Lunchami)
       ======================= */

    const BREAKFAST_BOXES = [
      { id:'bs-small-1', name:'Box Å›niadaniowy maÅ‚y nr 1', price: 43, image:'https://i.imgur.com/eom3rVn.jpeg', subtitle:'Kanapka z jajecznicÄ… i bekonem, majonez sriracha â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-small-2', name:'Box Å›niadaniowy maÅ‚y nr 2', price: 45, image:'https://i.imgur.com/4O2NNaB.jpeg', subtitle:'Buritto z jajecznicÄ… i chorizo â€¢ SaÅ‚atka koreaÅ„ska z kurczakiem w panko, warzywami i sezamem â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-small-3', name:'Box Å›niadaniowy maÅ‚y nr 3', price: 47, image:'https://i.imgur.com/ErBUGrk.jpeg', subtitle:'Kanapka z rostbefem, jajkiem poche, sosem musztardowo-chrzanowym i oliwÄ… truflowÄ… â€¢ SaÅ‚atka Cezar z kurczakiem, bekonem, saÅ‚atÄ… rzymskÄ… i grzankami â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-small-vege', name:'Box Å›niadaniowy maÅ‚y VEGE', price: 43, image:'https://i.imgur.com/CLHRTL9.jpeg', subtitle:'Kanapka z jajecznicÄ… i awokado, majonez sriracha â€¢ SaÅ‚atka z carpaccio z buraka z kozim serem i orzechami pekan, mix saÅ‚at, pomaraÅ„czowy dressing z oliwÄ… â€¢ Sok pomaraÅ„czowy 250 ml' },

      { id:'bs-med-1', name:'Box Å›niadaniowy Å›redni nr 1', price: 58, image:'https://i.imgur.com/QTpLAsM.jpeg', subtitle:'Kanapka z jajecznicÄ… i bekonem, majonez sriracha â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ Tost francuski z owocami i miodem â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-med-2', name:'Box Å›niadaniowy Å›redni nr 2', price: 60, image:'https://i.imgur.com/N1BOLT8.jpeg', subtitle:'Buritto z jajecznicÄ… i chorizo â€¢ SaÅ‚atka koreaÅ„ska z kurczakiem w panko, warzywa i sezamem â€¢ Pancakes (2 szt.) z NutellÄ… i owocami â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-med-3', name:'Box Å›niadaniowy Å›redni nr 3', price: 62, image:'https://i.imgur.com/nFAk3Mf.jpeg', subtitle:'Kanapka z rostbefem, jajkiem poche, sosem musztardowo-chrzanowym i oliwÄ… truflowÄ… â€¢ SaÅ‚atka Cezar z kurczakiem, bekonem, saÅ‚atÄ… rzymskÄ… i grzankami â€¢ Deser czekoladowy z owocami i kruszonkÄ… â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-med-vege', name:'Box Å›niadaniowy Å›redni VEGE', price: 58, image:'https://i.imgur.com/P3nuucU.jpeg', subtitle:'Kanapka z jajecznicÄ… i awokado, majonez sriracha â€¢ SaÅ‚atka z carpaccio z buraka z kozim serem i orzechami pekan, mix saÅ‚at, pomaraÅ„czowy dressing z oliwÄ… â€¢ Smoothie Mango Lassi z miodem â€¢ Sok pomaraÅ„czowy 250 ml' },

      { id:'bs-big-1', name:'Box Å›niadaniowy duÅ¼y nr 1', price: 87, image:'https://i.imgur.com/fpAw7zH.jpeg', subtitle:'Kanapka z jajecznicÄ… i bekonem, majonez sriracha â€¢ Club sandwich z kurczakiem i bekonem, majonez, saÅ‚ata, pomidor â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ SaÅ‚atka Cezar z kurczakiem, bekonem, saÅ‚atÄ… rzymskÄ… i grzankami â€¢ Tost francuski z owocami i miodem â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-big-2', name:'Box Å›niadaniowy duÅ¼y nr 2', price: 89, image:'https://i.imgur.com/VINVw4c.jpeg', subtitle:'Buritto z jajecznicÄ… i chorizo â€¢ Kanapka z jajecznicÄ… i bekonem, majonez sriracha â€¢ SaÅ‚atka koreaÅ„ska z kurczakiem w panko, warzywa i sezamem â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ Pancakes (2 szt.) z NutellÄ… i owocami â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-big-3', name:'Box Å›niadaniowy duÅ¼y nr 3', price: 91, image:'https://i.imgur.com/0fc2NHh.jpeg', subtitle:'Kanapka z rostbefem, jajkiem poche, sosem musztardowo-chrzanowym i oliwÄ… truflowÄ… â€¢ Kanapka z jajecznicÄ… i bekonem, majonez sriracha â€¢ SaÅ‚atka Cezar z kurczakiem, bekonem, saÅ‚atÄ… rzymskÄ… i grzankami â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ Deser czekoladowy z owocami i kruszonkÄ… â€¢ Sok pomaraÅ„czowy 250 ml' },
      { id:'bs-big-vege', name:'Box Å›niadaniowy duÅ¼y VEGE', price: 87, image:'https://i.imgur.com/Gtl4J4b.jpeg', subtitle:'Kanapka z jajecznicÄ… i awokado, majonez sriracha â€¢ Vege club sandwich z camembert i awokado, majonez, saÅ‚ata, pomidor â€¢ SaÅ‚atka z carpaccio z buraka z kozim serem i orzechami pekan, mix saÅ‚at, pomaraÅ„czowy dressing z oliwÄ… â€¢ Domowa granola z jogurtem greckim, owocami i miodem â€¢ Smoothie Mango Lassi z miodem â€¢ Sok pomaraÅ„czowy 250 ml' },
    ];

    // âœ… DEFAULT LUNCHES (Fallback - uÅ¼ywane jeÅ›li serwer nie odpowie)
    const DEFAULT_LUNCHES = [
      { id:'lunch-week', name:'Lunch tygodnia', price: 55, image:'https://i.imgur.com/sn5VMfS.jpeg', subtitle:'DostÄ™pny 12:00â€“16:00 â€¢ Zupa krem z pieczonych burakÃ³w 200 ml â€¢ Corn Flake Chicken: panierowana w pÅ‚atkach kukurydzianych pierÅ› z kurczaka z ziemniaczanym puree i coleslawem â€¢ Domowa lemoniada 250 ml' },
      { id:'lunch-month', name:'Lunch miesiÄ…ca', price: 65, image:'https://i.imgur.com/xGCYJZQ.jpeg', subtitle:'DostÄ™pny 12:00â€“16:00 â€¢ Zupa krem z pieczonych burakÃ³w 200 ml â€¢ Kurczak Supreme: pieczona pierÅ› z kurczaka z ziemniaczanym puree, warzywami i sosem demi glace â€¢ Domowa lemoniada 250 ml' },
      { id:'lunch-vege', name:'Lunch VEGE', price: 55, image:'https://i.imgur.com/0hvAvxJ.jpeg', subtitle:'DostÄ™pny 12:00â€“16:00 â€¢ Zupa krem z pieczonych burakÃ³w 200 ml â€¢ Tagliatelle z warzywami, oliwÄ… z oliwek i pastÄ… truflowÄ… â€¢ Domowa lemoniada 250 ml' },
    ];

    const SANDWICHES = [
      { id:'k-jajecznica-bekon', name:'MaÅ›lane pieczywo z jajecznicÄ…, bekonem i majonezem sriracha', price: 19, image:'https://i.imgur.com/QZlDhsa.jpeg' },
      { id:'k-club-kurczak', name:'Club sandwich z grillowanym kurczakiem, chrupiÄ…cy bekon, majonez, saÅ‚ata i pomidor', price: 18, image:'https://i.imgur.com/a0GP7lJ.jpeg' },
      { id:'k-club-vege', name:'Vege club sandwich z camembert, palonym awokado, majonez, saÅ‚ata i pomidorem', price: 19, image:'https://i.imgur.com/a0GP7lJ.jpeg' },
      { id:'k-jajecznica-avo', name:'MaÅ›lane pieczywo z jajecznicÄ…, awokado i majonezem sriracha', price: 18, image:'https://i.imgur.com/nkLtUQG.jpeg' },
      { id:'k-buritto-chorizo', name:'Buritto z jajecznicÄ… z mozzarellÄ…, chorizo i majonezem sriracha', price: 20, image:'https://i.imgur.com/Ixbu5bk.jpeg' },
      { id:'k-rostbef', name:'MaÅ›lane pieczywo z rostbefem, jajkiem poche, rukolÄ…, sosem musztardowo-chrzanowym i oliwÄ… truflowÄ…', price: 22, image:'https://i.imgur.com/iF8vvVj.jpeg' },
    ];

    const HEALTHY = [
      { id:'z-granola', name:'Domowa granola z jogurtem greckim, owoce i miÃ³d', price: 20, image:'https://i.imgur.com/qOZTV6Y.jpeg' },
      { id:'z-cezar', name:'SaÅ‚atka Cezar z kurczakiem, bekonem, saÅ‚atÄ… rzymskÄ…, parmezanem i grzankami', price: 20, image:'https://i.imgur.com/ZBbo6rD.jpeg' },
      { id:'z-koreanska', name:'SaÅ‚atka koreaÅ„ska z kurczakiem w panko, warzywa i sezam, sÅ‚odki sos sojowy', price: 20, image:'https://i.imgur.com/1cE6tVB.jpeg' },
      { id:'z-burak', name:'SaÅ‚atka z carpaccio z buraka i serem kozim, karmelizowane orzechy pekan, mix saÅ‚at i pomaraÅ„czowy dressing', price: 20, image:'https://i.imgur.com/VYRNIFt.jpeg' },
    ];

    const SWEETS = [
      { id:'s-smoothie', name:'Smoothie Mango Lassi (mango, jogurt grecki, miÃ³d)', price: 20, image:'https://i.imgur.com/RHmXGlZ.jpeg' },
      { id:'s-tost-fr', name:'Tost francuski z owocami i miodem', price: 20, image:'https://i.imgur.com/JwN4PMV.jpeg' },
      { id:'s-pancakes', name:'Pancakes (2 szt.) z NutellÄ… i owocami', price: 20, image:'https://i.imgur.com/yKYFN0z.jpeg' },
      { id:'s-deser-czeko', name:'Deser czekoladowy z owocami i kruszonkÄ…', price: 20, image:'https://i.imgur.com/mVjnusq.jpeg' },
    ];

    const DRINKS = [
      { id:'n-lemoniada', name:'Domowa lemoniada 250 ml', price: 13, image:'https://i.imgur.com/zKRceju.jpeg' },
      { id:'n-sok-pom', name:'Sok pomaraÅ„czowy 250 ml', price: 13, image:'https://i.imgur.com/vOgARPy.jpeg' },
      { id:'n-kawa-filt-cz', name:'Kawa filtrowana czarna 300 ml', price: 11, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-kawa-filt-b', name:'Kawa filtrowana biaÅ‚a 300 ml', price: 11, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-espresso-double', name:'Kawa czarna (podwÃ³jne espresso) 300 ml', price: 12, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-flat-white', name:'Kawa Flat White (podwÃ³jne espresso) 300 ml', price: 12, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-latte', name:'Latte (podwÃ³jne espresso) 300 ml', price: 13, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-cappu', name:'Cappuccino (podwÃ³jne espresso) 300 ml', price: 13, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-matcha', name:'Matcha 300 ml', price: 19, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-herbata-cz', name:'Herbata czarna z cytrynÄ… 300 ml', price: 10, image:'https://i.imgur.com/AbtHMCT.jpeg' },
      { id:'n-zimowa', name:'Zimowa herbata z miodem, cytrusami, goÅºdzikami i sokiem malinowym 300 ml', price: 16, image:'https://i.imgur.com/AbtHMCT.jpeg' },
    ];

    const EXTRA_ITEMS = [
      { id:'extra-granola', name:'Domowa granola', price: 20, image:'https://i.imgur.com/qOZTV6Y.jpeg' },
      { id:'extra-lemoniada', name:'Domowa lemoniada', price: 13, image:'https://i.imgur.com/zKRceju.jpeg' },
      { id:'extra-deser', name:'Deser czekoladowy', price: 20, image:'https://i.imgur.com/mVjnusq.jpeg' },
    ];

    // âœ… STATIC_PRODUCTS - Mapa, ktÃ³ra zostanie poÅ‚Ä…czona z dynamicznymi lunchami
    const STATIC_PRODUCTS = {
      'boxy-sniadaniowe': BREAKFAST_BOXES,
      // 'lunche': BÄ™dÄ… tutaj wstawione przez Context
      'kanapki': SANDWICHES,
      'zdrowe': HEALTHY,
      'slodkie': SWEETS,
      'napoje': DRINKS,
    };

    /* =======================
       MENU PROVIDER (DYNAMIC LUNCHES - ZMIANY)
       ======================= */
    const MenuContext = createContext();
    const useMenu = () => useContext(MenuContext);

    const MenuProvider = ({ children }) => {
      const [lunches, setLunches] = useState(DEFAULT_LUNCHES);

      useEffect(() => {
        // âœ… FETCHUJEMY Z PUBLICZNEGO ENDPOINTU (bez /admin/)
        const fetchLunches = async () => {
          try {
            const res = await fetch('/api/products/lunche'); 
            if (res.ok) {
              const data = await res.json();
              if (data.lunche && Array.isArray(data.lunche) && data.lunche.length > 0) {
                // Mapowanie danych z bazy (grosze -> pln)
                const mapped = data.lunche.map(item => ({
                  id: item.id,
                  name: item.name,
                  price: item.price / 100, // Grosze na zÅ‚otÃ³wki
                  image: item.image,
                  subtitle: item.description // Baza: description -> UI: subtitle
                }));
                
                setLunches(mapped);
              }
            }
          } catch (e) {
            console.warn("Nie udaÅ‚o siÄ™ pobraÄ‡ lunchÃ³w z bazy, uÅ¼ywam domyÅ›lnych.", e);
          }
        };

        fetchLunches();
      }, []);

      // ÅÄ…czymy statyczne kategorie z dynamicznymi lunchami
      const productsMap = useMemo(() => ({
        ...STATIC_PRODUCTS,
        'lunche': lunches
      }), [lunches]);

      return (
        <MenuContext.Provider value={productsMap}>
          {children}
        </MenuContext.Provider>
      );
    };

    /* =======================
       ADD-ONS (kawa/herbata)
       ======================= */

    const DRINK_ADDONS = [
      { id: "milk-oat", label: "Mleko owsiane", price: 2 },
      { id: "milk-coconut", label: "Mleko kokosowe", price: 2 },
      { id: "milk-pea", label: "Mleko grochowe", price: 2 },
      { id: "honey-50", label: "MiÃ³d 50 ml", price: 3 },
    ];

    const isCoffeeOrTea = (name = "") => {
      const s = String(name).toLowerCase();
      return s.includes("kawa") || s.includes("herbata") || s.includes("matcha");
    };

    const shouldPromptDrinkAddons = ({ categoryId, item }) => {
      if (categoryId !== "napoje") return false;
      return isCoffeeOrTea(item?.name || "");
    };

    /* =======================
       UTIL
       ======================= */

    const useLocalStorage = (key, initial) => {
      const [state, setState] = useState(() => {
        try { return JSON.parse(localStorage.getItem(key)) ?? initial } catch { return initial }
      });
      useEffect(() => { localStorage.setItem(key, JSON.stringify(state)) }, [key, state]);
      return [state, setState];
    };

    const currency = (n) =>
      new Intl.NumberFormat('pl-PL', { style:'currency', currency:'PLN' }).format(n);

    const haptics = () => {
      try { if (navigator.vibrate) navigator.vibrate(10); } catch {}
    };

    const useIsMobile = (breakpoint = 768) => {
      const [isMobile, setIsMobile] = useState(() => window.innerWidth < breakpoint);
      useEffect(() => {
        const onResize = () => setIsMobile(window.innerWidth < breakpoint);
        window.addEventListener("resize", onResize, { passive: true });
        return () => window.removeEventListener("resize", onResize);
      }, [breakpoint]);
      return isMobile;
    };

    // âœ… Customer localStorage helpers
    const CUSTOMER_STORAGE_KEY = "eatmi-customer";

    const safeParse = (raw, fallback) => {
      try {
        const v = JSON.parse(raw);
        return (v && typeof v === "object") ? v : fallback;
      } catch {
        return fallback;
      }
    };

    const loadSavedCustomer = () => {
      if (typeof localStorage === "undefined") return null;
      const raw = localStorage.getItem(CUSTOMER_STORAGE_KEY);
      if (!raw) return null;
      return safeParse(raw, null);
    };

    const saveCustomer = (customerObj) => {
      if (typeof localStorage === "undefined") return;
      try {
        localStorage.setItem(CUSTOMER_STORAGE_KEY, JSON.stringify(customerObj));
      } catch {}
    };

    const clearSavedCustomer = () => {
      if (typeof localStorage === "undefined") return;
      try { localStorage.removeItem(CUSTOMER_STORAGE_KEY); } catch {}
    };

    // âœ… AUTH token
    const AUTH_TOKEN_KEY = "eatmi-auth-token";

    const loadAuthToken = () => {
      try { return localStorage.getItem(AUTH_TOKEN_KEY) || ""; } catch { return ""; }
    };
    const saveAuthToken = (token) => {
      try { localStorage.setItem(AUTH_TOKEN_KEY, token || ""); } catch {}
    };
    const clearAuthToken = () => {
      try { localStorage.removeItem(AUTH_TOKEN_KEY); } catch {}
    };

    // âœ… API helper
    async function apiFetch(url, { method="GET", body=null, token=null } = {}) {
      const headers = { "Content-Type": "application/json" };
      if (token) headers.Authorization = `Bearer ${token}`;
      const r = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        const msg = data?.error || `HTTP ${r.status}`;
        const err = new Error(msg);
        err.status = r.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    /* =======================
       TOAST
       ======================= */

    const ToastContext = createContext();
    const useToast = () => useContext(ToastContext);

    const ToastProvider = ({children}) => {
      const [toast, setToast] = useState(null);
      const timeoutRef = React.useRef(null);

      const show = (message) => {
        setToast(message);
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => setToast(null), 2500);
      };

      const close = () => {
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        setToast(null);
      };

      return (
        <ToastContext.Provider value={{ show }}>
          {children}
          {toast && (
            <div className="fixed bottom-[calc(var(--tabbar-h)+var(--safe-b)+18px)] left-1/2 -translate-x-1/2 z-[80] pointer-events-none">
              <div className="relative pointer-events-auto toast-enter bg-white/95 border border-emerald-200 shadow-glass rounded-2xl px-4 py-3 min-w-[260px] max-w-[90vw] flex items-start gap-3">
                <div className="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 text-lg">âœ“</div>
                <div className="flex-1">
                  <div className="text-[10px] font-semibold uppercase tracking-[0.12em] text-emerald-600">
                    Powiadomienie
                  </div>
                  <div className="text-sm text-gray-900 mt-0.5">{toast}</div>
                </div>
                <button
                  type="button"
                  onClick={close}
                  className="ml-2 text-gray-400 hover:text-gray-600 text-xl leading-none"
                  aria-label="Zamknij powiadomienie"
                >
                  Ã—
                </button>
                <div className="absolute left-4 right-4 -bottom-1.5 h-1 rounded-full overflow-hidden bg-emerald-50">
                  <div className="toast-bar h-full bg-emerald-400"></div>
                </div>
              </div>
            </div>
          )}
        </ToastContext.Provider>
      );
    };

    /* =======================
       ACTIVE ORDER CONTEXT
       (Widget na dole)
       ======================= */
    const ActiveOrderContext = createContext();
    const useActiveOrder = () => useContext(ActiveOrderContext);

    const ActiveOrderProvider = ({ children }) => {
      const [activeOrder, setActiveOrder] = useLocalStorage('eatmi-active-order', null);

      const saveOrder = (orderData) => {
        const now = Date.now();
        setActiveOrder({
          ...orderData,
          status: 'PENDING', // Startowy status
          statusTimestamp: now,
          timestamp: now
        });
      };

      const clearActiveOrder = () => setActiveOrder(null);

      // âœ… NOWOÅšÄ†: Odpytywanie serwera o status (Polling)
      useEffect(() => {
        if (!activeOrder || !activeOrder.extOrderId) return;

        // JeÅ›li zamÃ³wienie jest juÅ¼ zakoÅ„czone, przestajemy pytaÄ‡ (oszczÄ™dnoÅ›Ä‡ baterii/danych)
        if (['COMPLETED', 'CANCELED', 'Zrealizowane', 'Anulowane'].includes(activeOrder.status)) return;

        const checkStatus = async () => {
          try {
            // Pytamy backend o status tego konkretnego zamÃ³wienia
            const res = await fetch(`/api/orders/${activeOrder.extOrderId}`);
            if (!res.ok) return;
              
            const data = await res.json();
              
            // JeÅ›li status na serwerze jest inny niÅ¼ u nas -> aktualizujemy
            if (data.status && data.status !== activeOrder.status) {
              setActiveOrder(prev => ({
                ...prev,
                status: data.status,
                statusTimestamp: Date.now()
              }));
                
              // Opcjonalnie: wibracja przy zmianie statusu
              try { if (navigator.vibrate) navigator.vibrate([100, 50, 100]); } catch {}
            }
          } catch (e) {
            console.error("BÅ‚Ä…d sprawdzania statusu:", e);
          }
        };

        // Sprawdzaj co 10 sekund
        const interval = setInterval(checkStatus, 10000);
          
        // SprawdÅº teÅ¼ od razu po zaÅ‚adowaniu
        checkStatus();

        return () => clearInterval(interval);
      }, [activeOrder, setActiveOrder]);

      // Auto-hide logic: po 15 minutach od 'Zrealizowane' lub 'Anulowane'
      useEffect(() => {
        if (!activeOrder) return;
        const finalStatuses = ['COMPLETED', 'CANCELED', 'Zrealizowane', 'Anulowane', 'Odbierz'];
          
        // Sprawdzamy czy status zawiera siÄ™ w liÅ›cie koÅ„cowej (rÃ³wnieÅ¼ mapowanie z PayU)
        const isFinal = finalStatuses.some(s => 
           String(activeOrder.status).toUpperCase().includes(s.toUpperCase())
        );

        if (isFinal) {
          const now = Date.now();
          const diff = now - (activeOrder.statusTimestamp || 0);
          // 15 min = 900000 ms (dajemy klientowi czas na dojÅ›cie)
          if (diff > 900000) {
            clearActiveOrder();
          }
        }
      }, [activeOrder]);

      return (
        <ActiveOrderContext.Provider value={{ activeOrder, saveOrder, clearActiveOrder }}>
          {children}
        </ActiveOrderContext.Provider>
      );
    };

    /* =======================
       AUTH (CONTEXT)
       ======================= */

    const AuthContext = createContext();
    const useAuth = () => useContext(AuthContext);

    const AuthProvider = ({ children }) => {
      const toast = useToast();
      const showToast = toast?.show;

      const [token, setToken] = useState(() => loadAuthToken());
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      const refreshMe = async (tkn) => {
        const tk = typeof tkn === "string" ? tkn : token;
        if (!tk) { setUser(null); return; }
        try {
          const data = await apiFetch("/api/auth/me", { token: tk });
          setUser(data?.user || null);
        } catch (e) {
          setUser(null);
          setToken("");
          clearAuthToken();
        }
      };

      useEffect(() => {
        (async () => {
          try { await refreshMe(token); }
          finally { setLoading(false); }
        })();
      }, []);

      useEffect(() => {
        if (!loading) refreshMe(token);
      }, [token]);

      const login = async ({ email, password }) => {
        const data = await apiFetch("/api/auth/login", { method: "POST", body: { email, password } });
        const tk = data?.token || "";
        if (tk) {
          setToken(tk);
          saveAuthToken(tk);
          setUser(data?.user || null);
          showToast?.("Zalogowano âœ…");
        }
        return data;
      };

      const register = async ({ email, fullName, password, confirm }) => {
        const data = await apiFetch("/api/auth/register", {
          method: "POST",
          body: { email, fullName, password, confirm }
        });

        const tk = data?.token || "";
        if (tk) {
          setToken(tk);
          saveAuthToken(tk);
          setUser(data?.user || null);
          showToast?.("Konto utworzone âœ…");
        } else {
          showToast?.("Konto utworzone âœ…");
        }

        return data;
      };

      const logout = () => {
        setUser(null);
        setToken("");
        clearAuthToken();
        showToast?.("Wylogowano");
      };

      return (
        <AuthContext.Provider value={{ token, user, loading, login, register, logout, refreshMe }}>
          {children}
        </AuthContext.Provider>
      );
    };

    /* =======================
       CART
       ======================= */

    const CartContext = createContext();
    const useCart = () => useContext(CartContext);

    const CartProvider = ({children}) => {
      const [cart, setCart] = useLocalStorage('eatmi-cart', []);
      const [promoCode, setPromoCode] = useState(null); // âœ… STAN KODU
      const [discount, setDiscount] = useState(0);      // âœ… STAN ZNIÅ»KI (PLN)

      const toast = useToast();
      const show = toast?.show;

      const add = (entry) => {
        const uuid =
          (typeof window !== "undefined" &&
            window.crypto &&
            typeof window.crypto.randomUUID === "function")
            ? window.crypto.randomUUID()
            : `${Date.now()}-${Math.random().toString(16).slice(2)}`;

        const newItem = {
          id: uuid,
          qty: 1,
          addons: [],
          ...entry
        };

        setCart(prev => [...prev, newItem]);
        if (show) show(`Dodano: ${entry.name}`);
        haptics();
        return newItem.id;
      };


      const remove  = (id) => setCart(prev => prev.filter(i => i.id !== id));

      const updateItem = (id, patch) => {
        setCart(prev => prev.map(i => i.id === id ? { ...i, ...patch } : i));
      };

      const setQty  = (id, qty) => setCart(prev => prev.map(i => i.id === id ? {...i, qty: Math.max(1, qty|0)} : i));
      const incQty  = (id) => setCart(prev => prev.map(i => i.id === id ? {...i, qty: (i.qty||1)+1} : i));
      const decQty  = (id) => setCart(prev => prev.map(i => i.id === id ? {...i, qty: Math.max(1, (i.qty||1)-1)} : i));
      const clear   = () => {
          setCart([]);
          setPromoCode(null);
          setDiscount(0);
      };

      const addonsTotalPerUnit = (i) => {
        const arr = Array.isArray(i?.addons) ? i.addons : [];
        return arr.reduce((s,a)=> s + (a?.price || 0), 0);
      };

      const lineTotal = (i) => {
        const base = (i.price || 0);
        const addOns = addonsTotalPerUnit(i);
        return (base + addOns) * (i.qty || 1);
      };

      // âœ… Obliczamy wartoÅ›Ä‡ koszyka
      const cartValue = useMemo(() => cart.reduce((s,i)=> s + lineTotal(i), 0), [cart]);

      // âœ… FUNKCJA DO APLIKOWANIA KODU
      const applyPromo = async (code) => {
          if(!code) return;
          try {
              const res = await fetch('/api/promo/verify', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ code })
              });
              const data = await res.json();
              
              if (!res.ok) {
                  show(data.error || "Kod nieprawidÅ‚owy");
                  setDiscount(0);
                  setPromoCode(null);
                  return false;
              }
              
              // Oblicz zniÅ¼kÄ™
              const discVal = Math.round(cartValue * (data.discountPercent / 100));
              setDiscount(discVal);
              setPromoCode(data.code);
              show(`Kod ${data.code} aktywny! -${data.discountPercent}%`);
              return true;
          } catch (e) {
              show("BÅ‚Ä…d poÅ‚Ä…czenia");
              return false;
          }
      };

      // Przeliczanie rabatu jeÅ›li zmienia siÄ™ wartoÅ›Ä‡ koszyka (uproszczone)
      useEffect(() => {
          if (promoCode && discount > 0 && cartValue > 0) {
              // W prawdziwej appce tutaj ponawialibyÅ›my verify, ale dla uproszczenia
              // zakÅ‚adamy, Å¼e % siÄ™ nie zmieniÅ‚, a discount trzeba przeskalowaÄ‡
              // ODKRYJEMY % ZNIÅ»KI WSTECZNIE:
              // discount = cartValue * percent
              // percent = discount / oldCartValue
              // NewDiscount = currentCartValue * percent
              // To jest trochÄ™ ryzykowne, lepiej zresetowaÄ‡ kod przy zmianie koszyka lub trzymaÄ‡ % w stanie
              // ZRESETUJMY DLA BEZPIECZEÅƒSTWA (lub zostawmy jak jest, user wpisze jeszcze raz)
              // setPromoCode(null); setDiscount(0);
          }
      }, [cartValue]);

      // âœ… WartoÅ›Ä‡ po rabacie
      const valueAfterDiscount = Math.max(0, cartValue - discount);
        
      const deliveryCost = useMemo(() => {
        if (valueAfterDiscount === 0 && cart.length === 0) return 0;
        if (valueAfterDiscount < 50) return 10;
        if (valueAfterDiscount < 80) return 5;
        return 0;
      }, [valueAfterDiscount, cart.length]);

      const total  = useMemo(() => valueAfterDiscount + deliveryCost, [valueAfterDiscount, deliveryCost]);
      const count  = useMemo(() => cart.reduce((s,i)=> s + (i.qty||1), 0), [cart]);

      return (
        <CartContext.Provider value={{
          cart, add, remove, updateItem, setQty, incQty, decQty, clear,
          lineTotal, total, cartValue, deliveryCost, count,
          addonsTotalPerUnit,
          promoCode, discount, applyPromo // Export promo logic
        }}>
          {children}
        </CartContext.Provider>
      );
    };

    /* =======================
       ORDER TRACKER WIDGET
       ======================= */
    const OrderTrackerWidget = () => {
      const { activeOrder } = useActiveOrder();
      const [expanded, setExpanded] = useState(false);

      if (!activeOrder) return null;

      // Status styling
      const getStatusStyles = (s) => {
        switch(s) {
          case 'Zrealizowane': return 'bg-green-100 text-green-700 border-green-200';
          case 'Anulowane': return 'bg-red-100 text-red-700 border-red-200';
          case 'W drodze': return 'bg-brand-yellow/20 text-yellow-800 border-brand-yellow/40';
          case 'OpÃ³Åºniony': return 'bg-orange-100 text-orange-700 border-orange-200';
          default: return 'bg-blue-50 text-blue-700 border-blue-200'; // W przygotowaniu
        }
      };

      // Time calculation: 60 - 80 mins from timestamp or Scheduled Time
      const formatTimeDisplay = () => {
         // âœ… JEÅšLI JEST USTALONA GODZINA PRZYJAZDU
         if (activeOrder.customer && activeOrder.customer.deliveryTime) {
             // Sprawdzamy czy "NextDay" (moÅ¼na by to zapisaÄ‡ w zamÃ³wieniu, ale tutaj uproszczamy)
             // JeÅ¼eli timestamp zamÃ³wienia jest > 16:00 poprzedniego dnia lub to pre-order,
             // wyÅ›wietlamy po prostu godzinÄ™.
             return (
               <>
                 <span className="text-xs uppercase font-bold tracking-widest block opacity-70 mb-0.5">Dostawa:</span>
                 {activeOrder.customer.deliveryTime}
               </>
             );
         }

         // Standardowe 60-80 min
         const ts = activeOrder.timestamp;
         if (!ts) return "";
         const date = new Date(ts);
         const start = new Date(date.getTime() + 60 * 60000); // +60m
         const end = new Date(date.getTime() + 80 * 60000);    // +80m
        
         const f = (d) => d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
         return `${f(start)} â€“ ${f(end)}`;
      };

      return (
        <div className="fixed inset-x-0 bottom-[calc(var(--tabbar-h)+var(--safe-b)+10px)] z-[60] px-3 md:px-0 md:bottom-10 md:right-10 md:left-auto md:w-96 tracker-enter">
          <div className="bg-white border border-gray-200 shadow-kiosk rounded-2xl overflow-hidden">
              
            {/* Header */}
            <div className="bg-gray-900 text-white p-4 flex items-center justify-between">
              <div>
                <div className="text-[10px] uppercase tracking-widest font-semibold opacity-80">Twoje zamÃ³wienie</div>
                <div className="font-bold flex items-center gap-2 mt-0.5">
                    <span className={`text-[10px] px-2 py-0.5 rounded border uppercase tracking-wider font-extrabold ${getStatusStyles(activeOrder.status)}`}>
                      {activeOrder.status}
                    </span>
                </div>
              </div>
              <div className="text-right">
                <div className="text-lg font-extrabold leading-none text-brand-yellow">
                  {formatTimeDisplay()}
                </div>
              </div>
            </div>

            {/* Body */}
            <div className="p-4 bg-white">
              <div className="flex items-start justify-between gap-3 text-sm">
                  <div>
                    <div className="font-semibold text-gray-900">Adres dostawy:</div>
                    <div className="text-gray-600 text-xs mt-0.5">
                      {activeOrder.customer.ulica} {activeOrder.customer.nrBud}
                      {activeOrder.customer.lokal ? '/' + activeOrder.customer.lokal : ''}, {activeOrder.customer.miasto}
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="font-semibold text-gray-900">Kwota:</div>
                    <div className="font-extrabold text-base">{currency(activeOrder.total)}</div>
                  </div>
              </div>

              {/* Items Toggle */}
              <div className="mt-3 pt-3 border-t border-gray-100">
                <button 
                  onClick={() => setExpanded(!expanded)}
                  className="w-full flex items-center justify-between text-xs text-gray-500 hover:text-gray-900 font-semibold"
                >
                  <span>Co zamÃ³wiÅ‚eÅ› ({activeOrder.items.length})</span>
                  <i data-lucide={expanded ? "chevron-up" : "chevron-down"} className="w-4 h-4"></i>
                </button>
                
                {expanded && (
                  <div className="mt-2 space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                    {activeOrder.items.map((item, idx) => (
                        <div key={idx} className="flex justify-between text-xs text-gray-700">
                          <span>{item.qty}x {item.name}</span>
                          <span>{currency(item.price)}</span>
                        </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

          </div>
        </div>
      );
    };

    /* =======================
       HEADER / LOGO / CART BTN
       ======================= */

    const Logo = () => (
      <a href="#/" className="flex items-center gap-3 group">
        <div className="w-10 h-10 rounded-2xl bg-white flex items-center justify-center border border-gray-100 overflow-hidden shadow-soft logo-glow">
          <img
            src="https://i.imgur.com/f9TN0Gh.png"
            alt="eatmi.pl â€” logo"
            loading="lazy"
            className="w-9 h-9 object-contain transition-transform duration-500 group-hover:-rotate-6 group-hover:scale-110"
          />
        </div>
        <span className="font-extrabold tracking-tight">
          eatmi<span className="text-brand-yellow">.pl</span>
        </span>
      </a>
    );

    const CartButton = () => {
      const { total, count } = useCart();
      return (
        <a
          href="#/koszyk"
          className="relative inline-flex items-center justify-center gap-2 border border-brand-yellow bg-brand-yellow px-3 py-2 rounded-xl shadow-soft hover:shadow-md transition hover:brightness-105"
          aria-label="Koszyk"
        >
          <i data-lucide="shopping-cart" className="w-5 h-5 text-gray-900"></i>
          <span className="hidden sm:inline text-sm font-bold text-gray-900">{currency(total)}</span>
          <span className="absolute -top-2 -right-2 bg-gray-900 text-white text-xs font-extrabold w-6 h-6 rounded-full grid place-items-center ring-2 ring-white">
            {count}
          </span>
        </a>
      );
    };

    const Header = ({ onOpenAuth }) => {
      const { user, loading, logout } = useAuth();
      useEffect(() => { window.lucide?.createIcons?.(); }, [user, loading]);

      return (
        <header className="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 header-pwa-fix">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <Logo />

            <div className="hidden md:flex items-center gap-6 text-sm">
              <a href="#kategorie" className="hover:text-gray-900 text-gray-600">Menu</a>
              <a href="#/kategoria/boxy-sniadaniowe" className="hover:text-gray-900 text-gray-600">Boxy</a>
              <a href="#/kategoria/lunche" className="hover:text-gray-900 text-gray-600">Lunche</a>
              <a href="#/kategoria/kanapki" className="hover:text-gray-900 text-gray-600">Kanapki</a>
              <a href="#/kategoria/napoje" className="hover:text-gray-900 text-gray-600">Napoje</a>
            </div>

            <div className="flex items-center gap-3">
              {!loading && user ? (
                <div className="hidden md:flex items-center gap-2">
                  <div className="px-3 py-2 rounded-xl border border-gray-200 bg-white shadow-soft text-sm">
                    <div className="text-[10px] uppercase tracking-widest text-gray-500 font-semibold">Zalogowany</div>
                    <div className="font-extrabold text-gray-900 leading-tight">{user.fullName || user.email}</div>
                  </div>
                  <button
                    type="button"
                    onClick={logout}
                    className="inline-flex items-center gap-2 border border-gray-200 bg-white px-4 py-2 rounded-xl shadow-soft hover:shadow-md transition text-sm font-semibold text-gray-800 hover:ring-2 hover:ring-brand-yellow/50"
                  >
                    <i data-lucide="log-out" className="w-4 h-4"></i>
                    Wyloguj
                  </button>
                </div>
              ) : (
                <>
                  <button
                    type="button"
                    onClick={onOpenAuth}
                    className="hidden md:inline-flex items-center gap-2 border border-gray-200 bg-white px-4 py-2 rounded-xl shadow-soft hover:shadow-md transition text-sm font-semibold text-gray-800 hover:ring-2 hover:ring-brand-yellow/50">
                    <i data-lucide="user" className="w-4 h-4"></i>
                    <span>Konto</span>
                  </button>
                </>
              )}

              <button
                type="button"
                onClick={onOpenAuth}
                className="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-gray-200 bg-white shadow-soft hover:ring-2 hover:ring-brand-yellow/50"
                aria-label="Moje konto">
                <i data-lucide="user" className="w-5 h-5"></i>
              </button>

              <CartButton />
            </div>
          </div>
        </header>
      );
    };

    /* =======================
       HERO / UI
       ======================= */

    const Hero = () => (
      <section className="relative overflow-hidden">
        <div className="max-w-6xl mx-auto px-4 py-10 md:py-16">
          <div className="max-w-2xl">
            <div className="inline-flex items-center gap-2 mb-3 px-4 py-2 rounded-full bg-white/80 border border-gray-200 shadow-soft">
              <span className="text-xl">ðŸ‘‹</span>
              <span className="text-sm md:text-base font-semibold text-gray-900">
                CzeÅ›Ä‡, na co masz dziÅ› ochotÄ™?
              </span>
            </div>

            <h1 className="text-4xl md:text-5xl font-extrabold leading-tight">
              Wybierz | ZamÃ³w {" "}
              <span className="text-brand-yellow">ZapÅ‚aÄ‡</span>
            </h1>
            <p className="mt-4 text-gray-600 max-w-prose">
              Boxy Å›niadaniowe, lunche, kanapki, zdrowe, sÅ‚odkie i napoje.
              Jak w kiosku â€” wybierasz kategoriÄ™, klikasz pozycje i finalizujesz zamÃ³wienie.
            </p>

            <div className="mt-6 flex flex-wrap gap-3">
              <a
                href="#kategorie"
                className="btn-yellow inline-flex items-center gap-2 font-extrabold px-6 py-3 rounded-xl2 shadow-soft hover:scale-[1.02] transition"
              >
                <i data-lucide="shopping-bag" className="w-5 h-5"></i>
                PrzeglÄ…daj menu
              </a>

              <a
                href="#/kategoria/boxy-sniadaniowe"
                className="btn-yellow inline-flex items-center gap-2 font-extrabold px-6 py-3 rounded-xl2 shadow-soft hover:scale-[1.02] transition"
              >
                <i data-lucide="package-open" className="w-5 h-5"></i>
                Zobacz boxy Å›niadaniowe
              </a>
            </div>
          </div>
        </div>
      </section>
    );

    const SectionTitle = ({eyebrow, title, subtitle}) => (
      <div className="text-center max-w-2xl mx-auto">
        {eyebrow && <div className="text-xs uppercase tracking-widest text-gray-500">{eyebrow}</div>}
        <h2 className="text-3xl md:text-4xl font-extrabold mt-1">{title}</h2>
        {subtitle && <p className="text-gray-600 mt-2">{subtitle}</p>}
      </div>
    );

    const CategoryCard = ({ category }) => {
      const handleClick = () => { window.location.hash = `#/kategoria/${category.id}`; };
      return (
        <button
          type="button"
          onClick={handleClick}
          className="group relative bg-white border border-gray-200 rounded-2xl text-left shadow-soft hover:shadow-md hover:-translate-y-1 transition w-full overflow-hidden hover:ring-2 hover:ring-brand-yellow/60"
        >
          <div className="absolute inset-x-0 top-0 h-1.5 bg-gradient-to-r from-brand-yellow via-amber-300 to-orange-400 opacity-80 z-[2]"></div>

          <div className="relative h-36 w-full overflow-hidden">
            <img
              src={category.image}
              alt={category.name}
              loading="lazy"
              className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-[1.05]"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/35 to-transparent"></div>
          </div>

          <div className="p-5">
            <div className="flex items-center justify-between gap-3 mt-1">
              <div>
                <div className="inline-flex items-center gap-2 text-xs uppercase tracking-widest text-gray-500">
                  <span className="w-2.5 h-2.5 rounded-full bg-brand-yellow shadow-sm"></span>
                  Kategoria
                </div>
                <h3 className="mt-1 text-lg font-extrabold">{category.name}</h3>
              </div>

              <div className="w-10 h-10 rounded-xl bg-brand-yellow/20 grid place-items-center ring-1 ring-brand-yellow/30 group-hover:bg-brand-yellow/30 transition">
                <i data-lucide={category.icon} className="w-5 h-5 text-gray-900"></i>
              </div>
            </div>

            <p className="mt-3 text-sm text-gray-600">{category.description}</p>
            <div className="mt-4 inline-flex items-center gap-2 text-sm font-extrabold text-gray-900 group-hover:gap-3 transition">
              OtwÃ³rz kategoriÄ™ <i data-lucide="arrow-right" className="w-4 h-4"></i>
            </div>
          </div>
        </button>
      );
    };

    const splitSubtitle = (text='') =>
      text.split('â€¢').map(s => s.trim()).filter(Boolean);

    const getBadges = (categoryId, name) => {
      const badges = [];
      const upper = (name||'').toUpperCase();
      if (categoryId === 'boxy-sniadaniowe') badges.push({ label: 'BOX', color: 'bg-kiosk-blue/15 text-kiosk-blue border-kiosk-blue/30' });
      if (categoryId === 'lunche') badges.push({ label: 'LUNCH 12â€“16', color: 'bg-kiosk-orange/15 text-kiosk-orange border-kiosk-orange/30' });
      if (upper.includes('VEGE')) badges.push({ label: 'VEGE', color: 'bg-kiosk-green/15 text-kiosk-green border-kiosk-green/30' });
      return badges;
    };

    const ProductCard = ({ item, categoryId, onAdd, onZoom }) => {
      const bullets = splitSubtitle(item.subtitle || '');
      const badges = getBadges(categoryId, item.name);

      return (
        <div className="relative bg-white border border-gray-200 rounded-3xl p-5 md:p-6 shadow-soft hover:shadow-kiosk transition group overflow-hidden hover:ring-2 hover:ring-brand-yellow/40">
          <div className="absolute inset-x-0 top-0 h-1.5 bg-gradient-to-r from-brand-yellow via-amber-300 to-orange-400 opacity-70"></div>

          <div 
              className="relative mt-3 h-36 w-full overflow-hidden rounded-2xl border border-gray-200 cursor-zoom-in"
              onClick={() => onZoom && onZoom(item.image)}
          >
            <img
              src={item.image}
              alt={item.name}
              loading="lazy"
              className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-[1.04]"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/25 to-transparent"></div>
            
            {/* âœ… DODANE: Gwiazdka i napis "ZdjÄ™cie poglÄ…dowe" */}
            <div className="absolute bottom-1 right-2 z-10 text-[9px] font-medium text-white/90 drop-shadow-md flex items-center gap-0.5 opacity-80 pointer-events-none">
                  <span>*</span> ZdjÄ™cie poglÄ…dowe
            </div>
          </div>

          <div className="text-[10px] text-gray-500 text-center mt-2 flex items-center justify-center gap-1 opacity-70">
              <i data-lucide="maximize-2" className="w-3 h-3"></i> Kliknij zdjÄ™cie, aby powiÄ™kszyÄ‡
          </div>

          <div className="mt-3 inline-flex items-center gap-2">
            <span className="text-[10px] font-extrabold tracking-widest uppercase px-2.5 py-1 rounded-full bg-brand-yellow text-gray-900 shadow-sm">
              HIT
            </span>
            <span className="text-[10px] font-extrabold tracking-widest uppercase px-2.5 py-1 rounded-full bg-brand-yellow/15 text-gray-900 border border-brand-yellow/30">
              Polecane
            </span>
          </div>

          {badges.length > 0 && (
            <div className="flex flex-wrap gap-2 mt-3">
              {badges.map((b, i) => (
                <span key={i}
                  className={`text-[10px] font-extrabold tracking-widest uppercase border px-2.5 py-1 rounded-full ${b.color}`}>
                  {b.label}
                </span>
              ))}
            </div>
          )}

          <h3 className="text-lg md:text-xl font-extrabold text-gray-900 leading-snug mt-3">
            {item.name}
          </h3>

          {bullets.length > 0 && (
            <ul className="mt-3 space-y-1.5 text-sm text-gray-700">
              {bullets.map((b, idx) => (
                <li key={idx} className="flex gap-2">
                  <span className="mt-[6px] w-1.5 h-1.5 rounded-full bg-gray-900/60 shrink-0"></span>
                  <span>{b}</span>
                </li>
              ))}
            </ul>
          )}

          <div className="mt-5 flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <div className="px-3 py-1.5 rounded-xl bg-gray-900 text-white font-extrabold text-base md:text-lg shadow">
                {currency(item.price)}
              </div>
              <div className="text-xs text-gray-500 font-semibold uppercase tracking-wider">
                / szt.
              </div>
            </div>

            <button
              type="button"
              onClick={() => onAdd(item)}
              className="inline-flex items-center justify-center gap-2 bg-brand-yellow text-gray-900 font-extrabold px-4 py-3 rounded-2xl shadow-soft hover:scale-[1.03] active:scale-[0.98] transition hover:ring-2 hover:ring-brand-yellow/40 min-h-[44px]"
            >
              <i data-lucide="plus" className="w-4 h-4"></i> Dodaj
            </button>
          </div>
        </div>
      );
    };

    /* =======================
       MODAL: dodatki do kawy/herbaty
       ======================= */

    const lockBodyScroll = (lock) => {
      const body = document.body;
      if (!body) return;
      if (lock) {
        body.dataset._scrollY = String(window.scrollY || 0);
        body.style.position = "fixed";
        body.style.top = `-${window.scrollY || 0}px`;
        body.style.left = "0";
        body.style.right = "0";
        body.style.width = "100%";
      } else {
        const y = parseInt(body.dataset._scrollY || "0", 10) || 0;
        body.style.position = "";
        body.style.top = "";
        body.style.left = "";
        body.style.right = "";
        body.style.width = "";
        delete body.dataset._scrollY;
        window.scrollTo(0, y);
      }
    };

    const DrinkAddonsModal = ({ open, onClose, cartItemId, title }) => {
      const { cart, updateItem } = useCart();
      const toast = useToast();
      const showToast = toast?.show;

      const item = useMemo(() => cart.find(x => x.id === cartItemId) || null, [cart, cartItemId]);
      const [selected, setSelected] = useState([]);

      useEffect(() => {
        if (!open) return;
        setSelected([]);
        lockBodyScroll(true);
        return () => lockBodyScroll(false);
      }, [open]);

      useEffect(() => {
        const onKey = (e) => {
          if (!open) return;
          if (e.key === "Escape") onClose?.();
        };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [open]);

      if (!open) return null;

      const toggle = (addonId) => {
        setSelected((prev) => prev.includes(addonId) ? prev.filter(x => x !== addonId) : [...prev, addonId]);
      };

      const skip = () => {
        onClose?.();
      };

      const apply = () => {
        if (!item) { onClose?.(); return; }
        const addons = DRINK_ADDONS
          .filter(a => selected.includes(a.id))
          .map(a => ({ id: a.id, label: a.label, price: a.price }));

        updateItem(item.id, { addons });
        if (addons.length) {
          const label = addons.map(a => a.label).join(", ");
          showToast?.(`Dodano dodatki: ${label}`);
        }
        onClose?.();
      };

      const addonsSum = selected
        .map(id => DRINK_ADDONS.find(a => a.id === id))
        .filter(Boolean)
        .reduce((s,a)=> s + a.price, 0);

      return (
        <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center px-4" onClick={skip} role="dialog" aria-modal="true">
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-glass border border-gray-200 p-6 pop-in" onClick={(e)=>e.stopPropagation()}>
            <button
              type="button"
              onClick={skip}
              className="absolute top-3 right-3 p-2 rounded-full bg-white border border-gray-200 shadow-soft hover:bg-gray-50 hover:ring-2 hover:ring-brand-yellow/40"
              aria-label="Zamknij okno dodatkÃ³w"
            >
              <i data-lucide="x" className="w-4 h-4"></i>
            </button>

            <div className="mb-4">
              <div className="text-xs uppercase tracking-[0.16em] text-gray-500 font-semibold">Dodatki</div>
              <h3 className="text-xl font-extrabold mt-1">Wybierz dodatki do napoju</h3>
              <p className="text-xs text-gray-600 mt-1">
                {title || item?.name || "NapÃ³j"} â€¢ dodatki doliczÄ… siÄ™ do ceny w koszyku
              </p>
            </div>

            <div className="bg-gray-50 border border-gray-200 rounded-2xl p-3">
              <div className="text-xs uppercase tracking-widest text-gray-500 font-semibold">DostÄ™pne dodatki</div>

              <div className="mt-3 grid gap-2">
                {DRINK_ADDONS.map((a) => {
                  const checked = selected.includes(a.id);
                  return (
                    <label
                      key={a.id}
                      className={`cursor-pointer flex items-center justify-between gap-3 rounded-2xl border px-4 py-3 shadow-soft transition ${
                        checked ? "border-brand-yellow bg-white ring-2 ring-brand-yellow/30" : "border-gray-200 bg-white hover:ring-2 hover:ring-brand-yellow/20"
                      }`}
                    >
                      <span className="flex items-center gap-3">
                        <span className={`w-5 h-5 rounded-md border grid place-items-center ${checked ? "bg-brand-yellow border-brand-yellow" : "bg-white border-gray-300"}`}>
                          {checked ? <span className="text-[12px] font-extrabold">âœ“</span> : null}
                        </span>
                        <span className="font-extrabold text-gray-900">{a.label}</span>
                      </span>
                      <span className="font-extrabold text-gray-900">{currency(a.price)}</span>
                      <input
                        type="checkbox"
                        className="hidden"
                        checked={checked}
                        onChange={() => toggle(a.id)}
                      />
                    </label>
                  );
                })}
              </div>

              <div className="mt-3 flex items-center justify-between text-sm">
                <span className="text-gray-600 font-semibold">Suma dodatkÃ³w</span>
                <span className="font-extrabold text-gray-900">{currency(addonsSum)}</span>
              </div>
            </div>

            <div className="mt-4 grid gap-2">
              <button
                type="button"
                onClick={apply}
                className="w-full bg-gray-900 text-white font-extrabold rounded-xl px-4 py-3 min-h-[44px] hover:ring-2 hover:ring-brand-yellow/30"
              >
                Dodaj wybrane dodatki
              </button>
              <button
                type="button"
                onClick={skip}
                className="w-full bg-brand-yellow text-gray-900 font-extrabold rounded-xl px-4 py-3 min-h-[44px] hover:ring-2 hover:ring-brand-yellow/40"
              >
                PomiÅ„
              </button>
            </div>

            <div className="mt-3 text-[11px] text-gray-500">
              Dodatki sÄ… liczone per sztuka (jeÅ›li zwiÄ™kszysz iloÅ›Ä‡ napoju, dodatki mnoÅ¼Ä… siÄ™ razem z iloÅ›ciÄ…).
            </div>
          </div>
        </div>
      );
    };

    /* =======================
       ImageModal (FULLSCREEN)
       ======================= */
    const ImageModal = ({ src, onClose }) => {
      useEffect(() => {
         if(src) {
           lockBodyScroll(true);
           window.lucide?.createIcons?.();
         } else {
           lockBodyScroll(false);
         }
         return () => lockBodyScroll(false);
      }, [src]);

      if (!src) return null;

      return (
        <div 
          className="fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm pop-in"
          onClick={onClose}
        >
           <button 
             onClick={onClose}
             className="absolute top-5 right-5 w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition backdrop-blur-md"
           >
             <i data-lucide="x" className="w-8 h-8"></i>
           </button>

           <img 
             src={src} 
             alt="PowiÄ™kszenie" 
             className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
             onClick={(e) => e.stopPropagation()} 
           />
        </div>
      );
    };

    /* =======================
       CategoryPage
       ======================= */

    const CategoryPage = ({ categoryId }) => {
      const { add } = useCart();
      const productsMap = useMenu(); // âœ… Use dynamic menu context
       
      const category = PRODUCT_CATEGORIES.find(c => c.id === categoryId);
      const items = productsMap[categoryId] || [];

      // âœ… modal dodatkÃ³w do kawy/herbaty
      const [addonsOpen, setAddonsOpen] = useState(false);
      const [addonsCartItemId, setAddonsCartItemId] = useState("");
      const [addonsTitle, setAddonsTitle] = useState("");
       
      // âœ… stan do powiÄ™kszania zdjÄ™Ä‡
      const [zoomedImage, setZoomedImage] = useState(null);

      // âœ… ZAWSZE STARTUJ OD GÃ“RY PO WEJÅšCIU W KATEGORIÄ˜
      React.useEffect(() => {
        window.scrollTo({ top: 0, left: 0, behavior: "auto" });
      }, [categoryId]);

      if (!category) {
        return (
          <section className="py-10">
            <div className="max-w-6xl mx-auto px-4">
              <a href="#/" className="inline-flex items-center gap-2 text-sm text-gray-600">
                <i data-lucide="arrow-left" className="w-4 h-4"></i> WrÃ³Ä‡
              </a>
              <h2 className="text-2xl font-extrabold mt-3">Kategoria nie istnieje</h2>
              <p className="mt-2 text-gray-600">WrÃ³Ä‡ do menu i wybierz jednÄ… z dostÄ™pnych kategorii.</p>
            </div>
          </section>
        );
      }

      const handleAdd = (item) => {
        const cartItemId = add({
          type: 'product',
          productId: item.id,
          name: item.name,
          price: item.price,
          image: item.image
        });

        // âœ… po dodaniu kawy/herbaty: pokaÅ¼ okienko z dodatkami
        if (shouldPromptDrinkAddons({ categoryId, item })) {
          setAddonsCartItemId(cartItemId);
          setAddonsTitle(item.name);
          setAddonsOpen(true);
        }
      };

      return (
        <>
          <section className="py-6 md:py-10">
            <div className="max-w-6xl mx-auto px-4">
              <a href="#kategorie" className="mt-2 inline-flex items-center justify-center gap-2 text-lg font-extrabold text-gray-900 bg-brand-yellow/20 border border-brand-yellow/30 rounded-2xl px-5 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/40 transition">
                    <i data-lucide="arrow-left" className="w-5 h-5"></i>
                          WrÃ³Ä‡ do menu
              </a>

              <div className="mt-4 flex items-center gap-3">
                <div className="w-11 h-11 rounded-2xl bg-brand-yellow/20 grid place-items-center ring-1 ring-brand-yellow/30">
                  <i data-lucide={category.icon} className="w-6 h-6 text-gray-900"></i>
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-extrabold">{category.name}</h2>
                  <p className="text-sm text-gray-600 mt-1">{category.description}</p>
                </div>
              </div>

              <div className="mt-6 grid gap-5 sm:grid-cols-2 xl:grid-cols-3 md:gap-6">
                {items.map(item => (
                  <ProductCard
                    key={item.id}
                    item={item}
                    categoryId={categoryId}
                    onAdd={handleAdd}
                    onZoom={setZoomedImage}
                  />
                ))}
              </div>
              <div className="mt-10 flex justify-center">
                  <a href="#kategorie" className="inline-flex items-center justify-center gap-2 text-lg font-extrabold text-gray-900 bg-brand-yellow border border-black/5 rounded-2xl px-6 py-4 shadow-soft hover:scale-[1.02] active:scale-[0.98] transition hover:ring-2 hover:ring-brand-yellow/40 min-h-[56px]">
                        <i data-lucide="arrow-left" className="w-6 h-6"></i>
                                WrÃ³Ä‡ do menu
                </a>
              </div>
            </div>
          </section>

          <DrinkAddonsModal
            open={addonsOpen}
            onClose={() => setAddonsOpen(false)}
            cartItemId={addonsCartItemId}
            title={addonsTitle}
          />
           
          <ImageModal 
            src={zoomedImage}
            onClose={() => setZoomedImage(null)}
          />
        </>
      );
    };

    /* =======================
       Koszyk
       ======================= */

    const Koszyk = () => {
      const { cart, remove, clear, total, cartValue, deliveryCost, incQty, decQty, setQty, lineTotal, add, addonsTotalPerUnit, promoCode, setPromoCode, discount, applyPromo } = useCart();
      const goToCheckout = () => window.location.hash = '#/zamowienie';
      
      const [codeIn, setCodeIn] = useState("");
      
      return (
        <section className="py-8 md:py-10">
          <div className="max-w-6xl mx-auto px-4">
            <a href="#/" className="inline-flex items-center gap-2 text-sm text-gray-600">
              <i data-lucide="arrow-left" className="w-4 h-4"></i> WrÃ³Ä‡
            </a>
            <h2 className="text-2xl font-extrabold mt-3">Koszyk</h2>

            {cart.length === 0 ? (
              <div className="mt-4 bg-white border border-gray-200 rounded-2xl p-5">
                <p className="text-gray-700 font-semibold">TwÃ³j koszyk jest pusty.</p>
                <a href="#kategorie" className="inline-flex mt-3 items-center gap-2 bg-brand-yellow text-gray-900 font-extrabold rounded-xl px-4 py-3 hover:ring-2 hover:ring-brand-yellow/40 min-h-[44px]">
                  <i data-lucide="shopping-bag" className="w-5 h-5"></i>
                  Wybierz menu
                </a>
              </div>
            ) : (
              <>
                <div className="mt-6 grid md:grid-cols-3 gap-6 items-start">
                  <div className="md:col-span-2 space-y-4">
                    {cart.map(item => {
                      const addSum = addonsTotalPerUnit(item);
                      return (
                        <div key={item.id}
                          className="bg-white border border-gray-200 rounded-2xl p-4 flex flex-col md:flex-row gap-4 md:items-center justify-between w-full hover:ring-2 hover:ring-brand-yellow/30 transition">

                          <div className="flex items-start gap-3 min-w-0 flex-1">
                            <div className="w-14 h-14 rounded-2xl overflow-hidden border border-gray-200 shrink-0">
                              <img
                                src={item.image}
                                alt={item.name}
                                loading="lazy"
                                className="w-full h-full object-cover"
                              />
                            </div>

                            <div className="min-w-0 flex-1">
                              <div className="font-bold break-words">{item.name}</div>

                              {/* âœ… pokazujemy dodatki */}
                              {Array.isArray(item.addons) && item.addons.length > 0 && (
                                <div className="mt-1 flex flex-wrap gap-1.5">
                                  {item.addons.map((a) => (
                                    <span key={a.id} className="text-[11px] font-extrabold px-2 py-1 rounded-full bg-brand-yellow/20 border border-brand-yellow/30">
                                      + {a.label} ({currency(a.price)})
                                    </span>
                                  ))}
                                </div>
                              )}

                              <div className="text-xs text-gray-500 mt-1">
                                ID produktu: <span className="font-mono">{item.productId || 'brak'}</span>
                              </div>

                              {addSum > 0 && (
                                <div className="text-xs text-gray-500 mt-1">
                                  Dodatki / szt.: <span className="font-extrabold text-gray-900">{currency(addSum)}</span>
                                </div>
                              )}
                            </div>
                          </div>

                          <div className="flex flex-col sm:flex-row md:flex-row gap-3 md:gap-4 items-stretch md:items-center w-full md:w-auto justify-between md:justify-end">
                            <div className="flex items-center gap-2 self-start">
                              <button onClick={()=> decQty(item.id)} className="w-10 h-10 rounded-xl border border-gray-200 grid place-items-center hover:ring-2 hover:ring-brand-yellow/40">âˆ’</button>
                              <input
                                value={item.qty||1}
                                onChange={(e)=> setQty(item.id, parseInt(e.target.value||'1',10))}
                                className="input-focus w-16 text-center border border-gray-200 rounded-xl py-2"
                                inputMode="numeric"
                                pattern="[0-9]*"
                              />
                              <button onClick={()=> incQty(item.id)} className="w-10 h-10 rounded-xl border border-gray-200 grid place-items-center hover:ring-2 hover:ring-brand-yellow/40">+</button>
                            </div>

                            <div className="text-right self-center">
                              <div className="font-extrabold whitespace-nowrap">{currency(lineTotal(item))}</div>
                              <div className="text-xs text-gray-500 whitespace-nowrap">
                                ({currency(item.price + (addSum || 0))} / szt.)
                              </div>
                            </div>

                            <button onClick={()=> remove(item.id)} className="text-red-600 hover:underline self-center text-sm">UsuÅ„</button>
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  <aside className="bg-white border border-gray-200 rounded-2xl p-5 sticky top-[84px]">
                      
                    <div className="space-y-2 text-sm text-gray-600 border-b border-gray-100 pb-3 mb-3">
                        <div className="flex items-center justify-between">
                            <span>WartoÅ›Ä‡ koszyka</span>
                            <span className="font-semibold text-gray-900">{currency(cartValue)}</span>
                        </div>
                        {discount > 0 && (
                           <div className="flex items-center justify-between text-green-600 font-bold">
                               <span>Rabat</span>
                               <span>-{currency(discount)}</span>
                           </div>
                        )}
                        <div className="flex items-center justify-between">
                            <span>Koszt dostawy</span>
                            <span className="font-semibold text-gray-900">{currency(deliveryCost)}</span>
                        </div>
                    </div>

                    {/* âœ… KOD RABATOWY */}
                    <div className="mb-4 pb-4 border-b border-gray-100">
                        <label className="text-xs uppercase tracking-widest text-gray-500 font-semibold">Kod rabatowy</label>
                        <div className="flex gap-2 mt-1">
                            <input 
                                value={codeIn}
                                onChange={(e) => setCodeIn(e.target.value)}
                                placeholder="Wpisz kod..."
                                className="input-focus flex-1 border border-gray-200 rounded-xl px-3 py-2 text-sm uppercase"
                            />
                            <button 
                                onClick={() => applyPromo(codeIn)}
                                className="bg-gray-900 text-white rounded-xl px-3 py-2 text-xs font-bold hover:bg-black transition"
                            >
                                UÅ¼yj
                            </button>
                        </div>
                        {promoCode && (
                            <div className="text-xs text-emerald-600 font-bold mt-1.5 flex items-center gap-1">
                                <i data-lucide="tag" className="w-3 h-3"></i> Kod "{promoCode}" dodany do zamÃ³wienia
                            </div>
                        )}
                    </div>

                    <div className="flex items-center justify-between">
                      <span className="font-semibold">Suma</span>
                      <span className="font-extrabold text-xl">{currency(total)}</span>
                    </div>

                    <div className="mt-4 grid gap-2">
                      <button
                        onClick={goToCheckout}
                        className="w-full btn-yellow font-extrabold rounded-xl px-4 py-3 hover:ring-2 hover:ring-brand-yellow/40 min-h-[44px]"

                      >
                        PrzejdÅº do zamÃ³wienia
                      </button>
                      <button onClick={clear} className="w-full bg-gray-100 text-gray-700 rounded-xl px-4 py-3 hover:ring-2 hover:ring-brand-yellow/20 min-h-[44px]">
                        WyczyÅ›Ä‡ koszyk
                      </button>
                    </div>
                  </aside>
                </div>

                <div className="mt-10 border-t border-gray-200 pt-6">
                  <h3 className="text-lg font-bold flex items-center gap-2">
                    <span>MoÅ¼e dorzucisz coÅ› jeszcze?</span>
                    <span className="text-xs px-2 py-0.5 rounded-full bg-brand-yellow text-gray-900 font-extrabold">1 klik i dodane</span>
                  </h3>
                  <p className="text-sm text-gray-600 mt-1">
                    SÅ‚odki dodatek lub napÃ³j czÄ™sto robi rÃ³Å¼nicÄ™ â€” szczegÃ³lnie przy wiÄ™kszych zamÃ³wieniach.
                  </p>

                  <div className="mt-4 flex flex-wrap gap-3">
                    {EXTRA_ITEMS.map(extra => (
                      <button key={extra.id}
                        onClick={() => add({
                          type:'extra',
                          productId: extra.id,
                          name: extra.name,
                          price: extra.price,
                          image: extra.image
                        })}
                        className="flex items-center gap-3 px-4 py-3 rounded-full bg-white border border-gray-200 shadow-soft text-sm hover:shadow-md hover:-translate-y-0.5 transition hover:ring-2 hover:ring-brand-yellow/30 min-h-[44px]">
                        <div className="w-8 h-8 rounded-full overflow-hidden border border-gray-200 shrink-0">
                          <img src={extra.image} alt={extra.name} className="w-full h-full object-cover" loading="lazy" />
                        </div>
                        <span className="text-base font-extrabold text-brand-yellow">+</span>
                        <span>{extra.name}</span>
                        <span className="font-extrabold text-gray-900">{currency(extra.price)}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </>
            )}
          </div>
        </section>
      );
    };

    /* =======================
       CALENDAR WIDGET (POLISH GRID)
       ======================= */
    const CalendarWidget = ({ onDateSelect, selectedDateStr, maxDateStr, now }) => {
        // State for current view month
        const [viewDate, setViewDate] = useState(now);

        // Helper: Format date to YYYY-MM-DD for comparison
        const toYMD = (d) => d.toISOString().split('T')[0];

        // Polish Month Names
        const PL_MONTHS = ["StyczeÅ„", "Luty", "Marzec", "KwiecieÅ„", "Maj", "Czerwiec", "Lipiec", "SierpieÅ„", "WrzesieÅ„", "PaÅºdziernik", "Listopad", "GrudzieÅ„"];

        // Navigation
        const nextMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1));
        const prevMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1));

        // Logic check
        const isDateDisabled = (d) => {
            const ymd = toYMD(d);
            const todayYMD = toYMD(now);
            const maxYMD = maxDateStr;

            // 1. Past dates (before today)
            if (d < new Date(now.getFullYear(), now.getMonth(), now.getDate())) return true;

            // 2. Logic: If today is Friday > 16:00, today is disabled
            // (We handle this by passing `now` which might be logically shifted, 
            // but here we just check if it's strictly before `now` passed as prop)
            
            // 3. Weekend check
            const day = d.getDay();
            if (day === 0 || day === 6) return true; // 0=Sun, 6=Sat

            // 4. Max date check
            if (ymd > maxYMD) return true;

            return false;
        };

        const renderCalendarGrid = () => {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            // First day of month
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
            // Polish grid starts on Monday (1). 
            // If 1 (Mon) -> offset 0. If 0 (Sun) -> offset 6.
            const startOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];

            // Empty slots for start offset
            for (let i = 0; i < startOffset; i++) {
                days.push(<div key={`empty-${i}`} className="h-10"></div>);
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const ymd = toYMD(dateObj);
                const disabled = isDateDisabled(dateObj);
                const selected = selectedDateStr === ymd;

                days.push(
                    <button
                        key={ymd}
                        type="button"
                        onClick={() => !disabled && onDateSelect(ymd)}
                        disabled={disabled}
                        className={`h-10 w-full rounded-lg text-sm font-bold flex items-center justify-center transition
                            ${selected 
                                ? 'bg-brand-yellow text-gray-900 ring-2 ring-brand-yellow/50' 
                                : disabled 
                                    ? 'text-gray-300 bg-gray-50 cursor-not-allowed'
                                    : 'text-gray-700 hover:bg-gray-100 hover:text-gray-900'
                            }
                        `}
                    >
                        {d}
                    </button>
                );
            }
            return days;
        };

        return (
            <div className="bg-white border border-gray-200 rounded-xl p-4 select-none">
                {/* Header */}
                <div className="flex items-center justify-between mb-4">
                    <button type="button" onClick={prevMonth} className="p-1 hover:bg-gray-100 rounded-lg text-gray-500">
                        <i data-lucide="chevron-left" className="w-5 h-5"></i>
                    </button>
                    <div className="font-bold text-gray-900 capitalize">
                        {PL_MONTHS[viewDate.getMonth()]} {viewDate.getFullYear()}
                    </div>
                    <button type="button" onClick={nextMonth} className="p-1 hover:bg-gray-100 rounded-lg text-gray-500">
                        <i data-lucide="chevron-right" className="w-5 h-5"></i>
                    </button>
                </div>

                {/* Days Header (Pn Wt...) */}
                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                    {['Pn','Wt','Åšr','Cz','Pt','So','Nd'].map(d => (
                        <div key={d} className="text-xs font-bold text-gray-400 uppercase">{d}</div>
                    ))}
                </div>

                {/* Grid */}
                <div className="grid grid-cols-7 gap-1">
                    {renderCalendarGrid()}
                </div>
            </div>
        );
    };

    /* =======================
       ZAMOWIENIE (3 metody pÅ‚atnoÅ›ci + 2 metody realizacji + DATA/CZAS)
       ======================= */
    
    // âœ… DEFINICJA SLOTÃ“W CZASOWYCH I ICH PROGÃ“W ODCIÄ˜CIA (dla DZISIAJ)
    // cutoff: minuty od poczÄ…tku dnia (np. 8:00 = 8*60 = 480)
    // JeÅ›li aktualny czas w minutach > cutoff, slot jest niedostÄ™pny dzisiaj.
    const TIME_SLOTS_DEF = [
      { id: 'slot-1', label: '08:30 â€“ 09:30', cutoff: 8 * 60 },      // 8:00
      { id: 'slot-2', label: '10:00 â€“ 11:00', cutoff: 10 * 60 },     // 10:00 (implies > 9:59)
      { id: 'slot-3', label: '11:30 â€“ 12:30', cutoff: 11 * 60 + 30 },// 11:30 (implies > 11:29)
      { id: 'slot-4', label: '13:00 â€“ 14:00', cutoff: 13 * 60 },     // 13:00 (implies > 12:59)
      { id: 'slot-5', label: '15:00 â€“ 16:00', cutoff: 15 * 60 }      // 15:00 - koniec dnia
    ];

    const Zamowienie = () => {
      const { cart, total, cartValue, deliveryCost, lineTotal, clear, addonsTotalPerUnit, promoCode } = useCart();
      const { user } = useAuth();
      const { saveOrder } = useActiveOrder();
      const toast = useToast();
      const showToast = toast?.show;

      const [now, setNow] = useState(new Date());
      useEffect(() => {
        const interval = setInterval(() => setNow(new Date()), 1000 * 60);
        return () => clearInterval(interval);
      }, []);

      // âœ… Lista obsÅ‚ugiwanych miast
      const ALLOWED_CITIES = [
         'SÅ‚upsk', 'Redzikowo', 'Bierkowo', 'Åosiono', 'KrÄ™pa SÅ‚upska', 'GÅ‚obino', 'WÅ‚ynkÃ³wko', 'Siemianice', 'Kobylnica'
      ];

      // âœ… Metody realizacji i pÅ‚atnoÅ›ci
      const [fulfillmentMethod, setFulfillmentMethod] = useState('delivery'); // 'delivery' | 'pickup'
      const [paymentMethod, setPaymentMethod] = useState("payu"); // 'payu' | 'card' | 'cash'
      const [busyPay, setBusyPay] = useState(false);
      
      // âœ… Stan bÅ‚Ä™dÃ³w walidacji
      const [errors, setErrors] = useState({});

      // âœ… LOGIKA DATY I CZASU
      const getAvailableSlots = (targetDateStr) => {
          const targetDate = new Date(targetDateStr);
          const isToday = targetDate.toDateString() === now.toDateString();

          if (!isToday) {
             // JeÅ›li to przyszÅ‚a data (np. jutro), wszystkie sloty sÄ… dostÄ™pne
             return TIME_SLOTS_DEF;
          }

          // JeÅ›li dzisiaj: filtrujemy po godzinie
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          return TIME_SLOTS_DEF.filter(slot => currentMinutes < slot.cutoff);
      };

      const dateConfig = useMemo(() => {
          // Ustalamy datÄ™ minimalnÄ…. 
          // JeÅ›li jest po 16:00 (lub brak slotÃ³w na dziÅ›), min data to jutro (jeÅ›li roboczy)
          // Ale CalendarWidget i tak filtruje sloty.
          
          let startDate = new Date(now);
          // JeÅ›li dzisiaj brak slotÃ³w, przeskocz na jutro logicznie jako start
          const slotsToday = getAvailableSlots(startDate.toISOString().split('T')[0]);
          if (slotsToday.length === 0) {
              startDate.setDate(startDate.getDate() + 1);
          }
          
          // Max date calculation (Current + 7 WORKING days strictly)
          let maxDate = new Date(startDate);
          let workingDaysAdded = 0;
          let safetyCounter = 0;
          while (workingDaysAdded < 7 && safetyCounter < 20) {
             maxDate.setDate(maxDate.getDate() + 1);
             const d = maxDate.getDay();
             if (d !== 0 && d !== 6) { // Not Sun (0) or Sat (6)
                 workingDaysAdded++;
             }
             safetyCounter++;
          }

          return {
              minStr: startDate.toISOString().split('T')[0],
              maxStr: maxDate.toISOString().split('T')[0]
          };
      }, [now]);
      
      const [dateParams, setDateParams] = useState({
         selectedDate: dateConfig.minStr, 
         selectedTimeSlot: null // Przechowujemy caÅ‚y obiekt slotu lub ID
      });

      // JeÅ›li selectedDate jest niepoprawna (np. sobota), przesuÅ„ na poniedziaÅ‚ek
      useEffect(() => {
          const d = new Date(dateParams.selectedDate);
          const day = d.getDay();
          if (day === 0 || day === 6) {
             let nextValid = new Date(d);
             while (nextValid.getDay() === 0 || nextValid.getDay() === 6) {
                 nextValid.setDate(nextValid.getDate() + 1);
             }
             setDateParams(p => ({...p, selectedDate: nextValid.toISOString().split('T')[0]}));
          }
      }, [dateParams.selectedDate]);

      // âœ… Automatyczny wybÃ³r pierwszego dostÄ™pnego slotu po zmianie daty
      const availableSlots = useMemo(() => getAvailableSlots(dateParams.selectedDate), [dateParams.selectedDate, now]);

      useEffect(() => {
          // JeÅ›li aktualnie wybrany slot nie jest dostÄ™pny w nowej liÅ›cie, zresetuj lub wybierz pierwszy
          const isValid = dateParams.selectedTimeSlot && availableSlots.find(s => s.id === dateParams.selectedTimeSlot.id);
          
          if (!isValid && availableSlots.length > 0) {
             setDateParams(p => ({ ...p, selectedTimeSlot: availableSlots[0] }));
          } else if (availableSlots.length === 0) {
             setDateParams(p => ({ ...p, selectedTimeSlot: null }));
          }
      }, [availableSlots]);


      // Formularz
      const emptyForm = {
        imieNazwisko:'', telefon:'', email:'', miasto:'', kod:'', ulica:'', nrBud:'', pietro:'', lokal:'', uwagi:'', faktura:false, nip:'', firma:''
      };

      const [form, setForm] = useState(() => {
        const saved = loadSavedCustomer();
        const base = { ...emptyForm };
        if (saved && typeof saved === "object") {
          Object.keys(base).forEach((k) => {
            if (typeof saved[k] !== "undefined" && saved[k] !== null) base[k] = saved[k];
          });
        }
        if (user?.email) base.email = base.email || user.email;
        if (user?.fullName) base.imieNazwisko = base.imieNazwisko || user.fullName;
        return base;
      });

      // NasÅ‚uch na miasto (ukrywanie Å¼Ã³Å‚tego boxa)
      const isCityValid = useMemo(() => {
          if (!form.miasto) return false;
          const normalizedInput = form.miasto.toLowerCase().trim();
          return ALLOWED_CITIES.some(c => c.toLowerCase() === normalizedInput);
      }, [form.miasto]);

      useEffect(() => {
        setForm((prev) => {
          const next = { ...prev };
          if (user?.email) next.email = next.email || user.email;
          if (user?.fullName) next.imieNazwisko = next.imieNazwisko || user.fullName;
          return next;
        });
      }, [user]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [fulfillmentMethod, dateParams, errors]); 

      const [remember, setRemember] = useState(true);
      const [hadSaved, setHadSaved] = useState(() => !!loadSavedCustomer());

      // âœ… Zmodyfikowany handle - czyÅ›ci bÅ‚Ä…d podczas pisania
      const handle = (k,v)=> {
          setForm(s=> ({...s,[k]:v}));
          if (errors[k]) {
              setErrors(prev => ({...prev, [k]: false}));
          }
      };

      useEffect(() => {
        if (!remember) return;
        const t = setTimeout(() => {
          saveCustomer({ ...form });
          setHadSaved(true);
        }, 250);
        return () => clearTimeout(t);
      }, [form, remember]);

      const clearRemembered = () => {
        clearSavedCustomer();
        setHadSaved(false);
        setForm({ ...emptyForm });
      };

      // âœ… Pomocnik do stylÃ³w inputÃ³w (czerwona ramka przy bÅ‚Ä™dzie)
      const getInputClass = (field) => {
          const base = "input-focus w-full border rounded-xl px-4 py-3 min-h-[44px] ";
          if (errors[field]) {
              return base + "border-red-500 bg-red-50 text-red-900 placeholder-red-300 ring-1 ring-red-500";
          }
          return base + "border-gray-200 bg-white";
      };

      // âœ… Zmodyfikowana walidacja
      const validateBeforeOrder = () => {
        const newErrors = {};
        let isValid = true;

        if (!form.imieNazwisko) { newErrors.imieNazwisko = true; isValid = false; }
        if (!form.telefon) { newErrors.telefon = true; isValid = false; }

        if (fulfillmentMethod === 'delivery') {
            if (!form.miasto) { newErrors.miasto = true; isValid = false; }
            if (!form.ulica) { newErrors.ulica = true; isValid = false; }
            if (!form.nrBud) { newErrors.nrBud = true; isValid = false; }
        }

        if (!isValid) {
            setErrors(newErrors);
            showToast('UzupeÅ‚nij wymagane pola zaznaczone na czerwono ðŸ”´');
            // Wibracja przy bÅ‚Ä™dzie
            try { if (navigator.vibrate) navigator.vibrate(200); } catch {}
            return false;
        }

        if (!dateParams.selectedTimeSlot) {
            showToast('Wybierz godzinÄ™ realizacji â°');
            return false;
        }

        if (!cart.length) {
          showToast('TwÃ³j koszyk jest pusty ðŸ›’');
          return false;
        }
        return true;
      };

       const placeOrder = async () => {
         if (!validateBeforeOrder()) return;

         if (remember) {
           saveCustomer({ ...form });
           setHadSaved(true);
         }

         setBusyPay(true);

         // Budujemy opis czasu dostawy
         const selDate = new Date(dateParams.selectedDate);
         const isToday = selDate.toDateString() === now.toDateString();
         const dayName = isToday ? "Dzisiaj" : selDate.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' });
         
         const deliveryTimeInfo = `${dayName}, ${dateParams.selectedTimeSlot.label}`;

         try {
           const payload = {
             customer: {
                 ...form,
                 deliveryTime: deliveryTimeInfo, // WysyÅ‚amy sformatowany czas
                 fulfillmentMethod: fulfillmentMethod // 'delivery' lub 'pickup'
             },
             cart: cart.map(i => ({
               productId: i.productId,
               name: i.name,
               price: i.price,
               qty: i.qty || 1,
               addons: Array.isArray(i.addons) ? i.addons.map(a => ({ id: a.id, label: a.label, price: a.price })) : []
             })),
             total: total,
             promoCode: promoCode
           };

           // --- PÅATNOÅšÄ† ONLINE (PAYU) ---
           if (paymentMethod === "payu") {
             const r = await fetch("/api/payu/order", {
               method: "POST",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify(payload),
             });

             const data = await r.json().catch(() => ({}));
             if (!r.ok) {
               alert("BÅ‚Ä…d serwera: " + (data.error || r.status));
               return;
             }
               
             if (data.redirectUri) {
                saveOrder({
                   extOrderId: data.extOrderId,
                   customer: payload.customer,
                   items: cart,
                   total: total,
                   paymentMethod: paymentMethod,
                   status: 'OCZEKIWANIE NA PÅATNOÅšÄ†'
                });
                
                clear();
                window.location.href = data.redirectUri;
             } else {
                alert("BÅ‚Ä…d: Brak linku do pÅ‚atnoÅ›ci");
             }
             return;
           }

           // --- PÅATNOÅšÄ† OFFLINE (KARTA / GOTÃ“WKA) ---
           const offlinePayload = { ...payload, paymentMethod: paymentMethod };

           const r2 = await fetch("/api/order/offline", {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify(offlinePayload),
           });

           const data2 = await r2.json();

           if (!r2.ok) {
               throw new Error(data2.error || "BÅ‚Ä…d zamÃ³wienia");
           }

           saveOrder({
               extOrderId: data2.extOrderId,
               customer: payload.customer,
               items: cart,
               total: total,
               paymentMethod: paymentMethod
           });

           showToast?.("Twoje zamÃ³wienie zostaÅ‚o przyjÄ™te! ðŸ‘¨â€ðŸ³");
           clear();
           window.location.hash = "#/";
             
         } catch (e) {
           alert("Nie udaÅ‚o siÄ™ zÅ‚oÅ¼yÄ‡ zamÃ³wienia: " + e.message);
         } finally {
           setBusyPay(false);
         }
       };

      const paymentLabel =
        paymentMethod === "payu" ? "PÅ‚atnoÅ›Ä‡ online (PayU)" :
        paymentMethod === "card" ? "Karta przy odbiorze" :
        "GotÃ³wka przy odbiorze";
      
      const submitLabel = fulfillmentMethod === 'pickup' ? "Zamawiam z odbiorem" : "Zamawiam z dostawÄ…";

      return (
        <section className="py-8 md:py-10">
          <div className="max-w-6xl mx-auto px-4">
            <a href="#/koszyk" className="inline-flex items-center gap-2 text-sm text-gray-600">
              <i data-lucide="arrow-left" className="w-4 h-4"></i> WrÃ³Ä‡ do koszyka
            </a>
            <h2 className="text-2xl font-extrabold mt-3">Finalizacja zamÃ³wienia</h2>

            <div className="mt-6 grid lg:grid-cols-3 gap-6 items-start">
              <div className="lg:col-span-2 space-y-6">
                  
                  {/* 1. SPOSÃ“B REALIZACJI I CZAS */}
                  <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-soft">
                      <div className="text-xs uppercase tracking-widest text-gray-500 font-semibold mb-4">1. SposÃ³b i czas realizacji</div>
                      
                      {/* WybÃ³r Daty - NOWY KALENDARZ (PRZENIESIONY NA GÃ“RÄ˜) */}
                      <div className="mb-6">
                          <label className="text-sm font-semibold text-gray-900 block mb-2">Wybierz dzieÅ„:</label>
                          <CalendarWidget 
                              onDateSelect={(val) => setDateParams(p => ({ ...p, selectedDate: val }))}
                              selectedDateStr={dateParams.selectedDate}
                              maxDateStr={dateConfig.maxStr}
                              now={now} 
                          />
                      </div>

                      {/* WybÃ³r Godziny (NOWA LOGIKA SLOTÃ“W) */}
                      <div className="mb-6">
                          <label className="text-sm font-semibold text-gray-900 block mb-2">Wybierz godzinÄ™ realizacji:</label>
                          
                          {availableSlots.length === 0 ? (
                              <div className="text-sm text-red-600 font-medium bg-red-50 p-3 rounded-lg border border-red-100">
                                  Brak wolnych terminÃ³w na ten dzieÅ„. ProszÄ™ wybraÄ‡ innÄ… datÄ™.
                              </div>
                          ) : (
                              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                  {availableSlots.map(slot => {
                                      const isSelected = dateParams.selectedTimeSlot?.id === slot.id;
                                      return (
                                          <button
                                              key={slot.id}
                                              type="button"
                                              onClick={() => setDateParams(p => ({ ...p, selectedTimeSlot: slot }))}
                                              className={`py-3 px-2 rounded-xl text-sm font-bold border transition ${
                                                  isSelected 
                                                    ? 'bg-brand-yellow text-gray-900 border-brand-yellow ring-2 ring-brand-yellow/40' 
                                                    : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'
                                              }`}
                                          >
                                              {slot.label}
                                          </button>
                                      );
                                  })}
                              </div>
                          )}
                      </div>

                      {/* Toggle Dostawa / OdbiÃ³r (PRZENIESIONE NA DÃ“Å) */}
                      <label className="text-sm font-semibold text-gray-900 block mb-2">SposÃ³b odbioru:</label>
                      <div className="grid grid-cols-2 gap-3">
                          <button
                             type="button"
                             onClick={() => setFulfillmentMethod('delivery')}
                             className={`flex items-center justify-center gap-2 py-3 rounded-xl font-bold border transition ${fulfillmentMethod === 'delivery' ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                          >
                             <i data-lucide="truck" className="w-4 h-4"></i> Dostawa
                          </button>
                          <button
                             type="button"
                             onClick={() => setFulfillmentMethod('pickup')}
                             className={`flex items-center justify-center gap-2 py-3 rounded-xl font-bold border transition ${fulfillmentMethod === 'pickup' ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                          >
                             <i data-lucide="shopping-bag" className="w-4 h-4"></i> OdbiÃ³r osobisty
                          </button>
                      </div>
                  </div>

                  {/* 2. DANE DOSTAWY / ODBIORU */}
                  <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-soft">
                      <div className="text-xs uppercase tracking-widest text-gray-500 font-semibold mb-4">
                          {fulfillmentMethod === 'delivery' ? '2. Adres dostawy' : '2. Dane odbierajÄ…cego'}
                      </div>
                      
                      {/* âœ… Å»Ã³Å‚ty Box - pojawia siÄ™ TYLKO gdy jest tekst ORAZ miasto nie jest na liÅ›cie */}
                      {fulfillmentMethod === 'delivery' && form.miasto.trim().length > 0 && !isCityValid && (
                          <div className="mb-4 p-4 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-800 text-sm flex items-start gap-3 shadow-sm transition-all duration-500">
                              <i data-lucide="info" className="w-5 h-5 shrink-0 mt-0.5"></i>
                              <div>
                                <div className="font-bold">Gdzie dowozimy?</div>
                                <p className="mt-1">
                                  ObsÅ‚ugujemy: <strong>SÅ‚upsk, Redzikowo, Bierkowo, Åosiono, KrÄ™pa SÅ‚upska, GÅ‚obino, WÅ‚ynkÃ³wko, Siemianice, Kobylnica</strong>.
                                  <br/>Wpisz poprawne miasto, aby ten komunikat zniknÄ…Å‚.
                                </p>
                              </div>
                          </div>
                      )}

                      <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="text-xs uppercase tracking-wider text-gray-500">ImiÄ™ i nazwisko *</label>
                            <input value={form.imieNazwisko} onChange={e=>handle('imieNazwisko', e.target.value)}
                              className={getInputClass('imieNazwisko')}/>
                          </div>
                          <div>
                            <label className="text-xs uppercase tracking-wider text-gray-500">Nr telefonu *</label>
                            <input value={form.telefon} onChange={e=>handle('telefon', e.target.value)}
                              className={getInputClass('telefon')}/>
                          </div>
                          <div className="md:col-span-2">
                            <label className="text-xs uppercase tracking-wider text-gray-500">Adres email (opcjonalnie)</label>
                            <input value={form.email} onChange={e=>handle('email', e.target.value)}
                              className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                          </div>

                          {/* Pola adresu - UKRYTE przy odbiorze osobistym */}
                          {fulfillmentMethod === 'delivery' && (
                              <>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">Miasto *</label>
                                    <input value={form.miasto} onChange={e=>handle('miasto', e.target.value)}
                                      className={getInputClass('miasto')}/>
                                  </div>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">Kod pocztowy</label>
                                    {/* âœ… UsuniÄ™ty placeholder */}
                                    <input value={form.kod} onChange={e=>handle('kod', e.target.value)}
                                      className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                                  </div>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">Ulica *</label>
                                    <input value={form.ulica} onChange={e=>handle('ulica', e.target.value)}
                                      className={getInputClass('ulica')}/>
                                  </div>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">Nr budynku *</label>
                                    <input value={form.nrBud} onChange={e=>handle('nrBud', e.target.value)}
                                      className={getInputClass('nrBud')}/>
                                  </div>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">PiÄ™tro</label>
                                    <input value={form.pietro} onChange={e=>handle('pietro', e.target.value)}
                                      className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                                  </div>
                                  <div>
                                    <label className="text-xs uppercase tracking-wider text-gray-500">Nr lokalu</label>
                                    <input value={form.lokal} onChange={e=>handle('lokal', e.target.value)}
                                      className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                                  </div>
                              </>
                          )}

                          <div className="md:col-span-2">
                            <label className="text-xs uppercase tracking-wider text-gray-500">Uwagi do zamÃ³wienia</label>
                            <textarea value={form.uwagi} onChange={e=>handle('uwagi', e.target.value)}
                              className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 min-h-[100px] bg-white"></textarea>
                          </div>
                      </div>

                      <div className="mt-4">
                        <label className="flex items-center gap-2 text-sm">
                          <input type="checkbox" checked={form.faktura} onChange={e=>handle('faktura', e.target.checked)} />
                          ChcÄ™ fakturÄ™ VAT
                        </label>
                        {form.faktura && (
                          <div className="grid md:grid-cols-2 gap-4 mt-3 pt-3 border-t border-gray-100">
                            <div>
                              <label className="text-xs uppercase tracking-wider text-gray-500">NIP</label>
                              <input value={form.nip} onChange={e=>handle('nip', e.target.value)}
                                className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                            </div>
                            <div>
                              <label className="text-xs uppercase tracking-wider text-gray-500">Nazwa firmy</label>
                              <input value={form.firma} onChange={e=>handle('firma', e.target.value)}
                                className="input-focus w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                            </div>
                          </div>
                        )}
                      </div>
                  </div>

                  {/* 3. METODA PÅATNOÅšCI */}
                  <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-soft">
                      <div className="text-xs uppercase tracking-widest text-gray-500 font-semibold mb-4">3. PÅ‚atnoÅ›Ä‡</div>
                      <div className="grid md:grid-cols-3 gap-3">
                        <label className={`cursor-pointer rounded-2xl border p-4 shadow-soft transition ${paymentMethod==="payu" ? "bg-brand-yellow border-brand-yellow ring-2 ring-brand-yellow/50" : "bg-white border-gray-200 hover:bg-gray-50"}`}>
                          <input type="radio" name="payment" value="payu" checked={paymentMethod==="payu"} onChange={() => setPaymentMethod("payu")} className="hidden" />
                          <div className="flex items-start gap-3">
                            <div className={`w-11 h-11 rounded-2xl grid place-items-center ring-1 ring-black/10 shrink-0 ${paymentMethod==="payu" ? "bg-white" : "bg-brand-yellow/20"}`}>
                              <i data-lucide="credit-card" className="w-5 h-5 text-gray-900"></i>
                            </div>
                            <div className="min-w-0">
                              <div className="font-extrabold text-gray-900">Online (PayU)</div>
                              <div className="text-xs text-gray-700 mt-0.5">Szybki przelew / BLIK</div>
                            </div>
                          </div>
                        </label>

                        <label className={`cursor-pointer rounded-2xl border p-4 shadow-soft transition ${paymentMethod==="card" ? "bg-brand-yellow border-brand-yellow ring-2 ring-brand-yellow/50" : "bg-white border-gray-200 hover:bg-gray-50"}`}>
                          <input type="radio" name="payment" value="card" checked={paymentMethod==="card"} onChange={() => setPaymentMethod("card")} className="hidden" />
                          <div className="flex items-start gap-3">
                            <div className={`w-11 h-11 rounded-2xl grid place-items-center ring-1 ring-black/10 shrink-0 ${paymentMethod==="card" ? "bg-white" : "bg-brand-yellow/20"}`}>
                              <i data-lucide="credit-card" className="w-5 h-5 text-gray-900"></i>
                            </div>
                            <div className="min-w-0">
                              <div className="font-extrabold text-gray-900">Karta na miejscu</div>
                              <div className="text-xs text-gray-700 mt-0.5">{fulfillmentMethod === 'pickup' ? 'Przy odbiorze' : 'U kuriera'}</div>
                            </div>
                          </div>
                        </label>

                        <label className={`cursor-pointer rounded-2xl border p-4 shadow-soft transition ${paymentMethod==="cash" ? "bg-brand-yellow border-brand-yellow ring-2 ring-brand-yellow/50" : "bg-white border-gray-200 hover:bg-gray-50"}`}>
                          <input type="radio" name="payment" value="cash" checked={paymentMethod==="cash"} onChange={() => setPaymentMethod("cash")} className="hidden" />
                          <div className="flex items-start gap-3">
                            <div className={`w-11 h-11 rounded-2xl grid place-items-center ring-1 ring-black/10 shrink-0 ${paymentMethod==="cash" ? "bg-white" : "bg-brand-yellow/20"}`}>
                              <i data-lucide="banknote" className="w-5 h-5 text-gray-900"></i>
                            </div>
                            <div className="min-w-0">
                              <div className="font-extrabold text-gray-900">GotÃ³wka</div>
                              <div className="text-xs text-gray-700 mt-0.5">{fulfillmentMethod === 'pickup' ? 'Przy odbiorze' : 'U kuriera'}</div>
                            </div>
                          </div>
                        </label>
                      </div>
                  </div>

                  {/* Logowanie / Zapisywanie danych */}
                  {!user && (
                    <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-soft flex flex-col md:flex-row md:items-center justify-between gap-3">
                      <div>
                        <div className="font-extrabold text-gray-900">Masz konto? Zaloguj siÄ™</div>
                        <div className="text-sm text-gray-600">Dane uzupeÅ‚niÄ… siÄ™ automatycznie.</div>
                      </div>
                      <div className="flex items-center gap-2">
                          <label className="flex items-center gap-2 text-sm font-semibold text-gray-800 cursor-pointer">
                            <input type="checkbox" checked={remember} onChange={(e)=>setRemember(e.target.checked)} />
                            ZapamiÄ™taj mnie
                          </label>
                          {hadSaved && (
                            <button type="button" onClick={clearRemembered} className="text-xs text-gray-500 hover:text-red-600 underline">WyczyÅ›Ä‡</button>
                          )}
                      </div>
                    </div>
                  )}

              </div>

              {/* PODSUMOWANIE (STICKY) */}
              <aside className="bg-white border border-gray-200 rounded-2xl p-5 sticky top-[84px]">
                <div className="font-semibold text-lg mb-4">Podsumowanie</div>
                <div className="space-y-3 max-h-64 overflow-auto pr-2 mb-4 custom-scrollbar">
                  {cart.map(i => {
                    const addSum = addonsTotalPerUnit(i);
                    return (
                      <div key={i.id} className="text-sm flex justify-between gap-2 border-b border-gray-50 pb-2">
                        <div>
                           <div className="font-medium">{i.name}</div>
                           {i.addons?.length > 0 && <div className="text-xs text-gray-500">+ dodatki</div>}
                           <div className="text-xs text-gray-400">IloÅ›Ä‡: {i.qty}</div>
                        </div>
                        <div className="font-bold">{currency(lineTotal(i))}</div>
                      </div>
                    );
                  })}
                </div>
                  
                <div className="space-y-2 text-sm text-gray-600 border-t border-gray-100 pt-3">
                    <div className="flex justify-between">
                        <span>Produkty</span>
                        <span>{currency(cartValue)}</span>
                    </div>
                    <div className="flex justify-between">
                        <span>Dostawa</span>
                        <span className="font-semibold text-gray-900">
                             {fulfillmentMethod === 'pickup' ? currency(0) : currency(deliveryCost)}
                        </span>
                    </div>
                </div>

                <div className="mt-4 bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm">
                  <div className="flex justify-between mb-1">
                      <span className="text-gray-500">Typ:</span>
                      <span className="font-bold">{fulfillmentMethod === 'delivery' ? 'Dostawa' : 'OdbiÃ³r osobisty'}</span>
                  </div>
                  <div className="flex justify-between mb-1">
                      <span className="text-gray-500">PÅ‚atnoÅ›Ä‡:</span>
                      <span className="font-bold">{paymentLabel.split('(')[0]}</span>
                  </div>
                  <div className="flex justify-between">
                      <span className="text-gray-500">Termin:</span>
                      <span className="font-bold text-right ml-4">
                          {dateParams.selectedTimeSlot ? dateParams.selectedTimeSlot.label : '-'}
                      </span>
                  </div>
                </div>

                <div className="flex items-center justify-between mt-5 text-xl">
                  <span className="font-bold">Razem</span>
                  <span className="font-extrabold text-brand-yellow drop-shadow-sm" style={{ textShadow: '0 1px 1px rgba(0,0,0,0.1)' }}>
                      {fulfillmentMethod === 'pickup' ? currency(total - deliveryCost) : currency(total)}
                  </span>
                </div>
                
                <button
                onClick={placeOrder}
                disabled={busyPay}
                style={{
                  backgroundColor: "#FFC107",
                  color: "#111827",
                  opacity: busyPay ? 0.6 : 1,
                  cursor: busyPay ? "not-allowed" : "pointer"
                }}
                className="w-full mt-6 font-extrabold rounded-xl px-4 py-4 text-base shadow-soft hover:shadow-lg hover:-translate-y-0.5 transition flex items-center justify-center gap-2"
              >
                {busyPay && <i data-lucide="loader" className="w-5 h-5 spin"></i>}
                {submitLabel}
              </button>
              </aside>
            </div>
          </div>
        </section>
      );
    };

    /* =======================
       AUTH MODAL (bez kodÃ³w)
       ======================= */

    const AuthModal = ({ open, onClose, initialStep }) => {
      const { user, login, register, logout } = useAuth();
      const toast = useToast();
      const showToast = toast?.show;

      const [step, setStep] = useState("login");
      const [busy, setBusy] = useState(false);
      const [error, setError] = useState("");

      const [loginForm, setLoginForm] = useState({ email: "", password: "" });
      const [regForm, setRegForm] = useState({ email: "", fullName: "", password: "", confirm: "" });

      useEffect(() => {
        if (!open) return;
        setError("");
        setBusy(false);

        if (user) {
          setStep("account");
        } else {
          if (initialStep && ["login","register","account"].includes(initialStep)) {
            setStep(initialStep === "account" ? "login" : initialStep);
          } else {
            setStep("login");
          }
        }
      }, [open, initialStep, user]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [open, step, busy, error, user]);

      useEffect(() => {
        const onKey = (e) => {
          if (!open) return;
          if (e.key === "Escape") onClose?.();
        };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);

      if (!open) return null;

      const submitLogin = async (e) => {
        e.preventDefault();
        setError("");
        setBusy(true);
        try {
          await login({ email: loginForm.email, password: loginForm.password });
          onClose?.();
        } catch (err) {
          setError(err?.message || "BÅ‚Ä…d logowania");
        } finally {
          setBusy(false);
        }
      };

      const submitRegister = async (e) => {
        e.preventDefault();
        setError("");
        setBusy(true);
        try {
          await register(regForm);
          onClose?.();
        } catch (err) {
          setError(err?.message || "BÅ‚Ä…d rejestracji");
        } finally {
          setBusy(false);
        }
      };

      const Title = ({ eyebrow, title, subtitle }) => (
        <div className="mb-4">
          <div className="text-xs uppercase tracking-[0.16em] text-gray-500 font-semibold">{eyebrow}</div>
          <h3 className="text-xl font-extrabold mt-1">{title}</h3>
          {subtitle && <p className="text-xs text-gray-500 mt-1">{subtitle}</p>}
          {error && (
            <div className="mt-3 text-sm bg-red-50 border border-red-200 text-red-700 rounded-xl px-3 py-2">
              {error}
            </div>
          )}
        </div>
      );

      const Button = ({ children, onClick, type="button", variant="dark", disabled=false }) => {
        const cls =
          variant === "dark"
            ? "bg-gray-900 text-white hover:bg-black hover:ring-2 hover:ring-brand-yellow/30"
            : variant === "yellow"
              ? "bg-brand-yellow text-gray-900 hover:ring-2 hover:ring-brand-yellow/40"
              : "bg-gray-100 text-gray-900 hover:ring-2 hover:ring-brand-yellow/20";

        return (
          <button
            type={type}
            onClick={onClick}
            disabled={disabled}
            className={`w-full mt-1 font-semibold rounded-xl px-4 py-3 text-sm min-h-[44px] transition ${cls} ${disabled ? "opacity-60 cursor-not-allowed" : ""}`}
          >
            <span className="inline-flex items-center justify-center gap-2">
              {disabled && <i data-lucide="loader" className="w-4 h-4 spin"></i>}
              {children}
            </span>
          </button>
        );
      };

      return (
        <div className="fixed inset-0 z-[90] bg-black/60 flex items-center justify-center px-4" onClick={onClose} role="dialog" aria-modal="true">
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-glass border border-gray-200 p-6" onClick={(e) => e.stopPropagation()}>
            <button type="button" onClick={onClose} className="absolute top-3 right-3 p-2 rounded-full bg-white border border-gray-200 shadow-soft hover:bg-gray-50 hover:ring-2 hover:ring-brand-yellow/40" aria-label="Zamknij okno konta">
              <i data-lucide="x" className="w-4 h-4"></i>
            </button>

            {step === "account" && user && (
              <>
                <Title
                  eyebrow="Konto"
                  title="JesteÅ› zalogowany"
                  subtitle="MoÅ¼esz siÄ™ wylogowaÄ‡ albo zamknÄ…Ä‡ okno."
                />
                <div className="bg-white border border-gray-200 rounded-2xl p-4">
                  <div className="text-xs uppercase tracking-widest text-gray-500 font-semibold">UÅ¼ytkownik</div>
                  <div className="mt-1 font-extrabold text-gray-900">{user.fullName || "-"}</div>
                  <div className="mt-1 text-sm text-gray-700">{user.email || "-"}</div>
                </div>

                <div className="mt-4 grid gap-2">
                  <Button
                    variant="yellow"
                    onClick={() => { showToast?.("OK ðŸ‘"); onClose?.(); }}
                  >
                    Zamknij
                  </Button>
                  <Button
                    variant="ghost"
                    onClick={() => { logout(); setStep("login"); }}
                  >
                    Wyloguj
                  </Button>
                </div>
              </>
            )}

            {step === "login" && (
              <>
                <Title
                  eyebrow="Logowanie"
                  title="Zaloguj siÄ™ do eatmi"
                  subtitle="Zaloguj siÄ™, aby szybciej zamawiaÄ‡ i mieÄ‡ zapisane dane."
                />
                <form onSubmit={submitLogin} className="space-y-3">
                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">Adres e-mail</label>
                    <input type="email" required value={loginForm.email}
                      onChange={(e) => setLoginForm(s => ({...s, email: e.target.value}))}
                      placeholder="np. jan.kowalski@example.com"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">HasÅ‚o</label>
                    <input type="password" required value={loginForm.password}
                      onChange={(e) => setLoginForm(s => ({...s, password: e.target.value}))}
                      placeholder="Wpisz hasÅ‚o"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <Button type="submit" variant="dark" disabled={busy}>
                    Zaloguj siÄ™
                  </Button>
                </form>

                <div className="mt-4 text-xs text-gray-600 text-center">
                  Nie masz konta?{" "}
                  <button
                    type="button"
                    onClick={() => { setStep("register"); setError(""); }}
                    className="font-semibold text-gray-900 underline underline-offset-2"
                  >
                    Zarejestruj siÄ™
                  </button>
                </div>
              </>
            )}

            {step === "register" && (
              <>
                <Title
                  eyebrow="Rejestracja"
                  title="ZaÅ‚Ã³Å¼ konto w eatmi"
                  subtitle="Rejestracja bez kodÃ³w â€” po utworzeniu konta zalogujemy CiÄ™ automatycznie."
                />
                <form onSubmit={submitRegister} className="space-y-3">
                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">Adres e-mail</label>
                    <input type="email" required value={regForm.email}
                      onChange={(e) => setRegForm(s => ({...s, email: e.target.value}))}
                      placeholder="np. jan.kowalski@example.com"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">ImiÄ™ i nazwisko</label>
                    <input type="text" required value={regForm.fullName}
                      onChange={(e) => setRegForm(s => ({...s, fullName: e.target.value}))}
                      placeholder="np. Jan Kowalski"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">HasÅ‚o (min. 8 znakÃ³w)</label>
                    <input type="password" required value={regForm.password}
                      onChange={(e) => setRegForm(s => ({...s, password: e.target.value}))}
                      placeholder="Ustaw hasÅ‚o"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <div>
                    <label className="text-xs uppercase tracking-wider text-gray-500">PowtÃ³rz hasÅ‚o</label>
                    <input type="password" required value={regForm.confirm}
                      onChange={(e) => setRegForm(s => ({...s, confirm: e.target.value}))}
                      placeholder="PowtÃ³rz hasÅ‚o"
                      className="input-focus mt-1 w-full border border-gray-200 rounded-xl px-4 py-3 bg-white min-h-[44px]"/>
                  </div>

                  <Button type="submit" variant="dark" disabled={busy}>
                    ZaÅ‚Ã³Å¼ konto
                  </Button>
                </form>

                <div className="mt-4 text-xs text-gray-600 text-center">
                  Masz konto?{" "}
                  <button
                    type="button"
                    onClick={() => { setStep("login"); setError(""); }}
                    className="font-semibold text-gray-900 underline underline-offset-2"
                  >
                    Zaloguj siÄ™
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    };

    /* =======================
       HOME (bez formularza kontaktowego)
       ======================= */

    const Home = () => {
      // Sprawdzamy, czy jest weekend, aby wyÅ›wietliÄ‡ komunikat
      const now = new Date();
      const plString = now.toLocaleString("en-US", {timeZone: "Europe/Warsaw"});
      const dateObj = new Date(plString);
      const day = dateObj.getDay(); // 0=Sun, 6=Sat
      const isWeekend = day === 0 || day === 6;

      return (
        <>
          {/* Komunikat o weekendzie */}
          {isWeekend && (
            <div className="bg-red-600 text-white text-center py-2 px-4 text-sm font-bold shadow-md relative z-10">
              ZamÃ³wienia przyjmujemy od poniedziaÅ‚ku do piÄ…tku
            </div>
          )}

          <Hero />

          <section id="kategorie" className="py-12 md:py-20 bg-gradient-to-b from-white to-brand-light">
            <div className="max-w-6xl mx-auto px-4">
              <SectionTitle eyebrow="Menu" title="Wybierz z Menu" subtitle="Najpierw wybierz kategoriÄ™, potem dodawaj pozycje do koszyka â€” w kilka klikniÄ™Ä‡!" />
              <div className="mt-8 grid gap-5 md:grid-cols-3 md:gap-6">
                {PRODUCT_CATEGORIES.map(cat => <CategoryCard key={cat.id} category={cat} />)}
              </div>
            </div>
          </section>
        </>
      );
    };

    /* =======================
       Router (hash) â€” FIX (route split '?')
       ======================= */

    const Router = () => {
      const [route, setRoute] = useState(window.location.hash || '#/');

      useEffect(()=>{
        const onHash = () => setRoute(window.location.hash || '#/');
        window.addEventListener('hashchange', onHash);
        return ()=> window.removeEventListener('hashchange', onHash);
      },[]);

      useEffect(()=> { window.lucide?.createIcons?.(); }, [route]);

      const pathOnly = (route || '#/').split('?')[0];

      if (pathOnly.startsWith('#/kategoria/')) {
        const id = pathOnly.split('/')[2];
        return <CategoryPage categoryId={id} />;
      }
      if(pathOnly === '#/koszyk') return <Koszyk />;
      if(pathOnly === '#/zamowienie') return <Zamowienie />;
      return <Home />;
    };

    /* =======================
       Mobile components
       ======================= */

    const CategorySheet = ({ open, onClose }) => {
      useEffect(() => {
        if (open) lockBodyScroll(true);
        return () => lockBodyScroll(false);
      }, [open]);

      useEffect(() => {
        const onKey = (e) => {
          if (!open) return;
          if (e.key === "Escape") onClose?.();
        };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [open]);

      if (!open) return null;

      const go = (id) => {
        window.location.hash = `#/kategoria/${id}`;
        onClose?.();
      };

      return (
        <div className="fixed inset-0 z-[100]">
          <div className="absolute inset-0 bg-black/50" onClick={onClose} aria-hidden="true"></div>

          <div className="absolute inset-x-0 bottom-0">
            <div
              className="mx-auto w-full max-w-2xl bg-white rounded-t-3xl border border-gray-200 shadow-glass p-4"
              style={{ paddingBottom: "calc(var(--safe-b) + 12px)" }}
              role="dialog"
              aria-modal="true"
              onClick={(e)=>e.stopPropagation()}
            >
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-xs uppercase tracking-[0.16em] text-gray-500 font-semibold">ZamÃ³w</div>
                  <div className="text-xl font-extrabold mt-0.5">Wybierz kategoriÄ™</div>
                </div>
                <button
                  type="button"
                  onClick={onClose}
                  className="w-11 h-11 rounded-2xl border border-gray-200 bg-white shadow-soft grid place-items-center hover:ring-2 hover:ring-brand-yellow/40"
                  aria-label="Zamknij"
                >
                  <i data-lucide="x" className="w-5 h-5"></i>
                </button>
              </div>

              <div className="mt-4 grid gap-3">
                {PRODUCT_CATEGORIES.map((c) => (
                  <button
                    key={c.id}
                    type="button"
                    onClick={() => go(c.id)}
                    className="w-full flex items-center justify-between gap-3 rounded-2xl border border-gray-200 bg-white px-4 py-4 shadow-soft hover:ring-2 hover:ring-brand-yellow/40"
                  >
                    <div className="flex items-center gap-3 text-left min-w-0">
                      <div className="w-11 h-11 rounded-2xl overflow-hidden border border-gray-200 shrink-0">
                        <img src={c.image} alt={c.name} className="w-full h-full object-cover" loading="lazy" />
                      </div>

                      <div className="min-w-0">
                        <div className="font-extrabold">{c.name}</div>
                        <div className="text-xs text-gray-600 mt-0.5 line-clamp-2">{c.description}</div>
                      </div>
                    </div>
                    <i data-lucide="chevron-right" className="w-5 h-5 text-gray-400"></i>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const TabButton = ({ active, label, icon, onClick, badge }) => (
      <button
        type="button"
        onClick={onClick}
        className={`flex flex-col items-center justify-center gap-1 py-2 px-3 rounded-2xl transition min-h-[52px] ${
          active ? "bg-brand-yellow/20 ring-1 ring-brand-yellow/30" : "hover:bg-gray-100"
        }`}
        aria-label={label}
      >
        <span className="relative">
          <i data-lucide={icon} className="w-6 h-6"></i>
          {typeof badge === "number" && badge > 0 && (
            <span className="absolute -top-2 -right-2 bg-brand-yellow text-gray-900 text-[10px] font-extrabold w-5 h-5 rounded-full grid place-items-center ring-2 ring-white">
              {badge > 99 ? "99+" : badge}
            </span>
          )}
        </span>
        <span className={`text-[11px] font-extrabold ${active ? "text-gray-900" : "text-gray-600"}`}>
          {label}
        </span>
      </button>
    );

    const BottomTabBar = ({ route, onOpenOrder, onOpenAuth }) => {
      const { count } = useCart();
      const { user } = useAuth();

      useEffect(() => { window.lucide?.createIcons?.(); }, [route, count, user]);

      const isHome = !route || route === "#/" || route === "#";
      const isCart = route === "#/koszyk";
      const isOrder = route?.startsWith("#/kategoria/") || route?.startsWith("#/zamowienie");

      return (
        <div className="fixed inset-x-0 bottom-0 z-[70]">
          <div
            className="mx-auto w-full max-w-2xl px-3"
            style={{ paddingBottom: "calc(var(--safe-b) + 10px)" }}
          >
            <div className="liquid border border-white/60 shadow-glass rounded-3xl px-2 py-2">
              <div className="grid grid-cols-4 gap-2">
                <TabButton
                  active={isHome}
                  label="Start"
                  icon="home"
                  onClick={() => { window.location.hash = "#/"; }}
                />
                <TabButton
                  active={isOrder}
                  label="ZamÃ³w"
                  icon="shopping-bag"
                  onClick={onOpenOrder}
                />
                <TabButton
                  active={isCart}
                  label="Koszyk"
                  icon="shopping-cart"
                  badge={count}
                  onClick={() => { window.location.hash = "#/koszyk"; }}
                />
                <TabButton
                  active={false}
                  label={user ? "Profil" : "Konto"}
                  icon="user"
                  onClick={onOpenAuth}
                />
              </div>
            </div>
          </div>
        </div>
      );
    };

    const FloatingCheckoutCTA = ({ visible }) => {
      const { total, count } = useCart();
      useEffect(() => { window.lucide?.createIcons?.(); }, [visible, total, count]);
      if (!visible) return null;

      return (
        <div
          className="fixed inset-x-0 z-[75] md:hidden"
          style={{ bottom: "calc(var(--tabbar-h) + var(--safe-b) + 10px)" }}
        >
          <div className="mx-auto w-full max-w-2xl px-3">
            <button
              type="button"
              onClick={() => { window.location.hash = "#/koszyk"; }}
              className="w-full bg-gray-900 text-white font-extrabold rounded-2xl px-4 py-4 shadow-glass hover:ring-2 hover:ring-brand-yellow/40 flex items-center justify-between gap-3 min-h-[56px]"
            >
              <span className="flex items-center gap-2">
                <i data-lucide="receipt" className="w-5 h-5"></i>
                Zobacz swoje zamÃ³wienie
              </span>
              <span className="text-sm font-extrabold">
                {count} â€¢ {currency(total)}
              </span>
            </button>
          </div>
        </div>
      );
    };

    /* =======================
       APP
       ======================= */

    const App = () => {
      const [authOpen, setAuthOpen] = useState(false);
      const [authInitialStep, setAuthInitialStep] = useState("login");
      const [orderOpen, setOrderOpen] = useState(false);

      const [route, setRoute] = useState(window.location.hash || "#/");
      const isMobile = useIsMobile(768);

      useEffect(() => {
        const onHash = () => setRoute(window.location.hash || "#/");
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);

      const { count } = useCart();
      const { user, loading } = useAuth();
      const { activeOrder } = useActiveOrder();

      // âœ… AUTOMATYCZNA REJESTRACJA PUSH TYLKO W TRYBIE PWA
      // Zmiana: nasÅ‚uchiwanie na pierwsze klikniÄ™cie, aby ominÄ…Ä‡ blokadÄ™ przeglÄ…darki
      useEffect(() => {
        const initPushInPWA = async () => {
          // 1. SprawdÅº, czy jesteÅ›my w trybie STANDALONE (PWA)
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
           
          if (!isStandalone) {
              console.log("Not in PWA/Standalone mode - skipping push auto-subscribe.");
              return; 
          }

          // 2. JeÅ›li juÅ¼ mamy zgodÄ™ lub odmowÄ™, nie robimy nic
          if (Notification.permission !== 'default') return;

          // 3. JeÅ›li 'default', musimy czekaÄ‡ na klikniÄ™cie
          if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;

          const handleFirstUserInteraction = async () => {
              try {
                  const permission = await Notification.requestPermission();
                  if (permission === 'granted') {
                      const reg = await navigator.serviceWorker.ready;
                       
                      // Get Key
                      const response = await fetch('/api/push/vapid-public-key');
                      if(!response.ok) return;
                      const data = await response.json();
                      const vapidKey = data.publicKey;

                      if(!vapidKey) return;

                      // Subscribe
                      const subscription = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapidKey)
                      });

                      // Send to backend
                      await fetch('/api/push/subscribe', {
                        method: 'POST',
                        body: JSON.stringify(subscription),
                        headers: { 'Content-Type': 'application/json' }
                      });
                       
                      console.log("PWA subscribed on click!");
                  }
              } catch (e) {
                  console.error("PWA Auto-Subscribe Error:", e);
              } finally {
                  // Usuwamy listener po pierwszym klikniÄ™ciu (niezaleÅ¼nie od wyniku)
                  window.removeEventListener('click', handleFirstUserInteraction);
                  window.removeEventListener('touchstart', handleFirstUserInteraction);
              }
          };

          // Dodajemy nasÅ‚uch na caÅ‚e okno
          window.addEventListener('click', handleFirstUserInteraction);
          window.addEventListener('touchstart', handleFirstUserInteraction); // Dla dotyku mobilnego
        };

        initPushInPWA();
      }, []);

      useEffect(() => { window.lucide?.createIcons?.(); }, [authOpen, orderOpen, route, count, user, loading, activeOrder]);

      // âœ… Rejestracja SW tylko jako "instalacja", bez subskrypcji
      useEffect(() => { 
        if ("serviceWorker" in navigator) {
           navigator.serviceWorker.register("/sw.js", { scope: "/" })
            .then(reg => {
                console.log("SW Registered");
                // Listen for updates
                reg.addEventListener("updatefound", () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener("statechange", () => {
                        if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                            console.log("New SW version available");
                        }
                    });
                });
            })
            .catch(e => console.log("SW Fail", e));
        }
      }, []);

      const showCTA =
        isMobile &&
        count > 0 &&
        route !== "#/koszyk" &&
        !route.startsWith("#/zamowienie");

      return (
        <div className="min-h-screen no-overscroll">
          <Header onOpenAuth={() => { setAuthInitialStep("login"); setAuthOpen(true); }} />

          <main className={`app-content-pad ${showCTA ? "has-cta" : ""} ${activeOrder ? "has-tracker" : ""}`}>
            <Router />

            {/*âœ… FOOTER Z DANYMI PRZEDSIÄ˜BIORCY */}
            <footer className="py-12 text-sm text-gray-600 border-t border-gray-200">
              <div className="max-w-6xl mx-auto px-4">
                <div className="text-center">
                  <div className="font-extrabold text-gray-900 mb-2">
                    Dane przedsiÄ™biorcy
                  </div>

                  <ul className="space-y-1">
                    <li><span className="font-semibold">ImiÄ™:</span> Marcin</li>
                    <li><span className="font-semibold">Nazwisko:</span> Chojnacki</li>
                    <li><span className="font-semibold">NIP:</span> 8271982077</li>
                    <li><span className="font-semibold">REGON:</span> 100473965</li>
                    <li>
                      <span className="font-semibold">Firma przedsiÄ™biorcy:</span>{" "}
                      MARCIN CHOJNACKI MILKSHAKE BAR
                    </li>
                  </ul>
       
                  <div className="mt-4">
                    <div className="font-semibold text-gray-700">
                      Adres prowadzenia dziaÅ‚alnoÅ›ci:
                    </div>
                    <div className="text-gray-600">
                      ul. SzczeciÅ„ska 17, 76-200 SÅ‚upsk, pow. SÅ‚upsk, gm. SÅ‚upsk,
                      woj. POMORSKIE, Polska
                    </div>
                  </div>
           
                  <div className="mt-6 font-semibold text-gray-700">
                    Â© {new Date().getFullYear()} eatmi.pl â€¢ Wszystkie prawa zastrzeÅ¼one
                  </div>
           
                  <div className="mt-4 flex flex-wrap items-center justify-center gap-3 text-sm">
                    <a
                      href="/rule.html"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="font-semibold text-gray-700 hover:text-gray-900 underline underline-offset-4"
                    >
                      Regulamin
                    </a>
                    <span className="text-gray-300">â€¢</span>
                    <a
                      href="/rule.html"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="font-semibold text-gray-700 hover:text-gray-900 underline underline-offset-4"
                    >
                      Polityka prywatnoÅ›ci
                    </a>
                  </div>
                </div>
              </div>
            </footer>
          </main>

          <AuthModal
            open={authOpen}
            onClose={() => setAuthOpen(false)}
            initialStep={authInitialStep}
          />

          <CategorySheet open={orderOpen} onClose={() => setOrderOpen(false)} />

          <FloatingCheckoutCTA visible={showCTA} />
            
          <OrderTrackerWidget />

          <BottomTabBar
            route={route}
            onOpenOrder={() => setOrderOpen(true)}
            onOpenAuth={() => { setAuthInitialStep("login"); setAuthOpen(true); }}
          />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ToastProvider>
        <AuthProvider>
          <ActiveOrderProvider>
            <MenuProvider>
                <CartProvider>
                  <App />
                </CartProvider>
            </MenuProvider>
          </ActiveOrderProvider>
        </AuthProvider>
      </ToastProvider>
    );
  </script>
</body>
</html>
