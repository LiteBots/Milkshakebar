<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <!-- ✅ Anti-zoom + fullscreen PWA safe-area -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>MilkShake Bar — Panel Administratora</title>

  <!-- ✅ PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#FF6A00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary:#FF6A00;
      --secondary:#FF9100;
      --accent:#FFE0B2;

      --bg:#FFF6EC;
      --bg2:#ffffff;
      --text:#2B1300;
      --muted: rgba(43,19,0,0.65);

      --card: rgba(255,255,255,0.82);
      --card2: rgba(255,255,255,0.92);
      --border: rgba(43,19,0,0.12);

      --shadow: 0px 10px 30px rgba(0,0,0,0.12);
      --shadow2: 0px 18px 50px rgba(0,0,0,0.14);
      --radius: 20px;

      --good:#16A34A;
      --bad:#DC2626;

      --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
      --glass: rgba(255,255,255,0.70);
      --glass2: rgba(255,255,255,0.86);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Poppins,system-ui,Segoe UI,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(255,106,0,0.20), transparent 60%),
        radial-gradient(900px 500px at 90% 25%, rgba(255,145,0,0.16), transparent 60%),
        radial-gradient(800px 500px at 50% 90%, rgba(43,19,0,0.06), transparent 60%),
        var(--bg);
      overflow:hidden;
      overscroll-behavior: none;
    }

    /* ✅ Fullscreen responsive height */
    .app{
      height: 100dvh;
      display:grid;
      grid-template-columns: 290px 1fr;
    }

    /* ✅ Lockscreen freeze (no pinch/zoom/scroll/select) */
    body.locked{
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    /* allow “tap” behavior for buttons (no double-tap zoom intent) */
    #lock, #lock *{ touch-action: manipulation; }

    /* Sidebar */
    .sidebar{
      height:100%;
      padding:22px;
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.66));
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex;align-items:center;gap:14px;
      padding:14px 14px;border-radius:18px;
      background: var(--glass2);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .brand img{
      width:44px;height:44px;border-radius:999px;object-fit:cover;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    .brand .t1{font-weight:900;letter-spacing:.2px}
    .brand .t2{font-size:.86rem;color:var(--muted)}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:10px;}
    .navbtn{
      width:100%;
      display:flex;align-items:center;gap:12px;
      padding:12px 14px;border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.70);
      color:var(--text);cursor:pointer;transition:.18s ease;text-align:left;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .navbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.86)}
    .navbtn.active{
      background: linear-gradient(135deg, rgba(255,106,0,0.18), rgba(255,145,0,0.12));
      border-color: rgba(255,145,0,0.35);
      box-shadow: 0 18px 40px rgba(255,106,0,0.12);
    }
    .navbtn i{width:18px;opacity:.95}
    .navsep{
      margin:12px 0 6px;
      font-size:.82rem;color: rgba(43,19,0,0.55);
      padding:0 6px;letter-spacing:.4px;text-transform:uppercase;
    }
    .sidefoot{
      margin-top:14px;
      padding:12px 14px;border-radius:16px;
      background: rgba(255,255,255,0.70);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:.9rem;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,0.72);
      border:1px solid var(--border);
      font-size:.82rem;color:rgba(43,19,0,0.92);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--bad);
      box-shadow: 0 0 0 3px rgba(220,38,38,0.18);
    }
    .dot.ok{background:var(--good); box-shadow: 0 0 0 3px rgba(22,163,74,0.18);}

    /* Main */
    .main{
      height:100%;
      overflow:auto;
      padding: calc(22px + env(safe-area-inset-top)) 22px calc(22px + env(safe-area-inset-bottom));
    }
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:14px;margin-bottom:18px;
    }
    .topbar h1{
      font-size:1.9rem;line-height:1.15;font-weight:900;
      margin-bottom:6px;letter-spacing:.2px;
      background: var(--gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .topbar p{color:var(--muted);max-width:720px}
    .actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }

    .btn{
      border:none;cursor:pointer;font-weight:800;
      padding:12px 14px;border-radius:999px;
      color:var(--text);
      background: rgba(255,255,255,0.80);
      border:1px solid var(--border);
      transition:.18s ease;
      display:inline-flex;gap:10px;align-items:center;white-space:nowrap;
      box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.92)}
    .btn.primary{
      color:#fff;
      background: var(--gradient);
      border-color: rgba(255,145,0,0.45);
      box-shadow: 0 14px 35px rgba(255,106,0,0.22);
    }
    .btn.danger{
      color:#fff;
      background: rgba(220,38,38,0.90);
      border-color: rgba(220,38,38,0.35);
      box-shadow: 0 14px 35px rgba(220,38,38,0.16);
    }

    /* Cards / grid */
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:14px;}
    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .card h2{font-size:1.1rem;margin-bottom:10px;font-weight:900;letter-spacing:.2px;}
    .kpis{display:grid;grid-template-columns: repeat(4, 1fr);gap:14px;margin-top:10px;}
    .kpi{
      background: rgba(255,255,255,0.78);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      display:flex;gap:12px;align-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,0.06);
    }
    .kpi i{font-size:1.05rem;opacity:.95;color: rgba(255,106,0,0.95)}
    .kpi .num{font-weight:900;font-size:1.35rem}
    .kpi .lbl{font-size:.86rem;color:var(--muted)}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 10px;}
    th{
      text-align:left;font-size:.82rem;color:rgba(43,19,0,0.55);
      font-weight:900;padding:0 10px 6px;letter-spacing:.35px;text-transform:uppercase;
    }
    td{
      padding:12px 10px;background: rgba(255,255,255,0.86);
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      color: var(--text);
      vertical-align:top;
    }
    tr td:first-child{
      border-left:1px solid var(--border);
      border-top-left-radius:16px;border-bottom-left-radius:16px;
    }
    tr td:last-child{
      border-right:1px solid var(--border);
      border-top-right-radius:16px;border-bottom-right-radius:16px;
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      font-weight:900;font-size:.84rem;white-space:nowrap;
      box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    }
    .tag i{color: rgba(255,106,0,0.95)}
    .tag small{font-weight:700;color:rgba(43,19,0,0.55)}
    .row-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    .iconbtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.86);
      color:var(--text);cursor:pointer;
      display:grid;place-items:center;transition:.15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }
    .iconbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.95)}
    .iconbtn.danger{background: rgba(220,38,38,0.12);border-color: rgba(220,38,38,0.28);color:#8a0d0d}
    .iconbtn.ok{background: rgba(22,163,74,0.12);border-color: rgba(22,163,74,0.28);color:#0f5f2a}

    /* Inputs */
    .field{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
    .field label{font-weight:900;font-size:.9rem}
    .input, .textarea{
      width:100%;
      padding:12px 14px;border-radius:16px;
      border:2px solid rgba(43,19,0,0.10);
      background: rgba(255,255,255,0.90);
      color:var(--text);outline:none;font-family:Poppins;
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease;
    }
    .input:focus, .textarea:focus{
      border-color: rgba(255,106,0,0.55);
      box-shadow: 0 10px 26px rgba(255,106,0,0.12);
    }
    .textarea{min-height:130px;resize:vertical}
    .hint{margin-top:8px;color:var(--muted);font-size:.92rem}

    /* Modals */
    .modal, .lock{
      position:fixed; inset:0;
      display:none;align-items:center;justify-content:center;
      z-index:9999;
      background: rgba(0,0,0,0.42);
      backdrop-filter: blur(10px);
      padding:22px;
    }
    .modal.show, .lock.show{display:flex}
    .modalbox{
      width:min(920px, 100%);
      border-radius:28px;
      border:1px solid rgba(255,255,255,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow: var(--shadow2);
      padding:18px;
      color: var(--text);
    }
    .modalhead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .modalhead h3{font-size:1.2rem;font-weight:900}
    .modalgrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    .modalgrid .field{margin-top:0}
    .modalfoot{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

    /* LOCKSCREEN */
    .lockbox{
      width:min(520px, 100%);
      border-radius:30px;
      border:1px solid rgba(255,255,255,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow: var(--shadow2);
      padding:18px;
      color: var(--text);
    }
    .locktop{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:12px;}
    .locktop .title{display:flex;flex-direction:column;gap:2px}
    .locktop .title b{font-weight:900;font-size:1.1rem}
    .locktop .title span{color:var(--muted);font-size:.92rem}

    .pin{display:flex;gap:10px;justify-content:center;margin:14px 0 10px;}
    .pin .dotpin{
      width:14px;height:14px;border-radius:99px;
      background: rgba(43,19,0,0.10);
      border:1px solid rgba(43,19,0,0.12);
      box-shadow: inset 0 6px 12px rgba(0,0,0,0.10);
    }
    .pin .dotpin.filled{
      background: var(--gradient);
      border-color: rgba(255,145,0,0.55);
      box-shadow: 0 10px 25px rgba(255,106,0,0.18);
    }
    .keypad{display:grid;grid-template-columns: repeat(3, 1fr);gap:12px;margin-top:12px;}
    .key{
      height:56px;border-radius:18px;
      border:1px solid rgba(43,19,0,0.12);
      background: rgba(255,255,255,0.86);
      color:var(--text);font-weight:900;font-size:1.15rem;
      cursor:pointer;transition:.15s ease;display:grid;place-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,0.06);
    }
    .key:hover{transform: translateY(-1px); background: rgba(255,255,255,0.95)}
    .key.small{font-size:1rem}
    .key.danger{
      background: rgba(220,38,38,0.10);
      border-color: rgba(220,38,38,0.22);
      color:#8a0d0d;
    }
    .key.ok{
      background: rgba(22,163,74,0.10);
      border-color: rgba(22,163,74,0.22);
      color:#0f5f2a;
    }
    .lockmsg{text-align:center;color:rgba(43,19,0,0.75);font-size:.92rem;min-height:22px;margin-top:10px;}

    /* FULLSCREEN ALERT */
    .alarm{
      position:fixed; inset:0;
      z-index:10000;
      display:none;align-items:center;justify-content:center;
      padding:0; /* ✅ full */
      background: rgba(0,0,0,0.50);
      backdrop-filter: blur(6px);
    }
    .alarm.show{display:flex}
    .alarm.flash::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(700px 500px at 50% 30%, rgba(255,106,0,0.42), transparent 65%);
      animation: flash 0.55s infinite alternate;
      opacity:0.95;
    }
    @keyframes flash{from{opacity:.20}to{opacity:.85}}

    /* ✅ ALARM CONTENT = FULLSCREEN */
    .alarmbox{
      position:relative;
      width:100%;
      height:100%;
      border-radius:0;
      border:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow:none;
      padding:22px;
      text-align:center;
      color: var(--text);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
    }
    .alarmbox h3{font-size:1.6rem;font-weight:900;margin:8px 0 6px;}
    .alarmbox p{color:var(--muted)}
    .alarmbox .preview{
      max-width: 900px;
      margin: 12px auto 0;
      width: 100%;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      text-align:left;
      font-size:.95rem;
      line-height:1.6;
    }
    .alarmbox .preview .line{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(255,255,255,0.92);
      border:1px solid var(--border);
      margin-bottom:8px;
    }
    .alarmbox .preview .line i{width:18px;color:rgba(255,106,0,0.95)}
    .alarmbox .preview .muted{color:rgba(43,19,0,0.62)}
    .alarmbox .preview b{color:var(--text)}
    .alarmbox .okwrap{margin-top:14px;display:flex;justify-content:center}

    /* ✅ Rezerwacja: migawka tła co 0.1s (100ms) biały ↔ pomarańcz */
    .alarm.reservation .alarmbox{
      animation: resFlashBg 0.2s steps(1, end) infinite;
    }
    @keyframes resFlashBg{
      0%   { background: rgba(255,255,255,0.96); }
      50%  { background: rgba(255,145,0,0.35); }
      100% { background: rgba(255,255,255,0.96); }
    }

    /* Toast */
    #toast{
      position:fixed;bottom:18px;right:18px;z-index:12000;
      display:none;align-items:center;gap:10px;
      padding:12px 14px;border-radius:999px;
      background: rgba(22,163,74,0.14);
      border:1px solid rgba(22,163,74,0.25);
      color: var(--text);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 45px rgba(0,0,0,0.18);
      font-weight:900;
    }
    #toast i{color: var(--good)}

    /* Responsive base */
    @media (max-width: 1180px){
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 920px){
      body{overflow:auto}
      .app{grid-template-columns: 1fr}
      .sidebar{position:sticky;top:0;z-index:50}
      .main{height:auto; overflow:visible}
      .modalgrid{grid-template-columns: 1fr}
    }

    /* ============ MOBILE/TABLET UX (drawer sidebar) ============ */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      z-index:80;
      display:none;
    }
    .overlay.show{display:block}

    @media (max-width: 920px){
      body{overflow:auto}
      .app{grid-template-columns:1fr}

      /* Sidebar as drawer */
      .sidebar{
        position:fixed;
        top:0; left:0; bottom:0;
        width:min(86vw, 340px);
        transform: translateX(-110%);
        transition: transform .22s ease;
        z-index:90;
        border-right:1px solid var(--border);
        box-shadow: 0 30px 90px rgba(0,0,0,0.35);
      }
      .sidebar.open{transform: translateX(0)}

      /* Main full width */
      .main{
        padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
        height:auto;
        overflow:visible;
      }

      /* Topbar: sticky + stacked */
      .topbar{
        position:sticky;
        top:0;
        z-index:40;
        padding:12px;
        margin:-14px -14px 14px;
        border-radius:18px;
        background: rgba(255,255,255,0.86);
        border:1px solid var(--border);
        backdrop-filter: blur(12px);
        flex-direction:column;
        align-items:stretch;
        box-shadow: var(--shadow);
      }
      .actions{
        justify-content:space-between;
        gap:10px;
      }

      /* Show menu button on mobile */
      #menuBtn{display:inline-flex !important}

      /* ✅ KPI: małe prostokąty (2 kolumny), nie długie paski */
      .kpis{grid-template-columns: repeat(2, 1fr)}
      .kpi{
        padding:10px;
        border-radius:16px;
        min-height:78px;
        align-items:center;
      }
      .kpi .num{font-size:1.1rem}
      .kpi .lbl{font-size:.8rem}

      /* Tables: safe horizontal scroll */
      table{min-width: 760px}
      .card{padding:14px}
    }
  </style>
</head>

<body>

  <!-- LOCKSCREEN -->
  <div class="lock show" id="lock">
    <div class="lockbox">
      <div class="locktop">
        <div class="title">
          <b>MilkShake Bar — Panel</b>
          <span>Wpisz PIN na klawiaturze ekranowej</span>
        </div>
        <span class="pill"><i class="fa-solid fa-lock"></i> PIN</span>
      </div>

      <div class="pin" aria-label="PIN">
        <div class="dotpin" id="p1"></div>
        <div class="dotpin" id="p2"></div>
        <div class="dotpin" id="p3"></div>
        <div class="dotpin" id="p4"></div>
      </div>

      <div class="keypad" id="keypad">
        <button class="key" data-k="1">1</button>
        <button class="key" data-k="2">2</button>
        <button class="key" data-k="3">3</button>
        <button class="key" data-k="4">4</button>
        <button class="key" data-k="5">5</button>
        <button class="key" data-k="6">6</button>
        <button class="key" data-k="7">7</button>
        <button class="key" data-k="8">8</button>
        <button class="key" data-k="9">9</button>
        <button class="key danger small" data-act="back"><i class="fa-solid fa-delete-left"></i></button>
        <button class="key" data-k="0">0</button>
        <button class="key ok small" data-act="ok"><i class="fa-solid fa-check"></i></button>
      </div>

      <div class="lockmsg" id="lockMsg"></div>
    </div>
  </div>

  <!-- FULLSCREEN ALARM -->
  <div class="alarm" id="alarm">
    <div class="alarmbox">
      <div class="pill" style="margin:0 auto 8px; width:max-content;" id="alarmPill">
        <i class="fa-solid fa-bell"></i> Alert
      </div>
      <h3 id="alarmTitle">Alert</h3>
      <p id="alarmDesc">Panel będzie migał i piszczał, dopóki nie klikniesz <b>OK</b>.</p>

      <div class="preview" id="alarmPreview"></div>

      <div class="okwrap">
        <button class="btn primary" id="alarmOk"><i class="fa-solid fa-check"></i> OK</button>
      </div>
    </div>
  </div>

  <div class="app" id="app" style="display:none">
    <!-- OVERLAY (mobile drawer) -->
    <div class="overlay" id="overlay"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="https://i.imgur.com/Twr2Rms.jpeg" alt="Logo">
        <div>
          <div class="t1">MilkShake Bar</div>
          <div class="t2">Panel Administratora</div>
        </div>
      </div>

      <div class="nav">
        <div class="navsep">Główne</div>
        <button class="navbtn active" data-tab="reservations"><i class="fa-solid fa-calendar-check"></i> Rezerwacje</button>
        <button class="navbtn" data-tab="happy"><i class="fa-solid fa-bullhorn"></i> Pasek info</button>

        <div class="navsep">Zarządzanie</div>
        <button class="navbtn" data-tab="users"><i class="fa-solid fa-users"></i> Użytkownicy</button>
        <button class="navbtn" data-tab="employees"><i class="fa-solid fa-user-tie"></i> Pracownicy</button>

        <div class="navsep">Milki Aplikacja</div>
        <button class="navbtn" data-tab="pickup"><i class="fa-solid fa-bag-shopping"></i> Zamówienie z odbiorem</button>
        <button class="navbtn" data-tab="points"><i class="fa-solid fa-star"></i> Punkty Milk</button>
        <button class="navbtn" data-tab="codes"><i class="fa-solid fa-ticket"></i> Wykorzystaj kod</button>
        <button class="navbtn" data-tab="rewards"><i class="fa-solid fa-gift"></i> Nagrody</button>

        <div class="sidefoot">
          <span class="pill"><span class="dot" id="apiDot"></span> API</span>
          <span class="pill" id="clock"><i class="fa-regular fa-clock"></i> —</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div>
          <h1 id="title">Rezerwacje</h1>
          <p id="subtitle"></p>
        </div>

        <div class="actions">
          <button class="btn" id="menuBtn" style="display:none"><i class="fa-solid fa-bars"></i> Menu</button>
          <button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Odśwież</button>
          <button class="btn danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
        </div>
      </div>

      <!-- KPIs -->
      <section class="card" id="kpiCard">
        <h2>Statystyki</h2>
        <div class="kpis">
          <div class="kpi"><i class="fa-solid fa-users"></i><div><div class="num" id="kUsers">—</div><div class="lbl">Użytkownicy</div></div></div>
          <div class="kpi"><i class="fa-solid fa-calendar-check"></i><div><div class="num" id="kReservations">—</div><div class="lbl">Rezerwacje</div></div></div>
          <div class="kpi"><i class="fa-solid fa-user-tie"></i><div><div class="num" id="kEmployees">—</div><div class="lbl">Pracownicy</div></div></div>
          <div class="kpi"><i class="fa-solid fa-coins"></i><div><div class="num" id="kMilkos">—</div><div class="lbl">Milkosy łącznie</div></div></div>
        </div>

        <div class="kpis" style="margin-top:14px">
          <div class="kpi"><i class="fa-solid fa-user-check"></i><div><div class="num" id="kUsersWithPoints">—</div><div class="lbl">Użytkownicy z punktami</div></div></div>
          <div class="kpi"><i class="fa-solid fa-bag-shopping"></i><div><div class="num" id="kOrders">—</div><div class="lbl">Zamówienia</div></div></div>
          <div class="kpi"><i class="fa-solid fa-utensils"></i><div><div class="num" id="kProducts">—</div><div class="lbl">Produkty</div></div></div>
          <div class="kpi"><i class="fa-solid fa-bolt"></i><div><div class="num" id="kAppOps">Problem z Panelem?</div><div class="lbl">Zadzwoń 735 396 534</div></div></div>
        </div>

        <p class="hint">„Zamówienie z odbiorem” jest teraz pobierane z backendu (/api/orders) + realtime alarm (Socket.IO).</p>
      </section>

      <!-- TAB: RESERVATIONS -->
      <section class="card" id="tab-reservations">
        <h2>Rezerwacje</h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data / Godzina</th>
                <th>Klient</th>
                <th>Ilość</th>
                <th>Strefa</th>
                <th>Źródło</th>
                <th style="text-align:right">Akcje</th>
              </tr>
            </thead>
            <tbody id="resTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- TAB: HAPPY -->
      <section class="card" id="tab-happy" style="display:none">
        <h2>Pasek info</h2>

        <div class="field">
          <label>Tekst paska</label>
          <textarea class="textarea" id="happyText" placeholder="np. Happy Hour 12:00–16:00 • -20% na shake'i"></textarea>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn" id="happyLoad"><i class="fa-solid fa-download"></i> Wczytaj</button>
          <button class="btn primary" id="happySave"><i class="fa-solid fa-floppy-disk"></i> Zapisz</button>
        </div>
      </section>

      <!-- TAB: USERS (✅ from Mongo: users + milkpoints) -->
      <section class="card" id="tab-users" style="display:none">
        <h2>Użytkownicy (users + milkpoints)</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Filtr (email / Milk ID)</label>
            <input class="input" id="uFilter" placeholder="np. 123456 lub mail@...">
          </div>
          <div class="field" style="display:flex;justify-content:flex-end;align-items:flex-end">
            <button class="btn primary" id="uLoad"><i class="fa-solid fa-rotate"></i> Wczytaj listę</button>
          </div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Milk ID</th>
                <th>Adres e-mail</th>
                <th>Milkosy</th>
                <th style="text-align:right">Akcje</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>

        <p class="hint">
          Wymagany endpoint: <b>GET /api/admin/users</b> (z joinem users + milkpoints) -> [{milkId,email,points}]
        </p>
      </section>

      <!-- TAB: EMPLOYEES -->
      <section class="card" id="tab-employees" style="display:none">
        <h2>Pracownicy</h2>
        <p style="color:var(--muted)">Widok do rozbudowy.</p>
      </section>

      <!-- TAB: PICKUP (FROM DB: /api/orders) -->
      <section class="card" id="tab-pickup" style="display:none">
        <h2>Zamówienie z odbiorem</h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Klient</th>
                <th>Zamówienie</th>
                <th>Odbiór</th>
              </tr>
            </thead>
            <tbody id="ordersTbody"></tbody>
          </table>
        </div>
        <p class="hint">Pobierane z backendu: <b>/api/orders</b>. Alarm realtime: <b>new-order</b>.</p>
      </section>

      <!-- TAB: POINTS (✅ BACKEND + HISTORY) -->
      <section class="card" id="tab-points" style="display:none">
        <h2>Punkty Milk</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Milk ID (6 cyfr)</label>
            <input class="input" id="pMilkId" placeholder="np. 123456">
          </div>
          <div class="field">
            <label>Kwota wydana (zł)</label>
            <input class="input" id="pAmount" type="number" min="0" step="0.01" placeholder="np. 49.99">
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn" id="pHistoryLoad"><i class="fa-solid fa-clock-rotate-left"></i> Historia (Milk ID)</button>
          <button class="btn primary" id="pAdd"><i class="fa-solid fa-plus"></i> Dodaj punkty</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2 style="margin-bottom:6px">Wynik (z backendu)</h2>
          <p class="hint" style="margin-top:0">Przelicznik: <b>10 zł = 1 pkt</b>. Punkty są zapisywane w MongoDB.</p>
          <div id="pointsPreview" style="margin-top:10px;"></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2 style="margin-bottom:6px">Historia doładowań (użytkownika)</h2>
          <p class="hint" style="margin-top:0">
            Wymagany endpoint: <b>GET /api/admin/milkpoints/history?milkId=123456</b> -> {ok:true, email, milkId, points, history:[{createdAt, amountPln, addedPoints, note}]}
          </p>
          <div style="overflow:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Kwota (zł)</th>
                  <th>Dodano pkt</th>
                  <th>Info</th>
                </tr>
              </thead>
              <tbody id="pointsHistTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TAB: CODES (✅ redeem / use code -> rewards collection in Mongo) -->
      <section class="card" id="tab-codes" style="display:none">
        <h2>Wykorzystaj kod</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Kod</label>
            <input class="input" id="cCode" placeholder="np. MSB-AB12CD lub inny kod">
          </div>
          <div class="field" style="display:flex;justify-content:flex-end;align-items:flex-end">
            <button class="btn primary" id="cUse"><i class="fa-solid fa-circle-check"></i> Zrealizuj kod</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2 style="margin-bottom:6px">Ostatni wynik</h2>
          <div id="codePreview" style="margin-top:10px;">
            <span class="muted" style="color:rgba(43,19,0,0.62)">Brak operacji.</span>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2 style="margin-bottom:6px">Historia zrealizowanych kodów</h2>
          <p class="hint" style="margin-top:0">
            Wymagane endpointy: <b>POST /api/admin/rewards/redeem-code</b> {code} oraz <b>GET /api/admin/rewards/redeemed</b> -> [{code, redeemedAt, email, milkId, rewardName}]
          </p>
          <div style="overflow:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Kod</th>
                  <th>Użytkownik</th>
                  <th>Nagroda</th>
                </tr>
              </thead>
              <tbody id="codesTbody"></tbody>
            </table>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
            <button class="btn" id="cReload"><i class="fa-solid fa-rotate"></i> Odśwież listę</button>
          </div>
        </div>
      </section>

      <!-- TAB: REWARDS (STATIC) -->
      <section class="card" id="tab-rewards" style="display:none">
        <h2>Nagrody</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Nazwa nagrody</label>
            <input class="input" id="rName" placeholder="np. Darmowy shake 500 ml">
          </div>
          <div class="field">
            <label>Koszt (Milkosy)</label>
            <input class="input" id="rCost" type="number" min="0" step="1" placeholder="np. 20">
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn primary" id="rAdd"><i class="fa-solid fa-plus"></i> Dodaj nagrodę</button>
        </div>

        <div style="margin-top:12px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Nagroda</th>
                <th>Koszt</th>
                <th style="text-align:right">Akcje</th>
              </tr>
            </thead>
            <tbody id="rewardsTbody"></tbody>
          </table>
        </div>

        <p class="hint">To jest statyczna baza nagród — backend podłączymy później.</p>
      </section>

    </main>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modalbox">
      <div class="modalhead">
        <h3>Edycja rezerwacji</h3>
        <button class="iconbtn" id="editClose" title="Zamknij"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="modalgrid">
        <div class="field"><label>Imię i nazwisko</label><input class="input" id="eName"></div>
        <div class="field"><label>Telefon</label><input class="input" id="ePhone"></div>
        <div class="field"><label>Data</label><input class="input" id="eDate" type="date"></div>
        <div class="field"><label>Godzina</label><input class="input" id="eTime" type="time"></div>
        <div class="field"><label>Ilość osób</label><input class="input" id="eGuests"></div>
        <div class="field"><label>Strefa</label><input class="input" id="eRoom"></div>
        <div class="field" style="grid-column:span 2"><label>Uwagi</label><input class="input" id="eNotes"></div>
        <div class="field"><label>Źródło</label><input class="input" id="eSource" disabled></div>
        <div class="field"><label>Utworzono</label><input class="input" id="eCreated" disabled></div>
      </div>

      <div class="modalfoot">
        <button class="btn" id="editCancel"><i class="fa-regular fa-circle-xmark"></i> Anuluj</button>
        <button class="btn primary" id="editSave"><i class="fa-solid fa-floppy-disk"></i> Zapisz</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">
    <i class="fa-solid fa-circle-check"></i>
    <span id="toastText"></span>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==========================
    // Helpers
    // ==========================
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const state = {
      pin: "",
      unlocked: false,

      reservations: [],
      orders: [],

      editingId: null,

      alarmActive: false,
      audioCtx: null,
      beepInterval: null,

      // ✅ backend points last result
      pointsLast: null,

      // ✅ points history
      pointsHistory: [],

      // ✅ users list (users + milkpoints)
      users: [],

      // ✅ redeemed codes list
      redeemedCodes: [],

      // STATIC: Milki Aplikacja
      app: {
        rewards: [
          { id: "r1", name: "Darmowy shake 500 ml", cost: 20 },
          { id: "r2", name: "Zniżka -10% na zamówienie", cost: 12 }
        ]
      }
    };

    function showToast(msg, bad=false){
      const t = $("#toast");
      const tt = $("#toastText");
      tt.textContent = msg;
      t.style.display = "flex";
      t.style.background = bad ? "rgba(220,38,38,0.14)" : "rgba(22,163,74,0.14)";
      t.style.borderColor = bad ? "rgba(220,38,38,0.25)" : "rgba(22,163,74,0.25)";
      t.querySelector("i").style.color = bad ? "var(--bad)" : "var(--good)";
      setTimeout(()=> t.style.display="none", 3200);
    }

    function fmtDateTime(r){
      const d = (r?.date || "—");
      const t = (r?.time || "—");
      return `${d} • ${t}`;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function safePLDate(x){
      try{
        if(!x) return "—";
        const d = new Date(x);
        if(isNaN(d.getTime())) return String(x);
        return d.toLocaleString("pl-PL");
      }catch{
        return String(x ?? "—");
      }
    }

    // ==========================
    // ✅ Freeze + anti zoom gestures (lockscreen)
    // ==========================
    function setLockedFreeze(on){
      document.body.classList.toggle("locked", !!on);
    }
    setLockedFreeze(true);

    ["gesturestart","gesturechange","gestureend"].forEach(ev=>{
      window.addEventListener(ev, (e)=> e.preventDefault(), {passive:false});
    });

    let lastTouchEnd = 0;
    document.addEventListener("touchend", (e)=>{
      const now = Date.now();
      if(now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, {passive:false});

    // ==========================
    // ✅ Backend login (PIN not in frontend)
    // POST /api/login {pin:"1234"} => {ok:true}
    // ==========================
    async function verifyPin(pin){
      const res = await fetch("/api/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ pin })
      });
      const data = await res.json().catch(()=>({}));
      return !!(res.ok && data && data.ok);
    }

    // ==========================
    // Lock screen PIN
    // ==========================
    function renderPin(){
      const dots = [$("#p1"), $("#p2"), $("#p3"), $("#p4")];
      dots.forEach((d,i)=> d.classList.toggle("filled", i < state.pin.length));
    }

    function setLockMsg(msg, bad=false){
      const el = $("#lockMsg");
      el.textContent = msg || "";
      el.style.color = bad ? "rgba(220,38,38,0.95)" : "rgba(43,19,0,0.75)";
    }

    function unlock(){
      state.unlocked = true;
      setLockedFreeze(false);
      $("#lock").classList.remove("show");
      $("#app").style.display = "grid";
      showToast("Zalogowano ✅");
      initApp();
    }

    function lock(){
      state.unlocked = false;
      state.pin = "";
      renderPin();
      $("#app").style.display = "none";
      $("#lock").classList.add("show");
      setLockedFreeze(true);
      setLockMsg("");
      stopAlarm();
    }

    let loginBusy = false;

    $("#keypad").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn || loginBusy) return;

      const k = btn.getAttribute("data-k");
      const act = btn.getAttribute("data-act");

      if(k){
        if(state.pin.length >= 4) return;
        state.pin += k;
        renderPin();
        setLockMsg("");

        if(state.pin.length === 4){
          const entered = state.pin;
          state.pin = "";
          renderPin();

          loginBusy = true;
          try{
            const ok = await verifyPin(entered);
            if(ok) unlock();
            else setLockMsg("Błędny PIN", true);
          }catch{
            setLockMsg("Błąd logowania", true);
          }finally{
            loginBusy = false;
          }
        }
        return;
      }

      if(act === "back"){
        state.pin = state.pin.slice(0, -1);
        renderPin();
        setLockMsg("");
      }

      if(act === "ok"){
        const entered = state.pin;
        state.pin = "";
        renderPin();

        loginBusy = true;
        try{
          const ok = await verifyPin(entered);
          if(ok) unlock();
          else setLockMsg("Błędny PIN", true);
        }catch{
          setLockMsg("Błąd logowania", true);
        }finally{
          loginBusy = false;
        }
      }
    });

    // Blokuj klawiaturę systemową na lockscreen (totalny freeze)
    window.addEventListener("keydown", (e)=>{
      if(!$("#lock").classList.contains("show")) return;
      e.preventDefault();
    }, {passive:false});

    $("#logoutBtn").addEventListener("click", lock);

    // ==========================
    // Tabs
    // ==========================
    const tabMeta = {
      reservations: { title:"Rezerwacje" },
      happy: { title:"Pasek info" },
      users: { title:"Użytkownicy" },
      employees: { title:"Pracownicy" },
      pickup: { title:"Zamówienie z odbiorem" },
      points: { title:"Punkty Milk" },
      codes: { title:"Wykorzystaj kod" },
      rewards: { title:"Nagrody" },
    };

    function showTab(key){
      $$(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      Object.keys(tabMeta).forEach(k=>{
        const sec = $("#tab-" + k);
        if(sec) sec.style.display = (k === key) ? "block" : "none";
      });
      $("#title").textContent = tabMeta[key]?.title || "Panel";
      $("#subtitle").textContent = "";
    }

    $$(".navbtn").forEach(b => b.addEventListener("click", ()=> showTab(b.dataset.tab)));

    // ==========================
    // API (panel / backend)
    // ==========================
    async function apiHealth(){
      try{
        const res = await fetch("/api/health", {cache:"no-store"});
        const ok = res.ok;
        $("#apiDot").classList.toggle("ok", ok);
        $("#apiDot").classList.toggle("dot", true);
      }catch{
        $("#apiDot").classList.remove("ok");
      }
    }

    async function loadStats(){
      try{
        const res = await fetch("/api/admin/stats", {cache:"no-store"});
        const data = await res.json();
        if(!data?.ok) throw new Error("no ok");

        $("#kUsers").textContent = data.users ?? 0;
        $("#kOrders").textContent = data.orders ?? 0;
        $("#kProducts").textContent = data.products ?? 0;
        $("#kReservations").textContent = data.reservations ?? 0;

        $("#kMilkos").textContent = (data.milkosTotal ?? "—");
        $("#kUsersWithPoints").textContent = (data.usersWithPoints ?? "—");
        $("#kEmployees").textContent = (data.employees ?? "—");
      }catch{
        $("#kUsers").textContent = "—";
        $("#kOrders").textContent = "—";
        $("#kProducts").textContent = "—";
        $("#kReservations").textContent = "—";
        $("#kMilkos").textContent = "—";
        $("#kUsersWithPoints").textContent = "—";
        $("#kEmployees").textContent = "—";
      }
    }

    async function loadReservations(){
      try{
        const res = await fetch("/api/rezerwacje", {cache:"no-store"});
        const list = await res.json();
        state.reservations = Array.isArray(list) ? list : [];
        renderReservations();
        $("#kReservations").textContent = state.reservations.length;
      }catch(e){
        console.error(e);
        showToast("Nie udało się pobrać rezerwacji", true);
      }
    }

    async function loadOrders(){
      try{
        const res = await fetch("/api/orders", {cache:"no-store"});
        const list = await res.json();
        state.orders = Array.isArray(list) ? list : [];
        renderOrders();
      }catch(e){
        console.error(e);
        showToast("Nie udało się pobrać zamówień", true);
      }
    }

    // ✅ USERS (users + milkpoints)
    async function loadUsers(){
      try{
        const q = ($("#uFilter").value || "").trim();
        const url = q ? `/api/admin/users?query=${encodeURIComponent(q)}` : `/api/admin/users`;
        const res = await fetch(url, {cache:"no-store"});
        const data = await res.json().catch(()=>null);

        const list = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
        state.users = list.map(x => ({
          milkId: x.milkId ?? x.milkid ?? x.milkID ?? x.milk ?? "",
          email: x.email ?? x.mail ?? "",
          points: x.points ?? x.milkos ?? x.milkos ?? 0
        }));

        renderUsers();
        showToast("Wczytano użytkowników ✅");
      }catch(e){
        console.error(e);
        showToast("Nie udało się pobrać użytkowników", true);
      }
    }

    function renderUsers(){
      const tb = $("#usersTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.users || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak danych
            </td>
          </tr>
        `;
        return;
      }

      for(const u of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="tag"><i class="fa-solid fa-id-badge"></i> ${escapeHtml(u.milkId || "—")}</span></td>
          <td style="font-weight:900">${escapeHtml(u.email || "—")}</td>
          <td><span class="tag"><i class="fa-solid fa-star"></i> ${escapeHtml(u.points ?? 0)} <small>Milkosów</small></span></td>
          <td>
            <div class="row-actions">
              <button class="iconbtn ok" title="Pokaż historię punktów" data-act="uhist" data-milkid="${escapeHtml(u.milkId || "")}">
                <i class="fa-solid fa-clock-rotate-left"></i>
              </button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#usersTbody").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      if(act !== "uhist") return;
      const milkId = (btn.getAttribute("data-milkid") || "").trim();
      if(!milkId) return;

      // szybki skrót: przenosi do zakładki punkty + wczytuje historię dla milkId
      $("#pMilkId").value = milkId;
      showTab("points");
      await loadPointsHistoryByMilkId(milkId);
    });

    $("#uLoad").addEventListener("click", loadUsers);

    // ✅ CODES: redeemed list
    async function loadRedeemedCodes(){
      try{
        const res = await fetch("/api/admin/rewards/redeemed", {cache:"no-store"});
        const data = await res.json().catch(()=>null);
        const list = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
        state.redeemedCodes = list;
        renderRedeemedCodes();
      }catch(e){
        console.error(e);
        showToast("Nie udało się pobrać kodów", true);
      }
    }

    function renderRedeemedCodes(){
      const tb = $("#codesTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.redeemedCodes || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak zrealizowanych kodów
            </td>
          </tr>
        `;
        return;
      }

      for(const x of list){
        const tr = document.createElement("tr");
        const dt = x.redeemedAt || x.usedAt || x.createdAt || x.date;
        const who = x.email ? `${x.email}${x.milkId ? " • " + x.milkId : ""}` : (x.milkId || "—");
        tr.innerHTML = `
          <td><span class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(safePLDate(dt))}</span></td>
          <td style="font-weight:900">${escapeHtml(x.code || "—")}</td>
          <td><span class="tag"><i class="fa-solid fa-user"></i> ${escapeHtml(who)}</span></td>
          <td>${escapeHtml(x.rewardName || x.name || x.title || "—")}</td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#cReload").addEventListener("click", async ()=>{
      await loadRedeemedCodes();
      showToast("Odświeżono ✅");
    });

    $("#cUse").addEventListener("click", async ()=>{
      const code = ($("#cCode").value || "").trim();
      if(!code){
        showToast("Wpisz kod", true);
        return;
      }

      try{
        const res = await fetch("/api/admin/rewards/redeem-code", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ code })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false){
          throw new Error(data?.message || "Kod nieprawidłowy lub już wykorzystany");
        }

        $("#codePreview").innerHTML = `
          <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-ticket"></i> Kod <small>•</small> ${escapeHtml(data.code || code)}</div>
          <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-circle-check"></i> Status <small>•</small> Wykorzystany</div>
          ${data.rewardName ? `<div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-gift"></i> ${escapeHtml(data.rewardName)}</div>` : ``}
          ${data.email ? `<div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-envelope"></i> ${escapeHtml(data.email)}</div>` : ``}
          ${data.milkId ? `<div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-id-badge"></i> ${escapeHtml(data.milkId)}</div>` : ``}
        `;

        $("#cCode").value = "";
        showToast("Kod zrealizowany ✅");
        await loadRedeemedCodes();
      }catch(e){
        console.error(e);
        showToast(e.message || "Błąd realizacji kodu", true);
      }
    });

    // ==========================
    // Rendering: reservations
    // ==========================
    function renderReservations(){
      const tb = $("#resTbody");
      if(!tb) return;
      tb.innerHTML = "";

      if(state.reservations.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak rezerwacji
            </td>
          </tr>
        `;
        return;
      }

      for(const r of state.reservations){
        const tr = document.createElement("tr");
        const src = (r.source || "index");
        const created = r.createdAt ? new Date(r.createdAt).toLocaleString("pl-PL") : "—";

        tr.innerHTML = `
          <td>
            <div class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(fmtDateTime(r))}</div>
            <div style="color:rgba(43,19,0,0.60);font-size:.82rem;margin-top:6px">Utworzono: ${escapeHtml(created)}</div>
          </td>
          <td>
            <div style="font-weight:900">${escapeHtml(r.name || "—")}</div>
            <div style="color:rgba(43,19,0,0.70);font-size:.9rem;margin-top:4px"><i class="fa-solid fa-phone" style="color:rgba(255,106,0,0.95)"></i> ${escapeHtml(r.phone || "—")}</div>
          </td>
          <td><span class="tag"><i class="fa-solid fa-user-group"></i> ${escapeHtml(r.guests || "—")} <small>os.</small></span></td>
          <td><span class="tag"><i class="fa-solid fa-door-open"></i> ${escapeHtml(r.room || "—")}</span></td>
          <td><span class="tag"><i class="fa-solid fa-globe"></i> ${escapeHtml(src)}</span></td>
          <td>
            <div class="row-actions">
              <button class="iconbtn ok" title="Edytuj" data-act="edit" data-id="${r._id}"><i class="fa-solid fa-pen"></i></button>
              <button class="iconbtn danger" title="Usuń" data-act="del" data-id="${r._id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#resTbody").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(!id || !act) return;

      const r = state.reservations.find(x => x._id === id);
      if(!r) return;

      if(act === "edit"){
        openEdit(r);
      }
      if(act === "del"){
        if(!confirm("Usunąć rezerwację?")) return;
        try{
          const res = await fetch(`/api/rezerwacje/${id}`, { method:"DELETE" });
          const data = await res.json().catch(()=>({}));
          if(!res.ok || data?.ok === false) throw new Error(data?.message || "delete");
          showToast("Usunięto ✅");
          await loadReservations();
          await loadStats();
        }catch(err){
          console.error(err);
          showToast("Błąd usuwania", true);
        }
      }
    });

    // ==========================
    // Orders table
    // ==========================
    function renderOrders(){
      const tb = $("#ordersTbody");
      if(!tb) return;
      tb.innerHTML = "";

      if(state.orders.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak zamówień
            </td>
          </tr>
        `;
        return;
      }

      for(const o of state.orders){
        const created =
          o.createdAt ? new Date(o.createdAt).toLocaleString("pl-PL") :
          (o.date || "—");

        const name =
          o.name || o.customerName || o.customer?.name || "—";

        const pickup =
          o.pickupTime || o.pickup || o.time || (o.pickupAt ? new Date(o.pickupAt).toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"}) : "—");

        const items =
          Array.isArray(o.items)
            ? o.items.map(x => `${x.qty ?? x.quantity ?? 1}x ${x.name ?? x.title ?? "Produkt"}`).join(", ")
            : (o.itemsText || o.items || "—");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(created)}</div>
          </td>
          <td>
            <div style="font-weight:900">${escapeHtml(name)}</div>
            <div style="color:rgba(43,19,0,0.70);font-size:.9rem;margin-top:4px">
              <i class="fa-solid fa-receipt" style="color:rgba(255,106,0,0.95)"></i> ${escapeHtml(items)}
            </div>
          </td>
          <td>
            <span class="tag"><i class="fa-regular fa-clock"></i> ${escapeHtml(pickup)}</span>
          </td>
          <td>
            <span class="tag"><i class="fa-solid fa-location-dot"></i> ${escapeHtml(o.location || o.place || "—")}</span>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    // ==========================
    // Edit modal
    // ==========================
    function openEdit(r){
      state.editingId = r._id;
      $("#eName").value = r.name || "";
      $("#ePhone").value = r.phone || "";
      $("#eDate").value = r.date || "";
      $("#eTime").value = r.time || "";
      $("#eGuests").value = r.guests || "";
      $("#eRoom").value = r.room || "";
      $("#eNotes").value = r.notes || "";
      $("#eSource").value = r.source || "index";
      $("#eCreated").value = r.createdAt ? new Date(r.createdAt).toLocaleString("pl-PL") : "—";
      $("#editModal").classList.add("show");
      $("#editModal").setAttribute("aria-hidden","false");
    }
    function closeEdit(){
      state.editingId = null;
      $("#editModal").classList.remove("show");
      $("#editModal").setAttribute("aria-hidden","true");
    }
    $("#editClose").addEventListener("click", closeEdit);
    $("#editCancel").addEventListener("click", closeEdit);
    $("#editModal").addEventListener("click", (e)=>{ if(e.target.id === "editModal") closeEdit(); });

    $("#editSave").addEventListener("click", async ()=>{
      const id = state.editingId;
      if(!id) return;

      const payload = {
        name: $("#eName").value,
        phone: $("#ePhone").value,
        date: $("#eDate").value,
        time: $("#eTime").value,
        guests: $("#eGuests").value,
        room: $("#eRoom").value,
        notes: $("#eNotes").value
      };

      try{
        const res = await fetch(`/api/rezerwacje/${id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false) throw new Error(data?.message || "edit");
        showToast("Zapisano ✅");
        closeEdit();
        await loadReservations();
      }catch(err){
        console.error(err);
        showToast("Błąd zapisu", true);
      }
    });

    // ==========================
    // Happy bar
    // ==========================
    async function loadHappy(){
      try{
        const res = await fetch("/api/happy", {cache:"no-store"});
        const data = await res.json();
        if(!data?.ok) throw new Error("happy");
        $("#happyText").value = data.happy || "";
        showToast("Wczytano ✅");
      }catch(e){
        console.error(e);
        showToast("Błąd wczytywania paska", true);
      }
    }
    async function saveHappy(){
      try{
        const text = $("#happyText").value || "";
        const res = await fetch("/api/happy", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ happy: text })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false) throw new Error(data?.message || "save");
        showToast("Zapisano ✅");
      }catch(e){
        console.error(e);
        showToast("Błąd zapisu paska", true);
      }
    }
    $("#happyLoad").addEventListener("click", loadHappy);
    $("#happySave").addEventListener("click", saveHappy);

    // ==========================
    // ✅ Alarm: szybkie pikanie (oscillator)
    // ==========================
    function ensureAudio(){
      if(state.audioCtx) return;
      try{ state.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      catch(e){ state.audioCtx = null; }
    }

    function beepOnce(){
      if(!state.audioCtx) return;
      const ctx = state.audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = 1100;
      g.gain.value = 0.14;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} }, 140);
    }

    function startAlarm(kind, payload){
      if(state.alarmActive) return;
      state.alarmActive = true;

      const pill = $("#alarmPill");
      const title = $("#alarmTitle");
      const desc = $("#alarmDesc");
      const alarm = $("#alarm");

      // reset klas migania
      alarm.classList.remove("reservation");
      alarm.classList.remove("order");

      if(kind === "order"){
        alarm.classList.add("order");
        pill.innerHTML = `<i class="fa-solid fa-bag-shopping"></i> Nowe zamówienie`;
        title.textContent = "Przyszło nowe zamówienie!";
        desc.innerHTML = `Panel będzie migał i piszczał, dopóki nie klikniesz <b>OK</b>.`;
      }else{
        // ✅ rezerwacja: migawka tła 0.1s + ten sam dźwięk
        alarm.classList.add("reservation");
        pill.innerHTML = `<i class="fa-solid fa-bell"></i> Nowa rezerwacja`;
        title.textContent = "Przyszła nowa rezerwacja!";
        desc.innerHTML = `Panel będzie migał i piszczał, dopóki nie klikniesz <b>OK</b>.`;
      }

      if(kind === "order"){
        const name = payload?.name || payload?.customerName || payload?.customer?.name || "—";
        const phone = payload?.phone || payload?.customerPhone || payload?.customer?.phone || "—";
        const pickup =
          payload?.pickupTime || payload?.pickup || payload?.time ||
          (payload?.pickupAt ? new Date(payload.pickupAt).toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"}) : "—");

        const items =
          Array.isArray(payload?.items)
            ? payload.items.map(x => `${x.qty ?? x.quantity ?? 1}x ${x.name ?? x.title ?? "Produkt"}`).join(", ")
            : (payload?.itemsText || payload?.items || "—");

        $("#alarmPreview").innerHTML = `
          <div class="line">
            <i class="fa-solid fa-user"></i>
            <div><b>${escapeHtml(name)}</b> <span class="muted">•</span> ${escapeHtml(phone)}</div>
          </div>
          <div class="line">
            <i class="fa-regular fa-clock"></i>
            <div>Odbiór: <b>${escapeHtml(pickup)}</b></div>
          </div>
          <div class="line" style="margin-bottom:0">
            <i class="fa-solid fa-receipt"></i>
            <div class="muted">${escapeHtml(items)}</div>
          </div>
        `;
      }else{
        $("#alarmPreview").innerHTML = `
          <div class="line">
            <i class="fa-solid fa-user"></i>
            <div><b>${escapeHtml(payload?.name || "—")}</b> <span class="muted">•</span> ${escapeHtml(payload?.phone || "—")}</div>
          </div>
          <div class="line">
            <i class="fa-solid fa-calendar-day"></i>
            <div>${escapeHtml(payload?.date || "—")} <span class="muted">•</span> ${escapeHtml(payload?.time || "—")}</div>
          </div>
          <div class="line">
            <i class="fa-solid fa-user-group"></i>
            <div>${escapeHtml(payload?.guests || "—")} <span class="muted">os.</span></div>
          </div>
          <div class="line">
            <i class="fa-solid fa-door-open"></i>
            <div>${escapeHtml(payload?.room || "—")}</div>
          </div>
          <div class="line" style="margin-bottom:0">
            <i class="fa-solid fa-note-sticky"></i>
            <div class="muted">${escapeHtml(payload?.notes || "—")}</div>
          </div>
        `;
      }

      alarm.classList.add("show");
      alarm.classList.add("flash");

      ensureAudio();
      if(state.audioCtx && state.audioCtx.state === "suspended"){
        state.audioCtx.resume().catch(()=>{});
      }
      beepOnce();
      state.beepInterval = setInterval(beepOnce, 280);
    }

    function stopAlarm(){
      state.alarmActive = false;
      const alarm = $("#alarm");
      alarm.classList.remove("show");
      alarm.classList.remove("flash");
      alarm.classList.remove("reservation");
      alarm.classList.remove("order");

      if(state.beepInterval){
        clearInterval(state.beepInterval);
        state.beepInterval = null;
      }
    }

    $("#alarmOk").addEventListener("click", ()=>{
      stopAlarm();
      showToast("Potwierdzono ✅");
    });

    // ==========================
    // Realtime (Socket.IO)
    // ==========================
    let socket = null;

    function initSocket(){
      try{
        socket = io();

        socket.on("new-reservation", async (reservation)=>{
          startAlarm("reservation", reservation);
          await loadReservations();
          await loadStats();
        });

        socket.on("new-order", async (order)=>{
          startAlarm("order", order);
          await loadOrders();
          await loadStats();
        });

        socket.on("happy-updated", (text)=>{
          if($("#tab-happy").style.display !== "none"){
            $("#happyText").value = text || "";
          }
          showToast("Pasek zaktualizowany ✅");
        });

      }catch(e){
        console.error("Socket init error", e);
      }
    }

    // ==========================
    // ✅ POINTS (BACKEND) + HISTORY
    // ==========================
    function renderPointsPreview(){
      const box = $("#pointsPreview");
      if(!box) return;

      if(!state.pointsLast){
        box.innerHTML = `<span class="muted" style="color:rgba(43,19,0,0.62)">Brak operacji.</span>`;
        return;
      }

      const x = state.pointsLast;
      box.innerHTML = `
        <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-id-badge"></i> Milk ID <small>•</small> ${escapeHtml(x.milkId)}</div>
        <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-envelope"></i> ${escapeHtml(x.email)}</div>
        <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-plus"></i> +${escapeHtml(x.addedPoints)} pkt</div>
        <div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-star"></i> Razem <small>•</small> ${escapeHtml(x.points)} pkt</div>
      `;
    }

    function renderPointsHistory(){
      const tb = $("#pointsHistTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.pointsHistory || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak historii (wczytaj Milk ID)
            </td>
          </tr>
        `;
        return;
      }

      for(const h of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(safePLDate(h.createdAt || h.date))}</span></td>
          <td>${escapeHtml(h.amountPln ?? h.amount ?? "—")}</td>
          <td><span class="tag"><i class="fa-solid fa-plus"></i> ${escapeHtml(h.addedPoints ?? h.points ?? "—")}</span></td>
          <td>${escapeHtml(h.note || h.source || "")}</td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadPointsHistoryByMilkId(milkId){
      const id = (milkId || "").trim();
      if(!id || id.length !== 6){
        showToast("Podaj poprawny Milk ID (6 cyfr)", true);
        return;
      }

      try{
        const res = await fetch(`/api/admin/milkpoints/history?milkId=${encodeURIComponent(id)}`, {cache:"no-store"});
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false){
          throw new Error(data?.message || "Nie udało się pobrać historii");
        }

        // akceptuj: {ok:true, history:[...]} albo bez ok
        const hist = Array.isArray(data?.history) ? data.history : (Array.isArray(data) ? data : []);
        state.pointsHistory = hist.slice().sort((a,b)=>{
          const da = new Date(a.createdAt || a.date || 0).getTime();
          const db = new Date(b.createdAt || b.date || 0).getTime();
          return db - da;
        });

        renderPointsHistory();
        showToast("Wczytano historię ✅");
      }catch(e){
        console.error(e);
        state.pointsHistory = [];
        renderPointsHistory();
        showToast(e.message || "Błąd historii", true);
      }
    }

    $("#pHistoryLoad").addEventListener("click", async ()=>{
      await loadPointsHistoryByMilkId($("#pMilkId").value);
    });

    $("#pAdd").addEventListener("click", async () => {
      const milkId = ($("#pMilkId").value || "").trim();
      const amount = Number($("#pAmount").value);

      if (!milkId || milkId.length !== 6) {
        showToast("Podaj poprawny Milk ID (6 cyfr)", true);
        return;
      }

      if (!Number.isFinite(amount) || amount < 10) {
        showToast("Minimalna kwota to 10 zł (1 pkt)", true);
        return;
      }

      try {
        const res = await fetch("/api/admin/milkpoints/add-by-milkid", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ milkId, amountPln: amount })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          throw new Error(data.message || "Błąd naliczania punktów");
        }

        state.pointsLast = {
          milkId: data.milkId,
          email: data.email,
          addedPoints: data.addedPoints,
          points: data.points
        };

        $("#pAmount").value = "";
        renderPointsPreview();
        showToast(`Dodano +${data.addedPoints} pkt (razem: ${data.points}) ✅`);

        await loadStats();
        // ✅ po dodaniu: odśwież historię użytkownika
        await loadPointsHistoryByMilkId(milkId);
      } catch (err) {
        console.error(err);
        showToast(err.message || "Błąd serwera", true);
      }
    });

    // ==========================
    // STATIC: Rewards UI (unchanged)
    // ==========================
    function renderRewards(){
      const tb = $("#rewardsTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.app.rewards || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr><td colspan="3" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
            Brak nagród
          </td></tr>
        `;
        return;
      }

      for(const r of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="font-weight:900">${escapeHtml(r.name)}</td>
          <td><span class="tag"><i class="fa-solid fa-coins"></i> ${escapeHtml(r.cost)} <small>Milkosów</small></span></td>
          <td style="text-align:right">
            <button class="iconbtn danger" data-rid="${escapeHtml(r.id)}" title="Usuń"><i class="fa-solid fa-trash"></i></button>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#rAdd").addEventListener("click", ()=>{
      const name = ($("#rName").value || "").trim();
      const cost = Number($("#rCost").value);

      if(!name){
        showToast("Podaj nazwę nagrody", true);
        return;
      }
      if(!isFinite(cost) || cost <= 0){
        showToast("Podaj poprawny koszt", true);
        return;
      }

      state.app.rewards.push({ id: "r" + Math.random().toString(16).slice(2), name, cost: Math.floor(cost) });
      $("#rName").value = "";
      $("#rCost").value = "";
      renderRewards();
      showToast("Dodano nagrodę ✅");
    });

    $("#rewardsTbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-rid");
      if(!id) return;
      state.app.rewards = state.app.rewards.filter(x => x.id !== id);
      renderRewards();
      showToast("Usunięto ✅");
    });

    // ==========================
    // Mobile drawer sidebar
    // ==========================
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("overlay");
    const menuBtn = document.getElementById("menuBtn");

    function openMenu(){
      sidebar?.classList.add("open");
      overlay?.classList.add("show");
    }
    function closeMenu(){
      sidebar?.classList.remove("open");
      overlay?.classList.remove("show");
    }

    menuBtn?.addEventListener("click", ()=>{
      if(sidebar?.classList.contains("open")) closeMenu();
      else openMenu();
    });
    overlay?.addEventListener("click", closeMenu);

    document.querySelectorAll(".navbtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        if(window.matchMedia("(max-width: 920px)").matches) closeMenu();
      });
    });

    window.addEventListener("resize", ()=>{
      if(!window.matchMedia("(max-width: 920px)").matches){
        closeMenu();
      }
    });

    // ==========================
    // ✅ PWA service worker
    // ==========================
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("/sw.js").catch(()=>{});
      });
    }

    // ==========================
    // Init
    // ==========================
    async function initApp(){
      showTab("reservations");
      initSocket();

      await apiHealth();
      await loadStats();
      await loadReservations();
      await loadOrders();
      await loadHappy();

      renderPointsPreview();
      renderPointsHistory();
      renderRewards();

      // ✅ wstępnie wczytaj listę zrealizowanych kodów (dla zakładki)
      await loadRedeemedCodes();
    }

    $("#refreshBtn").addEventListener("click", async ()=>{
      await apiHealth();
      await loadStats();
      await loadReservations();
      await loadOrders();
      showToast("Odświeżono ✅");
    });

    setInterval(()=>{
      const now = new Date();
      $("#clock").innerHTML = `<i class="fa-regular fa-clock"></i> ${now.toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"})}`;
    }, 1000);

    setInterval(apiHealth, 6000);

    renderPin();
  </script>
</body>
</html>
