<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <!-- ✅ Anti-zoom + fullscreen PWA safe-area -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>MilkShake Bar — Panel Administratora</title>

  <!-- ✅ PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#FF6A00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary:#FF6A00;
      --secondary:#FF9100;
      --accent:#FFE0B2;

      --bg:#FFF6EC;
      --bg2:#ffffff;
      --text:#2B1300;
      --muted: rgba(43,19,0,0.65);

      --card: rgba(255,255,255,0.82);
      --card2: rgba(255,255,255,0.92);
      --border: rgba(43,19,0,0.12);

      --shadow: 0px 10px 30px rgba(0,0,0,0.12);
      --shadow2: 0px 18px 50px rgba(0,0,0,0.14);
      --radius: 20px;

      --good:#16A34A;
      --bad:#DC2626;

      --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
      --glass: rgba(255,255,255,0.70);
      --glass2: rgba(255,255,255,0.86);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Poppins,system-ui,Segoe UI,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(255,106,0,0.20), transparent 60%),
        radial-gradient(900px 500px at 90% 25%, rgba(255,145,0,0.16), transparent 60%),
        radial-gradient(800px 500px at 50% 90%, rgba(43,19,0,0.06), transparent 60%),
        var(--bg);
      overflow:hidden;
      overscroll-behavior: none;
    }

    /* ✅ Fullscreen responsive height */
    .app{
      height: 100dvh;
      display:grid;
      grid-template-columns: 290px 1fr;
    }

    /* ✅ Lockscreen freeze (no pinch/zoom/scroll/select) */
    body.locked{
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    /* allow “tap” behavior for buttons (no double-tap zoom intent) */
    #lock, #lock *{ touch-action: manipulation; }

    /* Sidebar */
    .sidebar{
      height:100%;
      padding:22px;
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.66));
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex;align-items:center;gap:14px;
      padding:14px 14px;border-radius:18px;
      background: var(--glass2);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .brand img{
      width:44px;height:44px;border-radius:999px;object-fit:cover;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    .brand .t1{font-weight:900;letter-spacing:.2px}
    .brand .t2{font-size:.86rem;color:var(--muted)}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:10px;}
    .navbtn{
      width:100%;
      display:flex;align-items:center;gap:12px;
      padding:12px 14px;border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.70);
      color:var(--text);cursor:pointer;transition:.18s ease;text-align:left;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .navbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.86)}
    .navbtn.active{
      background: linear-gradient(135deg, rgba(255,106,0,0.18), rgba(255,145,0,0.12));
      border-color: rgba(255,145,0,0.35);
      box-shadow: 0 18px 40px rgba(255,106,0,0.12);
    }
    .navbtn i{width:18px;opacity:.95}
    .navsep{
      margin:12px 0 6px;
      font-size:.82rem;color: rgba(43,19,0,0.55);
      padding:0 6px;letter-spacing:.4px;text-transform:uppercase;
    }
    .sidefoot{
      margin-top:14px;
      padding:12px 14px;border-radius:16px;
      background: rgba(255,255,255,0.70);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:.9rem;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,0.72);
      border:1px solid var(--border);
      font-size:.82rem;color:rgba(43,19,0,0.92);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--bad);
      box-shadow: 0 0 0 3px rgba(220,38,38,0.18);
    }
    .dot.ok{background:var(--good); box-shadow: 0 0 0 3px rgba(22,163,74,0.18);}

    /* Main */
    .main{
      height:100%;
      overflow:auto;
      padding: calc(22px + env(safe-area-inset-top)) 22px calc(22px + env(safe-area-inset-bottom));
    }
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:14px;margin-bottom:18px;
    }
    .topbar h1{
      font-size:1.9rem;line-height:1.15;font-weight:900;
      margin-bottom:6px;letter-spacing:.2px;
      background: var(--gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .topbar p{color:var(--muted);max-width:720px}
    .actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }

    .btn{
      border:none;cursor:pointer;font-weight:800;
      padding:12px 14px;border-radius:999px;
      color:var(--text);
      background: rgba(255,255,255,0.80);
      border:1px solid var(--border);
      transition:.18s ease;
      display:inline-flex;gap:10px;align-items:center;white-space:nowrap;
      box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.92)}
    .btn.primary{
      color:#fff;
      background: var(--gradient);
      border-color: rgba(255,145,0,0.45);
      box-shadow: 0 14px 35px rgba(255,106,0,0.22);
    }
    .btn.danger{
      color:#fff;
      background: rgba(220,38,38,0.90);
      border-color: rgba(220,38,38,0.35);
      box-shadow: 0 14px 35px rgba(220,38,38,0.16);
    }

    /* Cards / grid */
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:14px;}
    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .card h2{font-size:1.1rem;margin-bottom:10px;font-weight:900;letter-spacing:.2px;}
    .kpis{display:grid;grid-template-columns: repeat(4, 1fr);gap:14px;margin-top:10px;}
    .kpi{
      background: rgba(255,255,255,0.78);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      display:flex;gap:12px;align-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,0.06);
    }
    .kpi i{font-size:1.05rem;opacity:.95;color: rgba(255,106,0,0.95)}
    .kpi .num{font-weight:900;font-size:1.35rem}
    .kpi .lbl{font-size:.86rem;color:var(--muted)}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 10px;}
    th{
      text-align:left;font-size:.82rem;color:rgba(43,19,0,0.55);
      font-weight:900;padding:0 10px 6px;letter-spacing:.35px;text-transform:uppercase;
    }
    td{
      padding:12px 10px;background: rgba(255,255,255,0.86);
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      color: var(--text);
    }
    tr td:first-child{
      border-left:1px solid var(--border);
      border-top-left-radius:16px;border-bottom-left-radius:16px;
    }
    tr td:last-child{
      border-right:1px solid var(--border);
      border-top-right-radius:16px;border-bottom-right-radius:16px;
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      font-weight:900;font-size:.84rem;white-space:nowrap;
      box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    }
    .tag i{color: rgba(255,106,0,0.95)}
    .tag small{font-weight:700;color:rgba(43,19,0,0.55)}
    .row-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    .iconbtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.86);
      color:var(--text);cursor:pointer;
      display:grid;place-items:center;transition:.15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }
    .iconbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,0.95)}
    .iconbtn.danger{background: rgba(220,38,38,0.12);border-color: rgba(220,38,38,0.28);color:#8a0d0d}
    .iconbtn.ok{background: rgba(22,163,74,0.12);border-color: rgba(22,163,74,0.28);color:#0f5f2a}

    /* Inputs */
    .field{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
    .field label{font-weight:900;font-size:.9rem}
    .input, .textarea{
      width:100%;
      padding:12px 14px;border-radius:16px;
      border:2px solid rgba(43,19,0,0.10);
      background: rgba(255,255,255,0.90);
      color:var(--text);outline:none;font-family:Poppins;
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease;
    }
    .input:focus, .textarea:focus{
      border-color: rgba(255,106,0,0.55);
      box-shadow: 0 10px 26px rgba(255,106,0,0.12);
    }
    .textarea{min-height:130px;resize:vertical}
    .hint{margin-top:8px;color:var(--muted);font-size:.92rem}

    /* Modals */
    .modal, .lock{
      position:fixed; inset:0;
      display:none;align-items:center;justify-content:center;
      z-index:9999;
      background: rgba(0,0,0,0.42);
      backdrop-filter: blur(10px);
      padding:22px;
    }
    .modal.show, .lock.show{display:flex}
    .modalbox{
      width:min(920px, 100%);
      border-radius:28px;
      border:1px solid rgba(255,255,255,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow: var(--shadow2);
      padding:18px;
      color: var(--text);
    }
    .modalhead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .modalhead h3{font-size:1.2rem;font-weight:900}
    .modalgrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    .modalgrid .field{margin-top:0}
    .modalfoot{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

    /* LOCKSCREEN */
    .lockbox{
      width:min(520px, 100%);
      border-radius:30px;
      border:1px solid rgba(255,255,255,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow: var(--shadow2);
      padding:18px;
      color: var(--text);
    }
    .locktop{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:12px;}
    .locktop .title{display:flex;flex-direction:column;gap:2px}
    .locktop .title b{font-weight:900;font-size:1.1rem}
    .locktop .title span{color:var(--muted);font-size:.92rem}

    .pin{display:flex;gap:10px;justify-content:center;margin:14px 0 10px;}
    .pin .dotpin{
      width:14px;height:14px;border-radius:99px;
      background: rgba(43,19,0,0.10);
      border:1px solid rgba(43,19,0,0.12);
      box-shadow: inset 0 6px 12px rgba(0,0,0,0.10);
    }
    .pin .dotpin.filled{
      background: var(--gradient);
      border-color: rgba(255,145,0,0.55);
      box-shadow: 0 10px 25px rgba(255,106,0,0.18);
    }
    .keypad{display:grid;grid-template-columns: repeat(3, 1fr);gap:12px;margin-top:12px;}
    .key{
      height:56px;border-radius:18px;
      border:1px solid rgba(43,19,0,0.12);
      background: rgba(255,255,255,0.86);
      color:var(--text);font-weight:900;font-size:1.15rem;
      cursor:pointer;transition:.15s ease;display:grid;place-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,0.06);
    }
    .key:hover{transform: translateY(-1px); background: rgba(255,255,255,0.95)}
    .key.small{font-size:1rem}
    .key.danger{
      background: rgba(220,38,38,0.10);
      border-color: rgba(220,38,38,0.22);
      color:#8a0d0d;
    }
    .key.ok{
      background: rgba(22,163,74,0.10);
      border-color: rgba(22,163,74,0.22);
      color:#0f5f2a;
    }
    .lockmsg{text-align:center;color:rgba(43,19,0,0.75);font-size:.92rem;min-height:22px;margin-top:10px;}

    /* FULLSCREEN ALERT */
    .alarm{
      position:fixed; inset:0;
      z-index:10000;
      display:none;align-items:center;justify-content:center;
      padding:22px;
      background: rgba(0,0,0,0.50);
      backdrop-filter: blur(6px);
    }
    .alarm.show{display:flex}
    .alarm.flash::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(700px 500px at 50% 30%, rgba(255,106,0,0.42), transparent 65%);
      animation: flash 0.55s infinite alternate;
      opacity:0.95;
    }
    @keyframes flash{from{opacity:.20}to{opacity:.85}}
    .alarmbox{
      position:relative;
      width:min(640px, 100%);
      border-radius:30px;
      border:1px solid rgba(255,255,255,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
      box-shadow: var(--shadow2);
      padding:18px;
      text-align:center;
      color: var(--text);
    }
    .alarmbox h3{font-size:1.35rem;font-weight:900;margin:8px 0 6px;}
    .alarmbox p{color:var(--muted)}
    .alarmbox .preview{
      margin-top:12px;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      text-align:left;
      font-size:.95rem;
      line-height:1.6;
    }
    .alarmbox .preview .line{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(255,255,255,0.92);
      border:1px solid var(--border);
      margin-bottom:8px;
    }
    .alarmbox .preview .line i{width:18px;color:rgba(255,106,0,0.95)}
    .alarmbox .preview .muted{color:rgba(43,19,0,0.62)}
    .alarmbox .preview b{color:var(--text)}
    .alarmbox .okwrap{margin-top:14px;display:flex;justify-content:center}

    /* Toast */
    #toast{
      position:fixed;bottom:18px;right:18px;z-index:12000;
      display:none;align-items:center;gap:10px;
      padding:12px 14px;border-radius:999px;
      background: rgba(22,163,74,0.14);
      border:1px solid rgba(22,163,74,0.25);
      color: var(--text);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 45px rgba(0,0,0,0.18);
      font-weight:900;
    }
    #toast i{color: var(--good)}

    /* Responsive base */
    @media (max-width: 1180px){
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 920px){
      body{overflow:auto}
      .app{grid-template-columns: 1fr}
      .sidebar{position:sticky;top:0;z-index:50}
      .main{height:auto; overflow:visible}
      .modalgrid{grid-template-columns: 1fr}
    }

    /* ============ MOBILE/TABLET UX (drawer sidebar) ============ */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      z-index:80;
      display:none;
    }
    .overlay.show{display:block}

    @media (max-width: 920px){
      body{overflow:auto}
      .app{grid-template-columns:1fr}

      /* Sidebar as drawer */
      .sidebar{
        position:fixed;
        top:0; left:0; bottom:0;
        width:min(86vw, 340px);
        transform: translateX(-110%);
        transition: transform .22s ease;
        z-index:90;
        border-right:1px solid var(--border);
        box-shadow: 0 30px 90px rgba(0,0,0,0.35);
      }
      .sidebar.open{transform: translateX(0)}

      /* Main full width */
      .main{
        padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
        height:auto;
        overflow:visible;
      }

      /* Topbar: sticky + stacked */
      .topbar{
        position:sticky;
        top:0;
        z-index:40;
        padding:12px;
        margin:-14px -14px 14px;
        border-radius:18px;
        background: rgba(255,255,255,0.86);
        border:1px solid var(--border);
        backdrop-filter: blur(12px);
        flex-direction:column;
        align-items:stretch;
        box-shadow: var(--shadow);
      }
      .actions{
        justify-content:space-between;
        gap:10px;
      }

      /* Show menu button on mobile */
      #menuBtn{display:inline-flex !important}

      /* ✅ KPI: małe prostokąty (2 kolumny), nie długie paski */
      .kpis{grid-template-columns: repeat(2, 1fr)}
      .kpi{
        padding:10px;
        border-radius:16px;
        min-height:78px;
        align-items:center;
      }
      .kpi .num{font-size:1.1rem}
      .kpi .lbl{font-size:.8rem}

      /* Tables: safe horizontal scroll */
      table{min-width: 760px}
      .card{padding:14px}
    }
  </style>
</head>

<body>

  <!-- LOCKSCREEN -->
  <div class="lock show" id="lock">
    <div class="lockbox">
      <div class="locktop">
        <div class="title">
          <b>MilkShake Bar — Panel</b>
          <span>Wpisz PIN na klawiaturze ekranowej</span>
        </div>
        <span class="pill"><i class="fa-solid fa-lock"></i> PIN</span>
      </div>

      <div class="pin" aria-label="PIN">
        <div class="dotpin" id="p1"></div>
        <div class="dotpin" id="p2"></div>
        <div class="dotpin" id="p3"></div>
        <div class="dotpin" id="p4"></div>
      </div>

      <div class="keypad" id="keypad">
        <button class="key" data-k="1">1</button>
        <button class="key" data-k="2">2</button>
        <button class="key" data-k="3">3</button>
        <button class="key" data-k="4">4</button>
        <button class="key" data-k="5">5</button>
        <button class="key" data-k="6">6</button>
        <button class="key" data-k="7">7</button>
        <button class="key" data-k="8">8</button>
        <button class="key" data-k="9">9</button>
        <button class="key danger small" data-act="back"><i class="fa-solid fa-delete-left"></i></button>
        <button class="key" data-k="0">0</button>
        <button class="key ok small" data-act="ok"><i class="fa-solid fa-check"></i></button>
      </div>

      <div class="lockmsg" id="lockMsg"></div>
    </div>
  </div>

  <!-- FULLSCREEN ALARM -->
  <div class="alarm" id="alarm">
    <div class="alarmbox">
      <div class="pill" style="margin:0 auto 8px; width:max-content;">
        <i class="fa-solid fa-bell"></i> Nowa rezerwacja
      </div>
      <h3>Przyszła nowa rezerwacja!</h3>
      <p>Panel będzie migał i piszczał, dopóki nie klikniesz <b>OK</b>.</p>

      <div class="preview" id="alarmPreview"></div>

      <div class="okwrap">
        <button class="btn primary" id="alarmOk"><i class="fa-solid fa-check"></i> OK</button>
      </div>
    </div>
  </div>

  <div class="app" id="app" style="display:none">
    <!-- OVERLAY (mobile drawer) -->
    <div class="overlay" id="overlay"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="https://i.imgur.com/Twr2Rms.jpeg" alt="Logo">
        <div>
          <div class="t1">MilkShake Bar</div>
          <div class="t2">Panel Administratora</div>
        </div>
      </div>

      <div class="nav">
        <div class="navsep">Główne</div>
        <button class="navbtn active" data-tab="reservations"><i class="fa-solid fa-calendar-check"></i> Rezerwacje</button>
        <button class="navbtn" data-tab="happy"><i class="fa-solid fa-bullhorn"></i> Pasek info</button>

        <div class="navsep">Zarządzanie</div>
        <button class="navbtn" data-tab="users"><i class="fa-solid fa-users"></i> Użytkownicy</button>
        <button class="navbtn" data-tab="employees"><i class="fa-solid fa-user-tie"></i> Pracownicy</button>

        <div class="navsep">Milki Aplikacja</div>
        <button class="navbtn" data-tab="pickup"><i class="fa-solid fa-bag-shopping"></i> Zamówienie z odbiorem</button>
        <button class="navbtn" data-tab="points"><i class="fa-solid fa-star"></i> Punkty Milk</button>
        <button class="navbtn" data-tab="rewards"><i class="fa-solid fa-gift"></i> Nagrody</button>
        <button class="navbtn" data-tab="clients"><i class="fa-solid fa-address-book"></i> Baza klientów</button>

        <div class="sidefoot">
          <span class="pill"><span class="dot" id="apiDot"></span> API</span>
          <span class="pill" id="clock"><i class="fa-regular fa-clock"></i> —</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div>
          <h1 id="title">Rezerwacje</h1>
          <p id="subtitle"></p>
        </div>

        <div class="actions">
          <button class="btn" id="menuBtn" style="display:none"><i class="fa-solid fa-bars"></i> Menu</button>
          <button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Odśwież</button>
          <button class="btn danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
        </div>
      </div>

      <!-- KPIs -->
      <section class="card" id="kpiCard">
        <h2>Statystyki</h2>
        <div class="kpis">
          <div class="kpi"><i class="fa-solid fa-users"></i><div><div class="num" id="kUsers">—</div><div class="lbl">Użytkownicy</div></div></div>
          <div class="kpi"><i class="fa-solid fa-calendar-check"></i><div><div class="num" id="kReservations">—</div><div class="lbl">Rezerwacje</div></div></div>
          <div class="kpi"><i class="fa-solid fa-user-tie"></i><div><div class="num" id="kEmployees">—</div><div class="lbl">Pracownicy</div></div></div>
          <div class="kpi"><i class="fa-solid fa-coins"></i><div><div class="num" id="kMilkos">—</div><div class="lbl">Milkosy łącznie</div></div></div>
        </div>

        <div class="kpis" style="margin-top:14px">
          <div class="kpi"><i class="fa-solid fa-user-check"></i><div><div class="num" id="kUsersWithPoints">—</div><div class="lbl">Użytkownicy z punktami</div></div></div>
          <div class="kpi"><i class="fa-solid fa-bag-shopping"></i><div><div class="num" id="kOrders">—</div><div class="lbl">Zamówienia</div></div></div>
          <div class="kpi"><i class="fa-solid fa-utensils"></i><div><div class="num" id="kProducts">—</div><div class="lbl">Produkty</div></div></div>
          <div class="kpi"><i class="fa-solid fa-bolt"></i><div><div class="num" id="kAppOps">Problem z Panelem?</div><div class="lbl">Zadzwoń 735 396 534</div></div></div>
        </div>

        <p class="hint">Sekcja „Milki Aplikacja” jest teraz w pełni statyczna (bez backendu).</p>
      </section>

      <!-- TAB: RESERVATIONS -->
      <section class="card" id="tab-reservations">
        <h2>Rezerwacje</h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data / Godzina</th>
                <th>Klient</th>
                <th>Ilość</th>
                <th>Strefa</th>
                <th>Źródło</th>
                <th style="text-align:right">Akcje</th>
              </tr>
            </thead>
            <tbody id="resTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- TAB: HAPPY -->
      <section class="card" id="tab-happy" style="display:none">
        <h2>Pasek info</h2>

        <div class="field">
          <label>Tekst paska</label>
          <textarea class="textarea" id="happyText" placeholder="np. Happy Hour 12:00–16:00 • -20% na shake'i"></textarea>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn" id="happyLoad"><i class="fa-solid fa-download"></i> Wczytaj</button>
          <button class="btn primary" id="happySave"><i class="fa-solid fa-floppy-disk"></i> Zapisz</button>
        </div>
      </section>

      <!-- TAB: USERS -->
      <section class="card" id="tab-users" style="display:none">
        <h2>Użytkownicy</h2>
        <p style="color:var(--muted)">Widok do rozbudowy.</p>
      </section>

      <!-- TAB: EMPLOYEES -->
      <section class="card" id="tab-employees" style="display:none">
        <h2>Pracownicy</h2>
        <p style="color:var(--muted)">Widok do rozbudowy.</p>
      </section>

      <!-- TAB: PICKUP (STATIC) -->
      <section class="card" id="tab-pickup" style="display:none">
        <h2>Zamówienie z odbiorem</h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Klient</th>
                <th>Zamówienie</th>
                <th>Odbiór</th>
              </tr>
            </thead>
            <tbody id="ordersTbody"></tbody>
          </table>
        </div>
        <p class="hint">To jest statyczny podgląd — backend podłączymy później.</p>
      </section>

      <!-- TAB: POINTS (STATIC) -->
      <section class="card" id="tab-points" style="display:none">
        <h2>Punkty Milk</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Milk ID</label>
            <input class="input" id="pMilkId" placeholder="np. MILK-10293">
          </div>
          <div class="field">
            <label>Kwota wydana (zł)</label>
            <input class="input" id="pAmount" type="number" min="0" step="0.01" placeholder="np. 49.99">
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn primary" id="pAdd"><i class="fa-solid fa-plus"></i> Dodaj punkty</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2 style="margin-bottom:6px">Podgląd punktów (lokalnie)</h2>
          <p class="hint" style="margin-top:0">Przelicznik: <b>10 zł = 1 pkt</b>. Punkty są liczone i trzymane tylko w pamięci przeglądarki.</p>
          <div id="pointsPreview" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- TAB: REWARDS (STATIC) -->
      <section class="card" id="tab-rewards" style="display:none">
        <h2>Nagrody</h2>

        <div class="modalgrid" style="margin-top:6px">
          <div class="field">
            <label>Nazwa nagrody</label>
            <input class="input" id="rName" placeholder="np. Darmowy shake 500 ml">
          </div>
          <div class="field">
            <label>Koszt (Milkosy)</label>
            <input class="input" id="rCost" type="number" min="0" step="1" placeholder="np. 20">
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
          <button class="btn primary" id="rAdd"><i class="fa-solid fa-plus"></i> Dodaj nagrodę</button>
        </div>

        <div style="margin-top:12px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Nagroda</th>
                <th>Koszt</th>
                <th style="text-align:right">Akcje</th>
              </tr>
            </thead>
            <tbody id="rewardsTbody"></tbody>
          </table>
        </div>

        <p class="hint">To jest statyczna baza nagród — backend podłączymy później.</p>
      </section>

      <!-- TAB: CLIENTS (STATIC + PIN 5100) -->
      <section class="card" id="tab-clients" style="display:none">
        <h2>Baza klientów</h2>

        <div id="clientsLocked" style="display:block">
          <p style="color:var(--muted)">Dostęp wymaga PIN.</p>
          <div class="modalgrid" style="margin-top:6px">
            <div class="field" style="grid-column:span 2">
              <label>PIN dostępu</label>
              <input class="input" id="cPin" type="password" placeholder="••••">
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end">
            <button class="btn primary" id="cUnlock"><i class="fa-solid fa-unlock"></i> Odblokuj</button>
          </div>
        </div>

        <div id="clientsContent" style="display:none">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Klient</th>
                  <th>Email</th>
                  <th>Telefon</th>
                  <th>Milk ID</th>
                  <th style="text-align:right">Akcje</th>
                </tr>
              </thead>
              <tbody id="clientsTbody"></tbody>
            </table>
          </div>

          <div class="card" style="margin-top:14px;">
            <h2 style="margin-bottom:8px">Aktywność konta</h2>
            <div id="clientActivity">
              Wybierz klienta, aby zobaczyć aktywność.
            </div>
          </div>

          <p class="hint">To jest statyczny widok — backend podłączymy później.</p>
        </div>
      </section>

    </main>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modalbox">
      <div class="modalhead">
        <h3>Edycja rezerwacji</h3>
        <button class="iconbtn" id="editClose" title="Zamknij"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="modalgrid">
        <div class="field"><label>Imię i nazwisko</label><input class="input" id="eName"></div>
        <div class="field"><label>Telefon</label><input class="input" id="ePhone"></div>
        <div class="field"><label>Data</label><input class="input" id="eDate" type="date"></div>
        <div class="field"><label>Godzina</label><input class="input" id="eTime" type="time"></div>
        <div class="field"><label>Ilość osób</label><input class="input" id="eGuests"></div>
        <div class="field"><label>Strefa</label><input class="input" id="eRoom"></div>
        <div class="field" style="grid-column:span 2"><label>Uwagi</label><input class="input" id="eNotes"></div>
        <div class="field"><label>Źródło</label><input class="input" id="eSource" disabled></div>
        <div class="field"><label>Utworzono</label><input class="input" id="eCreated" disabled></div>
      </div>

      <div class="modalfoot">
        <button class="btn" id="editCancel"><i class="fa-regular fa-circle-xmark"></i> Anuluj</button>
        <button class="btn primary" id="editSave"><i class="fa-solid fa-floppy-disk"></i> Zapisz</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">
    <i class="fa-solid fa-circle-check"></i>
    <span id="toastText"></span>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==========================
    // Helpers
    // ==========================
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const state = {
      pin: "",
      unlocked: false,

      reservations: [],
      editingId: null,

      alarmActive: false,
      audioCtx: null,
      beepInterval: null,
      alarmAudio: null,

      // STATIC: Milki Aplikacja
      app: {
        pointsByMilkId: {},  // { MILK-xxx: number }
        rewards: [
          { id: "r1", name: "Darmowy shake 500 ml", cost: 20 },
          { id: "r2", name: "Zniżka -10% na zamówienie", cost: 12 }
        ],
        orders: [
          { id:"o1", date:"2025-12-16", name:"Klaudia Nowak", items:"2x Shake Mango, 1x Fries", pickup:"18:20" },
          { id:"o2", date:"2025-12-16", name:"Mateusz K.", items:"1x Shake Oreo", pickup:"19:05" }
        ],
        clientsPinOk: false,
        clients: [
          {
            id:"c1",
            name:"Anna Kowalska",
            email:"anna@example.com",
            phone:"+48 500 111 222",
            milkId:"MILK-10293",
            activity:[
              { t:"Doładowanie", d:"2025-12-12 14:22", v:"+5 Milkosów (50 zł)" },
              { t:"Nagroda", d:"2025-12-13 19:08", v:"-20 Milkosów — Darmowy shake 500 ml" },
              { t:"Rezerwacja", d:"2025-12-15 12:01", v:"Stolik 3 os. • 18:00" }
            ]
          },
          {
            id:"c2",
            name:"Piotr Zieliński",
            email:"piotr@example.com",
            phone:"+48 501 333 444",
            milkId:"MILK-88401",
            activity:[
              { t:"Doładowanie", d:"2025-12-10 11:40", v:"+3 Milkosy (30 zł)" }
            ]
          }
        ]
      }
    };

    function showToast(msg, bad=false){
      const t = $("#toast");
      const tt = $("#toastText");
      tt.textContent = msg;
      t.style.display = "flex";
      t.style.background = bad ? "rgba(220,38,38,0.14)" : "rgba(22,163,74,0.14)";
      t.style.borderColor = bad ? "rgba(220,38,38,0.25)" : "rgba(22,163,74,0.25)";
      t.querySelector("i").style.color = bad ? "var(--bad)" : "var(--good)";
      setTimeout(()=> t.style.display="none", 3200);
    }

    function fmtDateTime(r){
      const d = (r?.date || "—");
      const t = (r?.time || "—");
      return `${d} • ${t}`;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ==========================
    // ✅ Freeze + anti zoom gestures (lockscreen)
    // ==========================
    function setLockedFreeze(on){
      document.body.classList.toggle("locked", !!on);
    }
    setLockedFreeze(true);

    ["gesturestart","gesturechange","gestureend"].forEach(ev=>{
      window.addEventListener(ev, (e)=> e.preventDefault(), {passive:false});
    });

    let lastTouchEnd = 0;
    document.addEventListener("touchend", (e)=>{
      const now = Date.now();
      if(now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, {passive:false});

    // ==========================
    // ✅ Backend login (PIN not in frontend)
    // POST /api/login {pin:"1234"} => {ok:true}
    // ==========================
    async function verifyPin(pin){
      const res = await fetch("/api/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ pin })
      });
      const data = await res.json().catch(()=>({}));
      return !!(res.ok && data && data.ok);
    }

    // ==========================
    // Lock screen PIN
    // ==========================
    function renderPin(){
      const dots = [$("#p1"), $("#p2"), $("#p3"), $("#p4")];
      dots.forEach((d,i)=> d.classList.toggle("filled", i < state.pin.length));
    }

    function setLockMsg(msg, bad=false){
      const el = $("#lockMsg");
      el.textContent = msg || "";
      el.style.color = bad ? "rgba(220,38,38,0.95)" : "rgba(43,19,0,0.75)";
    }

    function unlock(){
      state.unlocked = true;
      setLockedFreeze(false);
      $("#lock").classList.remove("show");
      $("#app").style.display = "grid";
      showToast("Zalogowano ✅");
      initApp();
    }

    function lock(){
      state.unlocked = false;
      state.pin = "";
      renderPin();
      $("#app").style.display = "none";
      $("#lock").classList.add("show");
      setLockedFreeze(true);
      setLockMsg("");
      stopAlarm();
    }

    let loginBusy = false;

    $("#keypad").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn || loginBusy) return;

      const k = btn.getAttribute("data-k");
      const act = btn.getAttribute("data-act");

      if(k){
        if(state.pin.length >= 4) return;
        state.pin += k;
        renderPin();
        setLockMsg("");

        if(state.pin.length === 4){
          const entered = state.pin;
          state.pin = "";
          renderPin();

          loginBusy = true;
          try{
            const ok = await verifyPin(entered);
            if(ok) unlock();
            else setLockMsg("Błędny PIN", true);
          }catch{
            setLockMsg("Błąd logowania", true);
          }finally{
            loginBusy = false;
          }
        }
        return;
      }

      if(act === "back"){
        state.pin = state.pin.slice(0, -1);
        renderPin();
        setLockMsg("");
      }

      if(act === "ok"){
        const entered = state.pin;
        state.pin = "";
        renderPin();

        loginBusy = true;
        try{
          const ok = await verifyPin(entered);
          if(ok) unlock();
          else setLockMsg("Błędny PIN", true);
        }catch{
          setLockMsg("Błąd logowania", true);
        }finally{
          loginBusy = false;
        }
      }
    });

    // Blokuj klawiaturę systemową na lockscreen (totalny freeze)
    window.addEventListener("keydown", (e)=>{
      if(!$("#lock").classList.contains("show")) return;
      e.preventDefault();
    }, {passive:false});

    $("#logoutBtn").addEventListener("click", lock);

    // ==========================
    // Tabs
    // ==========================
    const tabMeta = {
      reservations: { title:"Rezerwacje" },
      happy: { title:"Pasek info" },
      users: { title:"Użytkownicy" },
      employees: { title:"Pracownicy" },
      pickup: { title:"Zamówienie z odbiorem" },
      points: { title:"Punkty Milk" },
      rewards: { title:"Nagrody" },
      clients: { title:"Baza klientów" },
    };

    function showTab(key){
      $$(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      Object.keys(tabMeta).forEach(k=>{
        const sec = $("#tab-" + k);
        if(sec) sec.style.display = (k === key) ? "block" : "none";
      });
      $("#title").textContent = tabMeta[key]?.title || "Panel";
      $("#subtitle").textContent = "";
    }

    $$(".navbtn").forEach(b => b.addEventListener("click", ()=> showTab(b.dataset.tab)));

    // ==========================
    // API (panel / backend)
    // ==========================
    async function apiHealth(){
      try{
        const res = await fetch("/api/health", {cache:"no-store"});
        const ok = res.ok;
        $("#apiDot").classList.toggle("ok", ok);
        $("#apiDot").classList.toggle("dot", true);
      }catch{
        $("#apiDot").classList.remove("ok");
      }
    }

    async function loadStats(){
      try{
        const res = await fetch("/api/admin/stats", {cache:"no-store"});
        const data = await res.json();
        if(!data?.ok) throw new Error("no ok");

        $("#kUsers").textContent = data.users ?? 0;
        $("#kOrders").textContent = data.orders ?? 0;
        $("#kProducts").textContent = data.products ?? 0;
        $("#kReservations").textContent = data.reservations ?? 0;

        $("#kMilkos").textContent = (data.milkosTotal ?? "—");
        $("#kUsersWithPoints").textContent = (data.usersWithPoints ?? "—");
        $("#kEmployees").textContent = (data.employees ?? "—");

      }catch{
        $("#kUsers").textContent = "—";
        $("#kOrders").textContent = "—";
        $("#kProducts").textContent = "—";
        $("#kReservations").textContent = "—";
        $("#kMilkos").textContent = "—";
        $("#kUsersWithPoints").textContent = "—";
        $("#kEmployees").textContent = "—";
      }
    }

    async function loadReservations(){
      try{
        const res = await fetch("/api/rezerwacje", {cache:"no-store"});
        const list = await res.json();
        state.reservations = Array.isArray(list) ? list : [];
        renderReservations();
        $("#kReservations").textContent = state.reservations.length;
      }catch(e){
        console.error(e);
        showToast("Nie udało się pobrać rezerwacji", true);
      }
    }

    function renderReservations(){
      const tb = $("#resTbody");
      if(!tb) return;
      tb.innerHTML = "";

      if(state.reservations.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
              Brak rezerwacji
            </td>
          </tr>
        `;
        return;
      }

      for(const r of state.reservations){
        const tr = document.createElement("tr");
        const src = (r.source || "index");
        const created = r.createdAt ? new Date(r.createdAt).toLocaleString("pl-PL") : "—";

        tr.innerHTML = `
          <td>
            <div class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(fmtDateTime(r))}</div>
            <div style="color:rgba(43,19,0,0.60);font-size:.82rem;margin-top:6px">Utworzono: ${escapeHtml(created)}</div>
          </td>
          <td>
            <div style="font-weight:900">${escapeHtml(r.name || "—")}</div>
            <div style="color:rgba(43,19,0,0.70);font-size:.9rem;margin-top:4px"><i class="fa-solid fa-phone" style="color:rgba(255,106,0,0.95)"></i> ${escapeHtml(r.phone || "—")}</div>
          </td>
          <td><span class="tag"><i class="fa-solid fa-user-group"></i> ${escapeHtml(r.guests || "—")} <small>os.</small></span></td>
          <td><span class="tag"><i class="fa-solid fa-door-open"></i> ${escapeHtml(r.room || "—")}</span></td>
          <td><span class="tag"><i class="fa-solid fa-globe"></i> ${escapeHtml(src)}</span></td>
          <td>
            <div class="row-actions">
              <button class="iconbtn ok" title="Edytuj" data-act="edit" data-id="${r._id}"><i class="fa-solid fa-pen"></i></button>
              <button class="iconbtn danger" title="Usuń" data-act="del" data-id="${r._id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#resTbody").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(!id || !act) return;

      const r = state.reservations.find(x => x._id === id);
      if(!r) return;

      if(act === "edit"){
        openEdit(r);
      }
      if(act === "del"){
        if(!confirm("Usunąć rezerwację?")) return;
        try{
          const res = await fetch(`/api/rezerwacje/${id}`, { method:"DELETE" });
          const data = await res.json().catch(()=>({}));
          if(!res.ok || data?.ok === false) throw new Error(data?.message || "delete");
          showToast("Usunięto ✅");
          await loadReservations();
          await loadStats();
        }catch(err){
          console.error(err);
          showToast("Błąd usuwania", true);
        }
      }
    });

    // ==========================
    // Edit modal
    // ==========================
    function openEdit(r){
      state.editingId = r._id;
      $("#eName").value = r.name || "";
      $("#ePhone").value = r.phone || "";
      $("#eDate").value = r.date || "";
      $("#eTime").value = r.time || "";
      $("#eGuests").value = r.guests || "";
      $("#eRoom").value = r.room || "";
      $("#eNotes").value = r.notes || "";
      $("#eSource").value = r.source || "index";
      $("#eCreated").value = r.createdAt ? new Date(r.createdAt).toLocaleString("pl-PL") : "—";
      $("#editModal").classList.add("show");
      $("#editModal").setAttribute("aria-hidden","false");
    }
    function closeEdit(){
      state.editingId = null;
      $("#editModal").classList.remove("show");
      $("#editModal").setAttribute("aria-hidden","true");
    }
    $("#editClose").addEventListener("click", closeEdit);
    $("#editCancel").addEventListener("click", closeEdit);
    $("#editModal").addEventListener("click", (e)=>{ if(e.target.id === "editModal") closeEdit(); });

    $("#editSave").addEventListener("click", async ()=>{
      const id = state.editingId;
      if(!id) return;

      const payload = {
        name: $("#eName").value,
        phone: $("#ePhone").value,
        date: $("#eDate").value,
        time: $("#eTime").value,
        guests: $("#eGuests").value,
        room: $("#eRoom").value,
        notes: $("#eNotes").value
      };

      try{
        const res = await fetch(`/api/rezerwacje/${id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false) throw new Error(data?.message || "edit");
        showToast("Zapisano ✅");
        closeEdit();
        await loadReservations();
      }catch(err){
        console.error(err);
        showToast("Błąd zapisu", true);
      }
    });

    // ==========================
    // Happy bar
    // ==========================
    async function loadHappy(){
      try{
        const res = await fetch("/api/happy", {cache:"no-store"});
        const data = await res.json();
        if(!data?.ok) throw new Error("happy");
        $("#happyText").value = data.happy || "";
        showToast("Wczytano ✅");
      }catch(e){
        console.error(e);
        showToast("Błąd wczytywania paska", true);
      }
    }
    async function saveHappy(){
      try{
        const text = $("#happyText").value || "";
        const res = await fetch("/api/happy", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ happy: text })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false) throw new Error(data?.message || "save");
        showToast("Zapisano ✅");
      }catch(e){
        console.error(e);
        showToast("Błąd zapisu paska", true);
      }
    }
    $("#happyLoad").addEventListener("click", loadHappy);
    $("#happySave").addEventListener("click", saveHappy);

    // ==========================
    // ✅ Alarm: bardzo głośny dźwięk (loop) do OK
    // Upewnij się, że backend serwuje /alarm.mp3 (głośny plik)
    // ==========================
    function ensureAlarmAudio(){
      if(state.alarmAudio) return;
      state.alarmAudio = new Audio("/alarm.mp3");
      state.alarmAudio.loop = true;
      state.alarmAudio.preload = "auto";
      state.alarmAudio.volume = 1.0;
    }

    // fallback oscillator
    function ensureAudio(){
      if(state.audioCtx) return;
      try{ state.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      catch(e){ state.audioCtx = null; }
    }
    function beepOnce(){
      if(!state.audioCtx) return;
      const ctx = state.audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = 1100;   // wyżej = bardziej “alarmowo”
      g.gain.value = 0.14;        // głośniej (oscillator)
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} }, 140);
    }

    function startAlarm(reservation){
      if(state.alarmActive) return;
      state.alarmActive = true;

      $("#alarmPreview").innerHTML = `
        <div class="line">
          <i class="fa-solid fa-user"></i>
          <div><b>${escapeHtml(reservation?.name || "—")}</b> <span class="muted">•</span> ${escapeHtml(reservation?.phone || "—")}</div>
        </div>
        <div class="line">
          <i class="fa-solid fa-calendar-day"></i>
          <div>${escapeHtml(reservation?.date || "—")} <span class="muted">•</span> ${escapeHtml(reservation?.time || "—")}</div>
        </div>
        <div class="line">
          <i class="fa-solid fa-user-group"></i>
          <div>${escapeHtml(reservation?.guests || "—")} <span class="muted">os.</span></div>
        </div>
        <div class="line">
          <i class="fa-solid fa-door-open"></i>
          <div>${escapeHtml(reservation?.room || "—")}</div>
        </div>
        <div class="line" style="margin-bottom:0">
          <i class="fa-solid fa-note-sticky"></i>
          <div class="muted">${escapeHtml(reservation?.notes || "—")}</div>
        </div>
      `;

      const alarm = $("#alarm");
      alarm.classList.add("show");
      alarm.classList.add("flash");

      // Prefer mp3 loop
      ensureAlarmAudio();
      try{
        state.alarmAudio.currentTime = 0;
        state.alarmAudio.volume = 1.0;
        state.alarmAudio.play().catch(()=>{
          // fallback oscillator loop
          ensureAudio();
          if(state.audioCtx && state.audioCtx.state === "suspended"){
            state.audioCtx.resume().catch(()=>{});
          }
          beepOnce();
          state.beepInterval = setInterval(beepOnce, 280);
        });
      }catch{
        ensureAudio();
        beepOnce();
        state.beepInterval = setInterval(beepOnce, 280);
      }
    }

    function stopAlarm(){
      state.alarmActive = false;
      const alarm = $("#alarm");
      alarm.classList.remove("show");
      alarm.classList.remove("flash");

      if(state.beepInterval){
        clearInterval(state.beepInterval);
        state.beepInterval = null;
      }
      if(state.alarmAudio){
        try{
          state.alarmAudio.pause();
          state.alarmAudio.currentTime = 0;
        }catch(e){}
      }
    }

    $("#alarmOk").addEventListener("click", ()=>{
      stopAlarm();
      showToast("Potwierdzono ✅");
    });

    // ==========================
    // Realtime (Socket.IO)
    // ==========================
    let socket = null;

    function initSocket(){
      try{
        socket = io();

        socket.on("new-reservation", async (reservation)=>{
          startAlarm(reservation);
          await loadReservations();
          await loadStats();
        });

        socket.on("happy-updated", (text)=>{
          if($("#tab-happy").style.display !== "none"){
            $("#happyText").value = text || "";
          }
          showToast("Pasek zaktualizowany ✅");
        });

      }catch(e){
        console.error("Socket init error", e);
      }
    }

    // ==========================
    // STATIC: Milki Aplikacja
    // ==========================
    function renderOrders(){
      const tb = $("#ordersTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.app.orders || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr><td colspan="4" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
            Brak zamówień
          </td></tr>
        `;
        return;
      }

      for(const o of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="tag"><i class="fa-regular fa-calendar"></i> ${escapeHtml(o.date)}</span></td>
          <td style="font-weight:900">${escapeHtml(o.name)}</td>
          <td>${escapeHtml(o.items)}</td>
          <td><span class="tag"><i class="fa-regular fa-clock"></i> ${escapeHtml(o.pickup)}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    function calcPointsFromAmount(amount){
      const a = Number(amount);
      if(!isFinite(a) || a <= 0) return 0;
      return Math.floor(a / 10);
    }

    function renderPointsPreview(){
      const box = $("#pointsPreview");
      if(!box) return;
      const entries = Object.entries(state.app.pointsByMilkId || {});
      if(entries.length === 0){
        box.innerHTML = `<span class="muted">Brak danych.</span>`;
        return;
      }
      box.innerHTML = entries
        .sort((a,b)=> b[1]-a[1])
        .map(([id, pts]) => `<div class="tag" style="margin:6px 8px 0 0"><i class="fa-solid fa-id-badge"></i> ${escapeHtml(id)} <small>•</small> ${escapeHtml(pts)} pkt</div>`)
        .join("");
    }

    $("#pAdd").addEventListener("click", ()=>{
      const milkId = ($("#pMilkId").value || "").trim();
      const amount = $("#pAmount").value;

      if(!milkId){
        showToast("Podaj Milk ID", true);
        return;
      }
      const pts = calcPointsFromAmount(amount);
      if(pts <= 0){
        showToast("Kwota za mała (min. 10 zł = 1 pkt)", true);
        return;
      }

      const cur = state.app.pointsByMilkId[milkId] || 0;
      state.app.pointsByMilkId[milkId] = cur + pts;

      $("#pMilkId").value = "";
      $("#pAmount").value = "";

      renderPointsPreview();
      showToast(`Dodano +${pts} pkt ✅`);
    });

    function renderRewards(){
      const tb = $("#rewardsTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.app.rewards || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr><td colspan="3" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
            Brak nagród
          </td></tr>
        `;
        return;
      }

      for(const r of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="font-weight:900">${escapeHtml(r.name)}</td>
          <td><span class="tag"><i class="fa-solid fa-coins"></i> ${escapeHtml(r.cost)} <small>Milkosów</small></span></td>
          <td style="text-align:right">
            <button class="iconbtn danger" data-rid="${escapeHtml(r.id)}" title="Usuń"><i class="fa-solid fa-trash"></i></button>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    $("#rAdd").addEventListener("click", ()=>{
      const name = ($("#rName").value || "").trim();
      const cost = Number($("#rCost").value);

      if(!name){
        showToast("Podaj nazwę nagrody", true);
        return;
      }
      if(!isFinite(cost) || cost <= 0){
        showToast("Podaj poprawny koszt", true);
        return;
      }

      state.app.rewards.push({ id: "r" + Math.random().toString(16).slice(2), name, cost: Math.floor(cost) });
      $("#rName").value = "";
      $("#rCost").value = "";
      renderRewards();
      showToast("Dodano nagrodę ✅");
    });

    $("#rewardsTbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-rid");
      if(!id) return;
      state.app.rewards = state.app.rewards.filter(x => x.id !== id);
      renderRewards();
      showToast("Usunięto ✅");
    });

    function renderClients(){
      const tb = $("#clientsTbody");
      if(!tb) return;
      tb.innerHTML = "";

      const list = state.app.clients || [];
      if(list.length === 0){
        tb.innerHTML = `
          <tr><td colspan="5" style="text-align:center;color:rgba(43,19,0,0.65);padding:18px;border-radius:16px;background:rgba(255,255,255,0.86);border:1px solid rgba(43,19,0,0.12)">
            Brak klientów
          </td></tr>
        `;
        return;
      }

      for(const c of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="font-weight:900">${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.email)}</td>
          <td>${escapeHtml(c.phone)}</td>
          <td><span class="tag"><i class="fa-solid fa-id-badge"></i> ${escapeHtml(c.milkId)}</span></td>
          <td style="text-align:right">
            <button class="iconbtn ok" data-cid="${escapeHtml(c.id)}" title="Podgląd"><i class="fa-solid fa-eye"></i></button>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderClientActivity(client){
      const box = $("#clientActivity");
      if(!box) return;
      if(!client){
        box.textContent = "Wybierz klienta, aby zobaczyć aktywność.";
        return;
      }

      const items = client.activity || [];
      if(items.length === 0){
        box.innerHTML = `<span class="muted">Brak aktywności.</span>`;
        return;
      }

      box.innerHTML = items.map(a => `
        <div class="tag" style="display:flex;justify-content:space-between;gap:10px;width:100%;margin-top:10px">
          <span><i class="fa-solid fa-circle-dot"></i> ${escapeHtml(a.t)} <small>•</small> ${escapeHtml(a.v)}</span>
          <small class="muted" style="opacity:.9">${escapeHtml(a.d)}</small>
        </div>
      `).join("");
    }

    $("#cUnlock").addEventListener("click", ()=>{
      const pin = ($("#cPin").value || "").trim();
      if(pin !== "5100"){
        showToast("Błędny PIN", true);
        return;
      }
      state.app.clientsPinOk = true;
      $("#clientsLocked").style.display = "none";
      $("#clientsContent").style.display = "block";
      renderClients();
      renderClientActivity(null);
      showToast("Odblokowano ✅");
    });

    $("#clientsTbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-cid");
      if(!id) return;
      const client = (state.app.clients || []).find(x => x.id === id);
      renderClientActivity(client);
      showToast("Podgląd klienta ✅");
    });

    // ==========================
    // Mobile drawer sidebar
    // ==========================
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("overlay");
    const menuBtn = document.getElementById("menuBtn");

    function openMenu(){
      sidebar?.classList.add("open");
      overlay?.classList.add("show");
    }
    function closeMenu(){
      sidebar?.classList.remove("open");
      overlay?.classList.remove("show");
    }

    menuBtn?.addEventListener("click", ()=>{
      if(sidebar?.classList.contains("open")) closeMenu();
      else openMenu();
    });
    overlay?.addEventListener("click", closeMenu);

    document.querySelectorAll(".navbtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        if(window.matchMedia("(max-width: 920px)").matches) closeMenu();
      });
    });

    window.addEventListener("resize", ()=>{
      if(!window.matchMedia("(max-width: 920px)").matches){
        closeMenu();
      }
    });

    // ==========================
    // ✅ PWA service worker
    // ==========================
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("/sw.js").catch(()=>{});
      });
    }

    // ==========================
    // Init
    // ==========================
    async function initApp(){
      showTab("reservations");
      initSocket();

      await apiHealth();
      await loadStats();
      await loadReservations();
      await loadHappy();

      renderOrders();
      renderPointsPreview();
      renderRewards();
    }

    $("#refreshBtn").addEventListener("click", async ()=>{
      await apiHealth();
      await loadStats();
      await loadReservations();
      showToast("Odświeżono ✅");
    });

    setInterval(()=>{
      const now = new Date();
      $("#clock").innerHTML = `<i class="fa-regular fa-clock"></i> ${now.toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"})}`;
    }, 1000);

    setInterval(apiHealth, 6000);

    renderPin();
  </script>
</body>
</html>
