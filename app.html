<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FF6A00" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Milk — Aplikacja</title>

  <!-- Fonts / Icons (opcjonalnie) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Manifest + icons (jeśli masz) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg0:#0a0a0d;
      --bg1:#0e0e12;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text:#f4f4f6;
      --muted: rgba(244,244,246,.72);
      --muted2: rgba(244,244,246,.55);
      --orange:#FF6A00;
      --orange2:#FF9100;
      --good:#37d67a;
      --bad:#ff4d4f;
      --warn:#ffb020;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 16px;
      --radius3: 14px;
      --pad: 16px;
      --pad2: 12px;
      --max: 920px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 18% -10%, rgba(255,106,0,.25), transparent 60%),
        radial-gradient(1100px 700px at 90% 0%, rgba(255,145,0,.18), transparent 65%),
        radial-gradient(900px 650px at 40% 110%, rgba(255,106,0,.20), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding-bottom: 96px; /* miejsce na bottom nav */
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }

    /* blobs */
    .blob{
      position:fixed;
      width: 520px;
      height: 520px;
      border-radius: 50%;
      filter: blur(40px);
      opacity:.35;
      pointer-events:none;
      z-index:-1;
      transform: translate3d(0,0,0);
    }
    .blob.b1{left:-220px; top:-220px; background:rgba(255,106,0,.55)}
    .blob.b2{right:-240px; top:-180px; background:rgba(255,145,0,.45)}
    .blob.b3{left:10%; bottom:-260px; background:rgba(255,106,0,.40)}

    /* layout */
    .wrap{
      width: min(var(--max), calc(100% - 22px));
      margin: 0 auto;
      padding: 14px 0 0;
    }

    /* topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 14px 0 10px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(10,10,13,.88), rgba(10,10,13,.65));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .topbar-inner{
      width: min(var(--max), calc(100% - 22px));
      margin: 0 auto;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background:
        radial-gradient(16px 16px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, var(--orange), var(--orange2));
      box-shadow: 0 10px 30px rgba(255,106,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      min-width:0;
    }
    .brand-title b{font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .brand-title span{font-size:11px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .spacer{flex:1}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill i{opacity:.9}
    .pill strong{font-size: 13px}
    .pill .muted{color:var(--muted2); font-weight:500}

    /* cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding: var(--pad);}
    .card-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0 0 10px;
    }
    .card-title h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }
    .chip .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(55,214,122,.12);
    }
    .chip.warn .dot{background: var(--warn); box-shadow: 0 0 0 4px rgba(255,176,32,.12);}
    .chip.bad .dot{background: var(--bad); box-shadow: 0 0 0 4px rgba(255,77,79,.12);}

    /* sections */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 12px 0 0;
    }
    @media (min-width: 860px){
      .grid.two{grid-template-columns: 1.1fr .9fr}
      .grid.three{grid-template-columns: 1fr 1fr 1fr}
    }

    /* mini buttons */
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      user-select:none;
      font-family: inherit;
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 600;
      font-size: 13px;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 34px rgba(255,106,0,.22);
      color:#111;
    }
    .btn.ghost{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:none;
    }
    .btn.danger{
      background: rgba(255,77,79,.10);
      border: 1px solid rgba(255,77,79,.20);
      box-shadow:none;
    }
    .btn.small{padding: 9px 12px; border-radius: 14px; font-size: 12px; gap:8px}
    .btn.wide{width:100%}

    /* info text */
    .muted{color: var(--muted)}
    .muted2{color: var(--muted2)}
    .tiny{font-size: 11px}
    .sep{height:1px;background:rgba(255,255,255,.08); margin: 12px 0}

    /* quick actions */
    .qa{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .qa .btn{justify-content:flex-start}
    .qa .btn i{opacity:.9}

    /* opening hours */
    .hours{
      display:flex; flex-direction:column; gap:10px;
    }
    .hours-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hours-badge{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      min-width: 0;
    }
    .hours-badge .ico{
      width: 34px; height:34px; border-radius: 14px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      flex: 0 0 auto;
    }
    .hours-badge .txt{min-width:0}
    .hours-badge b{display:block; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .hours-badge span{display:block; font-size: 11px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .hours-list{
      display:none;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
    }
    .hours-list .row{
      display:flex; align-items:center; justify-content:space-between;
      padding: 7px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
      font-size: 12px;
    }
    .hours-list .row:last-child{border-bottom:0}
    .hours-list .row b{font-weight:600}
    .hours-open .hours-list{display:block}

    /* bottom nav */
    .bottom-nav{
      position: fixed;
      left: 0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      z-index: 30;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(10,10,13,.0), rgba(10,10,13,.82) 35%, rgba(10,10,13,.92));
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .bottom-inner{
      width: min(var(--max), calc(100% - 22px));
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .navbtn{
      border:0;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 10px 8px;
      color: var(--muted);
      font-family: inherit;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      font-size: 10px;
      line-height:1;
      transition: transform .12s ease;
    }
    .navbtn i{font-size: 16px}
    .navbtn:active{transform: scale(.98)}
    .navbtn.active{
      color:#111;
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 34px rgba(255,106,0,.22);
    }

    /* tabs/pages */
    .page{display:none; margin-top: 12px;}
    .page.active{display:block}

    /* lists / items */
    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .item .left{min-width:0}
    .item b{display:block; font-size: 13px; margin-bottom: 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .item span{display:block; font-size: 11px; color: var(--muted2)}
    .item .right{display:flex; flex-direction:column; align-items:flex-end; gap:6px; flex: 0 0 auto;}
    .price{
      font-weight:700;
      font-size: 13px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    /* order chips */
    .cats{
      display:flex;
      gap: 8px;
      overflow:auto;
      padding-bottom: 2px;
      scrollbar-width: none;
    }
    .cats::-webkit-scrollbar{display:none}
    .cat{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:600;
      cursor:pointer;
      white-space: nowrap;
    }
    .cat.active{
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      color:#111;
      border: 1px solid rgba(255,255,255,.16);
    }

    /* cart FAB */
    .fab{
      position: fixed;
      right: 14px;
      bottom: 92px;
      z-index: 35;
      border:0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 999px;
      color:#111;
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      box-shadow: 0 16px 45px rgba(255,106,0,.25);
      display:flex;
      align-items:center;
      gap:10px;
      font-family: inherit;
      font-weight: 800;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,.16);
    }
    .fab .badge{
      background: rgba(17,17,17,.14);
      border: 1px solid rgba(17,17,17,.12);
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color:#111;
    }
    @media (min-width: 860px){
      .fab{right: 26px}
    }

    /* forms */
    .form{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row2{grid-template-columns: 1fr}
    }
    label{
      font-size: 11px;
      color: var(--muted2);
      display:block;
      margin: 2px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      font-family: inherit;
      font-size: 13px;
    }
    textarea{min-height: 84px; resize: vertical}

    /* modal */
    .modal{
      position:fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index: 60;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(6px);
    }
    .modal.show{display:flex}
    .sheet{
      width: min(var(--max), 100%);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(20,20,26,.94), rgba(15,15,20,.92));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
      max-height: 86vh;
      display:flex;
      flex-direction:column;
    }
    .sheet-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sheet-head b{font-size: 14px}
    .sheet-body{
      padding: 14px 16px 16px;
      overflow:auto;
    }

    /* toast */
    .toasts{
      position: fixed;
      left: 12px;
      right: 12px;
      top: calc(12px + env(safe-area-inset-top));
      z-index: 80;
      display:flex;
      flex-direction:column;
      gap: 10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .toast i{margin-top:2px}
    .toast b{display:block; font-size: 12px; margin-bottom:2px}
    .toast span{display:block; font-size: 11px; color: var(--muted2)}
    .toast.good i{color: var(--good)}
    .toast.bad i{color: var(--bad)}
    .toast.warn i{color: var(--warn)}

    /* install overlay */
    .install{
      position:fixed;
      inset:0;
      z-index: 90;
      display:none;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      align-items:center;
      justify-content:center;
    }
    .install.show{display:flex}
    .install-card{
      width: min(560px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(20,20,26,.92), rgba(15,15,20,.90));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 90px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .install-card .head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .install-card .body{padding: 14px 16px 16px}
    .steps{
      display:flex; flex-direction:column; gap: 10px;
      margin: 10px 0 0;
    }
    .step{
      display:flex; gap: 10px; align-items:flex-start;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
    }
    .step .n{
      width: 28px; height:28px; border-radius: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size: 12px;
      flex: 0 0 auto;
    }
    .step b{display:block; font-size: 12px}
    .step span{display:block; font-size: 11px; color: var(--muted2)}

    /* helper */
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <!-- TOASTS -->
  <div class="toasts" id="toasts"></div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">M</div>
        <div class="brand-title">
          <b>Milk</b>
          <span id="subTitle">Aplikacja lojalnościowa</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" title="Twoje punkty">
        <i class="fa-solid fa-star"></i>
        <span class="muted">Punkty:</span>
        <strong id="pointsPill">0</strong>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- PAGE: POINTS -->
    <section class="page active" id="page-points">
      <div class="grid two">
        <div class="card">
          <div class="card-inner">
            <div class="card-title">
              <h3><i class="fa-solid fa-bolt"></i> Szybkie akcje</h3>
              <span class="chip"><span class="dot"></span> aktywne</span>
            </div>

            <div class="qa">
              <button class="btn" id="btnShowMilkId"><i class="fa-solid fa-id-badge"></i> Milk ID</button>
              <button class="btn" id="btnGoRewards"><i class="fa-solid fa-gift"></i> Nagrody</button>
              <button class="btn" id="btnGoOrder"><i class="fa-solid fa-bag-shopping"></i> Zamów i odbierz</button>
              <button class="btn" id="btnGoRes"><i class="fa-solid fa-calendar-check"></i> Rezerwacje</button>
            </div>

            <div class="sep"></div>

            <div class="card-title" style="margin-bottom:6px;">
              <h3><i class="fa-solid fa-store"></i> Godziny otwarcia</h3>
              <button class="btn ghost small" id="btnToggleHours"><i class="fa-solid fa-chevron-down"></i></button>
            </div>

            <div class="hours" id="hoursCard">
              <div class="hours-top">
                <div class="hours-badge">
                  <div class="ico"><i class="fa-solid fa-clock"></i></div>
                  <div class="txt">
                    <b id="openStatus">Sprawdzam…</b>
                    <span id="openHint">Kliknij, aby rozwinąć harmonogram</span>
                  </div>
                </div>
                <button class="btn primary small" id="btnCall"><i class="fa-solid fa-phone"></i> Zadzwoń</button>
              </div>

              <div class="hours-list" id="hoursList">
                <div class="row"><span>Pon</span><b>11:00 – 22:00</b></div>
                <div class="row"><span>Wt</span><b>11:00 – 22:00</b></div>
                <div class="row"><span>Śr</span><b>11:00 – 22:00</b></div>
                <div class="row"><span>Czw</span><b>11:00 – 22:00</b></div>
                <div class="row"><span>Pt</span><b>11:00 – 23:00</b></div>
                <div class="row"><span>Sob</span><b>11:00 – 23:00</b></div>
                <div class="row"><span>Nie</span><b>11:00 – 22:00</b></div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="card-title" style="margin-bottom:6px;">
              <h3><i class="fa-solid fa-chart-line"></i> Postęp</h3>
              <span class="chip"><i class="fa-solid fa-star"></i> <span id="pointsBig">0</span> pkt</span>
            </div>

            <div class="tiny muted2">
              Zbieraj punkty i wymieniaj na nagrody. Historia poniżej pokazuje ostatnie zmiany.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-title">
              <h3><i class="fa-solid fa-clock-rotate-left"></i> Historia punktów</h3>
              <button class="btn ghost small" id="btnClearHistory"><i class="fa-solid fa-broom"></i> Wyczyść</button>
            </div>

            <div class="list" id="pointsHistory">
              <!-- wypełni JS -->
              <div class="item">
                <div class="left">
                  <b>Brak historii</b>
                  <span>Gdy pojawią się punkty, pokażemy wpisy tutaj.</span>
                </div>
                <div class="right">
                  <div class="price">—</div>
                </div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="card-title" style="margin-bottom:6px;">
              <h3><i class="fa-solid fa-bullhorn"></i> Szybka informacja</h3>
            </div>

            <div class="item" style="align-items:center;">
              <div class="left">
                <b>Eatmi.pl</b>
                <span class="muted2">Zamawiaj online — odbierz w lokalu.</span>
              </div>
              <div class="right">
                <button class="btn primary small" id="btnOpenEatmi"><i class="fa-solid fa-arrow-up-right-from-square"></i> Otwórz</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: REWARDS -->
    <section class="page" id="page-rewards">
      <div class="card">
        <div class="card-inner">
          <div class="card-title">
            <h3><i class="fa-solid fa-gift"></i> Nagrody</h3>
            <span class="chip"><i class="fa-solid fa-star"></i> <span id="pointsRewards">0</span> pkt</span>
          </div>

          <!-- docelowo JS wyrenderuje, ale już masz poprawne “nowe nagrody” w HTML -->
          <div class="list" id="rewardsList">
            <div class="item">
              <div class="left">
                <b>Milkshake do 30 PLN</b>
                <span>Wymagane: <strong>25 pkt</strong></span>
              </div>
              <div class="right">
                <div class="price">25 pkt</div>
                <button class="btn primary small" data-reward="milkshake-30"><i class="fa-solid fa-check"></i> Odbierz</button>
              </div>
            </div>

            <div class="item">
              <div class="left">
                <b>Zestaw burger do 60 PLN</b>
                <span>Wymagane: <strong>50 pkt</strong></span>
              </div>
              <div class="right">
                <div class="price">50 pkt</div>
                <button class="btn primary small" data-reward="burger-60"><i class="fa-solid fa-check"></i> Odbierz</button>
              </div>
            </div>

            <div class="item">
              <div class="left">
                <b>Zamówienie do 120 PLN</b>
                <span>Wymagane: <strong>100 pkt</strong></span>
              </div>
              <div class="right">
                <div class="price">100 pkt</div>
                <button class="btn primary small" data-reward="order-120"><i class="fa-solid fa-check"></i> Odbierz</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>
          <div class="tiny muted2">
            Nagrody są odejmowane z punktów. Szczegóły i potwierdzenie obsługuje skrypt.
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: ORDER -->
    <section class="page" id="page-order">
      <div class="card">
        <div class="card-inner">
          <div class="card-title">
            <h3><i class="fa-solid fa-bag-shopping"></i> Zamów i odbierz</h3>
            <span class="chip warn"><span class="dot"></span> Rowy wyłączone</span>
          </div>

          <div class="tiny muted2">
            Wybierz kategorię, dodaj produkty do koszyka i uzupełnij dane odbioru.
          </div>

          <div class="sep"></div>

          <div class="card-title" style="margin-bottom:8px;">
            <h3><i class="fa-solid fa-layer-group"></i> Kategorie</h3>
          </div>
          <div class="cats" id="orderCats">
            <!-- wypełni JS (kategorie z wbudowanego menu) -->
            <button class="cat active" data-cat="all">Wszystko</button>
            <button class="cat" data-cat="kawa-herbata">Kawa / Herbata</button>
            <button class="cat" data-cat="napoje-soki">Napoje / Soki</button>
            <button class="cat" data-cat="shake">Shakes</button>
            <button class="cat" data-cat="deser">Desery</button>
            <button class="cat" data-cat="texmex">Tex Mex</button>
            <button class="cat" data-cat="kanapki">Kanapki</button>
            <button class="cat" data-cat="burger">Burgery</button>
            <button class="cat" data-cat="sniadania">Śniadania</button>
          </div>

          <div class="sep"></div>

          <div class="card-title" style="margin-bottom:8px;">
            <h3><i class="fa-solid fa-list"></i> Menu</h3>
            <span class="chip"><i class="fa-solid fa-filter"></i> <span id="menuCount">0</span></span>
          </div>

          <div class="list" id="menuList">
            <!-- wypełni JS (już bez menu.json) -->
            <div class="item">
              <div class="left">
                <b>Menu ładuje się…</b>
                <span>Za chwilę pojawią się pozycje.</span>
              </div>
              <div class="right">
                <div class="price">—</div>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="card-title" style="margin-bottom:8px;">
            <h3><i class="fa-solid fa-receipt"></i> Dane odbioru</h3>
          </div>

          <form class="form" id="orderForm" autocomplete="on">
            <div class="row2">
              <div>
                <label>Imię i nazwisko</label>
                <input id="orderName" placeholder="np. Klaudia Zacharska" />
              </div>
              <div>
                <label>Telefon</label>
                <input id="orderPhone" placeholder="np. 600 000 000" inputmode="tel" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Godzina odbioru</label>
                <input id="orderTime" type="time" />
                <div class="tiny muted2" id="orderTimeHint" style="margin-top:6px;">
                  Minimalny czas przygotowania ustawiony w skrypcie.
                </div>
              </div>
              <div>
                <label>Lokalizacja</label>
                <select id="orderPlace">
                  <option value="slupsk">Słupsk</option>
                  <option value="rowy" disabled>Rowy (wyłączone)</option>
                </select>
              </div>
            </div>

            <div>
              <label>Uwagi (opcjonalnie)</label>
              <textarea id="orderNotes" placeholder="np. bez sosu, extra lód…"></textarea>
            </div>

            <button class="btn primary wide" type="button" id="btnCheckout">
              <i class="fa-solid fa-paper-plane"></i> Złóż zamówienie
            </button>

            <div class="tiny muted2">
              Zamówienia zapisują się po stronie serwera (a w razie potrzeby lokalnie).
            </div>
          </form>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="card-inner">
            <div class="card-title">
              <h3><i class="fa-solid fa-clock-rotate-left"></i> Twoje zamówienia</h3>
              <button class="btn ghost small" id="btnReloadOrders"><i class="fa-solid fa-rotate"></i> Odśwież</button>
            </div>

            <div class="list" id="ordersList">
              <!-- wypełni JS -->
              <div class="item">
                <div class="left">
                  <b>Brak zamówień</b>
                  <span>Gdy złożysz zamówienie, pokażemy je tutaj.</span>
                </div>
                <div class="right">
                  <div class="price">—</div>
                </div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="tiny muted2">
              Odświeżanie listy zamówień jest niezależne od „ustawień aplikacji”.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: RESERVATIONS -->
    <section class="page" id="page-res">
      <div class="card">
        <div class="card-inner">
          <div class="card-title">
            <h3><i class="fa-solid fa-calendar-check"></i> Rezerwacje</h3>
            <span class="chip"><i class="fa-solid fa-lock"></i> wymagane konto</span>
          </div>

          <form class="form" id="resForm">
            <div class="row2">
              <div>
                <label>Data</label>
                <input id="resDate" type="date" />
              </div>
              <div>
                <label>Godzina</label>
                <input id="resTime" type="time" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Liczba osób</label>
                <input id="resPeople" type="number" min="1" max="20" value="2" />
              </div>
              <div>
                <label>Lokalizacja</label>
                <select id="resPlace">
                  <option value="slupsk">Słupsk</option>
                  <option value="rowy">Rowy</option>
                </select>
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Telefon</label>
                <input id="resPhone" placeholder="np. 600 000 000" inputmode="tel" />
              </div>
              <div>
                <label>Imię</label>
                <input id="resName" placeholder="np. Klaudia" />
              </div>
            </div>

            <div>
              <label>Uwagi (opcjonalnie)</label>
              <textarea id="resNotes" placeholder="np. stolik przy oknie…"></textarea>
            </div>

            <button class="btn primary wide" type="button" id="btnCreateRes">
              <i class="fa-solid fa-plus"></i> Dodaj rezerwację
            </button>
            <div class="tiny muted2">Rezerwacje są zapisywane na serwerze lub lokalnie, jeśli brak połączenia.</div>
          </form>

          <div class="sep"></div>

          <div class="card-title">
            <h3><i class="fa-solid fa-list"></i> Twoje rezerwacje</h3>
            <button class="btn ghost small" id="btnReloadRes"><i class="fa-solid fa-rotate"></i> Odśwież</button>
          </div>

          <div class="list" id="resList">
            <div class="item">
              <div class="left">
                <b>Brak rezerwacji</b>
                <span>Dodaj pierwszą rezerwację formularzem powyżej.</span>
              </div>
              <div class="right">
                <div class="price">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: ACCOUNT -->
    <section class="page" id="page-account">
      <div class="grid two">
        <div class="card">
          <div class="card-inner">
            <div class="card-title">
              <h3><i class="fa-solid fa-user"></i> Konto</h3>
              <span class="chip" id="authChip"><i class="fa-solid fa-user-slash"></i> niezalogowano</span>
            </div>

            <div id="accountLoggedOut">
              <div class="tiny muted2">Zaloguj się, aby mieć Milk ID, rezerwacje i synchronizację.</div>
              <div class="sep"></div>
              <div class="qa" style="grid-template-columns:1fr;">
                <button class="btn primary" id="btnLoginGoogle"><i class="fa-brands fa-google"></i> Zaloguj (Google)</button>
                <button class="btn" id="btnLoginEmail"><i class="fa-solid fa-envelope"></i> Zaloguj e-mail</button>
              </div>
            </div>

            <div id="accountLoggedIn" class="hide">
              <div class="item" style="align-items:center;">
                <div class="left">
                  <b id="userName">Użytkownik</b>
                  <span id="userEmail" class="muted2">email@…</span>
                </div>
                <div class="right">
                  <button class="btn danger small" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
                </div>
              </div>

              <div class="sep"></div>

              <div class="qa" style="grid-template-columns:1fr 1fr;">
                <button class="btn" id="btnProfile"><i class="fa-solid fa-id-card"></i> Profil</button>
                <button class="btn" id="btnSettings"><i class="fa-solid fa-gear"></i> Ustawienia</button>
              </div>

              <div class="sep"></div>

              <div class="tiny muted2">
                Synchronizacja i pobieranie danych realizuje przycisk „Synchronizuj” w profilu (jeśli go używasz w skrypcie).
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-title">
              <h3><i class="fa-solid fa-sliders"></i> Ustawienia aplikacji</h3>
            </div>

            <!-- UWAGA: zgodnie z Twoją prośbą NIE ma tu przycisku “odśwież dane z serwera” -->
            <div class="list">
              <div class="item" style="align-items:center;">
                <div class="left">
                  <b>Język</b>
                  <span class="muted2">Interfejs aplikacji</span>
                </div>
                <div class="right" style="min-width:140px;">
                  <select id="langSelect">
                    <option value="pl">Polski</option>
                    <option value="en">English</option>
                  </select>
                </div>
              </div>

              <div class="item" style="align-items:center;">
                <div class="left">
                  <b>Powiadomienia</b>
                  <span class="muted2">Włącz / wyłącz</span>
                </div>
                <div class="right">
                  <button class="btn ghost small" id="btnPush"><i class="fa-solid fa-bell"></i> Ustaw</button>
                </div>
              </div>

              <div class="item" style="align-items:center;">
                <div class="left">
                  <b>Pomoc</b>
                  <span class="muted2">Najczęstsze pytania</span>
                </div>
                <div class="right">
                  <button class="btn ghost small" id="btnHelp"><i class="fa-solid fa-circle-question"></i> Otwórz</button>
                </div>
              </div>

              <div class="item" style="align-items:center;">
                <div class="left">
                  <b>O aplikacji</b>
                  <span class="muted2">Wersja i informacje</span>
                </div>
                <div class="right">
                  <button class="btn ghost small" id="btnAbout"><i class="fa-solid fa-circle-info"></i> Otwórz</button>
                </div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="tiny muted2">
              Brak przycisku “Odśwież dane z serwera” — usunięty zgodnie z Twoją prośbą.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- CART FAB -->
  <button class="fab" id="fabCart" title="Koszyk">
    <i class="fa-solid fa-cart-shopping"></i>
    <span>Koszyk</span>
    <span class="badge" id="cartCount">0</span>
  </button>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="bottom-inner">
      <button class="navbtn active" data-nav="points">
        <i class="fa-solid fa-star"></i><span>Punkty</span>
      </button>
      <button class="navbtn" data-nav="rewards">
        <i class="fa-solid fa-gift"></i><span>Nagrody</span>
      </button>
      <button class="navbtn" data-nav="order">
        <i class="fa-solid fa-bag-shopping"></i><span>Zamów</span>
      </button>
      <button class="navbtn" data-nav="res">
        <i class="fa-solid fa-calendar-check"></i><span>Rezerw.</span>
      </button>
      <button class="navbtn" data-nav="account">
        <i class="fa-solid fa-user"></i><span>Konto</span>
      </button>
    </div>
  </div>

  <!-- MODAL: MILK ID -->
  <div class="modal" id="modalMilkId">
    <div class="sheet">
      <div class="sheet-head">
        <b><i class="fa-solid fa-id-badge"></i> Milk ID</b>
        <button class="btn ghost small" data-close="modalMilkId"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="sheet-body">
        <div class="item" style="align-items:center;">
          <div class="left">
            <b>Twój kod lojalnościowy</b>
            <span class="muted2">Dostępny po zalogowaniu</span>
          </div>
          <div class="right">
            <div class="price" id="milkIdValue">— — — — — —</div>
          </div>
        </div>

        <div class="sep"></div>
        <button class="btn primary wide" id="btnCopyMilkId"><i class="fa-solid fa-copy"></i> Kopiuj</button>
        <div class="tiny muted2" style="margin-top:10px;">
          Pokaż Milk ID obsłudze, aby naliczyć punkty lub odebrać nagrodę.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: CART -->
  <div class="modal" id="modalCart">
    <div class="sheet">
      <div class="sheet-head">
        <b><i class="fa-solid fa-cart-shopping"></i> Koszyk</b>
        <button class="btn ghost small" data-close="modalCart"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="sheet-body">
        <div class="list" id="cartList">
          <div class="item">
            <div class="left">
              <b>Pusty koszyk</b>
              <span class="muted2">Dodaj produkty z menu.</span>
            </div>
            <div class="right">
              <div class="price">0 PLN</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="item" style="align-items:center;">
          <div class="left">
            <b>Razem</b>
            <span class="muted2">Suma produktów w koszyku</span>
          </div>
          <div class="right">
            <div class="price" id="cartTotal">0 PLN</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row2">
          <button class="btn ghost wide" id="btnClearCart"><i class="fa-solid fa-trash"></i> Wyczyść</button>
          <button class="btn primary wide" id="btnGoCheckout"><i class="fa-solid fa-credit-card"></i> Do zamówienia</button>
        </div>

        <div class="tiny muted2" style="margin-top:10px;">
          Złożenie zamówienia wykonasz na ekranie „Zamów i odbierz”.
        </div>
      </div>
    </div>
  </div>

  <!-- INSTALL OVERLAY -->
  <div class="install" id="installOverlay">
    <div class="install-card">
      <div class="head">
        <b><i class="fa-solid fa-mobile-screen"></i> Zainstaluj aplikację</b>
        <button class="btn ghost small" id="btnCloseInstall"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="body">
        <div class="tiny muted2">
          Dodaj Milk do ekranu głównego, aby działał jak aplikacja.
        </div>

        <div class="sep"></div>

        <div class="row2">
          <button class="btn" id="btnInstallAndroid"><i class="fa-brands fa-android"></i> Android</button>
          <button class="btn" id="btnInstallIos"><i class="fa-brands fa-apple"></i> iOS</button>
        </div>

        <div class="steps" id="installSteps">
          <!-- wypełni JS -->
          <div class="step">
            <div class="n">1</div>
            <div>
              <b>Otwórz menu przeglądarki</b>
              <span>W Chrome/Safari kliknij ikonę udostępniania lub „⋮”.</span>
            </div>
          </div>
          <div class="step">
            <div class="n">2</div>
            <div>
              <b>Wybierz „Dodaj do ekranu głównego”</b>
              <span>Następnie zatwierdź dodanie.</span>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <button class="btn primary wide" id="btnBipInstall"><i class="fa-solid fa-download"></i> Zainstaluj teraz</button>
        <div class="tiny muted2" style="margin-top:10px;">
          Przycisk działa tylko, gdy przeglądarka pozwala na instalację (beforeinstallprompt).
        </div>
      </div>
    </div>
  </div>
  <script>
    <script>
/* =========================
   MILK PWA — SCRIPT (v: menu wbudowane + nowe nagrody + bez "odśwież dane")
   ========================= */

(() => {
  "use strict";

  /* ---------- Helpers ---------- */
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  const fmtPLN = (n) => {
    const v = Number(n);
    if (Number.isNaN(v)) return String(n);
    return v.toFixed(0) + " PLN";
  };

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  /* ---------- Toasts ---------- */
  const toast = (msg, type = "info") => {
    const host =
      $("#toasts") ||
      (() => {
        const d = document.createElement("div");
        d.id = "toasts";
        d.style.position = "fixed";
        d.style.left = "50%";
        d.style.bottom = "88px";
        d.style.transform = "translateX(-50%)";
        d.style.zIndex = "9999";
        d.style.display = "grid";
        d.style.gap = "10px";
        d.style.width = "min(520px, calc(100% - 24px))";
        document.body.appendChild(d);
        return d;
      })();

    const el = document.createElement("div");
    el.className = "toast";
    el.style.padding = "12px 14px";
    el.style.borderRadius = "14px";
    el.style.backdropFilter = "blur(10px)";
    el.style.background = type === "error" ? "rgba(255,0,60,.20)" : type === "ok" ? "rgba(0,255,140,.16)" : "rgba(255,255,255,.10)";
    el.style.border = "1px solid rgba(255,255,255,.18)";
    el.style.boxShadow = "0 18px 60px rgba(0,0,0,.25)";
    el.style.color = "rgba(255,255,255,.92)";
    el.style.fontWeight = "600";
    el.style.lineHeight = "1.25";
    el.textContent = msg;

    host.appendChild(el);
    setTimeout(() => {
      el.style.opacity = "0";
      el.style.transform = "translateY(6px)";
      el.style.transition = "opacity .25s ease, transform .25s ease";
      setTimeout(() => el.remove(), 280);
    }, 2600);
  };

  /* ---------- Modal (lekki) ---------- */
  const modal = (() => {
    let wrap = $("#milkModal");
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = "milkModal";
      wrap.style.position = "fixed";
      wrap.style.inset = "0";
      wrap.style.zIndex = "10000";
      wrap.style.display = "none";
      wrap.style.alignItems = "flex-end";
      wrap.style.justifyContent = "center";
      wrap.style.background = "rgba(0,0,0,.55)";
      wrap.innerHTML = `
        <div id="milkModalCard" style="
          width:min(560px, calc(100% - 18px));
          border-radius:22px 22px 18px 18px;
          background: rgba(25,25,25,.65);
          border: 1px solid rgba(255,255,255,.16);
          backdrop-filter: blur(12px);
          box-shadow: 0 30px 100px rgba(0,0,0,.45);
          padding: 14px 14px 12px;
          margin: 0 0 12px;
          color: rgba(255,255,255,.92);
        ">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div id="milkModalTitle" style="font-weight:800;font-size:16px;"></div>
            <button id="milkModalClose" style="
              border:0;background:rgba(255,255,255,.10);
              color:#fff;border-radius:12px;padding:8px 10px;
              font-weight:800;cursor:pointer;
            ">Zamknij</button>
          </div>
          <div id="milkModalBody" style="margin-top:10px;"></div>
        </div>
      `;
      document.body.appendChild(wrap);

      wrap.addEventListener("click", (e) => {
        if (e.target === wrap) modal.hide();
      });
      $("#milkModalClose").addEventListener("click", () => modal.hide());
    }

    return {
      show(title, bodyNodeOrHTML) {
        $("#milkModalTitle").textContent = title || "";
        const body = $("#milkModalBody");
        body.innerHTML = "";
        if (typeof bodyNodeOrHTML === "string") body.innerHTML = bodyNodeOrHTML;
        else if (bodyNodeOrHTML) body.appendChild(bodyNodeOrHTML);
        wrap.style.display = "flex";
        document.body.style.overflow = "hidden";
      },
      hide() {
        wrap.style.display = "none";
        document.body.style.overflow = "";
      },
    };
  })();

  /* ---------- Storage ---------- */
  const store = {
    get(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw == null ? fallback : JSON.parse(raw);
      } catch {
        return fallback;
      }
    },
    set(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    },
    del(key) {
      localStorage.removeItem(key);
    },
  };

  /* ---------- Auth (mock /api/auth/login) ---------- */
  const auth = {
    key: "milk_auth",
    me() {
      return store.get(this.key, null);
    },
    isLogged() {
      return !!this.me();
    },
    email() {
      return (this.me()?.email || "").toLowerCase();
    },
    name() {
      return this.me()?.name || "";
    },
    async login(payload) {
      // payload: { email, name }
      const email = (payload?.email || "").trim().toLowerCase();
      if (!email || !email.includes("@")) throw new Error("Podaj poprawny e-mail");
      const name = (payload?.name || "").trim() || email.split("@")[0];

      // Jeżeli masz backend, spróbuj:
      try {
        const res = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, name }),
        });
        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          const u = {
            email,
            name: data?.name || name,
            token: data?.token || null,
          };
          store.set(this.key, u);
          return u;
        }
      } catch {
        // fallback lokalny
      }

      const u = { email, name, token: null };
      store.set(this.key, u);
      return u;
    },
    logout() {
      store.del(this.key);
    },
  };

  /* ---------- Milk ID (6 cyfr per email) ---------- */
  const milkId = {
    key: "milk_ids_by_email",
    getForEmail(email) {
      if (!email) return null;
      const map = store.get(this.key, {});
      if (map[email]) return map[email];
      const code = String(Math.floor(100000 + Math.random() * 900000));
      map[email] = code;
      store.set(this.key, map);
      return code;
    },
  };

  /* ---------- Points & History ---------- */
  const points = {
    key: "milk_points",
    histKey: "milk_points_history",
    get() {
      return Number(store.get(this.key, 0)) || 0;
    },
    set(v) {
      store.set(this.key, Number(v) || 0);
    },
    add(delta, label = "") {
      const p = this.get();
      const next = Math.max(0, p + Number(delta || 0));
      this.set(next);

      const h = store.get(this.histKey, []);
      h.unshift({
        id: uid(),
        ts: Date.now(),
        delta: Number(delta || 0),
        label: label || (delta >= 0 ? "Dodano punkty" : "Wydano punkty"),
        after: next,
      });
      store.set(this.histKey, h.slice(0, 100));
      return next;
    },
    history() {
      return store.get(this.histKey, []);
    },
  };

  // Jednorazowy reset historii (zostawiam kompatybilność z Twoim poprzednim kodem)
  if (!store.get("milk_points_history_reset_once", false)) {
    // jeśli chcesz kiedyś znowu czyścić, ustaw tu warunek; teraz zostawiam bez czyszczenia
    store.set("milk_points_history_reset_once", true);
  }

  /* ---------- Nagrody (NOWE) ---------- */
  const REWARDS = [
    { id: "r1", title: "Milkshake do 30PLN", cost: 25, desc: "Dowolny milkshake do wartości 30 PLN." },
    { id: "r2", title: "Zestaw burger do 60 PLN", cost: 50, desc: "Zestaw burger o wartości do 60 PLN." },
    { id: "r3", title: "Zamówienie do 120 PLN", cost: 100, desc: "Zamówienie o wartości do 120 PLN." },
  ];

  const rewards = {
    myKey: "milk_rewards_my",
    my() {
      return store.get(this.myKey, []);
    },
    addMy(item) {
      const arr = this.my();
      arr.unshift(item);
      store.set(this.myKey, arr.slice(0, 50));
    },
    async redeem(reward) {
      const p = points.get();
      if (p < reward.cost) throw new Error("Za mało punktów");

      // Spróbuj backendu /api/rewards/redeem, jeśli istnieje
      try {
        const res = await fetch("/api/rewards/redeem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            rewardId: reward.id,
            title: reward.title,
            cost: reward.cost,
            email: auth.email(),
            milkId: milkId.getForEmail(auth.email()),
          }),
        });
        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          points.add(-reward.cost, `Nagroda: ${reward.title}`);
          this.addMy({
            id: uid(),
            ts: Date.now(),
            title: reward.title,
            cost: reward.cost,
            code: data?.code || ("MILK-" + Math.random().toString(36).slice(2, 8).toUpperCase()),
            status: "active",
          });
          return;
        }
      } catch {
        // fallback
      }

      points.add(-reward.cost, `Nagroda: ${reward.title}`);
      this.addMy({
        id: uid(),
        ts: Date.now(),
        title: reward.title,
        cost: reward.cost,
        code: "MILK-" + Math.random().toString(36).slice(2, 8).toUpperCase(),
        status: "active",
      });
    },
  };

  /* ---------- MENU (wbudowane, bez menu.json) ---------- */
  const MENU_CATALOG = {
    "schemaVersion": "1.0",
    "currency": "PLN",
    "items": [
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Espresso",
        "tag": "espresso",
        "desc": "35 ml",
        "price": 11
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Podwójne espresso",
        "tag": "espresso",
        "desc": "70 ml",
        "price": 16
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Affogato (espresso z lodami)",
        "tag": "deser kawowy",
        "desc": "",
        "price": "22/27",
        "variants": [
          { "label": "wariant 1", "price": 22, "size": null },
          { "label": "wariant 2", "price": 27, "size": null }
        ]
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Kawa czarna",
        "tag": "klasyka",
        "desc": "200/300 ml",
        "price": "12/17",
        "variants": [
          { "label": "200", "price": 12, "size": "200" },
          { "label": "300 ml", "price": 17, "size": "300 ml" }
        ]
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Kawa biała",
        "tag": "klasyka",
        "desc": "200/300 ml",
        "price": "12/17",
        "variants": [
          { "label": "200", "price": 12, "size": "200" },
          { "label": "300 ml", "price": 17, "size": "300 ml" }
        ]
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Cappuccino",
        "tag": "klasyka",
        "desc": "200/300 ml",
        "price": "13/18",
        "variants": [
          { "label": "200", "price": 13, "size": "200" },
          { "label": "300 ml", "price": 18, "size": "300 ml" }
        ]
      },
      {
        "category": "kawa-herbata",
        "categoryLabel": "Kawa",
        "title": "Latte",
        "tag": "klasyka",
        "desc": "200/300 ml",
        "price": "13/18",
        "variants": [
          { "label": "200", "price": 13, "size": "200" },
          { "label": "300 ml", "price": 18, "size": "300 ml" }
        ]
      },
      { "category": "kawa-herbata", "categoryLabel": "Kawa", "title": "Kawa mrożona", "tag": "na zimno", "desc": "300 ml", "price": 26 },
      { "category": "kawa-herbata", "categoryLabel": "Kawa", "title": "Frappe słony karmel", "tag": "na zimno", "desc": "Podwójne espresso, kostki lodu, mleko, słony karmel", "price": 27 },
      { "category": "kawa-herbata", "categoryLabel": "Kawa", "title": "Gorąca czekolada", "tag": "na ciepło", "desc": "200 ml", "price": 21 },
      { "category": "kawa-herbata", "categoryLabel": "Kawa", "title": "Dodatkowe espresso", "tag": "dodatek", "desc": "", "price": 5 },

      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "Zielona", "tag": "klasyka", "desc": "", "price": 15 },
      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "English breakfast", "tag": "klasyka", "desc": "", "price": 15 },
      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "Piekielna herbata", "tag": "rozgrzewająca", "desc": "", "price": 22 },
      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "Czort", "tag": "rozgrzewająca", "desc": "", "price": 22 },
      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "Mon Cheri", "tag": "rozgrzewająca", "desc": "", "price": 22 },
      { "category": "kawa-herbata", "categoryLabel": "Herbata", "title": "Domowa herbata mrożona", "tag": "na zimno", "desc": "500 ml", "price": 26 },

      { "category": "kawa-herbata", "categoryLabel": "Matcha", "title": "Matcha latte", "tag": "matcha", "desc": "", "price": 20 },
      { "category": "kawa-herbata", "categoryLabel": "Matcha", "title": "Iced matcha", "tag": "matcha", "desc": "", "price": 25 },

      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Cytrusowa",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "15/30",
        "variants": [
          { "label": "400", "price": 15, "size": "400" },
          { "label": "1200 ml", "price": 30, "size": "1200 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Arbuzowa",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "17/35",
        "variants": [
          { "label": "400", "price": 17, "size": "400" },
          { "label": "1200 ml", "price": 35, "size": "1200 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Ananasowa",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "17/35",
        "variants": [
          { "label": "400", "price": 17, "size": "400" },
          { "label": "1200 ml", "price": 35, "size": "1200 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Gruszkowa",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "17/35",
        "variants": [
          { "label": "400", "price": 17, "size": "400" },
          { "label": "1200 ml", "price": 35, "size": "1200 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Malinowa zimna",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "17/35",
        "variants": [
          { "label": "400", "price": 17, "size": "400" },
          { "label": "1200 ml", "price": 35, "size": "1200 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Lemoniada",
        "title": "Malinowa ciepła",
        "tag": "lemoniada",
        "desc": "400/1200 ml",
        "price": "17/35",
        "variants": [
          { "label": "400", "price": 17, "size": "400" },
          { "label": "1200 ml", "price": 35, "size": "1200 ml" }
        ]
      },

      { "category": "napoje-soki", "categoryLabel": "Napoje", "title": "Woda z kranu", "tag": "", "desc": "", "price": 0 },
      { "category": "napoje-soki", "categoryLabel": "Napoje", "title": "Woda niegazowana", "tag": "", "desc": "500 ml", "price": 8 },
      { "category": "napoje-soki", "categoryLabel": "Napoje", "title": "Woda gazowana", "tag": "", "desc": "500 ml", "price": 8 },
      { "category": "napoje-soki", "categoryLabel": "Napoje", "title": "Pepsi", "tag": "", "desc": "330 ml", "price": 9 },
      { "category": "napoje-soki", "categoryLabel": "Napoje", "title": "Pepsi Max", "tag": "", "desc": "330 ml", "price": 9 },

      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Pomarańczowy", "tag": "świeży sok", "desc": "300 ml", "price": 19 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Grejpfrutowy", "tag": "świeży sok", "desc": "300 ml", "price": 22 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Pomarańczowo-grejpfrutowy", "tag": "świeży sok", "desc": "300 ml", "price": 22 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Jabłkowy", "tag": "świeży sok", "desc": "300 ml", "price": 19 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Jabłkowo-gruszkowy", "tag": "świeży sok", "desc": "300 ml", "price": 19 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Marchewka-jabłko-pomarańcza", "tag": "świeży sok", "desc": "300 ml", "price": 19 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Burak-jabłko-pomarańcza-seler", "tag": "świeży sok", "desc": "300 ml", "price": 22 },
      { "category": "napoje-soki", "categoryLabel": "Świeże soki", "title": "Jabłko-seler-kiwi", "tag": "świeży sok", "desc": "300 ml", "price": 22 },

      { "category": "napoje-soki", "categoryLabel": "Smoothies", "title": "Zielony", "tag": "smoothies", "desc": "350 ml • szpinak, kiwi, pomarańcza, gruszka", "price": 29 },
      { "category": "napoje-soki", "categoryLabel": "Smoothies", "title": "Żółty", "tag": "smoothies", "desc": "350 ml • banan, jabłko, ananas, mango", "price": 29 },
      { "category": "napoje-soki", "categoryLabel": "Smoothies", "title": "Pomarańczowy", "tag": "smoothies", "desc": "350 ml • banan, pomarańcza, mango, nerkowce, limonka", "price": 29 },
      { "category": "napoje-soki", "categoryLabel": "Smoothies", "title": "Czerwony", "tag": "smoothies", "desc": "350 ml • truskawki, maliny, banan, ananas", "price": 29 },

      { "category": "napoje-soki", "categoryLabel": "Piwo", "title": "Corona", "tag": "piwo", "desc": "330 ml", "price": 15 },
      { "category": "napoje-soki", "categoryLabel": "Piwo", "title": "Piwo bezalkoholowe", "tag": "piwo", "desc": "", "price": 14 },
      { "category": "napoje-soki", "categoryLabel": "Piwo", "title": "IPA", "tag": "piwo", "desc": "0,5 l", "price": 19 },
      { "category": "napoje-soki", "categoryLabel": "Piwo", "title": "Lager", "tag": "piwo", "desc": "Zapytaj o dostępność", "price": 17 },

      {
        "category": "napoje-soki",
        "categoryLabel": "Wino & Aperitiff",
        "title": "Sauvignon blanc (białe wytrawne) – Skarby Mołdawii",
        "tag": "wino-aperitiff",
        "desc": "170/500/700 ml",
        "price": "22/64/89",
        "variants": [
          { "label": "170", "price": 22, "size": "170" },
          { "label": "500", "price": 64, "size": "500" },
          { "label": "700 ml", "price": 89, "size": "700 ml" }
        ]
      },
      {
        "category": "napoje-soki",
        "categoryLabel": "Wino & Aperitiff",
        "title": "Cabernet sauvignon (czerwone wytrawne) – Skarby Mołdawii",
        "tag": "wino-aperitiff",
        "desc": "170/500/700 ml",
        "price": "22/64/89",
        "variants": [
          { "label": "170", "price": 22, "size": "170" },
          { "label": "500", "price": 64, "size": "500" },
          { "label": "700 ml", "price": 89, "size": "700 ml" }
        ]
      },
      { "category": "napoje-soki", "categoryLabel": "Wino & Aperitiff", "title": "Hugo", "tag": "wino-aperitiff", "desc": "Prosecco, woda gazowana, syrop z czarnego bzu, mięta i limonka", "price": 35 },
      { "category": "napoje-soki", "categoryLabel": "Wino & Aperitiff", "title": "Prosecco (wytrawne wino musujące)", "tag": "wino-aperitiff", "desc": "", "price": 26 },

      /* =========================
   DOKLEJ TO DO: MENU_CATALOG.items  (ZA OSTATNIM ELEMENTEM, KTÓRY MASZ: Prosecco...)
   ========================= */

/* --- SHAKES --- */
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Śmietankowy",
  "tag": "klasyka",
  "desc": "",
  "price": 18
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Waniliowy",
  "tag": "klasyka",
  "desc": "",
  "price": 19
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Czekoladowy",
  "tag": "klasyka",
  "desc": "",
  "price": 19
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Straciatella",
  "tag": "klasyka",
  "desc": "",
  "price": 19
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Chałwa",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Krówka",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Daim",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Milky Way",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Oreo",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Snickers",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Ptasie mleczko waniliowe",
  "tag": "klasyka",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kinder Bueno",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Reese's Peanut Butter",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Nutella",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Raffaello",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Skittles",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Ferrero Rocher",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Maxi King",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Masło orzechowe",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kawowy",
  "tag": "klasyka",
  "desc": "",
  "price": 24
},

/* VIP */
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Ciasteczkowy Potwór",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Pistacjusz",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Marshall",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Cringe",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Cheesecake",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Gonzo",
  "tag": "vip",
  "desc": "",
  "price": 37
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Johny Pierniczony",
  "tag": "vip",
  "desc": "",
  "price": 37
},

/* Best-of */
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Banan + maliny",
  "tag": "best-of",
  "desc": "",
  "price": 26
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Mango + truskawki",
  "tag": "best-of",
  "desc": "",
  "price": 26
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kiwi + mango",
  "tag": "best-of",
  "desc": "",
  "price": 26
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kinder bueno + maliny",
  "tag": "best-of",
  "desc": "",
  "price": 28
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Oreo + masło orzechowe",
  "tag": "best-of",
  "desc": "",
  "price": 28
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kawa + słony karmel",
  "tag": "best-of",
  "desc": "",
  "price": 29
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Kawa + Nutella",
  "tag": "best-of",
  "desc": "",
  "price": 29
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Ptasie mleczko + maliny",
  "tag": "best-of",
  "desc": "",
  "price": 28
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Raffaello + jagody",
  "tag": "best-of",
  "desc": "",
  "price": 28
},

/* Owocowe */
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Bananowy",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Czarna porzeczka",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Malinowy",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Mango",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Truskawkowy",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},
{
  "category": "shake",
  "categoryLabel": "Shakes",
  "title": "Jagodowy",
  "tag": "owocowe",
  "desc": "",
  "price": 22
},

/* Proteinowe */
{
  "category": "shake",
  "categoryLabel": "Shakes proteinowe",
  "title": "Jagodowy muffin",
  "tag": "proteinowe",
  "desc": "",
  "price": 32
},
{
  "category": "shake",
  "categoryLabel": "Shakes proteinowe",
  "title": "Słony karmel",
  "tag": "proteinowe",
  "desc": "",
  "price": 28
},
{
  "category": "shake",
  "categoryLabel": "Shakes proteinowe",
  "title": "Truskawkowe love",
  "tag": "proteinowe",
  "desc": "",
  "price": 28
},

/* --- DESER --- */
{
  "category": "deser",
  "categoryLabel": "Lody włoskie",
  "title": "Lody włoskie śmietankowe (małe)",
  "tag": "lody-wloskie",
  "desc": "150 g",
  "price": 11
},
{
  "category": "deser",
  "categoryLabel": "Lody włoskie",
  "title": "Lody włoskie śmietankowe (duże)",
  "tag": "lody-wloskie",
  "desc": "250 g",
  "price": 16
},
{
  "category": "deser",
  "categoryLabel": "Dodatki",
  "title": "Mus owocowy lub polewa",
  "tag": "lody-wloskie",
  "desc": "",
  "price": 6
},
{
  "category": "deser",
  "categoryLabel": "Dodatki",
  "title": "M&Ms",
  "tag": "lody-wloskie",
  "desc": "",
  "price": 6
},
{
  "category": "deser",
  "categoryLabel": "Dodatki",
  "title": "Owoce",
  "tag": "lody-wloskie",
  "desc": "",
  "price": 14
},
{
  "category": "deser",
  "categoryLabel": "Dodatki",
  "title": "Bita śmietana",
  "tag": "lody-wloskie",
  "desc": "",
  "price": 6
},
{
  "category": "deser",
  "categoryLabel": "Desery lodowe",
  "title": "Troll",
  "tag": "desery-lodowe",
  "desc": "",
  "price": 24
},
{
  "category": "deser",
  "categoryLabel": "Desery lodowe",
  "title": "Owocowa aleja",
  "tag": "desery-lodowe",
  "desc": "",
  "price": 38
},
{
  "category": "deser",
  "categoryLabel": "Desery lodowe",
  "title": "Grzeszna truskawka",
  "tag": "desery-lodowe",
  "desc": "",
  "price": 38
},
{
  "category": "deser",
  "categoryLabel": "Desery lodowe",
  "title": "Oreo Sundae",
  "tag": "desery-lodowe",
  "desc": "",
  "price": 29
},

/* Gofry */
{
  "category": "deser",
  "categoryLabel": "Gofry amerykańskie",
  "title": "Z syropem klonowym, jajkiem sadzonym i bekonem",
  "tag": "gofry-amerykanskie",
  "desc": "pół / cały",
  "price": "28/44",
  "variants": [
    { "label": "pół", "price": 28, "size": "pół" },
    { "label": "cały", "price": 44, "size": "cały" }
  ]
},
{
  "category": "deser",
  "categoryLabel": "Gofry amerykańskie",
  "title": "American Pie z pieczonymi jabłkami, cynamonem, domową kruszonką i lodami",
  "tag": "gofry-amerykanskie",
  "desc": "pół / cały",
  "price": "27/49",
  "variants": [
    { "label": "pół", "price": 27, "size": "pół" },
    { "label": "cały", "price": 49, "size": "cały" }
  ]
},
{
  "category": "deser",
  "categoryLabel": "Gofry amerykańskie",
  "title": "Z dżemem z czarnej porzeczki i polewą Lotus Biscoff",
  "tag": "gofry-amerykanskie",
  "desc": "pół / cały",
  "price": "26/48",
  "variants": [
    { "label": "pół", "price": 26, "size": "pół" },
    { "label": "cały", "price": 48, "size": "cały" }
  ]
},
{
  "category": "deser",
  "categoryLabel": "Gofry amerykańskie",
  "title": "Dubajski z truskawkami",
  "tag": "gofry-amerykanskie",
  "desc": "pół / cały",
  "price": "32/54",
  "variants": [
    { "label": "pół", "price": 32, "size": "pół" },
    { "label": "cały", "price": 54, "size": "cały" }
  ]
},
{
  "category": "deser",
  "categoryLabel": "Gofry amerykańskie",
  "title": "Cheesecake z serkiem Philadelphia, masą ciasteczkową, kruszonką i truskawkami",
  "tag": "gofry-amerykanskie",
  "desc": "pół / cały",
  "price": "28/50",
  "variants": [
    { "label": "pół", "price": 28, "size": "pół" },
    { "label": "cały", "price": 50, "size": "cały" }
  ]
},

/* Pancakes */
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z syropem klonowym i lodami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 29
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z owocami, musem truskawkowym i lodami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 36
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z Nutellą, truskawkami i lodami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 36
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z masą Kinder Bueno, malinami i lodami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 39
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z masą Raffaello, truskawkami i lodami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 39
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Z dubajską pistacją i truskawkami",
  "tag": "pancakes",
  "desc": "3 szt.",
  "price": 39
},
{
  "category": "deser",
  "categoryLabel": "Pancakes",
  "title": "Hello USA",
  "tag": "pancakes",
  "desc": "syrop klonowy, bekon, 2 jaja sadzone",
  "price": 39
},

/* --- TEXMEX --- */
{ "category": "texmex", "categoryLabel": "Quesadillas", "title": "Pollo", "tag": "quesadillas", "desc": "", "price": 45 },
{ "category": "texmex", "categoryLabel": "Quesadillas", "title": "Torro", "tag": "quesadillas", "desc": "", "price": 46 },
{ "category": "texmex", "categoryLabel": "Quesadillas", "title": "Camaron", "tag": "quesadillas", "desc": "", "price": 49 },
{ "category": "texmex", "categoryLabel": "Quesadillas", "title": "Verduras", "tag": "quesadillas", "desc": "", "price": 42 },

{ "category": "texmex", "categoryLabel": "Fajita", "title": "Fajita z kurczakiem", "tag": "fajita", "desc": "", "price": 59 },
{ "category": "texmex", "categoryLabel": "Fajita", "title": "Fajita z krewetkami", "tag": "fajita", "desc": "", "price": 69 },
{ "category": "texmex", "categoryLabel": "Fajita", "title": "Fajita z polędwicą wołową", "tag": "fajita", "desc": "", "price": 79 },

{ "category": "texmex", "categoryLabel": "Churros", "title": "Churros (6 szt.) z sosem czekoladowym i truskawkami", "tag": "churros", "desc": "", "price": 33 },
{ "category": "texmex", "categoryLabel": "Churros", "title": "Churros (6 szt.) ze słonym karmelem i precelkami", "tag": "churros", "desc": "", "price": 32 },

{ "category": "texmex", "categoryLabel": "Pasta", "title": "Tagiatelle z krewetkami", "tag": "pasta", "desc": "", "price": 51 },
{ "category": "texmex", "categoryLabel": "Pasta", "title": "Vege Pasta", "tag": "pasta", "desc": "", "price": 44 },

{ "category": "texmex", "categoryLabel": "NY Chinatown Stir Fry", "title": "Vege (z nerkowcami)", "tag": "stir-fry", "desc": "", "price": 39 },
{ "category": "texmex", "categoryLabel": "NY Chinatown Stir Fry", "title": "Z kurczakiem 90g", "tag": "stir-fry", "desc": "", "price": 47 },
{ "category": "texmex", "categoryLabel": "NY Chinatown Stir Fry", "title": "Z wołowiną 90g", "tag": "stir-fry", "desc": "", "price": 55 },
{ "category": "texmex", "categoryLabel": "NY Chinatown Stir Fry", "title": "Z krewetkami (16/20) 7 szt.", "tag": "stir-fry", "desc": "", "price": 51 },

{ "category": "texmex", "categoryLabel": "Dodatki", "title": "Dodatkowe nerkowce 20g", "tag": "stir-fry", "desc": "", "price": 8 },

{ "category": "texmex", "categoryLabel": "Sałaty", "title": "Cezar", "tag": "salaty", "desc": "", "price": 49 },
{ "category": "texmex", "categoryLabel": "Sałaty", "title": "Vege Cezar", "tag": "salaty", "desc": "", "price": 42 },
{ "category": "texmex", "categoryLabel": "Sałaty", "title": "Ale burak", "tag": "salaty", "desc": "", "price": 44 },
{ "category": "texmex", "categoryLabel": "Sałaty", "title": "Alabama", "tag": "salaty", "desc": "", "price": 51 },

/* --- KANAPKI / STARTERY / DANIA / ZESTAWY --- */
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Frytki", "tag": "startery", "desc": "150 g", "price": 15 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Frytki z batatów", "tag": "startery", "desc": "150 g", "price": 19 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Frytki z serem, bekonem i majonezem sriracha", "tag": "startery", "desc": "", "price": 30 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Krążki cebulowe (5 szt.) z sosem sweet chili", "tag": "startery", "desc": "", "price": 18 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Krewetki w tempurze (3 szt.) z sosem sweet chili", "tag": "startery", "desc": "", "price": 21 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Krewetki w tempurze (6 szt.) z sosem sweet chili", "tag": "startery", "desc": "", "price": 39 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Nachos z serem, guacamole, śmietaną, salsą i jalapeno", "tag": "startery", "desc": "", "price": 41 },
{ "category": "kanapki", "categoryLabel": "Startery", "title": "Nachos z chili con carne, serem, śmietaną, guacamole i jalapeno", "tag": "startery", "desc": "", "price": 49 },

{
  "category": "kanapki",
  "categoryLabel": "Kanapki",
  "title": "Rostbef",
  "tag": "kanapki",
  "desc": "60 g / 100 g",
  "price": "42/58",
  "variants": [
    { "label": "60 g", "price": 42, "size": "60 g" },
    { "label": "100 g", "price": 58, "size": "100 g" }
  ]
},
{
  "category": "kanapki",
  "categoryLabel": "Kanapki",
  "title": "Cotto",
  "tag": "kanapki",
  "desc": "70 g / 120 g",
  "price": "37/49",
  "variants": [
    { "label": "70 g", "price": 37, "size": "70 g" },
    { "label": "120 g", "price": 49, "size": "120 g" }
  ]
},
{ "category": "kanapki", "categoryLabel": "Kanapki", "title": "Kura", "tag": "kanapki", "desc": "", "price": 46 },
{ "category": "kanapki", "categoryLabel": "Kanapki", "title": "Club sandwich", "tag": "kanapki", "desc": "", "price": 38 },
{ "category": "kanapki", "categoryLabel": "Kanapki", "title": "Cotto club", "tag": "kanapki", "desc": "", "price": 36 },
{ "category": "kanapki", "categoryLabel": "Kanapki", "title": "Vege club", "tag": "kanapki", "desc": "", "price": 36 },

{ "category": "kanapki", "categoryLabel": "Dania główne", "title": "Tatar z polędwicy wołowej", "tag": "dania-glowne", "desc": "100 g", "price": 51 },
{ "category": "kanapki", "categoryLabel": "Dania główne", "title": "Żebro wieprzowe", "tag": "dania-glowne", "desc": "450 g", "price": 75 },
{ "category": "kanapki", "categoryLabel": "Dania główne", "title": "Stek", "tag": "dania-glowne", "desc": "", "price": 125 },
{ "category": "kanapki", "categoryLabel": "Dania główne", "title": "Kurczak supreme", "tag": "dania-glowne", "desc": "", "price": 65 },

{
  "category": "kanapki",
  "categoryLabel": "Zestawy",
  "title": "Burger + frytki lub sałatka",
  "tag": "zestawy",
  "desc": "oszczędzasz 5 PLN",
  "price": "+12",
  "variants": [{ "label": "dopłata", "price": 12.0, "size": null }]
},
{
  "category": "kanapki",
  "categoryLabel": "Zestawy",
  "title": "Burger + frytki/sałatka + lemoniada cytrusowa",
  "tag": "zestawy",
  "desc": "oszczędzasz 10 PLN",
  "price": "+22",
  "variants": [{ "label": "dopłata", "price": 22.0, "size": null }]
},
{ "category": "kanapki", "categoryLabel": "Zestawy", "title": "Zamień frytki na krążki cebulowe", "tag": "zestawy", "desc": "", "price": 15 },
{ "category": "kanapki", "categoryLabel": "Zestawy", "title": "Zamień frytki na mini nachos", "tag": "zestawy", "desc": "", "price": 18 },
{ "category": "kanapki", "categoryLabel": "Zestawy", "title": "Zamień frytki na bataty", "tag": "zestawy", "desc": "", "price": 14 },

/* --- BURGERY --- */
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Prostak",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "30/38/46",
  "variants": [
    { "label": "mały", "price": 30, "size": "mały" },
    { "label": "średni", "price": 38, "size": "średni" },
    { "label": "duży", "price": 46, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Sergio",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "32/40/48",
  "variants": [
    { "label": "mały", "price": 32, "size": "mały" },
    { "label": "średni", "price": 40, "size": "średni" },
    { "label": "duży", "price": 48, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Boston",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "34/42/50",
  "variants": [
    { "label": "mały", "price": 34, "size": "mały" },
    { "label": "średni", "price": 42, "size": "średni" },
    { "label": "duży", "price": 50, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Pleśniak",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "38/46/54",
  "variants": [
    { "label": "mały", "price": 38, "size": "mały" },
    { "label": "średni", "price": 46, "size": "średni" },
    { "label": "duży", "price": 54, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Bajpas",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "36/44/52",
  "variants": [
    { "label": "mały", "price": 36, "size": "mały" },
    { "label": "średni", "price": 44, "size": "średni" },
    { "label": "duży", "price": 52, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Burakoza",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "38/46/54",
  "variants": [
    { "label": "mały", "price": 38, "size": "mały" },
    { "label": "średni", "price": 46, "size": "średni" },
    { "label": "duży", "price": 54, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "New York",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "38/46/54",
  "variants": [
    { "label": "mały", "price": 38, "size": "mały" },
    { "label": "średni", "price": 46, "size": "średni" },
    { "label": "duży", "price": 54, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Złodziej",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "38/46/54",
  "variants": [
    { "label": "mały", "price": 38, "size": "mały" },
    { "label": "średni", "price": 46, "size": "średni" },
    { "label": "duży", "price": 54, "size": "duży" }
  ]
},
{
  "category": "burger",
  "categoryLabel": "Burgery wołowe Black Angus",
  "title": "Missisipi",
  "tag": "wolowy",
  "desc": "mały / średni / duży",
  "price": "38/46/54",
  "variants": [
    { "label": "mały", "price": 38, "size": "mały" },
    { "label": "średni", "price": 46, "size": "średni" },
    { "label": "duży", "price": 54, "size": "duży" }
  ]
},

{ "category": "burger", "categoryLabel": "Burgery z kurczakiem", "title": "Kura", "tag": "kurczak", "desc": "", "price": 43 },
{ "category": "burger", "categoryLabel": "Burgery z kurczakiem", "title": "Żółtodziób", "tag": "kurczak", "desc": "", "price": 43 },

/* --- ŚNIADANIA --- */
{ "category": "sniadania", "categoryLabel": "Napoje do śniadania", "title": "Kawa filtrowana (z dolewką)", "tag": "sniadania", "desc": "", "price": 12 },
{ "category": "sniadania", "categoryLabel": "Napoje do śniadania", "title": "Herbata śniadaniowa", "tag": "sniadania", "desc": "", "price": 9 },
{ "category": "sniadania", "categoryLabel": "Napoje do śniadania", "title": "Świeży sok", "tag": "sniadania", "desc": "0,2 l", "price": 18 },
{ "category": "sniadania", "categoryLabel": "Napoje do śniadania", "title": "Mimoza", "tag": "sniadania", "desc": "", "price": 31 },

{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Granola", "tag": "sniadania", "desc": "", "price": 44 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Tost francuski w panko", "tag": "sniadania", "desc": "", "price": 44 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Jajito burrito", "tag": "sniadania", "desc": "", "price": 37 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Czerwona szakszuka", "tag": "sniadania", "desc": "", "price": 39 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Egg royal", "tag": "sniadania", "desc": "", "price": 45 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Jajecznica", "tag": "sniadania", "desc": "", "price": 33 },
{ "category": "sniadania", "categoryLabel": "Śniadania", "title": "Omlet francuski", "tag": "sniadania", "desc": "", "price": 37 },

{
  "category": "sniadania",
  "categoryLabel": "Kanapki śniadaniowe",
  "title": "Rostbef",
  "tag": "kanapki-sniadaniowe",
  "desc": "60 g / 100 g",
  "price": "42/58",
  "variants": [
    { "label": "60 g", "price": 42, "size": "60 g" },
    { "label": "100 g", "price": 58, "size": "100 g" }
  ]
},
{
  "category": "sniadania",
  "categoryLabel": "Kanapki śniadaniowe",
  "title": "Cotto",
  "tag": "kanapki-sniadaniowe",
  "desc": "70 g / 120 g",
  "price": "37/49",
  "variants": [
    { "label": "70 g", "price": 37, "size": "70 g" },
    { "label": "120 g", "price": 49, "size": "120 g" }
  ]
},
{ "category": "sniadania", "categoryLabel": "Kanapki śniadaniowe", "title": "Kura", "tag": "kanapki-sniadaniowe", "desc": "", "price": 46 },
{ "category": "sniadania", "categoryLabel": "Kanapki śniadaniowe", "title": "Club sandwich", "tag": "kanapki-sniadaniowe", "desc": "", "price": 38 },
{ "category": "sniadania", "categoryLabel": "Kanapki śniadaniowe", "title": "Cotto club", "tag": "kanapki-sniadaniowe", "desc": "", "price": 36 },
{ "category": "sniadania", "categoryLabel": "Kanapki śniadaniowe", "title": "Vege club", "tag": "kanapki-sniadaniowe", "desc": "", "price": 36 },

{ "category": "sniadania", "categoryLabel": "Full milkshake breakfast", "title": "Duży full milkshake breakfast", "tag": "zestaw-sniadaniowy", "desc": "", "price": 53 },
{ "category": "sniadania", "categoryLabel": "Full milkshake breakfast", "title": "Mały full milkshake breakfast", "tag": "zestaw-sniadaniowy", "desc": "", "price": 42 },

{ "category": "sniadania", "categoryLabel": "Chiquita", "title": "Chiquita", "tag": "chiquita", "desc": "", "price": 41 },
{ "category": "sniadania", "categoryLabel": "Chiquita", "title": "Chiquita z chorizo", "tag": "chiquita", "desc": "80 g", "price": 39 },

/* KETO dodatki */
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Frankfurterka", "tag": "sniadania-keto", "desc": "", "price": 7 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Chorizo", "tag": "sniadania-keto", "desc": "70 g", "price": 8 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "½ awokado", "tag": "sniadania-keto", "desc": "", "price": 9 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Twarożek", "tag": "sniadania-keto", "desc": "80 g", "price": 7 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Ogórek zielony", "tag": "sniadania-keto", "desc": "7 plastrów", "price": 5 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Pomidorki koktajlowe", "tag": "sniadania-keto", "desc": "80 g", "price": 5 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Bekon", "tag": "sniadania-keto", "desc": "2 plastry", "price": 4 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Jajo", "tag": "sniadania-keto", "desc": "", "price": 4 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Masło", "tag": "sniadania-keto", "desc": "10 g", "price": 2 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Chleb maślany", "tag": "sniadania-keto", "desc": "80 g", "price": 6 },
{ "category": "sniadania", "categoryLabel": "Śniadanie KETO – dodatki", "title": "Gravlax", "tag": "sniadania-keto", "desc": "50 g", "price": 15 }

    ]
  };


  const menu = (() => {
    const items = (MENU_CATALOG?.items || []).map((it) => {
      const base = { ...it };
      if (Array.isArray(base.variants) && base.variants.length) {
        base._hasVariants = true;
      } else {
        base._hasVariants = false;
      }

      // price może być string — bierz min jako "od"
      const parsePriceStr = (s) => {
        if (typeof s !== "string") return null;
        const clean = s.replace(",", ".").trim();
        // "+12" => 12
        if (/^\+?\d+(\.\d+)?$/.test(clean)) return Number(clean.replace("+", ""));
        // "12/17" => 12
        if (clean.includes("/")) {
          const p = clean.split("/").map((x) => Number(x.replace("+", "").trim())).filter((x) => !Number.isNaN(x));
          return p.length ? Math.min(...p) : null;
        }
        return null;
      };

      const p =
        typeof base.price === "number" ? base.price : parsePriceStr(base.price);

      base._priceFrom = p ?? 0;
      base._categoryKey = base.category || "inne";
      base._categoryLabel = base.categoryLabel || base._categoryKey;
      base._id = `${base._categoryKey}::${base.title}::${base.desc || ""}`.toLowerCase();
      return base;
    });

    const categories = [];
    const seen = new Set();
    for (const it of items) {
      const key = it._categoryKey;
      if (!seen.has(key)) {
        seen.add(key);
        categories.push({ key, label: it._categoryLabel });
      }
    }

    return { items, categories };
  })();

  /* ---------- Cart / Orders ---------- */
  const cart = {
    key: "milk_cart",
    get() {
      return store.get(this.key, []);
    },
    set(arr) {
      store.set(this.key, arr);
    },
    clear() {
      this.set([]);
    },
    add(product, chosenVariant = null) {
      const arr = this.get();
      const id = product._id + (chosenVariant ? `::v:${chosenVariant.label || chosenVariant.size || chosenVariant.price}` : "");
      const found = arr.find((x) => x.id === id);
      const price = chosenVariant?.price ?? product._priceFrom ?? 0;
      const title = product.title + (chosenVariant?.label ? ` (${chosenVariant.label})` : chosenVariant?.size ? ` (${chosenVariant.size})` : "");
      const desc = product.desc || "";

      if (found) found.qty += 1;
      else {
        arr.push({
          id,
          baseId: product._id,
          title,
          desc,
          price: Number(price) || 0,
          qty: 1,
          meta: {
            category: product._categoryKey,
            tag: product.tag || "",
            variant: chosenVariant || null,
          },
        });
      }
      this.set(arr);
    },
    inc(id) {
      const arr = this.get();
      const f = arr.find((x) => x.id === id);
      if (f) f.qty += 1;
      this.set(arr);
    },
    dec(id) {
      const arr = this.get();
      const f = arr.find((x) => x.id === id);
      if (!f) return;
      f.qty -= 1;
      const next = arr.filter((x) => x.qty > 0);
      this.set(next);
    },
    remove(id) {
      this.set(this.get().filter((x) => x.id !== id));
    },
    sum() {
      return this.get().reduce((a, x) => a + (Number(x.price) || 0) * (Number(x.qty) || 0), 0);
    },
    count() {
      return this.get().reduce((a, x) => a + (Number(x.qty) || 0), 0);
    },
  };

  const orders = {
    key: "milk_orders_local",
    async my() {
      // próbuj serwera
      try {
        const res = await fetch("/api/orders/my", {
          headers: { "Content-Type": "application/json" },
        });
        if (res.ok) return await res.json();
      } catch {}
      // fallback lokalny
      const all = store.get(this.key, []);
      const email = auth.email();
      return all.filter((o) => (o?.email || "").toLowerCase() === email);
    },
    async create(payload) {
      // próbuj serwera
      try {
        const res = await fetch("/api/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) return await res.json().catch(() => ({}));
      } catch {}

      // fallback lokalny
      const all = store.get(this.key, []);
      const o = { id: uid(), ts: Date.now(), status: "new", ...payload };
      all.unshift(o);
      store.set(this.key, all.slice(0, 100));
      return o;
    },
  };

  /* ---------- Reservations (zostawiam kompatybilność) ---------- */
  const reservations = {
    localKey: "milk_reservations_local",
    async my() {
      try {
        const res = await fetch("/api/rezerwacje/my");
        if (res.ok) return await res.json();
      } catch {}
      const all = store.get(this.localKey, []);
      const email = auth.email();
      return all.filter((r) => (r?.email || "").toLowerCase() === email);
    },
    async create(payload) {
      try {
        const res = await fetch("/api/rezerwacje", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) return await res.json().catch(() => ({}));
      } catch {}
      const all = store.get(this.localKey, []);
      const r = { id: uid(), ts: Date.now(), ...payload };
      all.unshift(r);
      store.set(this.localKey, all.slice(0, 100));
      return r;
    },
  };

  /* ---------- UI: Tabs / Navigation ---------- */
  const ui = {
    setTab(tabId) {
      // Oczekuję, że masz sekcje z data-tab lub id; robię tryb "łagodny"
      const tabs = $$("[data-tab]");
      const pages = $$("[data-page]");
      tabs.forEach((b) => b.classList.toggle("active", b.getAttribute("data-tab") === tabId));
      pages.forEach((p) => p.style.display = (p.getAttribute("data-page") === tabId ? "" : "none"));

      // fallback: jeżeli masz sekcje o id = tabId
      if (!pages.length) {
        $$("section").forEach((s) => (s.style.display = s.id === tabId ? "" : "none"));
      }

      store.set("milk_last_tab", tabId);
      this.refreshAll();
    },

    requireLogin(actionName = "Ta funkcja") {
      if (auth.isLogged()) return true;
      toast(`${actionName}: zaloguj się`, "error");
      this.openLogin();
      return false;
    },

    openLogin() {
      const box = document.createElement("div");
      box.style.display = "grid";
      box.style.gap = "10px";

      box.innerHTML = `
        <div style="font-weight:800;opacity:.95">Zaloguj się</div>
        <input id="loginEmail" type="email" placeholder="E-mail" style="width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;outline:none;">
        <input id="loginName" type="text" placeholder="Imię (opcjonalnie)" style="width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;outline:none;">
        <button id="loginBtn" style="padding:12px 12px;border-radius:14px;border:0;background:rgba(255,255,255,.14);color:#fff;font-weight:900;cursor:pointer;">
          Zaloguj
        </button>
      `;

      modal.show("Konto", box);

      $("#loginBtn", box).addEventListener("click", async () => {
        const email = $("#loginEmail", box).value.trim();
        const name = $("#loginName", box).value.trim();
        try {
          await auth.login({ email, name });
          modal.hide();
          toast("Zalogowano", "ok");
          this.refreshAll();
        } catch (e) {
          toast(e?.message || "Błąd logowania", "error");
        }
      });
    },

    openMilkId() {
      if (!this.requireLogin("Milk ID")) return;
      const email = auth.email();
      const code = milkId.getForEmail(email);

      const body = document.createElement("div");
      body.style.display = "grid";
      body.style.gap = "10px";
      body.innerHTML = `
        <div style="opacity:.9">Twój Milk ID (dla: <b>${email}</b>)</div>
        <div style="font-size:34px;font-weight:1000;letter-spacing:.18em;text-align:center;padding:14px 10px;border-radius:18px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);">
          ${code}
        </div>
        <button id="copyMilkId" style="padding:12px;border-radius:14px;border:0;background:rgba(255,255,255,.14);color:#fff;font-weight:900;cursor:pointer;">
          Kopiuj
        </button>
      `;
      modal.show("Milk ID", body);
      $("#copyMilkId", body).addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(code);
          toast("Skopiowano Milk ID", "ok");
        } catch {
          toast("Nie udało się skopiować", "error");
        }
      });
    },

    refreshHeader() {
      // punkty pill
      const p = points.get();
      const pill = $("#pointsPill") || $("#points-pill") || $("[data-points-pill]");
      if (pill) pill.textContent = `${p} pkt`;

      const nameEl = $("#userName") || $("[data-user-name]");
      if (nameEl) nameEl.textContent = auth.isLogged() ? auth.name() : "Gość";
    },

    renderPoints() {
      // progres, historia – miękko po selektorach
      const pVal = points.get();
      const pValEl = $("#pointsValue") || $("[data-points-value]");
      if (pValEl) pValEl.textContent = `${pVal} pkt`;

      const histHost = $("#pointsHistory") || $("[data-points-history]");
      if (histHost) {
        const h = points.history();
        histHost.innerHTML = h
          .slice(0, 12)
          .map((x) => {
            const sign = x.delta >= 0 ? "+" : "";
            const d = new Date(x.ts);
            return `
              <div style="display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);">
                <div>
                  <div style="font-weight:800">${x.label || "Operacja"}</div>
                  <div style="opacity:.7;font-size:12px">${d.toLocaleString()}</div>
                </div>
                <div style="font-weight:1000">${sign}${x.delta} pkt</div>
              </div>
            `;
          })
          .join("");
      }
    },

    renderRewards() {
      const host = $("#rewardsList") || $("[data-rewards-list]");
      if (!host) return;

      const p = points.get();
      host.innerHTML = REWARDS.map((r) => {
        const disabled = p < r.cost;
        return `
          <div style="padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;gap:8px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:1000">${r.title}</div>
              <div style="font-weight:1000;opacity:.9">${r.cost} pkt</div>
            </div>
            <div style="opacity:.82">${r.desc || ""}</div>
            <button data-redeem="${r.id}" ${disabled ? "disabled" : ""} style="
              padding:12px;border-radius:14px;border:0;
              background:${disabled ? "rgba(255,255,255,.08)" : "rgba(255,255,255,.16)"};
              color:#fff;font-weight:900;cursor:${disabled ? "not-allowed" : "pointer"};
              opacity:${disabled ? ".6" : "1"};
            ">
              ${disabled ? "Za mało punktów" : "Odbierz"}
            </button>
          </div>
        `;
      }).join("");

      $$("button[data-redeem]", host).forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!this.requireLogin("Nagrody")) return;
          const id = btn.getAttribute("data-redeem");
          const r = REWARDS.find((x) => x.id === id);
          if (!r) return;

          try {
            await rewards.redeem(r);
            toast("Nagroda odebrana 🎉", "ok");
            this.refreshAll();
          } catch (e) {
            toast(e?.message || "Nie udało się odebrać nagrody", "error");
          }
        });
      });

      const myHost = $("#myRewards") || $("[data-my-rewards]");
      if (myHost) {
        const mine = rewards.my();
        myHost.innerHTML = mine.length
          ? mine
              .slice(0, 10)
              .map((x) => {
                const d = new Date(x.ts);
                return `
                  <div style="padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;gap:6px;">
                    <div style="display:flex;justify-content:space-between;gap:10px;">
                      <div style="font-weight:1000">${x.title}</div>
                      <div style="font-weight:900;opacity:.85">${x.cost} pkt</div>
                    </div>
                    <div style="opacity:.8;font-size:13px">Kod: <b style="letter-spacing:.06em">${x.code}</b></div>
                    <div style="opacity:.65;font-size:12px">${d.toLocaleString()}</div>
                  </div>
                `;
              })
              .join("")
          : `<div style="opacity:.75">Brak odebranych nagród.</div>`;
      }
    },

    /* ---------- ORDER & PICKUP UI ---------- */
    order: {
      selectedCategory: null,

      renderCategories() {
        const host = $("#orderCategories") || $("[data-order-categories]");
        if (!host) return;

        host.innerHTML = menu.categories
          .map((c) => {
            const active = this.selectedCategory === c.key;
            return `
              <button data-cat="${c.key}" style="
                padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
                background:${active ? "rgba(255,255,255,.16)" : "rgba(255,255,255,.06)"};
                color:#fff;font-weight:900;cursor:pointer;
              ">${c.label}</button>
            `;
          })
          .join("");

        $$("button[data-cat]", host).forEach((b) => {
          b.addEventListener("click", () => {
            this.selectedCategory = b.getAttribute("data-cat");
            store.set("milk_order_cat", this.selectedCategory);
            ui.order.renderCategories();
            ui.order.renderProducts();
          });
        });
      },

      pickVariant(product) {
        if (!product._hasVariants) return null;
        const variants = product.variants || [];

        // mały picker w modalu
        const wrap = document.createElement("div");
        wrap.style.display = "grid";
        wrap.style.gap = "10px";

        const list = document.createElement("div");
        list.style.display = "grid";
        list.style.gap = "8px";

        variants.forEach((v, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.style.padding = "12px";
          btn.style.borderRadius = "14px";
          btn.style.border = "1px solid rgba(255,255,255,.14)";
          btn.style.background = "rgba(255,255,255,.08)";
          btn.style.color = "#fff";
          btn.style.fontWeight = "900";
          btn.style.cursor = "pointer";
          btn.textContent = `${v.label || v.size || `Wariant ${idx + 1}`} — ${fmtPLN(v.price)}`;
          btn.addEventListener("click", () => {
            modal.hide();
            cart.add(product, v);
            toast("Dodano do koszyka", "ok");
            ui.order.renderCart();
            ui.refreshHeader();
          });
          list.appendChild(btn);
        });

        wrap.innerHTML = `<div style="opacity:.85">Wybierz wariant:</div>`;
        wrap.appendChild(list);
        modal.show(product.title, wrap);
        return "__handled__";
      },

      renderProducts() {
        const host = $("#orderProducts") || $("[data-order-products]");
        if (!host) return;

        const cat = this.selectedCategory;
        if (!cat) {
          host.innerHTML = `<div style="opacity:.75;padding:6px 2px;">Wybierz kategorię, aby zobaczyć produkty.</div>`;
          return;
        }

        const items = menu.items.filter((x) => x._categoryKey === cat);
        host.innerHTML = items
          .map((it) => {
            const priceLabel = it._hasVariants ? `od ${fmtPLN(it._priceFrom)}` : fmtPLN(it._priceFrom);
            return `
              <div style="padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;gap:8px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
                  <div>
                    <div style="font-weight:1000">${it.title}</div>
                    ${it.desc ? `<div style="opacity:.78">${it.desc}</div>` : ""}
                    ${it.tag ? `<div style="opacity:.6;font-size:12px;margin-top:2px">${it.tag}</div>` : ""}
                  </div>
                  <div style="font-weight:1000;white-space:nowrap;">${priceLabel}</div>
                </div>
                <button data-add="${it._id}" style="
                  padding:12px;border-radius:14px;border:0;background:rgba(255,255,255,.16);
                  color:#fff;font-weight:900;cursor:pointer;
                ">Dodaj</button>
              </div>
            `;
          })
          .join("");

        $$("button[data-add]", host).forEach((btn) => {
          btn.addEventListener("click", () => {
            if (!ui.requireLogin("Zamów i odbierz")) return;
            const id = btn.getAttribute("data-add");
            const it = menu.items.find((x) => x._id === id);
            if (!it) return;

            if (it._hasVariants) {
              ui.order.pickVariant(it);
              return;
            }

            cart.add(it, null);
            toast("Dodano do koszyka", "ok");
            ui.order.renderCart();
            ui.refreshHeader();
          });
        });
      },

      renderCart() {
        const host = $("#cartList") || $("[data-cart-list]");
        const sumEl = $("#cartSum") || $("[data-cart-sum]");
        const countEl = $("#cartCount") || $("[data-cart-count]");

        const arr = cart.get();
        if (countEl) countEl.textContent = String(cart.count());
        if (sumEl) sumEl.textContent = fmtPLN(cart.sum());

        if (!host) return;
        if (!arr.length) {
          host.innerHTML = `<div style="opacity:.75">Koszyk jest pusty.</div>`;
          return;
        }

        host.innerHTML = arr
          .map((x) => {
            const line = (Number(x.price) || 0) * (Number(x.qty) || 0);
            return `
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);">
                <div style="min-width:0">
                  <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.title}</div>
                  ${x.desc ? `<div style="opacity:.7;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.desc}</div>` : ""}
                  <div style="opacity:.8;font-size:12px">${fmtPLN(x.price)} × ${x.qty} = <b>${fmtPLN(line)}</b></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
                  <button data-dec="${x.id}" style="width:36px;height:36px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;font-weight:1000;cursor:pointer;">−</button>
                  <button data-inc="${x.id}" style="width:36px;height:36px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;font-weight:1000;cursor:pointer;">+</button>
                </div>
              </div>
            `;
          })
          .join("");

        $$("button[data-inc]", host).forEach((b) => b.addEventListener("click", () => { cart.inc(b.getAttribute("data-inc")); ui.order.renderCart(); ui.refreshHeader(); }));
        $$("button[data-dec]", host).forEach((b) => b.addEventListener("click", () => { cart.dec(b.getAttribute("data-dec")); ui.order.renderCart(); ui.refreshHeader(); }));
      },

      bindCheckout() {
        const btn = $("#checkoutBtn") || $("[data-checkout-btn]");
        if (!btn) return;

        btn.addEventListener("click", async () => {
          if (!ui.requireLogin("Zamów i odbierz")) return;

          const arr = cart.get();
          if (!arr.length) return toast("Koszyk jest pusty", "error");

          const name = ($("#checkoutName") || $("[data-checkout-name]"))?.value?.trim() || auth.name();
          const phone = ($("#checkoutPhone") || $("[data-checkout-phone]"))?.value?.trim() || "";
          const notes = ($("#checkoutNotes") || $("[data-checkout-notes]"))?.value?.trim() || "";
          const pickupTime = ($("#checkoutTime") || $("[data-checkout-time]"))?.value?.trim() || "";
          const location = ($("#checkoutLocation") || $("[data-checkout-location]"))?.value?.trim() || "Słupsk";

          if (!name) return toast("Podaj imię", "error");
          if (!phone || phone.length < 7) return toast("Podaj poprawny numer telefonu", "error");
          if (String(location).toLowerCase().includes("rowy")) return toast("Rowy chwilowo niedostępne dla zamówień", "error");

          const payload = {
            email: auth.email(),
            milkId: milkId.getForEmail(auth.email()),
            name,
            phone,
            notes,
            pickupTime,
            location,
            items: arr.map((x) => ({ title: x.title, qty: x.qty, price: x.price })),
            total: cart.sum(),
            currency: "PLN",
            source: "milk-pwa",
          };

          btn.disabled = true;
          btn.style.opacity = ".65";
          try {
            await orders.create(payload);
            cart.clear();
            toast("Zamówienie wysłane ✅", "ok");
            ui.order.renderCart();
            ui.renderOrders();
            ui.refreshHeader();
          } catch (e) {
            toast(e?.message || "Nie udało się wysłać zamówienia", "error");
          } finally {
            btn.disabled = false;
            btn.style.opacity = "";
          }
        });
      },
    },

    async renderOrders() {
      const host = $("#ordersList") || $("[data-orders-list]");
      if (!host) return;
      if (!this.requireLogin("Historia zamówień")) return;

      host.innerHTML = `<div style="opacity:.75">Ładowanie…</div>`;
      const list = await orders.my().catch(() => []);
      if (!Array.isArray(list) || !list.length) {
        host.innerHTML = `<div style="opacity:.75">Brak zamówień.</div>`;
        return;
      }

      host.innerHTML = list
        .slice(0, 20)
        .map((o) => {
          const d = new Date(o.ts || o.createdAt || Date.now());
          const items = (o.items || []).slice(0, 6).map((i) => `${i.title} × ${i.qty}`).join(", ");
          return `
            <div style="padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;gap:6px;">
              <div style="display:flex;justify-content:space-between;gap:10px;">
                <div style="font-weight:1000">${o.location || "Słupsk"} • ${fmtPLN(o.total || 0)}</div>
                <div style="opacity:.75;font-weight:900">${o.status || "new"}</div>
              </div>
              <div style="opacity:.8;font-size:13px">${items}${(o.items || []).length > 6 ? "…" : ""}</div>
              <div style="opacity:.65;font-size:12px">${d.toLocaleString()}</div>
            </div>
          `;
        })
        .join("");
    },

    async renderReservations() {
      const host = $("#reservationsList") || $("[data-res-list]");
      if (!host) return;
      if (!this.requireLogin("Rezerwacje")) return;

      host.innerHTML = `<div style="opacity:.75">Ładowanie…</div>`;
      const list = await reservations.my().catch(() => []);
      if (!Array.isArray(list) || !list.length) {
        host.innerHTML = `<div style="opacity:.75">Brak rezerwacji.</div>`;
        return;
      }

      host.innerHTML = list
        .slice(0, 20)
        .map((r) => {
          const d = new Date(r.ts || r.date || Date.now());
          return `
            <div style="padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;gap:6px;">
              <div style="display:flex;justify-content:space-between;gap:10px;">
                <div style="font-weight:1000">${r.name || auth.name() || "Rezerwacja"}</div>
                <div style="opacity:.75;font-weight:900">${r.people ? `${r.people} os.` : ""}</div>
              </div>
              <div style="opacity:.85">${r.when || r.time || d.toLocaleString()}</div>
              ${r.notes ? `<div style="opacity:.75;font-size:13px">${r.notes}</div>` : ""}
            </div>
          `;
        })
        .join("");
    },

    bindAccount() {
      const loginBtn = $("#btnLogin") || $("[data-login-btn]");
      const logoutBtn = $("#btnLogout") || $("[data-logout-btn]");
      const milkIdBtn = $("#btnMilkId") || $("[data-milkid-btn]");

      if (loginBtn) loginBtn.addEventListener("click", () => this.openLogin());
      if (logoutBtn) logoutBtn.addEventListener("click", () => {
        auth.logout();
        toast("Wylogowano", "ok");
        this.refreshAll();
      });
      if (milkIdBtn) milkIdBtn.addEventListener("click", () => this.openMilkId());
    },

    bindTabs() {
      const tabButtons = $$("[data-tab]");
      if (!tabButtons.length) return;

      tabButtons.forEach((b) => {
        b.addEventListener("click", () => {
          const id = b.getAttribute("data-tab");
          if (id) this.setTab(id);
        });
      });
    },

    /* --- USUNIĘTE: przycisk "odśwież dane z serwera"
       Jeśli w HTML był element, nic nie binduję i nie używam. --- */

    refreshAll() {
      this.refreshHeader();
      this.renderPoints();
      this.renderRewards();
      this.order.renderCart();
      // zamówienia/rezerwacje tylko gdy na danej karcie (i po zalogowaniu)
      const last = store.get("milk_last_tab", null);
      if (last === "order") this.renderOrders();
      if (last === "reservations") this.renderReservations();
    },
  };

  /* ---------- Install Overlay (jeśli masz) ---------- */
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = $("#installBtn") || $("[data-install-btn]");
    if (btn) btn.style.display = "";
  });

  const bindInstall = () => {
    const btn = $("#installBtn") || $("[data-install-btn]");
    if (!btn) return;
    btn.addEventListener("click", async () => {
      if (!deferredPrompt) return toast("Instalacja niedostępna na tym urządzeniu", "error");
      deferredPrompt.prompt();
      await deferredPrompt.userChoice.catch(() => null);
      deferredPrompt = null;
      toast("Dzięki! 💛", "ok");
      btn.style.display = "none";
    });
  };

  /* ---------- Service Worker ---------- */
  const bindSW = () => {
    if (!("serviceWorker" in navigator)) return;
    const swPath = "sw.js";
    navigator.serviceWorker.register(swPath).catch(() => {});
  };

  /* ---------- Boot ---------- */
  const boot = () => {
    ui.bindTabs();
    ui.bindAccount();
    bindInstall();
    bindSW();

    // Order setup
    ui.order.selectedCategory = store.get("milk_order_cat", null);
    ui.order.renderCategories();
    ui.order.renderProducts();
    ui.order.renderCart();
    ui.order.bindCheckout();

    // Default tab
    const last = store.get("milk_last_tab", "points");
    ui.setTab(last);

    // Jeżeli masz gdzieś przyciski “moja historia zamówień” / “odśwież listę”
    const ordersRefresh = $("#ordersRefresh") || $("[data-orders-refresh]");
    if (ordersRefresh) ordersRefresh.addEventListener("click", () => ui.renderOrders());

    const resRefresh = $("#resRefresh") || $("[data-res-refresh]");
    if (resRefresh) resRefresh.addEventListener("click", () => ui.renderReservations());

    // Opcjonalnie: szybki “debug” – dodaj testowe punkty (jeśli masz przycisk)
    const addPtsBtn = $("#debugAddPts") || $("[data-debug-addpts]");
    if (addPtsBtn) addPtsBtn.addEventListener("click", () => {
      points.add(10, "Bonus");
      toast("+10 pkt", "ok");
      ui.refreshAll();
    });

    ui.refreshAll();
  };

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();

})();
</script>
</body>
</html>
