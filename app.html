<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Milk</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/favicon.png">
  <meta name="theme-color" content="#ff6a00">


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary:#FF6A00;
      --secondary:#FF9100;
      --accent:#FFE0B2;
      --bg:#FFF6EC;
      --text:#2B1300;
      --white:#fff;
      --grad:linear-gradient(135deg,var(--primary),var(--secondary));
      --radius:20px;
      --shadow:0 14px 40px rgba(0,0,0,.12);
      --shadow-soft:0 8px 22px rgba(0,0,0,.08);
      --glass:rgba(255,255,255,.82);
      --glass-strong:rgba(255,255,255,.97);
      --success:#16A34A;
      --danger:#DC2626;
      --link:#8a3d00;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      padding-bottom: calc(118px + var(--safe-bottom));
    }

    .blob{
      position:fixed;z-index:-1;filter:blur(70px);opacity:.33;
      width:280px;height:280px;border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, #ffe1c7, transparent 60%),
        var(--grad);
    }
    .blob.b1{top:-70px;left:-70px}
    .blob.b2{bottom:-110px;right:-90px;transform:rotate(25deg)}

    .topbar{
      position:sticky;top:0;z-index:20;
      padding: calc(10px + var(--safe-top)) 14px 10px;
      background:rgba(255,246,236,.96);
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(0,0,0,.06);
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:900;
      font-size:1.08rem;letter-spacing:.2px;
    }
    .logo-wrap{
      width:40px;height:40px;border-radius:50%;
      background:rgba(255,255,255,.9);
      display:grid;place-items:center;
      box-shadow:var(--shadow-soft);
      border:2px solid rgba(255,255,255,.9);
      overflow:hidden;
    }
    .logo-wrap img{
      width:100%;height:100%;object-fit:cover;border-radius:50%;
    }
    .pill{
      background:var(--grad);
      color:#fff;font-weight:900;font-size:.85rem;
      padding:7px 11px;border-radius:999px;
      display:flex;gap:7px;align-items:center;
      box-shadow:0 6px 16px rgba(255,106,0,.35);
    }

    .container{padding:14px;max-width:820px;margin:0 auto;}
    .stack{display:flex;flex-direction:column;gap:12px;}
    .card{
      background:var(--glass);
      backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.98);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .title{
      font-size:1.6rem;font-weight:900;
      background:var(--grad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .subtitle{font-weight:900;margin-bottom:8px;font-size:1.05rem;}
    .muted{opacity:.82;font-size:.95rem;line-height:1.55}
    .tiny{font-size:.82rem;opacity:.7}

    label{font-size:.9rem;font-weight:900;margin:8px 0 6px;display:block}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:14px;
      border:2px solid #eee;background:var(--white);
      font-size:1rem;outline:none;
      transition:.2s border-color,.2s box-shadow,.2s transform;
      font-family:inherit;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 6px 18px rgba(255,106,0,.12);
      transform:translateY(-1px);
    }
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .btn{
      border:none;cursor:pointer;font-weight:900;border-radius:16px;
      padding:12px 14px;display:inline-flex;align-items:center;gap:8px;
      transition:.2s transform,.2s box-shadow,.2s opacity,.2s background;
      text-decoration:none;user-select:none;-webkit-tap-highlight-color: transparent;
      justify-content:center;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      background:var(--grad);color:#fff;
      box-shadow:0 8px 22px rgba(255,106,0,.5);
    }
    .btn-ghost{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      color:var(--text);
    }
    .btn-small{padding:8px 10px;font-size:.9rem;border-radius:12px}
    .btn-wide{width:100%;}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .tab{display:none;animation:fade .22s ease}
    .tab.active{display:block}
    @keyframes fade{
      from{opacity:0;transform:translateY(8px) scale(.99)}
      to{opacity:1;transform:none}
    }

    .points-hero{
      background:var(--grad);color:#fff;border-radius:22px;padding:16px;
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
      box-shadow:var(--shadow);position:relative;overflow:hidden;
    }
    .points-hero::after{
      content:"";position:absolute;right:-40px;top:-40px;width:170px;height:170px;
      background:radial-gradient(circle, rgba(255,255,255,.45), transparent 60%);
      transform:rotate(18deg);
      pointer-events:none;
    }
    #showCodeBtn{position:relative;z-index:2;}
    .points-count{font-size:2.5rem;font-weight:900;letter-spacing:.6px;line-height:1;}
    .points-sub{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap;}
    .chip{
      background:rgba(255,255,255,.2);
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:.82rem;
      display:inline-flex;gap:6px;align-items:center;
    }
    .progress{margin-top:10px;background:rgba(255,255,255,.24);height:10px;border-radius:999px;overflow:hidden;}
    .progress > div{height:100%;background:rgba(255,255,255,.96);width:0%;transition:width .35s ease;border-radius:999px;}

    .opening-card{
      background: var(--glass);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,.98);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      padding: 12px 14px;
      display: grid;
      gap: 8px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .opening-status{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:900;
      font-size:1.02rem;
    }
    .status-dot{
      width:10px;height:10px;border-radius:50%;
      background:#ccc;
      box-shadow: 0 0 0 3px rgba(0,0,0,.04);
    }
    .status-dot.open{ background: var(--success); }
    .status-dot.closed{ background: var(--danger); }
    .opening-hint{ font-size:.82rem; opacity:.75; font-weight:800; }
    .opening-hours{
      font-size:.9rem;
      line-height:1.55;
      opacity:.9;
      display:none;
      gap:2px;
      padding-top:6px;
      border-top:1px dashed rgba(0,0,0,.08);
    }
    .opening-card.expanded .opening-hours{ display:grid; }
    .opening-hours b{ font-weight:900; }
    .opening-hours .today{ font-weight:900; color: var(--link); }

    .quick-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
    .quick{
      background:var(--glass-strong);border:1px solid rgba(0,0,0,.04);
      border-radius:18px;padding:12px;display:grid;gap:6px;place-items:center;text-align:center;
      box-shadow:var(--shadow-soft);
      transition:.2s transform,.2s box-shadow;
      -webkit-tap-highlight-color: transparent;
    }
    .quick:active{transform:translateY(1px)}
    .quick i{
      width:46px;height:46px;border-radius:14px;display:grid;place-items:center;
      background:var(--grad);color:#fff;box-shadow:0 6px 16px rgba(255,106,0,.45);
      font-size:1.1rem;
    }
    .quick b{font-size:.95rem;font-weight:900}
    .quick span{font-size:.8rem;opacity:.7}

    .eatmi-banner{
      margin-top:14px;
      width:100%;
      border-radius:22px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      background:
        linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,145,0,.95));
      color:#fff;
      box-shadow:0 14px 34px rgba(255,106,0,.45);
      text-decoration:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
      transition:.25s transform,.25s box-shadow,.25s opacity;
    }
    .eatmi-banner::after{
      content:"";
      position:absolute;
      right:-60px; top:-60px;
      width:220px; height:220px;
      background:radial-gradient(circle, rgba(255,255,255,.38), transparent 65%);
      transform:rotate(18deg);
      pointer-events:none;
    }
    .eatmi-banner:hover{ box-shadow:0 18px 42px rgba(255,106,0,.55); }
    .eatmi-banner:active{ transform:translateY(1px); }

    .eatmi-left{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
      position:relative;
      z-index:2;
    }
    .eatmi-logo{
      width:56px;
      height:56px;
      border-radius:18px;
      background:#fff;
      display:grid;
      place-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.18);
      flex:0 0 auto;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.35);
    }
    .eatmi-logo img{
      width:74%;
      height:74%;
      object-fit:contain;
    }
    .eatmi-text{ min-width:0; }
    .eatmi-text b{
      font-size:1.12rem;
      font-weight:900;
      display:block;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .eatmi-text span{
      font-size:.92rem;
      opacity:.92;
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .eatmi-cta{
      position:relative;
      z-index:2;
      flex:0 0 auto;
      background:#fff;
      color:#ff6a00;
      font-weight:900;
      border-radius:16px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      transition:.2s transform;
    }
    .eatmi-banner:hover .eatmi-cta{ transform:translateX(2px); }

    .reward{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:var(--glass-strong);border:1px solid rgba(0,0,0,.04);
      border-radius:18px;padding:12px;
      box-shadow:var(--shadow-soft);
    }
    .reward-left{display:flex;gap:12px;align-items:center;}
    .reward-ico{
      width:52px;height:52px;border-radius:16px;background:var(--grad);color:#fff;display:grid;place-items:center;
      box-shadow:0 6px 16px rgba(255,106,0,.45);font-size:1.25rem;
    }
    .reward-title{font-weight:900}
    .reward + .reward{margin-top:10px}

    .res-item{
      padding:10px;border-radius:14px;background:#fff;border:1px solid #eee;display:grid;gap:4px;
    }
    .res-item b{font-weight:900}
    .res-actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;}
    .divider{height:1px;background:rgba(0,0,0,.06);margin:4px 0 0;}

    .menu-list{display:grid;gap:10px;}
    .menu-item{
      background:var(--glass-strong);
      border:1px solid rgba(0,0,0,.05);
      border-radius:16px;
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow:var(--shadow-soft);
    }
    .menu-left{display:flex;gap:10px;align-items:center;}
    .menu-ico{
      width:48px;height:48px;border-radius:14px;background:var(--grad);color:#fff;
      display:grid;place-items:center;font-size:1.2rem;box-shadow:0 6px 14px rgba(255,106,0,.4);
    }
    .menu-title{font-weight:900}
    .menu-desc{font-size:.85rem;opacity:.7}
    .menu-price{font-weight:900}
    .cart-line{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      background:#fff;border:1px solid #eee;border-radius:12px;padding:8px 10px;
    }
    .cart-actions{display:flex;gap:6px;align-items:center;}
    .qty-btn{
      width:28px;height:28px;border-radius:8px;border:none;cursor:pointer;font-weight:900;
      background:rgba(0,0,0,.06);
    }

    .account-hero{display:flex;gap:12px;align-items:center;}
    .avatar{
      width:56px;height:56px;border-radius:16px;background:var(--grad);display:grid;place-items:center;
      color:#fff;font-size:1.3rem;font-weight:900;box-shadow:0 8px 20px rgba(255,106,0,.5);
    }
    .account-name{font-weight:900;font-size:1.1rem}
    .account-mail{font-size:.9rem;opacity:.75}
    .list{display:flex;flex-direction:column;gap:8px;}
    .list-item{
      background:var(--glass-strong);border:1px solid rgba(0,0,0,.04);
      padding:12px;border-radius:16px;display:flex;align-items:center;justify-content:space-between;
      box-shadow:var(--shadow-soft);
      cursor:pointer;transition:.2s transform,.2s box-shadow;-webkit-tap-highlight-color: transparent;
    }
    .list-item:active{transform:translateY(1px)}
    .list-left{display:flex;gap:10px;align-items:center;}
    .li-ico{
      width:40px;height:40px;border-radius:12px;background:rgba(0,0,0,.05);
      display:grid;place-items:center;font-size:1.05rem;
    }
    .li-title{font-weight:900}
    .li-sub{font-size:.85rem;opacity:.7}

    .auth-wrap{display:grid;gap:10px;}
    .auth-btn{width:100%;justify-content:center;font-weight:900;}
    .auth-btn.google{background:#fff;border:2px solid #eee;}
    .auth-sep{display:flex;align-items:center;gap:10px;margin:6px 0;}
    .auth-sep::before,.auth-sep::after{content:"";flex:1;height:1px;background:rgba(0,0,0,.08);}
    .auth-sep span{font-size:.85rem;opacity:.7;font-weight:800;}

    .subpage{
      position:fixed;inset:0;background:var(--bg);z-index:80;display:none;flex-direction:column;
      animation:slideIn .25s ease;padding-bottom: calc(20px + var(--safe-bottom));
    }
    .subpage.active{display:flex;}
    @keyframes slideIn{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:none}}
    .sub-top{
      position:sticky;top:0;z-index:5;
      padding: calc(10px + var(--safe-top)) 14px 10px;
      background:rgba(255,246,236,.96);backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(0,0,0,.06);
      display:flex;align-items:center;gap:10px;
    }
    .back-btn{
      width:40px;height:40px;border-radius:12px;border:none;background:#fff;cursor:pointer;
      display:grid;place-items:center;box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .sub-title{font-weight:900;font-size:1.05rem}

    .empty{
      background:var(--glass-strong);padding:14px;border-radius:16px;border:1px dashed rgba(0,0,0,.07);
      display:flex;gap:12px;align-items:center;
    }
    .empty .icon{
      width:48px;height:48px;border-radius:14px;background:var(--grad);color:#fff;display:grid;place-items:center;font-size:1.2rem;
      box-shadow:0 6px 14px rgba(255,106,0,.4);
    }

    .bottom-nav{
      position:fixed;
      left:0; right:0;
      bottom:10px;
      z-index:50;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .nav-wrap{
      pointer-events:auto;
      width:min(820px,calc(100% - 18px));
      background:rgba(255,255,255,.88);
      backdrop-filter:blur(16px);
      border:1px solid rgba(255,255,255,.98);
      box-shadow:0 10px 28px rgba(0,0,0,.18);
      border-radius:999px;
      padding:6px 6px;
      display:flex;
      gap:6px;
      align-items:stretch;
    }
    .nav-btn{
      flex:1 1 0;
      min-width:0;
      background:transparent;
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:8px 4px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-weight:900;
      color:var(--text);
      opacity:.7;
      transition:.2s all;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .nav-btn i{font-size:clamp(.95rem, 2.8vw, 1.12rem);line-height:1;}
    .nav-btn .lbl{font-size:clamp(.62rem, 2.2vw, .73rem);line-height:1.05;text-align:center;}
    .nav-btn.active{
      background:var(--grad);
      color:#fff;
      opacity:1;
      transform:translateY(-2px);
      box-shadow:0 8px 18px rgba(255,106,0,.45);
    }
    @media (max-width:560px){
      .row{grid-template-columns:1fr}
      .quick-grid{grid-template-columns:1fr 1fr 1fr}
    }
    @media (max-width:420px){ .eatmi-text span{display:none;} }
    @media (max-width:380px){ .quick-grid{grid-template-columns:1fr 1fr} }

    .toast{
      position:fixed;left:50%;bottom: calc(126px + var(--safe-bottom));
      transform:translateX(-50%) translateY(8px);
      background:var(--success);color:#fff;font-weight:900;font-size:.95rem;
      padding:10px 14px;border-radius:999px;box-shadow:0 10px 25px rgba(0,0,0,.25);
      opacity:0;pointer-events:none;transition:.25s;z-index:999;display:flex;gap:8px;align-items:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.danger{background:var(--danger)}

    .modal{position:fixed; inset:0; z-index:100; display:none;}
    .modal.show{display:block;}
    .modal-backdrop{
      position:absolute; inset:0;
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(2px);
      animation:fadeBg .18s ease;
    }
    @keyframes fadeBg{from{opacity:0}to{opacity:1}}
    .modal-sheet{
      position:absolute; left:0; right:0; bottom:0;
      background: var(--glass-strong);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 -12px 40px rgba(0,0,0,.25);
      padding: 10px 14px 18px;
      transform: translateY(12px);
      animation:sheetUp .22s ease forwards;
    }
    @keyframes sheetUp{to{transform:translateY(0)}}
    .modal-handle{
      width:46px; height:5px; border-radius:999px;
      background:rgba(0,0,0,.12); margin:6px auto 10px;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .modal-title{
      font-weight:900; font-size:1.2rem;
      background:var(--grad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .modal-close{
      width:40px; height:40px; border-radius:12px; border:none; cursor:pointer;
      background:#fff; display:grid; place-items:center;
      box-shadow: var(--shadow-soft);
    }
    .modal-code-box{
      background:#0f0f0f; color:#fff;
      border-radius:18px; padding:18px 14px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
    }
    .modal-code{
      font-size:2.4rem; font-weight:900;
      letter-spacing:10px; text-align:center;
      font-variant-numeric: tabular-nums;
    }
    .modal-actions{ margin-top:10px; display:grid; gap:8px; }

    .install-guide{
      position:fixed; inset:0; z-index:200;
      display:none;
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
      overflow:auto;
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(255,106,0,.12), transparent 60%),
        radial-gradient(900px 600px at 90% 90%, rgba(255,145,0,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,246,236,.98), rgba(255,246,236,.985));
    }
    .install-guide.show{ display:block; }
    .install-shell{ max-width: 860px; margin: 0 auto; display:grid; gap:12px; }
    .install-hero{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.98);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
    }
    .install-hero::after{
      content:"";
      position:absolute;
      right:-70px; top:-70px;
      width:260px; height:260px;
      background: radial-gradient(circle, rgba(255,106,0,.22), transparent 65%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .install-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .install-brand{display:flex;gap:12px;align-items:center;min-width:0;}
    .install-badge{
      width:54px;height:54px;border-radius:18px;
      background: var(--grad);
      color:#fff;
      display:grid;
      place-items:center;
      box-shadow: 0 12px 26px rgba(255,106,0,.35);
      font-size:1.25rem;
      flex:0 0 auto;
    }
    .install-headline{min-width:0;}
    .install-kicker{ font-weight:900; opacity:.72; font-size:.9rem; }
    .install-title{
      font-size:1.35rem;
      font-weight:900;
      margin-top:2px;
      line-height:1.15;
      background:var(--grad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .install-sub{
      margin-top:6px;
      opacity:.86;
      line-height:1.45;
      font-weight:700;
      max-width: 58ch;
    }
    .platform-switch{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:12px;
    }
    .platform-btn{
      border:none; cursor:pointer;
      padding:12px 10px;
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      -webkit-tap-highlight-color: transparent;
      transition:.2s transform,.2s box-shadow,.2s opacity,.2s background;
      color: var(--text);
      opacity:.88;
    }
    .platform-btn i{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: rgba(0,0,0,.05);
      font-size:1.05rem;
    }
    .platform-btn.active{
      background: var(--grad);
      color:#fff;
      opacity:1;
      box-shadow:0 10px 22px rgba(255,106,0,.32);
      transform: translateY(-1px);
    }
    .platform-btn.active i{ background: rgba(255,255,255,.22); color:#fff; }

    .install-panel{
      background: rgba(255,255,255,.84);
      border: 1px solid rgba(255,255,255,.98);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .install-pane{ display:none; }
    .install-pane.active{ display:block; }
    .steps{ display:grid; gap:10px; margin-top:10px; }
    .step{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.05);
      box-shadow: var(--shadow-soft);
    }
    .step-num{
      width:36px;height:36px;border-radius:14px;
      background: var(--grad);
      color:#fff;
      display:grid;place-items:center;
      font-weight:900;
      flex:0 0 auto;
      box-shadow:0 8px 18px rgba(255,106,0,.28);
    }
    .step-body b{ font-weight:900; }
    .step-body{ line-height:1.45; font-weight:750; opacity:.92; }
    .install-ctaRow{ display:grid; gap:8px; margin-top:12px; }
    .install-note{
      margin-top:10px;
      font-size:.86rem;
      opacity:.82;
      line-height:1.45;
      font-weight:700;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(0,0,0,.10);
    }
    .install-note i{ color: var(--primary); }
    .install-helpRow{ margin-top:12px; display:grid; gap:8px; }
    .help-pill{
      background: rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow-soft);
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-weight:750;
      opacity:.92;
      line-height:1.45;
    }
    .help-pill .hico{
      width:40px;height:40px;border-radius:14px;
      background: rgba(0,0,0,.05);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .help-pill b{ font-weight:900; }

    @media (max-width:520px){
      .platform-switch{ grid-template-columns:1fr; }
    }

    /* =========================
       ‚úÖ Kategorie + FAB
       ========================= */
    .categories-bar{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:4px 2px 10px;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
    }
    .cat-chip{
      flex:0 0 auto;
      scroll-snap-align:start;
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow-soft);
      opacity:.9;
      transition:.2s transform,.2s box-shadow,.2s opacity,.2s background;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .cat-chip:active{transform:translateY(1px)}
    .cat-chip.active{
      background:var(--grad);
      color:#fff;
      opacity:1;
      box-shadow:0 10px 22px rgba(255,106,0,.35);
    }

    .order-fab{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(86px + var(--safe-bottom)); /* nad dolnym nav */
      width:min(820px, calc(100% - 18px));
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:12px 14px;
      background:var(--grad);
      color:#fff;
      font-weight:900;
      box-shadow:0 16px 34px rgba(255,106,0,.45);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      z-index:60;
      -webkit-tap-highlight-color: transparent;
    }
    .order-fab:active{transform:translateX(-50%) translateY(1px)}
    .fab-left{display:flex;align-items:center;gap:10px;}
    .fab-right{opacity:.95;}
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>

  <!-- INSTALL GUIDE -->
  <section id="installGuide" class="install-guide" aria-hidden="true">
    <div class="install-shell">

      <div class="install-hero">
        <div class="install-top">
          <div class="install-brand">
            <div class="install-badge"><i class="fa-solid fa-mobile-screen-button"></i></div>
            <div class="install-headline">
              <div class="install-kicker">Milk ‚Ä¢ uruchom jak aplikacjƒô</div>
              <div class="install-title">Dodaj Milk do ekranu g≈Ç√≥wnego</div>
              <div class="install-sub">
                To zajmie <b>oko≈Ço 10 sekund</b>. Potem otwierasz Milk z ikony ‚Äî szybciej i wygodniej.
              </div>
            </div>
          </div>
        </div>

        <div class="platform-switch" style="position:relative;z-index:2;">
          <button class="platform-btn active" data-guide-tab="android">
            <i class="fa-brands fa-android"></i> Android (Chrome)
          </button>
          <button class="platform-btn" data-guide-tab="ios">
            <i class="fa-brands fa-apple"></i> iPhone / iPad (Safari)
          </button>
        </div>
      </div>

      <div class="install-panel">
        <div class="install-pane active" data-guide-pane="android">
          <div class="subtitle" style="margin:0;">Android ‚Äî instalacja</div>
          <div class="tiny" style="margin-top:4px; opacity:.78;">
            Najczƒô≈õciej dzia≈Ça w <b>Chrome</b>. Je≈õli widzisz przycisk ‚ÄûZainstaluj‚Äù, kliknij go.
          </div>

          <div class="install-ctaRow">
            <button id="androidInstallBtn" class="btn btn-primary btn-wide" style="display:none;">
              Zainstaluj teraz <i class="fa-solid fa-download"></i>
            </button>
            <div class="tiny" id="androidInstallHint" style="opacity:.78; text-align:center;">
              Je≈õli nie widzisz przycisku ‚Äî zr√≥b to rƒôcznie poni≈ºej.
            </div>
          </div>

          <div class="steps">
            <div class="step"><div class="step-num">1</div><div class="step-body">Naci≈õnij menu przeglƒÖdarki: <b>‚ãÆ</b> (prawy g√≥rny r√≥g).</div></div>
            <div class="step"><div class="step-num">2</div><div class="step-body">Wybierz <b>‚ÄûZainstaluj aplikacjƒô‚Äù</b> lub <b>‚ÄûDodaj do ekranu g≈Ç√≥wnego‚Äù</b>.</div></div>
            <div class="step"><div class="step-num">3</div><div class="step-body">Potwierd≈∫: <b>Zainstaluj / Dodaj</b>. Gotowe ‚úÖ</div></div>
          </div>

          <div class="install-helpRow">
            <div class="help-pill">
              <div class="hico"><i class="fa-solid fa-circle-question"></i></div>
              <div>
                <b>Nie widzƒô tej opcji?</b><br>
                Upewnij siƒô, ≈ºe masz otwarte w <b>Chrome</b> i od≈õwie≈º stronƒô.
              </div>
            </div>
          </div>

          <div class="install-note">
            <i class="fa-solid fa-shield-heart"></i>
            Poradnik zniknie automatycznie, gdy uruchomisz Milk z ikony (tryb aplikacji).
            <div class="tiny" style="margin-top:6px; opacity:.78;">
              Problem? Napisz: <b>support@velorie.pl</b>
            </div>
          </div>
        </div>

        <div class="install-pane" data-guide-pane="ios">
          <div class="subtitle" style="margin:0;">iPhone / iPad ‚Äî instalacja</div>
          <div class="tiny" style="margin-top:4px; opacity:.78;">
            Wa≈ºne: na iOS dodawanie dzia≈Ça w <b>Safari</b> (nie w Chrome).
          </div>

          <div class="steps">
            <div class="step"><div class="step-num">1</div><div class="step-body">Otw√≥rz tƒô stronƒô w <b>Safari</b>.</div></div>
            <div class="step"><div class="step-num">2</div><div class="step-body">Kliknij <b>Udostƒôpnij</b> (ikonka <b>‚¨ÜÔ∏è</b> na dole ekranu).</div></div>
            <div class="step"><div class="step-num">3</div><div class="step-body">Wybierz <b>‚ÄûDodaj do ekranu poczƒÖtkowego‚Äù</b>, potem <b>Dodaj</b>. Gotowe ‚úÖ</div></div>
          </div>

          <div class="install-helpRow">
            <div class="help-pill">
              <div class="hico"><i class="fa-solid fa-lightbulb"></i></div>
              <div>
                <b>Nie ma ‚ÄûDodaj do ekranu‚Äù?</b><br>
                Przewi≈Ñ listƒô w d√≥≈Ç w panelu udostƒôpniania. Je≈õli dalej brak ‚Äî upewnij siƒô, ≈ºe to <b>Safari</b>.
              </div>
            </div>
          </div>

          <div class="install-note">
            <i class="fa-solid fa-shield-heart"></i>
            Poradnik zniknie automatycznie, gdy uruchomisz Milk z ikony (tryb aplikacji).
            <div class="tiny" style="margin-top:6px; opacity:.78;">
              Problem? Napisz: <b>support@velorie.pl</b>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo-wrap">
        <img src="https://i.imgur.com/UNPIPSC.png" alt="Milk logo">
      </div>
      Milk
    </div>
    <div class="pill"><i class="fa-solid fa-star"></i> <span id="pointsPill">Zaloguj siƒô</span></div>
  </div>

  <main class="container">

    <!-- TAB: PUNKTY -->
    <section id="tab-points" class="tab active">

      <div class="opening-card" id="openingCard" title="Kliknij, aby zobaczyƒá godziny otwarcia">
        <div class="opening-status">
          <span class="status-dot" id="openDot"></span>
          <span id="openText">Sprawdzam status...</span>
        </div>
        <div class="opening-hint" id="openHint">Kliknij, aby zobaczyƒá godziny otwarcia</div>
        <div class="opening-hours" id="openingHours"></div>
      </div>

      <div class="points-hero">
        <div>
          <div class="tiny">Twoje punkty</div>
          <div class="points-count" id="pointsCount">‚Äî</div>
          <div class="points-sub">
            <div class="chip"><i class="fa-solid fa-receipt"></i> 10 z≈Ç = 1 pkt</div>
          </div>
        </div>

        <button class="btn btn-ghost btn-small" id="showCodeBtn">
          <i class="fa-solid fa-id-card"></i> Milk ID
        </button>
      </div>

      <div class="progress"><div id="pointsProgress"></div></div>

      <div class="card">
        <div class="subtitle">Szybkie akcje</div>
        <div class="quick-grid">
          <button class="quick" data-go="rewards">
            <i class="fa-solid fa-gift"></i>
            <b>Nagrody</b>
            <span>Wymie≈Ñ punkty</span>
          </button>

          <button class="quick" data-go="order">
            <i class="fa-solid fa-bag-shopping"></i>
            <b>Zam√≥w i odbierz</b>
            <span>P≈Çatno≈õƒá na miejscu</span>
          </button>

          <button class="quick" data-go="res">
            <i class="fa-solid fa-calendar-check"></i>
            <b>Rezerwuj</b>
            <span>Stolik w 10s</span>
          </button>
        </div>

        <a class="eatmi-banner" href="https://www.eatmi.pl" target="_blank" rel="noopener">
          <div class="eatmi-left">
            <div class="eatmi-logo">
              <img src="https://i.imgur.com/XrTPEHC.png" alt="Eatmi logo">
            </div>
            <div class="eatmi-text">
              <b>Eatmi</b>
              <span>Zamawiaj online szybciej i wygodniej</span>
            </div>
          </div>
          <div class="eatmi-cta">
            Przejd≈∫ <i class="fa-solid fa-arrow-up-right-from-square"></i>
          </div>
        </a>
      </div>

      <div class="card">
        <div class="subtitle">Historia punkt√≥w</div>
        <div id="pointsHistory" class="muted"></div>
      </div>
    </section>

    <!-- TAB: NAGRODY -->
    <section id="tab-rewards" class="tab">
      <div class="card">
        <div class="title">Nagrody</div>
        <p class="muted">Kliknij ‚ÄûWymie≈Ñ‚Äù, a poka≈ºemy Ci kod do odbioru w lokalu.</p>
      </div>
      <div class="card" id="rewardsList"></div>
    </section>

    <!-- TAB: ZAM√ìW I ODBIERZ -->
    <section id="tab-order" class="tab">
      <div class="card">
        <div class="title">Zam√≥w i odbierz</div>
        <p class="muted">
          Z≈Ç√≥≈º zam√≥wienie w aplikacji, odbierz w lokalu. <b>P≈Çatno≈õƒá na miejscu</b> (got√≥wka/karta).
        </p>
      </div>

      <div class="card">
        <div class="subtitle">Menu</div>
        <div class="tiny" id="menuHint" style="opacity:.78;margin:-4px 0 10px">
          Wybierz kategoriƒô, aby zobaczyƒá produkty.
        </div>

        <div id="categoriesBar" class="categories-bar"></div>
        <div id="menuList" class="menu-list"></div>
      </div>

      <div class="card stack">
        <div class="subtitle">Koszyk</div>
        <div id="cartList" class="stack"></div>
        <div class="divider"></div>
        <div style="display:flex;justify-content:space-between;font-weight:900;font-size:1.05rem">
          <span>Razem</span><span id="cartTotal">0 z≈Ç</span>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Imiƒô i nazwisko (wymagane)</label>
            <input type="text" id="orderCustomerName" placeholder="Jan Kowalski" required>
          </div>
          <div>
            <label>Telefon (wymagane)</label>
            <input type="tel" id="orderCustomerPhone" placeholder="+48 700 000 000" required>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div>
            <label>Godzina odbioru</label>
            <input type="time" id="pickupTime" required step="900">
            <div class="tiny" id="pickupRuleHint" style="margin-top:6px;opacity:.78;text-align:center"></div>
          </div>
          <div>
            <label>Lokal</label>
            <select id="pickupLocation">
              <option>S≈Çupsk</option>
              <option value="Rowy" disabled>Rowy (chwilowo niedostƒôpna)</option>
            </select>
            <div class="tiny" style="margin-top:6px;opacity:.78;text-align:center">
              Rowy jest chwilowo niedostƒôpne.
            </div>
          </div>
        </div>

        <div>
          <label>Uwagi (opcjonalnie)</label>
          <textarea id="orderNotes" placeholder="np. bez bitej ≈õmietany, alergie, itp."></textarea>
        </div>

        <button class="btn btn-primary btn-wide" id="submitOrderBtn">
          Z≈Ç√≥≈º zam√≥wienie <i class="fa-solid fa-check"></i>
        </button>
        <div class="tiny" style="text-align:center">
          P≈Çatno≈õƒá na miejscu przy odbiorze.
        </div>
      </div>

      <div class="card">
        <div class="subtitle">Twoje zam√≥wienia</div>
        <div id="ordersList" class="muted"></div>
      </div>

      <button id="orderSummaryFab" class="order-fab" style="display:none;">
        <span class="fab-left">
          <i class="fa-solid fa-receipt"></i>
          <b>Podsumowanie</b>
        </span>
        <span class="fab-right">
          <span id="fabItems">0</span> ‚Ä¢ <span id="fabTotal">0 z≈Ç</span>
        </span>
      </button>
    </section>

    <!-- TAB: REZERWACJE -->
    <section id="tab-res" class="tab">
      <div class="card">
        <div class="title">Rezerwacje</div>
        <p class="muted">Zarezerwuj stolik w kilka sekund. Potwierdzenie dostaniesz SMS lub telefonicznie.</p>
      </div>

      <div class="card">
        <div class="subtitle">Formularz rezerwacji</div>
        <form id="reservationForm" class="stack">
          <div>
            <label>Imiƒô i nazwisko</label>
            <input name="name" required placeholder="Jan Kowalski">
          </div>

          <div>
            <label>Telefon</label>
            <input name="phone" required placeholder="+48 700 000 000">
          </div>

          <div class="row">
            <div>
              <label>Data</label>
              <input type="date" name="date" required>
            </div>
            <div>
              <label>Godzina</label>
              <input type="time" name="time" required>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ilo≈õƒá os√≥b</label>
              <select name="guests" required>
                <option value="1">1 osoba</option>
                <option value="2" selected>2 osoby</option>
                <option value="3">3 osoby</option>
                <option value="4">4 osoby</option>
                <option value="5+">5+ os√≥b</option>
              </select>
            </div>
            <div>
              <label>Strefa</label>
              <select name="room" required>
                <option>Sala frontowa</option>
                <option>Sala g≈Ç√≥wna</option>
                <option>KƒÖcik dla dzieci</option>
              </select>
            </div>
          </div>

          <div>
            <label>Uwagi (opcjonalnie)</label>
            <textarea name="notes" placeholder="np. urodziny, alergie"></textarea>
          </div>

          <button class="btn btn-primary btn-wide">
            Zarezerwuj <i class="fa-solid fa-check"></i>
          </button>
        </form>
      </div>

      <div class="card">
        <div class="subtitle">Twoje rezerwacje</div>
        <div id="reservationsList" class="muted"></div>
      </div>
    </section>

    <!-- TAB: KONTO -->
    <section id="tab-account" class="tab">
      <div id="accountLoggedOut" class="stack">
        <div class="card">
          <div class="title">Konto</div>
          <p class="muted">Zaloguj siƒô, aby synchronizowaƒá punkty, nagrody i rezerwacje na wszystkich urzƒÖdzeniach.</p>
        </div>

        <div class="card auth-wrap">
          <div class="subtitle">Zaloguj siƒô</div>

          <button class="btn auth-btn google" id="loginGoogle">
            <i class="fa-brands fa-google"></i> Kontynuuj z Google
          </button>

          <div class="auth-sep"><span>lub</span></div>

          <form id="loginEmailForm" class="stack">
            <div>
              <label>Email</label>
              <input type="email" name="email" placeholder="np. klient@mail.com" required>
            </div>
            <div>
              <label>Has≈Ço (opcjonalnie)</label>
              <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary btn-wide">
              Zaloguj siƒô <i class="fa-solid fa-right-to-bracket"></i>
            </button>
            <div class="tiny" style="text-align:center;opacity:.75">
              Je≈õli nie u≈ºywasz hase≈Ç ‚Äî wpisz sam email (backend mo≈ºe tworzyƒá konto automatycznie).
            </div>
          </form>
        </div>
      </div>

      <div id="accountLoggedIn" class="stack" style="display:none">
        <div class="card account-hero">
          <div class="avatar" id="avatar">MK</div>
          <div>
            <div class="account-name" id="accName">U≈ºytkownik</div>
            <div class="account-mail" id="accEmail">user@mail.com</div>
            <div class="tiny" style="margin-top:2px">Zalogowano</div>
          </div>
          <div style="margin-left:auto">
            <button class="btn btn-ghost btn-small" id="logoutBtn">Wyloguj</button>
          </div>
        </div>

        <div class="card">
          <div class="subtitle">Ustawienia</div>
          <div class="list">
            <div class="list-item" data-open="personal">
              <div class="list-left">
                <div class="li-ico"><i class="fa-solid fa-user"></i></div>
                <div>
                  <div class="li-title">Dane osobowe</div>
                  <div class="li-sub">Imiƒô, telefon, email</div>
                </div>
              </div>
              <i class="fa-solid fa-chevron-right" style="opacity:.6"></i>
            </div>

            <div class="list-item" data-open="language">
              <div class="list-left">
                <div class="li-ico"><i class="fa-solid fa-language"></i></div>
                <div>
                  <div class="li-title">Jƒôzyk</div>
                  <div class="li-sub">Polski / English</div>
                </div>
              </div>
              <i class="fa-solid fa-chevron-right" style="opacity:.6"></i>
            </div>

            <div class="list-item" data-open="about">
              <div class="list-left">
                <div class="li-ico"><i class="fa-solid fa-circle-info"></i></div>
                <div>
                  <div class="li-title">O nas</div>
                  <div class="li-sub">MilkShake Bar S≈Çupsk & Rowy</div>
                </div>
              </div>
              <i class="fa-solid fa-chevron-right" style="opacity:.6"></i>
            </div>

            <div class="list-item" data-open="help">
              <div class="list-left">
                <div class="li-ico"><i class="fa-solid fa-life-ring"></i></div>
                <div>
                  <div class="li-title">Pomoc</div>
                  <div class="li-sub">Kontakt i informacje</div>
                </div>
              </div>
              <i class="fa-solid fa-chevron-right" style="opacity:.6"></i>
            </div>
          </div>
        </div>

        <!-- ‚úÖ USUNIƒòTO: przycisk "Od≈õwie≈º dane z serwera" -->
      </div>
    </section>

  </main>

  <!-- SUBPAGES -->
  <section class="subpage" id="page-personal">
    <div class="sub-top">
      <button class="back-btn" data-back><i class="fa-solid fa-arrow-left"></i></button>
      <div class="sub-title">Dane osobowe</div>
    </div>
    <div class="container stack">
      <div class="card stack">
        <div>
          <label>Imiƒô i nazwisko</label>
          <input id="personalName" placeholder="Jan Kowalski">
        </div>
        <div>
          <label>Telefon</label>
          <input id="personalPhone" placeholder="+48 700 000 000">
        </div>
        <div>
          <label>Email</label>
          <input id="personalEmail" placeholder="mail@adres.com">
        </div>
        <button class="btn btn-primary btn-wide" id="savePersonalBtn">Zapisz zmiany</button>
      </div>
    </div>
  </section>

  <section class="subpage" id="page-language">
    <div class="sub-top">
      <button class="back-btn" data-back><i class="fa-solid fa-arrow-left"></i></button>
      <div class="sub-title">Jƒôzyk</div>
    </div>
    <div class="container stack">
      <div class="card stack">
        <button class="btn btn-ghost btn-wide" data-lang="pl">üáµüá± Polski</button>
        <button class="btn btn-ghost btn-wide" data-lang="en">üá¨üáß English</button>
      </div>
    </div>
  </section>

  <section class="subpage" id="page-about">
    <div class="sub-top">
      <button class="back-btn" data-back><i class="fa-solid fa-arrow-left"></i></button>
      <div class="sub-title">O nas</div>
    </div>
    <div class="container stack">
      <div class="card">
        <div class="subtitle">MilkShake Bar</div>
        <p class="muted">
          Kremowe milkshake‚Äôi, desery i burgery w S≈Çupsku oraz Rowach.
          Tworzymy miejsce pe≈Çne energii i s≈Çodkich wspomnie≈Ñ.
        </p>
      </div>
    </div>
  </section>

  <section class="subpage" id="page-help">
    <div class="sub-top">
      <button class="back-btn" data-back><i class="fa-solid fa-arrow-left"></i></button>
      <div class="sub-title">Pomoc</div>
    </div>
    <div class="container stack">
      <div class="card stack">
        <div class="subtitle">Developer aplikacji</div>
        <p class="muted">Aplikacja zosta≈Ça wykonana przez <b>Velorie Design</b>.</p>
        <a class="btn btn-primary btn-wide" href="https://www.desing.velorie.pl" target="_blank" rel="noopener">
          www.desing.velorie.pl <i class="fa-solid fa-arrow-up-right-from-square"></i>
        </a>
      </div>
    </div>
  </section>

  <!-- Bottom nav -->
  <nav class="bottom-nav" aria-label="Dolne menu">
    <div class="nav-wrap">
      <button class="nav-btn active" data-tab="points">
        <i class="fa-solid fa-star"></i><div class="lbl">Punkty</div>
      </button>
      <button class="nav-btn" data-tab="rewards">
        <i class="fa-solid fa-gift"></i><div class="lbl">Nagrody</div>
      </button>
      <button class="nav-btn" data-tab="order">
        <i class="fa-solid fa-bag-shopping"></i><div class="lbl">Zam√≥w</div>
      </button>
      <button class="nav-btn" data-tab="res">
        <i class="fa-solid fa-calendar-check"></i><div class="lbl">Rezerwuj</div>
      </button>
      <button class="nav-btn" data-tab="account">
        <i class="fa-solid fa-user"></i><div class="lbl">Konto</div>
      </button>
    </div>
  </nav>

  <!-- Toast -->
  <div id="toast" class="toast">
    <i class="fa-solid fa-check-circle"></i><span id="toastText"></span>
  </div>

  <!-- MODAL: KOD LOJALNO≈öCIOWY -->
  <div id="codeModal" class="modal">
    <div class="modal-backdrop" data-close></div>

    <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
      <div class="modal-handle"></div>

      <div class="modal-header">
        <div>
          <div class="tiny">Tw√≥j kod lojalno≈õciowy</div>
          <div id="codeTitle" class="modal-title">Milk ID</div>
        </div>
        <button class="modal-close" data-close aria-label="Zamknij">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="modal-code-box">
        <div class="modal-code" id="loyaltyCode">000000</div>
        <div class="tiny" style="opacity:.9;text-align:center;margin-top:6px;">
          Poka≈º obs≈Çudze przy kasie
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost btn-wide" id="copyCodeBtn">
          <i class="fa-solid fa-copy"></i> Kopiuj kod
        </button>
      </div>

      <p class="tiny" style="text-align:center;margin-top:8px;">
        Kod jest sta≈Çy i zawsze przypisany do Twojego konta.
      </p>
    </div>
  </div>

<script>
  // ---------- PWA ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("sw.js"));
  }

  // ---------- Helpers / API ----------
  const API = {
    async json(url, opts = {}) {
      const res = await fetch(url, {
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
        ...opts,
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const text = await res.text();

      let data = null;
      if (ct.includes("application/json")) {
        try { data = JSON.parse(text); } catch { data = null; }
      }

      if (!res.ok) {
        const msg =
          (data && (data.message || data.error)) ||
          (text && text.slice(0, 180)) ||
          `HTTP ${res.status}`;
        throw new Error(msg);
      }

      if (!ct.includes("application/json") && text.trim().startsWith("<")) {
        throw new Error("Backend zwr√≥ci≈Ç HTML zamiast JSON (sprawd≈∫ routing / endpoint).");
      }

      if (data !== null) return data;
      if (!text) return null;
      try { return JSON.parse(text); } catch { return text; }
    },

    async getMy(urlBase, email) {
      const e = encodeURIComponent(email || "");
      try {
        return await API.json(`${urlBase}?email=${e}`);
      } catch {
        return await API.json(urlBase, {
          method: "POST",
          body: JSON.stringify({ email }),
        });
      }
    }
  };

  // ---------- Toast ----------
  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");
  function showToast(msg, danger = false) {
    toastText.textContent = msg;
    toast.classList.toggle("danger", danger);
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3200);
  }

  // ---------- Storage ----------
  const store = {
    get(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    },
    set(key, val) { localStorage.setItem(key, JSON.stringify(val)); },
    del(key) { localStorage.removeItem(key); }
  };

  // ---------- Auth / user gating ----------
  function getUser() { return store.get("user", null); }
  function isLoggedIn() { return !!getUser()?.email; }

  function requireLogin(actionName = "tej akcji") {
    if (isLoggedIn()) return true;
    showToast(`Zaloguj siƒô, aby u≈ºyƒá ${actionName}.`, true);
    openTab("account");
    return false;
  }

  // ---------- Tabs ----------
  const tabs = {
    points: document.getElementById("tab-points"),
    rewards: document.getElementById("tab-rewards"),
    order: document.getElementById("tab-order"),
    res: document.getElementById("tab-res"),
    account: document.getElementById("tab-account"),
  };
  const navButtons = document.querySelectorAll(".nav-btn");
  function openTab(name) {
    Object.entries(tabs).forEach(([k, el]) => el.classList.toggle("active", k === name));
    navButtons.forEach((b) => b.classList.toggle("active", b.dataset.tab === name));
    window.scrollTo({ top: 0, behavior: "smooth" });
    renderTopPill();
    if (name === "order") {
      prefillOrderCheckout();
      renderPickupRuleHintAndMin();
    }
    setTimeout(renderOrderFab, 50);
  }
  navButtons.forEach((btn) => btn.addEventListener("click", () => openTab(btn.dataset.tab)));
  document.querySelectorAll("[data-go]").forEach((b) =>
    b.addEventListener("click", () => openTab(b.dataset.go))
  );

  // ---------- Milk ID ----------
  function generate6DigitCode() {
    return String(Math.floor(100000 + Math.random() * 900000));
  }

  function getMilkId() {
    const user = getUser();
    if (user?.milkId && String(user.milkId).length === 6) return String(user.milkId);

    const email = (user?.email || "").toLowerCase();
    const key = email ? ("milkIdByEmail:" + email) : "milkIdAnonymous";
    let code = store.get(key, null);
    if (!code || String(code).length !== 6) {
      code = generate6DigitCode();
      store.set(key, code);
    }

    if (user?.email) {
      user.milkId = String(code);
      store.set("user", user);
    }

    return String(code);
  }

  // ---------- Top pill ----------
  const pointsPillEl = document.getElementById("pointsPill");
  function renderTopPill() {
    const user = getUser();
    if (!user?.email) {
      pointsPillEl.textContent = "Zaloguj siƒô";
      return;
    }
    const pts = store.get("points", 0);
    pointsPillEl.textContent = pts + " pkt";
  }

  // ---------- Opening hours / status ----------
  const openingCardEl = document.getElementById("openingCard");
  const openDotEl = document.getElementById("openDot");
  const openTextEl = document.getElementById("openText");
  const openHoursEl = document.getElementById("openingHours");
  const openHintEl = document.getElementById("openHint");

  const openingSchedule = {
    0: { label: "niedziela", open: "09:00", close: "21:00" },
    1: { label: "poniedzia≈Çek", open: "08:00", close: "21:00" },
    2: { label: "wtorek", open: "08:00", close: "21:00" },
    3: { label: "≈õroda", open: "08:00", close: "21:00" },
    4: { label: "czwartek", open: "08:00", close: "21:00" },
    5: { label: "piƒÖtek", open: "08:00", close: "22:00" },
    6: { label: "sobota", open: "09:00", close: "22:00" },
  };

  function toMinutes(hhmm) {
    const [h, m] = hhmm.split(":").map(Number);
    return h * 60 + m;
  }

  function renderOpeningHours() {
    const now = new Date();
    const day = now.getDay();
    const minutesNow = now.getHours() * 60 + now.getMinutes();

    const today = openingSchedule[day];
    const openM = toMinutes(today.open);
    const closeM = toMinutes(today.close);
    const isOpen = minutesNow >= openM && minutesNow < closeM;

    openDotEl.classList.remove("open", "closed");
    openDotEl.classList.add(isOpen ? "open" : "closed");
    openTextEl.textContent = isOpen ? "Jeste≈õmy Otwarci" : "Jeste≈õmy Zamkniƒôci";

    const order = [1, 2, 3, 4, 5, 6, 0];
    openHoursEl.innerHTML = order.map((d) => {
      const s = openingSchedule[d];
      const isToday = d === day;
      return `
        <div class="${isToday ? "today" : ""}">
          <b>${s.label}</b> ${s.open}‚Äì${s.close}
        </div>
      `;
    }).join("");
  }

  openingCardEl?.addEventListener("click", () => {
    openingCardEl.classList.toggle("expanded");
    const expanded = openingCardEl.classList.contains("expanded");
    openHintEl.textContent = expanded
      ? "Kliknij, aby ukryƒá godziny otwarcia"
      : "Kliknij, aby zobaczyƒá godziny otwarcia";
  });

  renderOpeningHours();
  setInterval(renderOpeningHours, 60 * 1000);

  // ---------- One-time clear (opcjonalne) ----------
  (function clearHistoryOnce() {
    const didClear = store.get("didClearHistoryOnce", false);
    if (!didClear) {
      store.set("pointsHistory", []);
      store.set("didClearHistoryOnce", true);
    }
  })();

  // ---------- Modal: code ----------
  const loyaltyCodeEl = document.getElementById("loyaltyCode");
  const showCodeBtn = document.getElementById("showCodeBtn");
  const copyCodeBtn = document.getElementById("copyCodeBtn");
  const codeModal = document.getElementById("codeModal");

  function renderMilkIdModal() {
    loyaltyCodeEl.textContent = getMilkId();
  }

  function openCodeModal() {
    if (!requireLogin("Milk ID")) return;
    renderMilkIdModal();
    codeModal.classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function closeCodeModal() {
    codeModal.classList.remove("show");
    document.body.style.overflow = "";
  }

  showCodeBtn?.addEventListener("click", openCodeModal);
  codeModal?.querySelectorAll("[data-close]")?.forEach((el) =>
    el.addEventListener("click", closeCodeModal)
  );
  copyCodeBtn?.addEventListener("click", async () => {
    const code = loyaltyCodeEl.textContent;
    try {
      await navigator.clipboard.writeText(code);
      showToast("Kod skopiowany ‚úÖ");
    } catch {
      showToast("Nie uda≈Ço siƒô skopiowaƒá ü§è", true);
    }
  });

  // ---------- Points ----------
  const pointsCountEl = document.getElementById("pointsCount");
  const pointsProgressEl = document.getElementById("pointsProgress");
  const historyEl = document.getElementById("pointsHistory");

  function renderPoints() {
    const user = getUser();
    const pts = store.get("points", 0);

    pointsCountEl.textContent = user?.email ? pts : "‚Äî";
    renderTopPill();

    const pct = user?.email ? Math.min(100, pts % 100) : 0;
    pointsProgressEl.style.width = pct + "%";

    const hist = store.get("pointsHistory", []);
    historyEl.innerHTML = user?.email
      ? (hist.length
          ? hist.map(h => `
              <div style="padding:8px 0;border-bottom:1px dashed rgba(0,0,0,.06)">
                <b>${h.text}</b><div class="tiny">${h.date}</div>
              </div>`).join("")
          : `<div class="empty">
              <div class="icon"><i class="fa-solid fa-clock"></i></div>
              <div>
                <b>Historia punkt√≥w jest pusta</b>
                <div class="tiny">Punkty pojawiƒÖ siƒô po pierwszym naliczeniu.</div>
              </div>
            </div>`)
      : `<div class="empty">
          <div class="icon"><i class="fa-solid fa-user"></i></div>
          <div>
            <b>Zaloguj siƒô</b>
            <div class="tiny">Aby zbieraƒá punkty i u≈ºywaƒá Milk ID.</div>
          </div>
        </div>`;
  }

  // ---------- Rewards (fallback lista) ----------
  const rewardsFallback = [
    { id: "milkshake_30", title: "Milkshake do 30 PLN", cost: 25, icon: "fa-ice-cream", desc: "Warto≈õƒá do 30 PLN" },
    { id: "burger_set_60", title: "Zestaw burger do 60 PLN", cost: 50, icon: "fa-burger", desc: "Warto≈õƒá do 60 PLN" },
    { id: "order_120", title: "Zam√≥wienie do 120 PLN", cost: 100, icon: "fa-receipt", desc: "Warto≈õƒá do 120 PLN" },
  ];
  const rewardsListEl = document.getElementById("rewardsList");

  function getRewardsFromStore() {
    return store.get("rewardsCatalog", rewardsFallback);
  }

  function renderRewards() {
    const user = getUser();
    const pts = store.get("points", 0);

    if (!user?.email) {
      rewardsListEl.innerHTML = `
        <div class="empty">
          <div class="icon"><i class="fa-solid fa-user"></i></div>
          <div>
            <b>Zaloguj siƒô, aby wymieniaƒá nagrody</b>
            <div class="tiny">Po zalogowaniu przypiszemy Milk ID do Twojego maila.</div>
          </div>
        </div>`;
      return;
    }

    const rewards = getRewardsFromStore();
    rewardsListEl.innerHTML = rewards.map((r) => {
      const disabled = pts < r.cost;
      return `
        <div class="reward">
          <div class="reward-left">
            <div class="reward-ico"><i class="fa-solid ${r.icon || "fa-gift"}"></i></div>
            <div>
              <div class="reward-title">${r.title}</div>
              <div class="tiny">${r.desc || ""}</div>
              <div class="muted">Koszt: <b>${r.cost} pkt</b></div>
            </div>
          </div>
          <div style="text-align:right;min-width:88px">
            <div style="font-weight:900">${r.cost} pkt</div>
            <button class="btn btn-primary btn-small"
              ${disabled ? "disabled style='opacity:.5;cursor:not-allowed'" : ""}
              data-redeem="${r.id}">
              Wymie≈Ñ
            </button>
          </div>
        </div>
      `;
    }).join("");

    rewardsListEl.querySelectorAll("[data-redeem]").forEach((btn) => {
      btn.addEventListener("click", () => redeemReward(btn.dataset.redeem));
    });
  }

  async function redeemReward(rewardId) {
    if (!requireLogin("wymiany nagr√≥d")) return;

    const user = getUser();
    const email = user.email;
    const milkId = getMilkId();

    try {
      const res = await API.json("/api/rewards/redeem", {
        method: "POST",
        body: JSON.stringify({ email, milkId, rewardId }),
      });

      if (typeof res?.points === "number") store.set("points", res.points);
      if (Array.isArray(res?.history)) store.set("pointsHistory", res.history);

      const code = res?.code || res?.rewardCode;
      if (code) {
        showToast("Nagroda wymieniona ‚úÖ");
        alert("Kod do odbioru nagrody:\n\n" + code + "\n\nPoka≈º w lokalu.");
      } else {
        showToast("Nagroda wymieniona ‚úÖ");
      }

      renderPoints();
      renderRewards();
      return;
    } catch (e) {
      console.warn("redeem server failed -> local fallback", e);
    }

    const rewards = getRewardsFromStore();
    const r = rewards.find((x) => x.id === rewardId);
    if (!r) return;

    const pts = store.get("points", 0);
    if (pts < r.cost) {
      showToast("Masz za ma≈Ço punkt√≥w üòÖ", true);
      return;
    }

    store.set("points", pts - r.cost);
    const hist = store.get("pointsHistory", []);
    hist.unshift({ text: `Wymieniono: -${r.cost} pkt (${r.title})`, date: new Date().toLocaleString("pl-PL") });
    store.set("pointsHistory", hist);

    renderPoints();
    renderRewards();
    showToast(`Nagroda odebrana: ${r.title} üéÅ`);
  }

  // ---------- Profile helpers ----------
  function getPersonal() {
    const user = getUser();
    const profile = store.get("profile", {});
    return {
      name: profile.name || user?.name || "",
      phone: profile.phone || user?.phone || "",
      email: profile.email || user?.email || "",
    };
  }

  function prefillPersonalUI() {
    const p = getPersonal();
    const nameInput = document.getElementById("personalName");
    const phoneInput = document.getElementById("personalPhone");
    const emailInput = document.getElementById("personalEmail");
    if (nameInput && !nameInput.value) nameInput.value = p.name || "";
    if (phoneInput && !phoneInput.value) phoneInput.value = p.phone || "";
    if (emailInput && !emailInput.value) emailInput.value = p.email || "";
  }

  function prefillReservationForm() {
    const p = getPersonal();
    const name = document.querySelector("#reservationForm input[name='name']");
    const phone = document.querySelector("#reservationForm input[name='phone']");
    if (name && !name.value && p.name) name.value = p.name;
    if (phone && !phone.value && p.phone) phone.value = p.phone;
  }

  function prefillOrderCheckout() {
    const p = getPersonal();
    const nameEl = document.getElementById("orderCustomerName");
    const phoneEl = document.getElementById("orderCustomerPhone");
    if (nameEl && !nameEl.value && p.name) nameEl.value = p.name;
    if (phoneEl && !phoneEl.value && p.phone) phoneEl.value = p.phone;
  }

  // ---------- Order time rules (Mon-Thu: 30min, Fri-Sun: 45min) ----------
  const pickupTimeEl = document.getElementById("pickupTime");
  const pickupRuleHintEl = document.getElementById("pickupRuleHint");

  function pad2(n){ return String(n).padStart(2,"0"); }
  function minutesToHHMM(mins){
    const h = Math.floor(mins / 60) % 24;
    const m = mins % 60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function ceilToQuarterMinutes(totalMins){
    return Math.ceil(totalMins / 15) * 15;
  }
  function getLeadMinutesForToday(now = new Date()){
    const d = now.getDay();
    if (d >= 1 && d <= 4) return 30;
    return 45;
  }
  function computeMinPickupTime(now = new Date()){
    const lead = getLeadMinutesForToday(now);
    const nowM = now.getHours()*60 + now.getMinutes();
    const base = ceilToQuarterMinutes(nowM);
    const minM = base + lead;
    return { minM, lead, baseM: base };
  }
  function renderPickupRuleHintAndMin(){
    if (!pickupTimeEl || !pickupRuleHintEl) return;
    const { minM, lead } = computeMinPickupTime(new Date());
    const hhmm = minutesToHHMM(minM);
    pickupRuleHintEl.innerHTML = `Najwcze≈õniej mo≈ºesz ustawiƒá odbi√≥r na <b>${hhmm}</b> (minimalnie pe≈Çne ${lead} min).`;
    if (!pickupTimeEl.value) {
      pickupTimeEl.value = hhmm;
    } else {
      const chosen = toMinutes(pickupTimeEl.value);
      if (chosen < minM) pickupTimeEl.value = hhmm;
    }
  }
  pickupTimeEl?.addEventListener("focus", renderPickupRuleHintAndMin);
  pickupTimeEl?.addEventListener("change", () => {
    const { minM } = computeMinPickupTime(new Date());
    const chosen = pickupTimeEl.value ? toMinutes(pickupTimeEl.value) : null;
    if (chosen !== null && chosen < minM) {
      showToast("Godzina odbioru jest za wcze≈õnie ‚Äî ustaw p√≥≈∫niejszƒÖ ‚è∞", true);
      pickupTimeEl.value = minutesToHHMM(minM);
    }
  });

  // ---------- Menu wklejane w kodzie ----------
  const menuListEl = document.getElementById("menuList");
  const menuHintEl = document.getElementById("menuHint");

  // ===============================
  // ‚úÖ MENU W KODZIE (WKLEJ TUTAJ)
  // ===============================
  // Wklej tutaj wszystkie pozycje menu jako tablica obiekt√≥w.
  // Wymagane pola: id, title, desc, price, icon, category
  let menuItems = [
    // PRZYK≈ÅAD:
    // { id: "kawa_americano", title: "Americano", desc: "Klasyczna kawa", price: 12, icon: "fa-mug-hot", category: "Kawa i herbata" },

    // ‚¨áÔ∏è WKLEJ TUTAJ PE≈ÅNE MENU ‚¨áÔ∏è
  ];

  // Kategorie (sta≈Çe)
  const CATEGORIES = [
    "Kawa i herbata",
    "Napoje i soki",
    "Shakes",
    "Desery",
    "Tex Mex",
    "Kanapki",
    "Burgery",
    "≈öniadania",
  ];
  const categoriesBarEl = document.getElementById("categoriesBar");
  let activeCategory = CATEGORIES[0];

  function renderCategories(){
    if (!categoriesBarEl) return;
    categoriesBarEl.innerHTML = CATEGORIES.map(c => `
      <button class="cat-chip ${c === activeCategory ? "active" : ""}" data-cat="${c}">
        ${c}
      </button>
    `).join("");
    categoriesBarEl.querySelectorAll("[data-cat]").forEach(btn => {
      btn.addEventListener("click", () => {
        activeCategory = btn.dataset.cat;
        renderCategories();
        renderMenu();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  // ---------- Order & pickup ----------
  const cartListEl = document.getElementById("cartList");
  const cartTotalEl = document.getElementById("cartTotal");
  const submitOrderBtn = document.getElementById("submitOrderBtn");
  const ordersListEl = document.getElementById("ordersList");

  function getCart() { return store.get("orderCart", []); }
  function setCart(c) { store.set("orderCart", c); }

  function addToCart(id) {
    if (!requireLogin("zam√≥wie≈Ñ")) return;
    const item = menuItems.find((x) => x.id === id);
    if (!item) return;
    const cart = getCart();
    const existing = cart.find((c) => c.id === id);
    if (existing) existing.qty++;
    else cart.push({ id, qty: 1 });
    setCart(cart);
    renderCart();
    showToast(`Dodano: ${item.title}`);
  }

  function changeQty(id, delta) {
    const cart = getCart();
    const line = cart.find((c) => c.id === id);
    if (!line) return;
    line.qty += delta;
    if (line.qty <= 0) {
      const idx = cart.findIndex((c) => c.id === id);
      cart.splice(idx, 1);
    }
    setCart(cart);
    renderCart();
  }

  function renderMenu() {
    if (!menuItems.length) {
      menuListEl.innerHTML = `
        <div class="empty">
          <div class="icon"><i class="fa-solid fa-utensils"></i></div>
          <div>
            <b>Brak menu</b>
            <div class="tiny">Chwilowo niedostƒôpne do <b>x</b>x</div>
          </div>
        </div>`;
      return;
    }

    renderCategories();

    const list = menuItems.filter(m => (m.category || "Inne") === activeCategory);

    if (!list.length){
      menuListEl.innerHTML = `
        <div class="empty">
          <div class="icon"><i class="fa-solid fa-layer-group"></i></div>
          <div>
            <b>Brak produkt√≥w w tej kategorii</b>
            <div class="tiny">Dodaj produkty z category: <b>${activeCategory}</b>.</div>
          </div>
        </div>`;
      return;
    }

    menuListEl.innerHTML = list.map((m) => `
      <div class="menu-item">
        <div class="menu-left">
          <div class="menu-ico"><i class="fa-solid ${m.icon}"></i></div>
          <div>
            <div class="menu-title">${m.title}</div>
            <div class="menu-desc">${m.desc || ""}</div>
          </div>
        </div>
        <div style="text-align:right;min-width:88px">
          <div class="menu-price">${m.price} z≈Ç</div>
          <button class="btn btn-primary btn-small" data-add="${m.id}">Dodaj</button>
        </div>
      </div>
    `).join("");

    menuListEl.querySelectorAll("[data-add]").forEach((btn) => {
      btn.addEventListener("click", () => addToCart(btn.dataset.add));
    });
  }

  // FAB podsumowania
  const orderFab = document.getElementById("orderSummaryFab");
  const fabItemsEl = document.getElementById("fabItems");
  const fabTotalEl = document.getElementById("fabTotal");

  function calcCartSummary(){
    const cart = getCart();
    let itemsCount = 0;
    let total = 0;

    cart.forEach(c => {
      const m = menuItems.find(x => x.id === c.id);
      if (!m) return;
      itemsCount += c.qty;
      total += (m.price * c.qty);
    });

    return { itemsCount, total };
  }

  function renderOrderFab(){
    if (!orderFab) return;

    const user = getUser();
    const cart = getCart();
    const visible = !!user?.email && cart.length && tabs.order.classList.contains("active");

    if (!visible){
      orderFab.style.display = "none";
      return;
    }

    const { itemsCount, total } = calcCartSummary();
    fabItemsEl.textContent = `${itemsCount} szt.`;
    fabTotalEl.textContent = `${total} z≈Ç`;
    orderFab.style.display = "flex";
  }

  orderFab?.addEventListener("click", () => {
    const cartCard = cartListEl?.closest(".card");
    cartCard?.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  function renderCart() {
    const user = getUser();
    const cart = getCart();

    if (!user?.email) {
      cartListEl.innerHTML = `
        <div class="empty">
          <div class="icon"><i class="fa-solid fa-user"></i></div>
          <div>
            <b>Zaloguj siƒô, aby sk≈Çadaƒá zam√≥wienia</b>
            <div class="tiny">Po zalogowaniu mo≈ºesz ‚ÄûZam√≥w i odbierz‚Äù.</div>
          </div>
        </div>`;
      cartTotalEl.textContent = "0 z≈Ç";
      submitOrderBtn.disabled = true;
      renderOrderFab();
      return;
    }

    if (!cart.length) {
      cartListEl.innerHTML = `
        <div class="empty">
          <div class="icon"><i class="fa-solid fa-bag-shopping"></i></div>
          <div>
            <b>Koszyk jest pusty</b>
            <div class="tiny">Dodaj co≈õ z menu.</div>
          </div>
        </div>`;
      cartTotalEl.textContent = "0 z≈Ç";
      submitOrderBtn.disabled = true;
      renderOrderFab();
      return;
    }

    submitOrderBtn.disabled = false;

    let total = 0;
    cartListEl.innerHTML = cart.map((c) => {
      const m = menuItems.find((x) => x.id === c.id);
      if (!m) return "";
      const lineTotal = m.price * c.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div>
            <b>${m.title}</b>
            <div class="tiny">${m.price} z≈Ç x ${c.qty} = ${lineTotal} z≈Ç</div>
          </div>
          <div class="cart-actions">
            <button class="qty-btn" data-qty="${c.id}" data-d="-1">‚àí</button>
            <b>${c.qty}</b>
            <button class="qty-btn" data-qty="${c.id}" data-d="1">+</button>
          </div>
        </div>
      `;
    }).join("");

    cartTotalEl.textContent = total + " z≈Ç";

    cartListEl.querySelectorAll("[data-qty]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.qty;
        const d = Number(btn.dataset.d);
        changeQty(id, d);
      });
    });

    renderOrderFab();
  }

  function cleanPhone(phone){
    return String(phone || "").trim();
  }
  function validatePhoneBasic(phone){
    const p = cleanPhone(phone);
    const digits = p.replace(/\D/g, "");
    return digits.length >= 7;
  }

  async function submitOrder() {
    if (!requireLogin("zam√≥wie≈Ñ")) return;

    const cart = getCart();
    if (!cart.length) {
      showToast("Koszyk pusty üòÖ", true);
      return;
    }

    const name = (document.getElementById("orderCustomerName")?.value || "").trim();
    const phone = (document.getElementById("orderCustomerPhone")?.value || "").trim();
    const pickupTime = document.getElementById("pickupTime").value;
    const pickupLocation = document.getElementById("pickupLocation").value;
    const notes = document.getElementById("orderNotes").value;

    if (!name) { showToast("Podaj imiƒô i nazwisko ‚úçÔ∏è", true); return; }
    if (!phone || !validatePhoneBasic(phone)) { showToast("Podaj poprawny numer telefonu üìû", true); return; }

    if (String(pickupLocation).toLowerCase() === "rowy") {
      showToast("Rowy jest chwilowo niedostƒôpne.", true);
      return;
    }

    if (!pickupTime) {
      showToast("Ustaw godzinƒô odbioru ‚è∞", true);
      return;
    }

    const { minM, lead } = computeMinPickupTime(new Date());
    const chosenM = toMinutes(pickupTime);
    if (chosenM < minM) {
      showToast(`Za wcze≈õnie. Minimalnie pe≈Çne ${lead} min ‚Äî ustaw p√≥≈∫niej.`, true);
      document.getElementById("pickupTime").value = minutesToHHMM(minM);
      renderPickupRuleHintAndMin();
      return;
    }

    const items = cart.map((c) => {
      const m = menuItems.find((x) => x.id === c.id);
      return { title: m?.title || "Pozycja", qty: c.qty, price: Number(m?.price || 0) };
    });
    const total = items.reduce((s, i) => s + i.price * i.qty, 0);

    const user = getUser();
    const milkId = getMilkId();

    const profile = store.get("profile", {});
    if (name) profile.name = name;
    if (phone) profile.phone = phone;
    if (!profile.email) profile.email = user?.email || "";
    store.set("profile", profile);

    const payload = {
      source: "app",
      email: user?.email || "",
      milkId,
      customerName: name,
      customerPhone: phone,
      pickupTime,
      pickupLocation,
      notes: notes || "",
      items,
      total,
      status: "Przyjƒôte",
      createdAt: new Date().toISOString(),
      payment: "on_pickup",
    };

    try {
      await API.json("/api/orders", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      setCart([]);
      document.getElementById("orderNotes").value = "";
      renderCart();
      showToast("Zam√≥wienie wys≈Çane ‚úÖ");
      await refreshOrdersFromServer();
      openTab("order");
    } catch (e) {
      const local = store.get("orders_local", []);
      local.unshift({ ...payload, _id: crypto.randomUUID() });
      store.set("orders_local", local);

      setCart([]);
      renderCart();

      showToast("Zam√≥wienie zapisane lokalnie (brak endpointu) ‚ö†Ô∏è", true);
      await refreshOrdersFromServer();
    }
  }

  submitOrderBtn?.addEventListener("click", submitOrder);

  async function refreshOrdersFromServer() {
    const user = getUser();
    if (!user?.email) {
      renderOrdersUI([], false);
      return;
    }

    try {
      const data = await API.getMy("/api/orders/my", user.email);
      const orders = Array.isArray(data) ? data : (data?.orders || []);
      renderOrdersUI(orders, false);
    } catch {
      const local = store.get("orders_local", []);
      renderOrdersUI(local, true);
    }
  }

  function renderOrdersUI(orders, isLocal = false) {
    ordersListEl.innerHTML = orders.length
      ? orders.map((o) => `
          <div class="res-item">
            <b>${(o.pickupLocation || "‚Äî")} ‚Ä¢ ${(o.pickupTime || "‚Äî")}</b>
            <div class="tiny">Z≈Ço≈ºono: ${o.date || (o.createdAt ? new Date(o.createdAt).toLocaleString("pl-PL") : "‚Äî")}</div>
            <div class="tiny">Status: <b>${o.status || "Przyjƒôte"}</b>${isLocal ? " (lokalnie)" : ""}</div>
            <div class="tiny">Dane: <b>${o.customerName || "‚Äî"}</b> ‚Ä¢ ${o.customerPhone || "‚Äî"}</div>
            <div style="margin-top:6px">
              ${(o.items || []).map((i) => `‚Ä¢ ${i.qty}x ${i.title}`).join("<br>")}
            </div>
            <div class="divider"></div>
            <div style="display:flex;justify-content:space-between;font-weight:900">
              <span>Razem</span><span>${o.total ?? 0} z≈Ç</span>
            </div>
            <div class="tiny" style="margin-top:4px">
              P≈Çatno≈õƒá na miejscu przy odbiorze.
            </div>
          </div>
        `).join("")
      : `<div class="empty">
          <div class="icon"><i class="fa-solid fa-bag-shopping"></i></div>
          <div>
            <b>Brak zam√≥wie≈Ñ</b>
            <div class="tiny">Twoje zam√≥wienia pojawiƒÖ siƒô tutaj.</div>
          </div>
        </div>`;
  }

  // ---------- Reservations ----------
  const resForm = document.getElementById("reservationForm");
  const resListEl = document.getElementById("reservationsList");

  async function refreshReservationsFromServer() {
    const user = getUser();
    if (!user?.email) {
      renderReservationsUI([], false);
      return;
    }

    try {
      const data = await API.getMy("/api/rezerwacje/my", user.email);
      const list = Array.isArray(data) ? data : (data?.reservations || data?.list || []);
      renderReservationsUI(list, false);
      return;
    } catch {}

    try {
      const all = await API.json("/api/rezerwacje");
      const milkId = getMilkId();
      const filtered = (Array.isArray(all) ? all : []).filter(r => {
        const re = String(r.email || "").toLowerCase();
        const rm = String(r.milkId || "");
        return (re && re === user.email.toLowerCase()) || (rm && rm === milkId);
      });
      renderReservationsUI(filtered, false);
    } catch {
      const local = store.get("reservations_local", []);
      renderReservationsUI(local, true);
    }
  }

  function renderReservationsUI(list, isLocal = false) {
    resListEl.innerHTML = list.length
      ? list.map((r) => `
          <div class="res-item">
            <b>${r.date} ‚Ä¢ ${r.time}</b>
            <div>${r.guests} os. ‚Ä¢ ${r.room}</div>
            <div class="tiny">${r.name}, ${r.phone}</div>
            ${r.notes ? `<div class="tiny">Uwagi: ${r.notes}</div>` : ""}
            <div class="divider"></div>
            <div class="res-actions">
              ${isLocal ? `<button class="btn btn-ghost btn-small" data-del-local="${r._id || r.id}">Usu≈Ñ</button>` : ``}
            </div>
          </div>
        `).join("")
      : `<div class="empty">
          <div class="icon"><i class="fa-solid fa-calendar-check"></i></div>
          <div>
            <b>Brak rezerwacji</b>
            <div class="tiny">Zarezerwuj stolik ‚Äî zajmie to chwilkƒô.</div>
          </div>
        </div>`;

    resListEl.querySelectorAll("[data-del-local]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.delLocal;
        const newList = store.get("reservations_local", []).filter((x) => (x._id || x.id) !== id);
        store.set("reservations_local", newList);
        refreshReservationsFromServer();
        showToast("Rezerwacja usuniƒôta");
      });
    });
  }

  resForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!requireLogin("rezerwacji")) return;

    const fd = new FormData(resForm);
    const data = Object.fromEntries(fd.entries());

    if (!data.name || !data.phone || !data.date || !data.time || !data.guests || !data.room) {
      showToast("Uzupe≈Çnij wszystkie pola", true);
      return;
    }

    const user = getUser();
    const milkId = getMilkId();

    const payload = {
      name: String(data.name),
      phone: String(data.phone),
      date: String(data.date),
      time: String(data.time),
      guests: String(data.guests),
      room: String(data.room),
      notes: String(data.notes || ""),
      email: String(user.email || ""),
      milkId: String(milkId || ""),
      source: "app",
    };

    try {
      await API.json("/api/rezerwacje", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      const local = store.get("reservations_local", []);
      local.unshift({ ...payload, _id: crypto.randomUUID() });
      store.set("reservations_local", local);

      resForm.reset();
      prefillReservationForm();
      showToast("Rezerwacja wys≈Çana üß°");
      await refreshReservationsFromServer();
      openTab("res");
    } catch (err) {
      const local = store.get("reservations_local", []);
      local.unshift({ ...payload, _id: crypto.randomUUID() });
      store.set("reservations_local", local);

      resForm.reset();
      prefillReservationForm();
      showToast("Rezerwacja zapisana lokalnie (brak endpointu) ‚ö†Ô∏è", true);
      await refreshReservationsFromServer();
    }
  });

  (function () {
    if (!resForm) return;
    const dateInput = resForm.querySelector("input[name='date']");
    if (!dateInput) return;
    dateInput.min = new Date().toISOString().split("T")[0];
  })();

  // ---------- Account / Auth ----------
  const loggedOutEl = document.getElementById("accountLoggedOut");
  const loggedInEl = document.getElementById("accountLoggedIn");
  const avatarEl = document.getElementById("avatar");
  const accNameEl = document.getElementById("accName");
  const accEmailEl = document.getElementById("accEmail");

  function renderAccount() {
    const user = getUser();
    const isLogged = !!user?.email;

    loggedOutEl.style.display = isLogged ? "none" : "flex";
    loggedInEl.style.display = isLogged ? "flex" : "none";

    if (isLogged) {
      const profile = getPersonal();
      const initials = (profile.name || user.name || "Milk User")
        .split(" ")
        .map((w) => w[0])
        .slice(0, 2)
        .join("")
        .toUpperCase();

      avatarEl.textContent = initials || "MK";
      accNameEl.textContent = profile.name || user.name || "U≈ºytkownik";
      accEmailEl.textContent = profile.email || user.email || "";
    }

    renderPoints();
    renderRewards();
    renderCart();
    prefillPersonalUI();
    prefillReservationForm();
    prefillOrderCheckout();
    renderPickupRuleHintAndMin();
    renderOrderFab();
  }

  // ---------- Login / Logout ----------
  const loginGoogleBtn = document.getElementById("loginGoogle");
  const loginEmailForm = document.getElementById("loginEmailForm");
  const logoutBtn = document.getElementById("logoutBtn");

  async function loginWithEmail(email, password = "") {
    email = String(email || "").trim().toLowerCase();
    if (!email) {
      showToast("Podaj email", true);
      return;
    }

    try {
      const res = await API.json("/api/auth/login", {
        method: "POST",
        body: JSON.stringify({ email, password }),
      });

      const user = {
        email,
        name: res?.name || res?.user?.name || store.get("profile", {})?.name || "",
        phone: res?.phone || res?.user?.phone || store.get("profile", {})?.phone || "",
        milkId: res?.milkId || res?.user?.milkId || store.get("user", {})?.milkId || "",
        token: res?.token || res?.jwt || "",
      };

      store.set("user", user);

      if (typeof res?.points === "number") store.set("points", res.points);
      if (Array.isArray(res?.history)) store.set("pointsHistory", res.history);

      if (!user.milkId) {
        user.milkId = getMilkId();
        store.set("user", user);
      }

      showToast("Zalogowano ‚úÖ");
      renderAccount();
      await syncAll();
      return;
    } catch (e) {
      console.warn("login server failed -> local fallback", e);
    }

    const user = {
      email,
      name: store.get("profile", {})?.name || "",
      phone: store.get("profile", {})?.phone || "",
      milkId: store.get("user", {})?.milkId || "",
      token: "",
    };
    store.set("user", user);

    user.milkId = getMilkId();
    store.set("user", user);

    showToast("Zalogowano lokalnie ‚ö†Ô∏è");
    renderAccount();
    await syncAll();
  }

  function fakeGoogleEmail() {
    const rand = Math.floor(1000 + Math.random() * 9000);
    return `google.user${rand}@gmail.com`;
  }

  loginGoogleBtn?.addEventListener("click", () => {
    loginWithEmail(fakeGoogleEmail(), "");
  });

  loginEmailForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    const fd = new FormData(loginEmailForm);
    const email = fd.get("email");
    const password = fd.get("password");
    loginWithEmail(email, password);
  });

  logoutBtn?.addEventListener("click", () => {
    store.del("user");
    showToast("Wylogowano");
    renderAccount();
    openTab("account");
  });

  // ---------- Subpages ----------
  const subpages = {
    personal: document.getElementById("page-personal"),
    language: document.getElementById("page-language"),
    about: document.getElementById("page-about"),
    help: document.getElementById("page-help"),
  };

  function openSubpage(name) {
    Object.values(subpages).forEach((p) => p?.classList.remove("active"));
    subpages[name]?.classList.add("active");
    prefillPersonalUI();
  }

  function closeSubpages() {
    Object.values(subpages).forEach((p) => p?.classList.remove("active"));
  }

  document.querySelectorAll("[data-open]").forEach((el) => {
    el.addEventListener("click", () => openSubpage(el.dataset.open));
  });

  document.querySelectorAll("[data-back]").forEach((btn) => {
    btn.addEventListener("click", closeSubpages);
  });

  // ---------- Personal save ----------
  const savePersonalBtn = document.getElementById("savePersonalBtn");
  savePersonalBtn?.addEventListener("click", () => {
    const name = (document.getElementById("personalName")?.value || "").trim();
    const phone = (document.getElementById("personalPhone")?.value || "").trim();
    const email = (document.getElementById("personalEmail")?.value || "").trim().toLowerCase();

    const profile = store.get("profile", {});
    if (name) profile.name = name;
    if (phone) profile.phone = phone;
    if (email) profile.email = email;
    store.set("profile", profile);

    const user = getUser();
    if (user?.email) {
      user.name = profile.name || user.name || "";
      user.phone = profile.phone || user.phone || "";
      store.set("user", user);
    }

    showToast("Zapisano ‚úÖ");
    renderAccount();
    closeSubpages();
  });

  // ---------- Language ----------
  document.querySelectorAll("[data-lang]").forEach((btn) => {
    btn.addEventListener("click", () => {
      store.set("lang", btn.dataset.lang);
      showToast("Zapisano jƒôzyk ‚úÖ");
      closeSubpages();
    });
  });

  // ---------- Sync (bez przycisku w UI; nadal u≈ºywane po loginie) ----------
  async function syncAll() {
    if (!isLoggedIn()) return;

    try {
      const user = getUser();
      const data = await API.getMy("/api/milkpoints/my", user.email);
      if (typeof data?.points === "number") store.set("points", data.points);
      if (Array.isArray(data?.history)) store.set("pointsHistory", data.history);
    } catch {}

    try {
      const user = getUser();
      const data = await API.getMy("/api/rewards/my", user.email);
      if (Array.isArray(data?.catalog)) store.set("rewardsCatalog", data.catalog);
    } catch {}

    await refreshOrdersFromServer();
    await refreshReservationsFromServer();

    renderPoints();
    renderRewards();
    renderCart();
    renderOrderFab();
  }

  // ---------- Install guide ----------
  const installGuide = document.getElementById("installGuide");
  const platformBtns = document.querySelectorAll(".platform-btn");
  const installPanes = document.querySelectorAll(".install-pane");
  const androidInstallBtn = document.getElementById("androidInstallBtn");
  const androidInstallHint = document.getElementById("androidInstallHint");

  let deferredPrompt = null;

  function isStandalone() {
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  }

  function showInstallGuide() {
    if (!installGuide) return;
    installGuide.classList.add("show");
    installGuide.setAttribute("aria-hidden", "false");
  }

  function hideInstallGuide() {
    if (!installGuide) return;
    installGuide.classList.remove("show");
    installGuide.setAttribute("aria-hidden", "true");
  }

  function setGuideTab(tab) {
    platformBtns.forEach((b) => b.classList.toggle("active", b.dataset.guideTab === tab));
    installPanes.forEach((p) => p.classList.toggle("active", p.dataset.guidePane === tab));
  }

  platformBtns.forEach((b) => {
    b.addEventListener("click", () => setGuideTab(b.dataset.guideTab));
  });

  installGuide?.addEventListener("click", (e) => {
    if (e.target === installGuide) hideInstallGuide();
  });

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (androidInstallBtn) androidInstallBtn.style.display = "inline-flex";
    if (androidInstallHint) androidInstallHint.style.display = "none";
  });

  androidInstallBtn?.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    try { await deferredPrompt.userChoice; } catch {}
    deferredPrompt = null;
    androidInstallBtn.style.display = "none";
    if (androidInstallHint) androidInstallHint.style.display = "block";
  });

  (function initInstallGuide() {
    const dismissed = store.get("installGuideDismissed", false);
    if (!isStandalone() && !dismissed) {
      setTimeout(showInstallGuide, 900);
    }
  })();

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") hideInstallGuide();
  });

  installGuide?.addEventListener("pointerdown", () => {
    store.set("installGuideDismissed", true);
  });

  // ---------- Init render ----------
  function initUI() {
    openTab("points");

    renderAccount();
    renderOpeningHours();
    renderCategories();

    menuHintEl.textContent = menuItems.length
      ? `Menu gotowe (${menuItems.length} pozycji)`
      : "Brak menu ‚Äî wklej pozycje do menuItems w kodzie.";

    renderMenu();
    renderCart();
    renderOrderFab();

    refreshOrdersFromServer();
    refreshReservationsFromServer();

    window.addEventListener("scroll", () => {
      if (tabs.order.classList.contains("active")) renderOrderFab();
    });
  }

  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => setTimeout(renderOrderFab, 50));
  });

  initUI();
</script>

</body>
</html>
