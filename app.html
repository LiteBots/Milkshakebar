<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f0f10" />
  <title>Milk — Aplikacja</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg0:#0b0b0c;
      --bg1:#0f0f10;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --accent:#ff7a00;
      --accent2:#ffb000;
      --ok:#2ecc71;
      --bad:#ff4d4d;

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --r: 22px;

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 650px at 20% 15%, rgba(255,122,0,.25), transparent 55%),
        radial-gradient(900px 650px at 80% 30%, rgba(255,176,0,.16), transparent 55%),
        radial-gradient(700px 700px at 50% 95%, rgba(255,122,0,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }

    /* blob background */
    .blob{
      position:fixed; inset:auto;
      width:380px; height:380px;
      filter: blur(36px);
      opacity:.35;
      pointer-events:none;
      z-index:0;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,176,0,.9), rgba(255,122,0,.6), transparent 65%);
      animation: floaty 10s ease-in-out infinite;
    }
    .blob.b1{left:-120px; top:80px; transform:rotate(12deg)}
    .blob.b2{right:-160px; top:260px; width:460px; height:460px; opacity:.28; animation-duration: 13s}
    .blob.b3{left:12%; bottom:-220px; width:520px; height:520px; opacity:.22; animation-duration: 15s}
    @keyframes floaty{
      0%,100%{transform:translateY(0) translateX(0) scale(1)}
      50%{transform:translateY(-18px) translateX(10px) scale(1.03)}
    }

    /* layout */
    .app{
      position:relative;
      z-index:1;
      min-height:100%;
      padding-bottom: calc(92px + var(--safe-bottom));
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(15,15,16,.78), rgba(15,15,16,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .topbarRow{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .logo{
      width:40px;
      height:40px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,122,0,.95), rgba(255,176,0,.85));
      box-shadow: 0 12px 26px rgba(255,122,0,.18);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .logo i{color:#101012; font-size:18px}

    .brandText{
      display:flex; flex-direction:column; line-height:1.1; min-width:0;
    }
    .brandText b{font-size:15px}
    .brandText span{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .pointsPill{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      user-select:none;
      cursor:pointer;
    }
    .pointsPill i{color:var(--accent2)}
    .pointsPill .num{font-weight:700}
    .pointsPill small{color:var(--muted); font-weight:500}

    .content{
      padding: 14px 16px 0;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardPad{padding:14px}

    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .cardTitle h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .cardTitle .hint{
      font-size:12px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .col{display:flex; flex-direction:column; gap:10px}

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      font-family:inherit;
      color:var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:600;
      transition: transform .08s ease, background .2s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,122,0,.95), rgba(255,176,0,.85));
      border-color: rgba(0,0,0,.18);
      color:#101012;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
    }
    .btn.small{padding:10px 12px; border-radius: 14px; font-size:13px}
    .btn.full{width:100%}

    .chipRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.82);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background: rgba(255,122,0,.18);
      border-color: rgba(255,122,0,.35);
      color: #fff;
    }

    .muted{color:var(--muted)}
    .sep{height:1px; background: rgba(255,255,255,.10); margin: 12px 0}

    /* Opening hours card */
    .statusDot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.30);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }
    .statusDot.open{background: var(--ok); box-shadow: 0 0 0 4px rgba(46,204,113,.14)}
    .statusDot.closed{background: var(--bad); box-shadow: 0 0 0 4px rgba(255,77,77,.12)}

    .hoursHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .hoursHeader .left{
      display:flex; gap:10px; align-items:center;
    }
    .hoursHeader b{font-size:14px}
    .hoursHeader span{font-size:12px; color:var(--muted)}
    .hoursBody{padding: 0 14px 12px}
    .hoursList{
      display:none;
      margin-top: 10px;
      gap:8px;
      flex-direction:column;
    }
    .hoursList.show{display:flex}
    .hoursRow{
      display:flex; justify-content:space-between; gap:12px;
      font-size:12px; color: rgba(255,255,255,.78);
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.09);
    }

    /* rewards */
    .rewardList{
      display:flex; flex-direction:column; gap:10px;
    }
    .reward{
      display:flex; gap:12px; align-items:center;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .rewardIcon{
      width:42px; height:42px;
      border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(255,122,0,.14);
      border: 1px solid rgba(255,122,0,.25);
      flex:0 0 auto;
    }
    .rewardIcon i{color: var(--accent2)}
    .rewardMain{min-width:0; flex:1}
    .rewardMain b{display:block; font-size:13px; margin-bottom:2px}
    .rewardMain span{display:block; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rewardRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
      flex:0 0 auto;
    }
    .pts{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.86);
    }

    /* order */
    .orderTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .menuGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .menuItem{
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .menuItem .left{min-width:0}
    .menuItem b{display:block; font-size:13px}
    .menuItem .desc{font-size:12px; color: var(--muted); margin-top:2px}
    .menuItem .right{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      flex:0 0 auto;
    }
    .price{
      font-weight:700;
      font-size:13px;
      color: rgba(255,255,255,.92);
    }

    /* cart fab */
    .fab{
      position:fixed;
      right: 16px;
      bottom: calc(92px + var(--safe-bottom) + 14px);
      z-index: 60;
      border-radius: 999px;
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(255,122,0,.95), rgba(255,176,0,.85));
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      color:#101012;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .fab b{font-size:13px}
    .fab .badge{
      display:inline-grid; place-items:center;
      min-width:22px; height:22px;
      padding: 0 7px;
      border-radius: 999px;
      background: rgba(16,16,18,.92);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
    }

    /* bottom nav */
    .bottomNav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:70;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(15,15,16,.30), rgba(15,15,16,.86));
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .navRow{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      max-width: 540px;
      margin: 0 auto;
    }
    .navBtn{
      flex:1;
      padding: 10px 8px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.75);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      transition: background .2s ease, color .2s ease;
      font-size: 11px;
      min-height: 54px;
    }
    .navBtn i{font-size:16px}
    .navBtn.active{
      background: rgba(255,122,0,.16);
      border-color: rgba(255,122,0,.32);
      color:#fff;
    }

    /* pages */
    .page{display:none}
    .page.show{display:block}

    /* forms */
    .input{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      outline:none;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
    }
    .input::placeholder{color: rgba(255,255,255,.40)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width: 380px){ .grid2{grid-template-columns: 1fr} }

    /* modals + toasts */
    .overlay{
      position:fixed;
      inset:0;
      z-index: 120;
      background: rgba(0,0,0,.55);
      display:none;
      padding: 18px;
      align-items:flex-end;
    }
    .overlay.show{display:flex}
    .modal{
      width:100%;
      max-width: 560px;
      margin: 0 auto;
      border-radius: 26px;
      background: rgba(20,20,22,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 60px rgba(0,0,0,.60);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead b{font-size:14px}
    .modalBody{padding: 14px 16px}
    .modalFoot{
      padding: 14px 16px 16px;
      display:flex;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    .toastWrap{
      position: fixed;
      left: 12px;
      right: 12px;
      top: calc(12px + var(--safe-top));
      z-index: 200;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      max-width: 560px;
      margin: 0 auto;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(20,20,22,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 40px rgba(0,0,0,.55);
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .toast i{margin-top:2px; color: var(--accent2)}
    .toast b{display:block; font-size:13px}
    .toast span{display:block; font-size:12px; color: var(--muted); margin-top:2px}

    /* install guide */
    .installOverlay{
      position:fixed;
      inset:0;
      z-index: 300;
      background: rgba(0,0,0,.70);
      display:none;
      padding: 18px;
      overflow:auto;
    }
    .installOverlay.show{display:block}
    .installBox{
      max-width: 560px;
      margin: calc(14px + var(--safe-top)) auto 20px;
      background: rgba(20,20,22,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      box-shadow: 0 20px 60px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .installBox .head{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .installBox .head b{font-size:14px}
    .installBox .body{padding: 14px 16px}
    .steps{
      display:flex; flex-direction:column; gap:10px;
    }
    .step{
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: rgba(255,255,255,.82);
    }
    .step i{color: var(--accent2); margin-right:8px}

    /* utility */
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <!-- toasts -->
  <div class="toastWrap" id="toastWrap"></div>

  <div class="app" id="app">
    <header class="topbar">
      <div class="topbarRow">
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-mug-hot"></i></div>
          <div class="brandText">
            <b>Milk</b>
            <span id="topSub">Aplikacja lojalnościowa</span>
          </div>
        </div>

        <div class="pointsPill" id="pointsPill" title="Kliknij, aby zobaczyć Milk ID">
          <i class="fa-solid fa-star"></i>
          <div>
            <div class="num" id="pointsNum">0</div>
            <small>pkt</small>
          </div>
        </div>
      </div>
    </header>

    <main class="content">
      <!-- PAGE: POINTS -->
      <section class="page show" id="pagePoints">
        <div class="card">
          <div class="cardPad">
            <div class="hoursHeader" id="hoursToggle" style="cursor:pointer;">
              <div class="left">
                <div class="statusDot" id="statusDot"></div>
                <div>
                  <b id="openStatus">Sprawdzam godziny…</b><br>
                  <span id="openHint">Kliknij, aby rozwinąć</span>
                </div>
              </div>
              <i class="fa-solid fa-chevron-down muted"></i>
            </div>

            <div class="hoursBody">
              <div class="hoursList" id="hoursList">
                <!-- wypełni JS -->
              </div>
            </div>

            <div class="sep"></div>

            <div class="cardTitle">
              <h3>Punkty i historia</h3>
              <span class="hint" id="pointsHint">Zbieraj punkty za zakupy</span>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnShowMilkId"><i class="fa-solid fa-id-card"></i> Milk ID</button>
              <button class="btn ghost" id="btnLogin"><i class="fa-solid fa-user"></i> Konto</button>
            </div>

            <div class="sep"></div>

            <div class="cardTitle">
              <h3>Historia</h3>
              <span class="hint" id="historyCount">0 wpisów</span>
            </div>
            <div class="col" id="historyList">
              <!-- wypełni JS -->
              <div class="muted" style="font-size:12px;">Brak historii — zrób pierwszy zakup.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardPad">
            <div class="cardTitle">
              <h3>Szybkie akcje</h3>
              <span class="hint">Najważniejsze w 1 klik</span>
            </div>

            <div class="grid3">
              <button class="btn small" data-nav="rewards"><i class="fa-solid fa-gift"></i> Nagrody</button>
              <button class="btn small" data-nav="order"><i class="fa-solid fa-bag-shopping"></i> Zamów</button>
              <button class="btn small" data-nav="res"><i class="fa-solid fa-calendar-check"></i> Rezerwuj</button>
            </div>

            <div class="sep"></div>

            <div class="card" style="box-shadow:none;">
              <div class="cardPad">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <b style="font-size:13px;">Eatmi.pl</b><br>
                    <span class="muted" style="font-size:12px;">Zamawianie online (promo)</span>
                  </div>
                  <button class="btn small primary" id="btnOpenEatmi"><i class="fa-solid fa-arrow-up-right-from-square"></i> Otwórz</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- PAGE: REWARDS -->
      <section class="page" id="pageRewards">
        <div class="card">
          <div class="cardPad">
            <div class="cardTitle">
              <h3>Nagrody</h3>
              <span class="hint">Wymień punkty na nagrody</span>
            </div>

            <div class="rewardList" id="rewardList">
              <!-- wypełni JS - docelowo TYLKO te 3:
                   - Milkshake do 30PLN - 25pkt
                   - Zestaw burger do 60PLN - 50pkt
                   - Zamówienie do 120PLN - 100pkt
              -->
              <div class="reward">
                <div class="rewardIcon"><i class="fa-solid fa-gift"></i></div>
                <div class="rewardMain">
                  <b>Ładowanie nagród…</b>
                  <span>Za chwilę zobaczysz dostępne opcje</span>
                </div>
                <div class="rewardRight">
                  <div class="pts">— pkt</div>
                  <button class="btn small" disabled>Wybierz</button>
                </div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="muted" style="font-size:12px;">
              * Wymiana nagród może wymagać zalogowania (Milk ID).
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: ORDER -->
      <section class="page" id="pageOrder">
        <div class="card">
          <div class="cardPad">
            <div class="orderTop">
              <div>
                <b style="font-size:14px;">Zamów i odbierz</b><br>
                <span class="muted" style="font-size:12px;">Wybierz kategorię i dodaj do koszyka</span>
              </div>
              <button class="btn small" id="btnOrderInfo"><i class="fa-solid fa-circle-info"></i></button>
            </div>

            <div class="chipRow" id="orderCategories">
              <!-- kategorie wypełni JS na podstawie menu wklejonego w kodzie (część 2/2) -->
              <div class="chip active" data-cat="kawa-herbata">Kawa</div>
              <div class="chip" data-cat="napoje-soki">Napoje</div>
              <div class="chip" data-cat="shake">Shakes</div>
              <div class="chip" data-cat="deser">Desery</div>
              <div class="chip" data-cat="texmex">Tex Mex</div>
              <div class="chip" data-cat="kanapki">Kanapki</div>
              <div class="chip" data-cat="burger">Burgery</div>
              <div class="chip" data-cat="sniadania">Śniadania</div>
            </div>

            <div class="sep"></div>

            <!-- tu JS wyrenderuje pozycje (JUŻ NIE Z menu.json) -->
            <div class="menuGrid" id="menuGrid">
              <div class="muted" style="font-size:12px;">
                Ładowanie menu…
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: RESERVATIONS -->
      <section class="page" id="pageRes">
        <div class="card">
          <div class="cardPad">
            <div class="cardTitle">
              <h3>Rezerwacje</h3>
              <span class="hint">Szybko i wygodnie</span>
            </div>

            <div class="grid2">
              <input class="input" id="resName" placeholder="Imię i nazwisko" />
              <input class="input" id="resPhone" placeholder="Telefon" inputmode="tel" />
            </div>
            <div style="height:10px"></div>
            <div class="grid2">
              <input class="input" id="resDate" type="date" />
              <input class="input" id="resTime" type="time" />
            </div>
            <div style="height:10px"></div>
            <div class="grid2">
              <input class="input" id="resPeople" type="number" min="1" max="30" placeholder="Liczba osób" />
              <select class="input" id="resPlace">
                <option value="Słupsk">Słupsk</option>
                <option value="Rowy">Rowy</option>
              </select>
            </div>

            <div style="height:10px"></div>
            <input class="input" id="resNote" placeholder="Uwagi (opcjonalnie)" />

            <div style="height:12px"></div>
            <button class="btn primary full" id="btnResSubmit"><i class="fa-solid fa-calendar-check"></i> Wyślij rezerwację</button>

            <div class="sep"></div>

            <div class="cardTitle">
              <h3>Moje rezerwacje</h3>
              <span class="hint" id="resCount">0</span>
            </div>
            <div class="col" id="resList">
              <div class="muted" style="font-size:12px;">Brak rezerwacji.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: ACCOUNT -->
      <section class="page" id="pageAccount">
        <div class="card">
          <div class="cardPad">
            <div class="cardTitle">
              <h3>Konto</h3>
              <span class="hint" id="accHint">Zaloguj się, aby mieć Milk ID</span>
            </div>

            <div class="col" id="accountBox">
              <!-- JS pokaże: login / profil -->
              <button class="btn primary full" id="btnOpenLogin"><i class="fa-brands fa-google"></i> Zaloguj (Google)</button>
              <button class="btn ghost full" id="btnOpenEmailLogin"><i class="fa-solid fa-envelope"></i> Zaloguj e-mail</button>
            </div>

            <div class="sep"></div>

            <div class="cardTitle">
              <h3>Ustawienia</h3>
              <span class="hint">Preferencje aplikacji</span>
            </div>

            <div class="col">
              <button class="btn full" id="btnSettingsPersonal"><i class="fa-solid fa-user-gear"></i> Dane osobowe</button>
              <button class="btn full" id="btnSettingsLang"><i class="fa-solid fa-language"></i> Język</button>
              <button class="btn full" id="btnSettingsHelp"><i class="fa-solid fa-circle-question"></i> Pomoc</button>
              <button class="btn full" id="btnSettingsAbout"><i class="fa-solid fa-circle-info"></i> O aplikacji</button>

              <!-- USUNIĘTE: przycisk "odśwież dane z serwera" (zgodnie z Twoją prośbą) -->
              <!-- <button class="btn full" id="btnSync"><i class="fa-solid fa-arrows-rotate"></i> Odśwież dane z serwera</button> -->

              <button class="btn full" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- CART FAB -->
    <div class="fab hide" id="cartFab">
      <i class="fa-solid fa-basket-shopping"></i>
      <b>Koszyk</b>
      <span class="badge" id="cartBadge">0</span>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottomNav">
      <div class="navRow">
        <div class="navBtn active" data-nav="points">
          <i class="fa-solid fa-star"></i>
          Punkty
        </div>
        <div class="navBtn" data-nav="rewards">
          <i class="fa-solid fa-gift"></i>
          Nagrody
        </div>
        <div class="navBtn" data-nav="order">
          <i class="fa-solid fa-bag-shopping"></i>
          Zamów
        </div>
        <div class="navBtn" data-nav="res">
          <i class="fa-solid fa-calendar-check"></i>
          Rezerwacje
        </div>
        <div class="navBtn" data-nav="account">
          <i class="fa-solid fa-user"></i>
          Konto
        </div>
      </div>
    </nav>
  </div>

  <!-- MODAL: Milk ID -->
  <div class="overlay" id="milkIdOverlay">
    <div class="modal">
      <div class="modalHead">
        <b>Milk ID</b>
        <button class="btn small" id="milkIdClose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modalBody">
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          Twój kod lojalnościowy (6 cyfr). Pokaż w barze.
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <input class="input" id="milkIdValue" readonly value="------" style="font-weight:800; text-align:center; letter-spacing:6px; font-size:16px;">
          <button class="btn primary" id="milkIdCopy"><i class="fa-solid fa-copy"></i> Kopiuj</button>
        </div>

        <div class="sep"></div>
        <div class="muted" style="font-size:12px;">
          * Kod jest przypisany do e-maila po zalogowaniu.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn full" id="milkIdGoLogin"><i class="fa-solid fa-user"></i> Przejdź do konta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Cart -->
  <div class="overlay" id="cartOverlay">
    <div class="modal">
      <div class="modalHead">
        <b>Koszyk</b>
        <button class="btn small" id="cartClose"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="modalBody">
        <div class="col" id="cartList">
          <div class="muted" style="font-size:12px;">Koszyk jest pusty.</div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <input class="input" id="orderName" placeholder="Imię i nazwisko" />
          <input class="input" id="orderPhone" placeholder="Telefon" inputmode="tel" />
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <input class="input" id="orderPickupTime" type="time" />
          <select class="input" id="orderPickupPlace">
            <option value="Słupsk">Słupsk</option>
            <option value="Rowy" disabled>Rowy (chwilowo niedostępne)</option>
          </select>
        </div>

        <div style="height:10px"></div>
        <input class="input" id="orderNote" placeholder="Uwagi (opcjonalnie)" />

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;">
          <div>
            <b style="font-size:13px;">Suma</b><br>
            <span class="muted" style="font-size:12px;">Do zapłaty na miejscu</span>
          </div>
          <div class="price" id="cartTotal">0 PLN</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn ghost full" id="cartClear"><i class="fa-solid fa-trash"></i> Wyczyść</button>
        <button class="btn primary full" id="cartCheckout"><i class="fa-solid fa-check"></i> Złóż zamówienie</button>
      </div>
    </div>
  </div>

  <!-- INSTALL GUIDE -->
  <div class="installOverlay" id="installOverlay">
    <div class="installBox">
      <div class="head">
        <b>Zainstaluj aplikację</b>
        <button class="btn small" id="installClose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="body">
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          Dodaj Milk do ekranu głównego — działa jak aplikacja.
        </div>

        <div class="row">
          <button class="btn small" id="installAndroid"><i class="fa-brands fa-android"></i> Android</button>
          <button class="btn small" id="installIos"><i class="fa-brands fa-apple"></i> iOS</button>
          <button class="btn small primary hide" id="installBtn"><i class="fa-solid fa-download"></i> Zainstaluj</button>
        </div>

        <div class="sep"></div>

        <div class="steps" id="installSteps">
          <!-- JS podmieni instrukcję zależnie od platformy -->
          <div class="step"><i class="fa-solid fa-ellipsis-vertical"></i> Otwórz menu przeglądarki</div>
          <div class="step"><i class="fa-solid fa-square-plus"></i> Wybierz „Dodaj do ekranu głównego”</div>
          <div class="step"><i class="fa-solid fa-check"></i> Potwierdź instalację</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  <script>
/* =========================================================
   MILK PWA — SCRIPT (CZĘŚĆ 2/2)
   Zmiany:
   ✅ Usunięte pobieranie menu z menu.json (menu wbudowane poniżej)
   ✅ Nowe nagrody:
      - Milkshake do 30 PLN — 25 pkt
      - Zestaw burger do 60 PLN — 50 pkt
      - Zamówienie do 120 PLN — 100 pkt
   ✅ Usunięty przycisk "Odśwież dane z serwera" z ustawień (HTML już go nie ma)
   ========================================================= */

(() => {
  /* -------------------------
     Helpers / State
  ------------------------- */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const nowISO = () => new Date().toISOString();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  const LS = {
    get(key, fallback){
      try { return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
      catch { return fallback; }
    },
    set(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    },
    del(key){ localStorage.removeItem(key); }
  };

  const toastWrap = $("#toastWrap");
  function toast(title, msg="", icon="fa-circle-info"){
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `
      <i class="fa-solid ${icon}"></i>
      <div>
        <b>${escapeHtml(title)}</b>
        <span>${escapeHtml(msg)}</span>
      </div>
    `;
    toastWrap.appendChild(el);
    setTimeout(() => { el.style.opacity="0"; el.style.transform="translateY(-6px)"; }, 2500);
    setTimeout(() => el.remove(), 3100);
  }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  /* -------------------------
     Embedded MENU (NO menu.json)
  ------------------------- */
  const MENU = {
    schemaVersion: "1.0",
    currency: "PLN",
    items: [
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Espresso","tag":"espresso","desc":"35 ml","price":11},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Podwójne espresso","tag":"espresso","desc":"70 ml","price":16},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Affogato (espresso z lodami)","tag":"deser kawowy","desc":"","price":"22/27","variants":[{"label":"wariant 1","price":22,"size":null},{"label":"wariant 2","price":27,"size":null}]},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Kawa czarna","tag":"klasyka","desc":"200/300 ml","price":"12/17","variants":[{"label":"200","price":12,"size":"200"},{"label":"300 ml","price":17,"size":"300 ml"}]},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Kawa biała","tag":"klasyka","desc":"200/300 ml","price":"12/17","variants":[{"label":"200","price":12,"size":"200"},{"label":"300 ml","price":17,"size":"300 ml"}]},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Cappuccino","tag":"klasyka","desc":"200/300 ml","price":"13/18","variants":[{"label":"200","price":13,"size":"200"},{"label":"300 ml","price":18,"size":"300 ml"}]},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Latte","tag":"klasyka","desc":"200/300 ml","price":"13/18","variants":[{"label":"200","price":13,"size":"200"},{"label":"300 ml","price":18,"size":"300 ml"}]},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Kawa mrożona","tag":"na zimno","desc":"300 ml","price":26},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Frappe słony karmel","tag":"na zimno","desc":"Podwójne espresso, kostki lodu, mleko, słony karmel","price":27},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Gorąca czekolada","tag":"na ciepło","desc":"200 ml","price":21},
      {"category":"kawa-herbata","categoryLabel":"Kawa","title":"Dodatkowe espresso","tag":"dodatek","desc":"","price":5},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"Zielona","tag":"klasyka","desc":"","price":15},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"English breakfast","tag":"klasyka","desc":"","price":15},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"Piekielna herbata","tag":"rozgrzewająca","desc":"","price":22},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"Czort","tag":"rozgrzewająca","desc":"","price":22},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"Mon Cheri","tag":"rozgrzewająca","desc":"","price":22},
      {"category":"kawa-herbata","categoryLabel":"Herbata","title":"Domowa herbata mrożona","tag":"na zimno","desc":"500 ml","price":26},
      {"category":"kawa-herbata","categoryLabel":"Matcha","title":"Matcha latte","tag":"matcha","desc":"","price":20},
      {"category":"kawa-herbata","categoryLabel":"Matcha","title":"Iced matcha","tag":"matcha","desc":"","price":25},

      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Cytrusowa","tag":"lemoniada","desc":"400/1200 ml","price":"15/30","variants":[{"label":"400","price":15,"size":"400"},{"label":"1200 ml","price":30,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Arbuzowa","tag":"lemoniada","desc":"400/1200 ml","price":"17/35","variants":[{"label":"400","price":17,"size":"400"},{"label":"1200 ml","price":35,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Ananasowa","tag":"lemoniada","desc":"400/1200 ml","price":"17/35","variants":[{"label":"400","price":17,"size":"400"},{"label":"1200 ml","price":35,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Gruszkowa","tag":"lemoniada","desc":"400/1200 ml","price":"17/35","variants":[{"label":"400","price":17,"size":"400"},{"label":"1200 ml","price":35,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Malinowa zimna","tag":"lemoniada","desc":"400/1200 ml","price":"17/35","variants":[{"label":"400","price":17,"size":"400"},{"label":"1200 ml","price":35,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Lemoniada","title":"Malinowa ciepła","tag":"lemoniada","desc":"400/1200 ml","price":"17/35","variants":[{"label":"400","price":17,"size":"400"},{"label":"1200 ml","price":35,"size":"1200 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Napoje","title":"Woda z kranu","tag":"","desc":"","price":0},
      {"category":"napoje-soki","categoryLabel":"Napoje","title":"Woda niegazowana","tag":"","desc":"500 ml","price":8},
      {"category":"napoje-soki","categoryLabel":"Napoje","title":"Woda gazowana","tag":"","desc":"500 ml","price":8},
      {"category":"napoje-soki","categoryLabel":"Napoje","title":"Pepsi","tag":"","desc":"330 ml","price":9},
      {"category":"napoje-soki","categoryLabel":"Napoje","title":"Pepsi Max","tag":"","desc":"330 ml","price":9},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Pomarańczowy","tag":"świeży sok","desc":"300 ml","price":19},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Grejpfrutowy","tag":"świeży sok","desc":"300 ml","price":22},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Pomarańczowo-grejpfrutowy","tag":"świeży sok","desc":"300 ml","price":22},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Jabłkowy","tag":"świeży sok","desc":"300 ml","price":19},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Jabłkowo-gruszkowy","tag":"świeży sok","desc":"300 ml","price":19},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Marchewka-jabłko-pomarańcza","tag":"świeży sok","desc":"300 ml","price":19},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Burak-jabłko-pomarańcza-seler","tag":"świeży sok","desc":"300 ml","price":22},
      {"category":"napoje-soki","categoryLabel":"Świeże soki","title":"Jabłko-seler-kiwi","tag":"świeży sok","desc":"300 ml","price":22},
      {"category":"napoje-soki","categoryLabel":"Smoothies","title":"Zielony","tag":"smoothies","desc":"350 ml • szpinak, kiwi, pomarańcza, gruszka","price":29},
      {"category":"napoje-soki","categoryLabel":"Smoothies","title":"Żółty","tag":"smoothies","desc":"350 ml • banan, jabłko, ananas, mango","price":29},
      {"category":"napoje-soki","categoryLabel":"Smoothies","title":"Pomarańczowy","tag":"smoothies","desc":"350 ml • banan, pomarańcza, mango, nerkowce, limonka","price":29},
      {"category":"napoje-soki","categoryLabel":"Smoothies","title":"Czerwony","tag":"smoothies","desc":"350 ml • truskawki, maliny, banan, ananas","price":29},
      {"category":"napoje-soki","categoryLabel":"Piwo","title":"Corona","tag":"piwo","desc":"330 ml","price":15},
      {"category":"napoje-soki","categoryLabel":"Piwo","title":"Piwo bezalkoholowe","tag":"piwo","desc":"","price":14},
      {"category":"napoje-soki","categoryLabel":"Piwo","title":"IPA","tag":"piwo","desc":"0,5 l","price":19},
      {"category":"napoje-soki","categoryLabel":"Piwo","title":"Lager","tag":"piwo","desc":"Zapytaj o dostępność","price":17},
      {"category":"napoje-soki","categoryLabel":"Wino & Aperitiff","title":"Sauvignon blanc (białe wytrawne) – Skarby Mołdawii","tag":"wino-aperitiff","desc":"170/500/700 ml","price":"22/64/89","variants":[{"label":"170","price":22,"size":"170"},{"label":"500","price":64,"size":"500"},{"label":"700 ml","price":89,"size":"700 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Wino & Aperitiff","title":"Cabernet sauvignon (czerwone wytrawne) – Skarby Mołdawii","tag":"wino-aperitiff","desc":"170/500/700 ml","price":"22/64/89","variants":[{"label":"170","price":22,"size":"170"},{"label":"500","price":64,"size":"500"},{"label":"700 ml","price":89,"size":"700 ml"}]},
      {"category":"napoje-soki","categoryLabel":"Wino & Aperitiff","title":"Hugo","tag":"wino-aperitiff","desc":"Prosecco, woda gazowana, syrop z czarnego bzu, mięta i limonka","price":35},
      {"category":"napoje-soki","categoryLabel":"Wino & Aperitiff","title":"Prosecco (wytrawne wino musujące)","tag":"wino-aperitiff","desc":"","price":26},

      {"category":"shake","categoryLabel":"Shakes","title":"Śmietankowy","tag":"klasyka","desc":"","price":18},
      {"category":"shake","categoryLabel":"Shakes","title":"Waniliowy","tag":"klasyka","desc":"","price":19},
      {"category":"shake","categoryLabel":"Shakes","title":"Czekoladowy","tag":"klasyka","desc":"","price":19},
      {"category":"shake","categoryLabel":"Shakes","title":"Straciatella","tag":"klasyka","desc":"","price":19},
      {"category":"shake","categoryLabel":"Shakes","title":"Chałwa","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Krówka","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Daim","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Milky Way","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Oreo","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Snickers","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Ptasie mleczko waniliowe","tag":"klasyka","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Kinder Bueno","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Reese's Peanut Butter","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Nutella","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Raffaello","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Skittles","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Ferrero Rocher","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Maxi King","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Masło orzechowe","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Kawowy","tag":"klasyka","desc":"","price":24},
      {"category":"shake","categoryLabel":"Shakes","title":"Ciasteczkowy Potwór","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Pistacjusz","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Marshall","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Cringe","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Cheesecake","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Gonzo","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Johny Pierniczony","tag":"vip","desc":"","price":37},
      {"category":"shake","categoryLabel":"Shakes","title":"Banan + maliny","tag":"best-of","desc":"","price":26},
      {"category":"shake","categoryLabel":"Shakes","title":"Mango + truskawki","tag":"best-of","desc":"","price":26},
      {"category":"shake","categoryLabel":"Shakes","title":"Kiwi + mango","tag":"best-of","desc":"","price":26},
      {"category":"shake","categoryLabel":"Shakes","title":"Kinder bueno + maliny","tag":"best-of","desc":"","price":28},
      {"category":"shake","categoryLabel":"Shakes","title":"Oreo + masło orzechowe","tag":"best-of","desc":"","price":28},
      {"category":"shake","categoryLabel":"Shakes","title":"Kawa + słony karmel","tag":"best-of","desc":"","price":29},
      {"category":"shake","categoryLabel":"Shakes","title":"Kawa + Nutella","tag":"best-of","desc":"","price":29},
      {"category":"shake","categoryLabel":"Shakes","title":"Ptasie mleczko + maliny","tag":"best-of","desc":"","price":28},
      {"category":"shake","categoryLabel":"Shakes","title":"Raffaello + jagody","tag":"best-of","desc":"","price":28},
      {"category":"shake","categoryLabel":"Shakes","title":"Bananowy","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Czarna porzeczka","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Malinowy","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Mango","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Truskawkowy","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes","title":"Jagodowy","tag":"owocowe","desc":"","price":22},
      {"category":"shake","categoryLabel":"Shakes proteinowe","title":"Jagodowy muffin","tag":"proteinowe","desc":"","price":32},
      {"category":"shake","categoryLabel":"Shakes proteinowe","title":"Słony karmel","tag":"proteinowe","desc":"","price":28},
      {"category":"shake","categoryLabel":"Shakes proteinowe","title":"Truskawkowe love","tag":"proteinowe","desc":"","price":28},

      {"category":"deser","categoryLabel":"Lody włoskie","title":"Lody włoskie śmietankowe (małe)","tag":"lody-wloskie","desc":"150 g","price":11},
      {"category":"deser","categoryLabel":"Lody włoskie","title":"Lody włoskie śmietankowe (duże)","tag":"lody-wloskie","desc":"250 g","price":16},
      {"category":"deser","categoryLabel":"Dodatki","title":"Mus owocowy lub polewa","tag":"lody-wloskie","desc":"","price":6},
      {"category":"deser","categoryLabel":"Dodatki","title":"M&Ms","tag":"lody-wloskie","desc":"","price":6},
      {"category":"deser","categoryLabel":"Dodatki","title":"Owoce","tag":"lody-wloskie","desc":"","price":14},
      {"category":"deser","categoryLabel":"Dodatki","title":"Bita śmietana","tag":"lody-wloskie","desc":"","price":6},
      {"category":"deser","categoryLabel":"Desery lodowe","title":"Troll","tag":"desery-lodowe","desc":"","price":24},
      {"category":"deser","categoryLabel":"Desery lodowe","title":"Owocowa aleja","tag":"desery-lodowe","desc":"","price":38},
      {"category":"deser","categoryLabel":"Desery lodowe","title":"Grzeszna truskawka","tag":"desery-lodowe","desc":"","price":38},
      {"category":"deser","categoryLabel":"Desery lodowe","title":"Oreo Sundae","tag":"desery-lodowe","desc":"","price":29},
      {"category":"deser","categoryLabel":"Gofry amerykańskie","title":"Z syropem klonowym, jajkiem sadzonym i bekonem","tag":"gofry-amerykanskie","desc":"pół / cały","price":"28/44","variants":[{"label":"pół","price":28,"size":"pół"},{"label":"cały","price":44,"size":"cały"}]},
      {"category":"deser","categoryLabel":"Gofry amerykańskie","title":"American Pie z pieczonymi jabłkami, cynamonem, domową kruszonką i lodami","tag":"gofry-amerykanskie","desc":"pół / cały","price":"27/49","variants":[{"label":"pół","price":27,"size":"pół"},{"label":"cały","price":49,"size":"cały"}]},
      {"category":"deser","categoryLabel":"Gofry amerykańskie","title":"Z dżemem z czarnej porzeczki i polewą Lotus Biscoff","tag":"gofry-amerykanskie","desc":"pół / cały","price":"26/48","variants":[{"label":"pół","price":26,"size":"pół"},{"label":"cały","price":48,"size":"cały"}]},
      {"category":"deser","categoryLabel":"Gofry amerykańskie","title":"Dubajski z truskawkami","tag":"gofry-amerykanskie","desc":"pół / cały","price":"32/54","variants":[{"label":"pół","price":32,"size":"pół"},{"label":"cały","price":54,"size":"cały"}]},
      {"category":"deser","categoryLabel":"Gofry amerykańskie","title":"Cheesecake z serkiem Philadelphia, masą ciasteczkową, kruszonką i truskawkami","tag":"gofry-amerykanskie","desc":"pół / cały","price":"28/50","variants":[{"label":"pół","price":28,"size":"pół"},{"label":"cały","price":50,"size":"cały"}]},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z syropem klonowym i lodami","tag":"pancakes","desc":"3 szt.","price":29},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z owocami, musem truskawkowym i lodami","tag":"pancakes","desc":"3 szt.","price":36},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z Nutellą, truskawkami i lodami","tag":"pancakes","desc":"3 szt.","price":36},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z masą Kinder Bueno, malinami i lodami","tag":"pancakes","desc":"3 szt.","price":39},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z masą Raffaello, truskawkami i lodami","tag":"pancakes","desc":"3 szt.","price":39},
      {"category":"deser","categoryLabel":"Pancakes","title":"Z dubajską pistacją i truskawkami","tag":"pancakes","desc":"3 szt.","price":39},
      {"category":"deser","categoryLabel":"Pancakes","title":"Hello USA","tag":"pancakes","desc":"syrop klonowy, bekon, 2 jaja sadzone","price":39},

      {"category":"texmex","categoryLabel":"Quesadillas","title":"Pollo","tag":"quesadillas","desc":"","price":45},
      {"category":"texmex","categoryLabel":"Quesadillas","title":"Torro","tag":"quesadillas","desc":"","price":46},
      {"category":"texmex","categoryLabel":"Quesadillas","title":"Camaron","tag":"quesadillas","desc":"","price":49},
      {"category":"texmex","categoryLabel":"Quesadillas","title":"Verduras","tag":"quesadillas","desc":"","price":42},
      {"category":"texmex","categoryLabel":"Fajita","title":"Fajita z kurczakiem","tag":"fajita","desc":"","price":59},
      {"category":"texmex","categoryLabel":"Fajita","title":"Fajita z krewetkami","tag":"fajita","desc":"","price":69},
      {"category":"texmex","categoryLabel":"Fajita","title":"Fajita z polędwicą wołową","tag":"fajita","desc":"","price":79},
      {"category":"texmex","categoryLabel":"Churros","title":"Churros (6 szt.) z sosem czekoladowym i truskawkami","tag":"churros","desc":"","price":33},
      {"category":"texmex","categoryLabel":"Churros","title":"Churros (6 szt.) ze słonym karmelem i precelkami","tag":"churros","desc":"","price":32},
      {"category":"texmex","categoryLabel":"Pasta","title":"Tagiatelle z krewetkami","tag":"pasta","desc":"","price":51},
      {"category":"texmex","categoryLabel":"Pasta","title":"Vege Pasta","tag":"pasta","desc":"","price":44},
      {"category":"texmex","categoryLabel":"NY Chinatown Stir Fry","title":"Vege (z nerkowcami)","tag":"stir-fry","desc":"","price":39},
      {"category":"texmex","categoryLabel":"NY Chinatown Stir Fry","title":"Z kurczakiem 90g","tag":"stir-fry","desc":"","price":47},
      {"category":"texmex","categoryLabel":"NY Chinatown Stir Fry","title":"Z wołowiną 90g","tag":"stir-fry","desc":"","price":55},
      {"category":"texmex","categoryLabel":"NY Chinatown Stir Fry","title":"Z krewetkami (16/20) 7 szt.","tag":"stir-fry","desc":"","price":51},
      {"category":"texmex","categoryLabel":"Dodatki","title":"Dodatkowe nerkowce 20g","tag":"stir-fry","desc":"","price":8},
      {"category":"texmex","categoryLabel":"Sałaty","title":"Cezar","tag":"salaty","desc":"","price":49},
      {"category":"texmex","categoryLabel":"Sałaty","title":"Vege Cezar","tag":"salaty","desc":"","price":42},
      {"category":"texmex","categoryLabel":"Sałaty","title":"Ale burak","tag":"salaty","desc":"","price":44},
      {"category":"texmex","categoryLabel":"Sałaty","title":"Alabama","tag":"salaty","desc":"","price":51},

      {"category":"kanapki","categoryLabel":"Startery","title":"Frytki","tag":"startery","desc":"150 g","price":15},
      {"category":"kanapki","categoryLabel":"Startery","title":"Frytki z batatów","tag":"startery","desc":"150 g","price":19},
      {"category":"kanapki","categoryLabel":"Startery","title":"Frytki z serem, bekonem i majonezem sriracha","tag":"startery","desc":"","price":30},
      {"category":"kanapki","categoryLabel":"Startery","title":"Krążki cebulowe (5 szt.) z sosem sweet chili","tag":"startery","desc":"","price":18},
      {"category":"kanapki","categoryLabel":"Startery","title":"Krewetki w tempurze (3 szt.) z sosem sweet chili","tag":"startery","desc":"","price":21},
      {"category":"kanapki","categoryLabel":"Startery","title":"Krewetki w tempurze (6 szt.) z sosem sweet chili","tag":"startery","desc":"","price":39},
      {"category":"kanapki","categoryLabel":"Startery","title":"Nachos z serem, guacamole, śmietaną, salsą i jalapeno","tag":"startery","desc":"","price":41},
      {"category":"kanapki","categoryLabel":"Startery","title":"Nachos z chili con carne, serem, śmietaną, guacamole i jalapeno","tag":"startery","desc":"","price":49},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Rostbef","tag":"kanapki","desc":"60 g / 100 g","price":"42/58","variants":[{"label":"60 g","price":42,"size":"60 g"},{"label":"100 g","price":58,"size":"100 g"}]},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Cotto","tag":"kanapki","desc":"70 g / 120 g","price":"37/49","variants":[{"label":"70 g","price":37,"size":"70 g"},{"label":"120 g","price":49,"size":"120 g"}]},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Kura","tag":"kanapki","desc":"","price":46},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Club sandwich","tag":"kanapki","desc":"","price":38},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Cotto club","tag":"kanapki","desc":"","price":36},
      {"category":"kanapki","categoryLabel":"Kanapki","title":"Vege club","tag":"kanapki","desc":"","price":36},
      {"category":"kanapki","categoryLabel":"Dania główne","title":"Tatar z polędwicy wołowej","tag":"dania-glowne","desc":"100 g","price":51},
      {"category":"kanapki","categoryLabel":"Dania główne","title":"Żebro wieprzowe","tag":"dania-glowne","desc":"450 g","price":75},
      {"category":"kanapki","categoryLabel":"Dania główne","title":"Stek","tag":"dania-glowne","desc":"","price":125},
      {"category":"kanapki","categoryLabel":"Dania główne","title":"Kurczak supreme","tag":"dania-glowne","desc":"","price":65},
      {"category":"kanapki","categoryLabel":"Zestawy","title":"Burger + frytki lub sałatka","tag":"zestawy","desc":"oszczędzasz 5 PLN","price":"+12","variants":[{"label":"dopłata","price":12.0,"size":null}]},
      {"category":"kanapki","categoryLabel":"Zestawy","title":"Burger + frytki/sałatka + lemoniada cytrusowa","tag":"zestawy","desc":"oszczędzasz 10 PLN","price":"+22","variants":[{"label":"dopłata","price":22.0,"size":null}]},
      {"category":"kanapki","categoryLabel":"Zestawy","title":"Zamień frytki na krążki cebulowe","tag":"zestawy","desc":"","price":15},
      {"category":"kanapki","categoryLabel":"Zestawy","title":"Zamień frytki na mini nachos","tag":"zestawy","desc":"","price":18},
      {"category":"kanapki","categoryLabel":"Zestawy","title":"Zamień frytki na bataty","tag":"zestawy","desc":"","price":14},

      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Prostak","tag":"wolowy","desc":"mały / średni / duży","price":"30/38/46","variants":[{"label":"mały","price":30,"size":"mały"},{"label":"średni","price":38,"size":"średni"},{"label":"duży","price":46,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Sergio","tag":"wolowy","desc":"mały / średni / duży","price":"32/40/48","variants":[{"label":"mały","price":32,"size":"mały"},{"label":"średni","price":40,"size":"średni"},{"label":"duży","price":48,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Boston","tag":"wolowy","desc":"mały / średni / duży","price":"34/42/50","variants":[{"label":"mały","price":34,"size":"mały"},{"label":"średni","price":42,"size":"średni"},{"label":"duży","price":50,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Pleśniak","tag":"wolowy","desc":"mały / średni / duży","price":"38/46/54","variants":[{"label":"mały","price":38,"size":"mały"},{"label":"średni","price":46,"size":"średni"},{"label":"duży","price":54,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Bajpas","tag":"wolowy","desc":"mały / średni / duży","price":"36/44/52","variants":[{"label":"mały","price":36,"size":"mały"},{"label":"średni","price":44,"size":"średni"},{"label":"duży","price":52,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Burakoza","tag":"wolowy","desc":"mały / średni / duży","price":"38/46/54","variants":[{"label":"mały","price":38,"size":"mały"},{"label":"średni","price":46,"size":"średni"},{"label":"duży","price":54,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"New York","tag":"wolowy","desc":"mały / średni / duży","price":"38/46/54","variants":[{"label":"mały","price":38,"size":"mały"},{"label":"średni","price":46,"size":"średni"},{"label":"duży","price":54,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Złodziej","tag":"wolowy","desc":"mały / średni / duży","price":"38/46/54","variants":[{"label":"mały","price":38,"size":"mały"},{"label":"średni","price":46,"size":"średni"},{"label":"duży","price":54,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery wołowe Black Angus","title":"Missisipi","tag":"wolowy","desc":"mały / średni / duży","price":"38/46/54","variants":[{"label":"mały","price":38,"size":"mały"},{"label":"średni","price":46,"size":"średni"},{"label":"duży","price":54,"size":"duży"}]},
      {"category":"burger","categoryLabel":"Burgery z kurczakiem","title":"Kura","tag":"kurczak","desc":"","price":43},
      {"category":"burger","categoryLabel":"Burgery z kurczakiem","title":"Żółtodziób","tag":"kurczak","desc":"","price":43},

      {"category":"sniadania","categoryLabel":"Napoje do śniadania","title":"Kawa filtrowana (z dolewką)","tag":"sniadania","desc":"","price":12},
      {"category":"sniadania","categoryLabel":"Napoje do śniadania","title":"Herbata śniadaniowa","tag":"sniadania","desc":"","price":9},
      {"category":"sniadania","categoryLabel":"Napoje do śniadania","title":"Świeży sok","tag":"sniadania","desc":"0,2 l","price":18},
      {"category":"sniadania","categoryLabel":"Napoje do śniadania","title":"Mimoza","tag":"sniadania","desc":"","price":31},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Granola","tag":"sniadania","desc":"","price":44},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Tost francuski w panko","tag":"sniadania","desc":"","price":44},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Jajito burrito","tag":"sniadania","desc":"","price":37},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Czerwona szakszuka","tag":"sniadania","desc":"","price":39},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Egg royal","tag":"sniadania","desc":"","price":45},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Jajecznica","tag":"sniadania","desc":"","price":33},
      {"category":"sniadania","categoryLabel":"Śniadania","title":"Omlet francuski","tag":"sniadania","desc":"","price":37},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Rostbef","tag":"kanapki-sniadaniowe","desc":"60 g / 100 g","price":"42/58","variants":[{"label":"60 g","price":42,"size":"60 g"},{"label":"100 g","price":58,"size":"100 g"}]},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Cotto","tag":"kanapki-sniadaniowe","desc":"70 g / 120 g","price":"37/49","variants":[{"label":"70 g","price":37,"size":"70 g"},{"label":"120 g","price":49,"size":"120 g"}]},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Kura","tag":"kanapki-sniadaniowe","desc":"","price":46},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Club sandwich","tag":"kanapki-sniadaniowe","desc":"","price":38},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Cotto club","tag":"kanapki-sniadaniowe","desc":"","price":36},
      {"category":"sniadania","categoryLabel":"Kanapki śniadaniowe","title":"Vege club","tag":"kanapki-sniadaniowe","desc":"","price":36},
      {"category":"sniadania","categoryLabel":"Full milkshake breakfast","title":"Duży full milkshake breakfast","tag":"zestaw-sniadaniowy","desc":"","price":53},
      {"category":"sniadania","categoryLabel":"Full milkshake breakfast","title":"Mały full milkshake breakfast","tag":"zestaw-sniadaniowy","desc":"","price":42},
      {"category":"sniadania","categoryLabel":"Chiquita","title":"Chiquita","tag":"chiquita","desc":"","price":41},
      {"category":"sniadania","categoryLabel":"Chiquita","title":"Chiquita z chorizo","tag":"chiquita","desc":"80 g","price":39},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Frankfurterka","tag":"sniadania-keto","desc":"","price":7},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Chorizo","tag":"sniadania-keto","desc":"70 g","price":8},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"½ awokado","tag":"sniadania-keto","desc":"","price":9},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Twarożek","tag":"sniadania-keto","desc":"80 g","price":7},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Ogórek zielony","tag":"sniadania-keto","desc":"7 plastrów","price":5},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Pomidorki koktajlowe","tag":"sniadania-keto","desc":"80 g","price":5},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Bekon","tag":"sniadania-keto","desc":"2 plastry","price":4},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Jajo","tag":"sniadania-keto","desc":"","price":4},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Masło","tag":"sniadania-keto","desc":"10 g","price":2},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Chleb maślany","tag":"sniadania-keto","desc":"80 g","price":6},
      {"category":"sniadania","categoryLabel":"Śniadanie KETO – dodatki","title":"Gravlax","tag":"sniadania-keto","desc":"50 g","price":15}
    ]
  };

  // categories display order + labels (must match HTML chips data-cat)
  const CAT_LABEL = {
    "kawa-herbata": "Kawa",
    "napoje-soki": "Napoje",
    "shake": "Shakes",
    "deser": "Desery",
    "texmex": "Tex Mex",
    "kanapki": "Kanapki",
    "burger": "Burgery",
    "sniadania": "Śniadania"
  };

  /* -------------------------
     Rewards (NEW)
  ------------------------- */
  const REWARDS = [
    { id:"milkshake30", title:"Milkshake do 30 PLN", subtitle:"Nagroda do wykorzystania w barze", points:25, icon:"fa-ice-cream" },
    { id:"burger60", title:"Zestaw burger o wartości do 60 PLN", subtitle:"Nagroda do wykorzystania w barze", points:50, icon:"fa-burger" },
    { id:"order120", title:"Zamówienie do 120 PLN", subtitle:"Nagroda do wykorzystania w barze", points:100, icon:"fa-receipt" },
  ];

  /* -------------------------
     Local "account" / identity
     (Simple mock: email + name)
  ------------------------- */
  const state = {
    // profile
    profile: LS.get("milk_profile", { loggedIn:false, email:"", name:"" }),
    // points/history
    points: LS.get("milk_points", 0),
    history: LS.get("milk_points_history", []),
    // milkId per-email
    milkIdMap: LS.get("milk_milkid_map", {}), // email -> 6-digit string
    // cart
    cart: LS.get("milk_cart_v1", []), // {key,title,variantLabel,price,qty,category}
    // reservations
    reservations: LS.get("milk_res_local", []), // fallback list
    // ui
    activeNav: "points",
    activeCategory: "kawa-herbata",
    install: { deferredPrompt:null, platform:"android" }
  };

  // one-time history reset helper (as in your previous code base)
  if (!LS.get("milk_pointsHistory_reset_once", false)) {
    // keep current history; do not wipe by default. If you previously had forced reset, uncomment next line:
    // state.history = []; LS.set("milk_points_history", state.history);
    LS.set("milk_pointsHistory_reset_once", true);
  }

  function saveAll(){
    LS.set("milk_profile", state.profile);
    LS.set("milk_points", state.points);
    LS.set("milk_points_history", state.history);
    LS.set("milk_milkid_map", state.milkIdMap);
    LS.set("milk_cart_v1", state.cart);
    LS.set("milk_res_local", state.reservations);
  }

  /* -------------------------
     Elements
  ------------------------- */
  const el = {
    pointsNum: $("#pointsNum"),
    pointsPill: $("#pointsPill"),
    topSub: $("#topSub"),

    // pages
    pages: {
      points: $("#pagePoints"),
      rewards: $("#pageRewards"),
      order: $("#pageOrder"),
      res: $("#pageRes"),
      account: $("#pageAccount")
    },
    navBtns: $$(".navBtn"),

    // hours
    hoursToggle: $("#hoursToggle"),
    hoursList: $("#hoursList"),
    statusDot: $("#statusDot"),
    openStatus: $("#openStatus"),
    openHint: $("#openHint"),

    // history
    historyList: $("#historyList"),
    historyCount: $("#historyCount"),

    // actions
    btnShowMilkId: $("#btnShowMilkId"),
    btnLogin: $("#btnLogin"),
    btnOpenEatmi: $("#btnOpenEatmi"),

    // milk id modal
    milkIdOverlay: $("#milkIdOverlay"),
    milkIdClose: $("#milkIdClose"),
    milkIdGoLogin: $("#milkIdGoLogin"),
    milkIdValue: $("#milkIdValue"),
    milkIdCopy: $("#milkIdCopy"),

    // rewards
    rewardList: $("#rewardList"),

    // order
    orderCategories: $("#orderCategories"),
    menuGrid: $("#menuGrid"),
    cartFab: $("#cartFab"),
    cartBadge: $("#cartBadge"),
    btnOrderInfo: $("#btnOrderInfo"),

    // cart modal
    cartOverlay: $("#cartOverlay"),
    cartClose: $("#cartClose"),
    cartList: $("#cartList"),
    cartTotal: $("#cartTotal"),
    cartClear: $("#cartClear"),
    cartCheckout: $("#cartCheckout"),
    orderName: $("#orderName"),
    orderPhone: $("#orderPhone"),
    orderPickupTime: $("#orderPickupTime"),
    orderPickupPlace: $("#orderPickupPlace"),
    orderNote: $("#orderNote"),

    // reservations
    resName: $("#resName"),
    resPhone: $("#resPhone"),
    resDate: $("#resDate"),
    resTime: $("#resTime"),
    resPeople: $("#resPeople"),
    resPlace: $("#resPlace"),
    resNote: $("#resNote"),
    btnResSubmit: $("#btnResSubmit"),
    resList: $("#resList"),
    resCount: $("#resCount"),

    // account
    accHint: $("#accHint"),
    accountBox: $("#accountBox"),
    btnOpenLogin: $("#btnOpenLogin"),
    btnOpenEmailLogin: $("#btnOpenEmailLogin"),
    btnLogout: $("#btnLogout"),

    btnSettingsPersonal: $("#btnSettingsPersonal"),
    btnSettingsLang: $("#btnSettingsLang"),
    btnSettingsHelp: $("#btnSettingsHelp"),
    btnSettingsAbout: $("#btnSettingsAbout"),

    // install
    installOverlay: $("#installOverlay"),
    installClose: $("#installClose"),
    installAndroid: $("#installAndroid"),
    installIos: $("#installIos"),
    installBtn: $("#installBtn"),
    installSteps: $("#installSteps"),
  };

  /* -------------------------
     Opening hours (simple)
  ------------------------- */
  const HOURS = [
    { d:"Pon", t:"10:00–22:00" },
    { d:"Wto", t:"10:00–22:00" },
    { d:"Śro", t:"10:00–22:00" },
    { d:"Czw", t:"10:00–22:00" },
    { d:"Pią", t:"10:00–23:00" },
    { d:"Sob", t:"10:00–23:00" },
    { d:"Nie", t:"10:00–22:00" },
  ];

  function getTodayIndex(){
    const d = new Date();
    // JS: 0=Sun..6=Sat => convert to 0=Mon..6=Sun
    const js = d.getDay();
    return (js + 6) % 7;
  }
  function parseHHMM(s){
    const [h,m] = String(s).split(":").map(n=>parseInt(n,10));
    return (h*60 + m);
  }
  function isOpenNow(){
    // based on today's hours only; simple ranges like "10:00–22:00"
    const idx = getTodayIndex();
    const range = HOURS[idx].t;
    const m = range.match(/(\d{1,2}:\d{2})\D+(\d{1,2}:\d{2})/);
    if(!m) return {open:false, label:"Zamknięte", hint:"Godziny dostępne po rozwinięciu"};
    const start = parseHHMM(m[1]);
    const end = parseHHMM(m[2]);
    const now = new Date();
    const cur = now.getHours()*60 + now.getMinutes();
    const open = (cur >= start && cur <= end);
    return {
      open,
      label: open ? "Otwarte" : "Zamknięte",
      hint: open ? `Dziś do ${m[2]}` : `Dziś od ${m[1]}`
    };
  }
  function renderHours(){
    el.hoursList.innerHTML = "";
    HOURS.forEach((h, i) => {
      const row = document.createElement("div");
      row.className = "hoursRow";
      row.innerHTML = `<span>${h.d}</span><span>${h.t}</span>`;
      el.hoursList.appendChild(row);
    });
    const s = isOpenNow();
    el.statusDot.classList.toggle("open", s.open);
    el.statusDot.classList.toggle("closed", !s.open);
    el.openStatus.textContent = s.label;
    el.openHint.textContent = s.hint + " • kliknij, aby rozwinąć";
  }

  /* -------------------------
     Milk ID
  ------------------------- */
  function ensureMilkId(){
    if(!state.profile.loggedIn || !state.profile.email) return null;
    const email = state.profile.email.toLowerCase().trim();
    if(!state.milkIdMap[email]){
      state.milkIdMap[email] = String(Math.floor(100000 + Math.random()*900000));
      saveAll();
    }
    return state.milkIdMap[email];
  }

  function openMilkIdModal(){
    if(!state.profile.loggedIn){
      toast("Zaloguj się", "Aby mieć Milk ID, zaloguj się w zakładce Konto.", "fa-user");
      el.milkIdValue.value = "------";
    } else {
      const code = ensureMilkId();
      el.milkIdValue.value = code ?? "------";
    }
    el.milkIdOverlay.classList.add("show");
  }
  function closeMilkIdModal(){ el.milkIdOverlay.classList.remove("show"); }

  /* -------------------------
     Points / History
  ------------------------- */
  function addHistory(type, pointsDelta, note){
    const item = {
      id: crypto?.randomUUID?.() ?? String(Math.random()).slice(2),
      ts: nowISO(),
      type,
      delta: pointsDelta,
      note: note ?? ""
    };
    state.history.unshift(item);
    if(state.history.length > 80) state.history.length = 80;
    saveAll();
  }

  function renderPoints(){
    el.pointsNum.textContent = String(state.points ?? 0);
    el.topSub.textContent = state.profile.loggedIn
      ? `Zalogowano: ${state.profile.email}`
      : "Aplikacja lojalnościowa";
  }

  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("pl-PL", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return iso; }
  }

  function renderHistory(){
    el.historyList.innerHTML = "";
    const list = state.history ?? [];
    el.historyCount.textContent = `${list.length} wpisów`;

    if(list.length === 0){
      el.historyList.innerHTML = `<div class="muted" style="font-size:12px;">Brak historii — zrób pierwszy zakup.</div>`;
      return;
    }

    list.slice(0, 20).forEach(h => {
      const box = document.createElement("div");
      box.className = "reward"; // reuse style
      const sign = (h.delta >= 0 ? "+" : "");
      const icon = h.delta >= 0 ? "fa-circle-plus" : "fa-circle-minus";
      box.innerHTML = `
        <div class="rewardIcon"><i class="fa-solid ${icon}"></i></div>
        <div class="rewardMain">
          <b>${escapeHtml(h.type)}</b>
          <span>${escapeHtml(h.note || fmtTime(h.ts))}</span>
        </div>
        <div class="rewardRight">
          <div class="pts">${sign}${h.delta} pkt</div>
        </div>
      `;
      el.historyList.appendChild(box);
    });
  }

  /* -------------------------
     Rewards
  ------------------------- */
  function renderRewards(){
    el.rewardList.innerHTML = "";
    REWARDS.forEach(r => {
      const can = (state.points >= r.points);
      const row = document.createElement("div");
      row.className = "reward";
      row.innerHTML = `
        <div class="rewardIcon"><i class="fa-solid ${r.icon}"></i></div>
        <div class="rewardMain">
          <b>${escapeHtml(r.title)}</b>
          <span>${escapeHtml(r.subtitle)}</span>
        </div>
        <div class="rewardRight">
          <div class="pts">${r.points} pkt</div>
          <button class="btn small ${can ? "primary" : ""}" data-reward="${r.id}" ${can ? "" : "disabled"}>
            ${can ? "Odbierz" : "Za mało"}
          </button>
        </div>
      `;
      el.rewardList.appendChild(row);
    });

    el.rewardList.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-reward]");
      if(!btn) return;
      const id = btn.getAttribute("data-reward");
      const r = REWARDS.find(x => x.id === id);
      if(!r) return;

      if(!state.profile.loggedIn){
        toast("Zaloguj się", "Do odbioru nagrody wymagane jest konto (Milk ID).", "fa-user");
        go("account");
        return;
      }
      if(state.points < r.points){
        toast("Za mało punktów", "Zbierz więcej punktów, żeby odebrać nagrodę.", "fa-triangle-exclamation");
        return;
      }

      // redeem locally (you can swap to /api/rewards/redeem later)
      state.points -= r.points;
      addHistory("Odebrano nagrodę", -r.points, r.title);
      renderAll();
      toast("Gotowe!", `Odebrano: ${r.title}`, "fa-gift");
    }, { once:true });
  }

  /* -------------------------
     Order: variants + cart
  ------------------------- */
  function priceLabel(item){
    if(item.variants?.length){
      const min = Math.min(...item.variants.map(v => Number(v.price)));
      const max = Math.max(...item.variants.map(v => Number(v.price)));
      return (min === max) ? `${min} PLN` : `${min}–${max} PLN`;
    }
    if(typeof item.price === "number") return `${item.price} PLN`;
    // string like "12/17" or "+12"
    const p = String(item.price);
    if(p.startsWith("+")){
      const v = Number(p.replace("+",""));
      return `+${v} PLN`;
    }
    if(p.includes("/")){
      const parts = p.split("/").map(x => Number(String(x).replace(",", ".").trim())).filter(n => !Number.isNaN(n));
      if(parts.length) return `${Math.min(...parts)}–${Math.max(...parts)} PLN`;
    }
    return `${p} PLN`;
  }

  function normalizeItems(){
    // create stable keys and ensure categoryLabel fallback
    return MENU.items.map((it, idx) => ({
      ...it,
      categoryLabel: it.categoryLabel || CAT_LABEL[it.category] || it.category,
      _id: it._id || `${it.category}:${it.title}:${idx}`
    }));
  }
  const MENU_ITEMS = normalizeItems();

  function setActiveCategory(cat){
    state.activeCategory = cat;
    $$(".chip", el.orderCategories).forEach(c => c.classList.toggle("active", c.dataset.cat === cat));
    renderMenuGrid();
  }

  function renderMenuGrid(){
    const cat = state.activeCategory;
    const items = MENU_ITEMS.filter(i => i.category === cat);

    el.menuGrid.innerHTML = "";
    if(items.length === 0){
      el.menuGrid.innerHTML = `<div class="muted" style="font-size:12px;">Brak pozycji w tej kategorii.</div>`;
      return;
    }

    items.forEach(item => {
      const row = document.createElement("div");
      row.className = "menuItem";
      row.innerHTML = `
        <div class="left">
          <b>${escapeHtml(item.title)}</b>
          <div class="desc">${escapeHtml((item.desc || item.tag || "").trim())}</div>
        </div>
        <div class="right">
          <div class="price">${escapeHtml(priceLabel(item))}</div>
          <button class="btn small primary" data-add="${escapeHtml(item._id)}">
            <i class="fa-solid fa-plus"></i> Dodaj
          </button>
        </div>
      `;
      el.menuGrid.appendChild(row);
    });
  }

  function cartKeyFor(itemId, variantLabel){
    return `${itemId}::${variantLabel || ""}`;
  }

  function addToCart(item, variant=null){
    const title = item.title;
    const variantLabel = variant?.label || "";
    const price = Number(variant?.price ?? item.price ?? 0);
    const key = cartKeyFor(item._id, variantLabel);

    let line = state.cart.find(x => x.key === key);
    if(!line){
      line = { key, itemId: item._id, title, variantLabel, price, qty: 0, category: item.category };
      state.cart.push(line);
    }
    line.qty += 1;
    if(line.qty > 99) line.qty = 99;
    saveAll();
    renderCartFab();
    toast("Dodano do koszyka", variantLabel ? `${title} • ${variantLabel}` : title, "fa-basket-shopping");
  }

  function openVariantPicker(item){
    // if no variants, add directly
    if(!item.variants?.length){
      addToCart(item, null);
      return;
    }

    // Use cart modal as picker quick (simple prompt-like)
    const opts = item.variants.map(v => `${v.label} — ${v.price} PLN`).join("\n");
    const picked = prompt(`Wybierz wariant:\n${opts}\n\nWpisz dokładnie nazwę wariantu (np. "${item.variants[0].label}")`);
    if(!picked) return;

    const v = item.variants.find(x => String(x.label).toLowerCase().trim() === String(picked).toLowerCase().trim());
    if(!v){
      toast("Nie znaleziono wariantu", "Spróbuj ponownie i wpisz nazwę wariantu dokładnie.", "fa-triangle-exclamation");
      return;
    }
    addToCart(item, v);
  }

  function cartTotals(){
    const sum = (state.cart || []).reduce((a, l) => a + (Number(l.price)||0) * (Number(l.qty)||0), 0);
    const qty = (state.cart || []).reduce((a, l) => a + (Number(l.qty)||0), 0);
    return { sum, qty };
  }

  function renderCartFab(){
    const { qty } = cartTotals();
    el.cartBadge.textContent = String(qty);
    el.cartFab.classList.toggle("hide", qty === 0 || state.activeNav !== "order");
  }

  function openCart(){
    renderCartModal();
    el.cartOverlay.classList.add("show");
  }
  function closeCart(){ el.cartOverlay.classList.remove("show"); }

  function renderCartModal(){
    el.cartList.innerHTML = "";
    const lines = state.cart || [];
    if(lines.length === 0){
      el.cartList.innerHTML = `<div class="muted" style="font-size:12px;">Koszyk jest pusty.</div>`;
    } else {
      lines.forEach(line => {
        const row = document.createElement("div");
        row.className = "menuItem";
        row.innerHTML = `
          <div class="left">
            <b>${escapeHtml(line.title)}</b>
            <div class="desc">${escapeHtml(line.variantLabel || "—")}</div>
          </div>
          <div class="right" style="align-items:flex-end;">
            <div class="price">${escapeHtml(line.price)} PLN</div>
            <div class="row" style="gap:8px;">
              <button class="btn small" data-dec="${escapeHtml(line.key)}"><i class="fa-solid fa-minus"></i></button>
              <div class="pts">${line.qty}</div>
              <button class="btn small" data-inc="${escapeHtml(line.key)}"><i class="fa-solid fa-plus"></i></button>
            </div>
          </div>
        `;
        el.cartList.appendChild(row);
      });
    }
    const { sum } = cartTotals();
    el.cartTotal.textContent = `${sum.toFixed(0)} PLN`;
  }

  function incLine(key){
    const l = state.cart.find(x => x.key === key);
    if(!l) return;
    l.qty = clamp((l.qty||0) + 1, 1, 99);
    saveAll();
    renderCartModal();
    renderCartFab();
  }
  function decLine(key){
    const idx = state.cart.findIndex(x => x.key === key);
    if(idx === -1) return;
    const l = state.cart[idx];
    l.qty = (l.qty||0) - 1;
    if(l.qty <= 0) state.cart.splice(idx, 1);
    saveAll();
    renderCartModal();
    renderCartFab();
  }

  function clearCart(){
    state.cart = [];
    saveAll();
    renderCartModal();
    renderCartFab();
    toast("Koszyk wyczyszczony", "", "fa-trash");
  }

  function minPickupMinutes(){
    const d = new Date();
    const day = d.getDay(); // 0 sun..6 sat
    // Mon-Thu 30min, Fri-Sun 45min (per your earlier rules)
    // Mon(1) Tue(2) Wed(3) Thu(4)
    if(day >= 1 && day <= 4) return 30;
    return 45;
  }

  function validatePickupTime(t){
    if(!t) return { ok:false, msg:"Wybierz godzinę odbioru." };
    const [hh, mm] = t.split(":").map(n=>parseInt(n,10));
    if(Number.isNaN(hh) || Number.isNaN(mm)) return { ok:false, msg:"Nieprawidłowa godzina." };

    const d = new Date();
    const target = new Date(d);
    target.setHours(hh, mm, 0, 0);

    const minM = minPickupMinutes();
    const minTarget = new Date(d.getTime() + minM*60000);
    if(target < minTarget){
      return { ok:false, msg:`Zbyt wcześnie. Minimalnie +${minM} min.` };
    }
    return { ok:true };
  }

  async function checkout(){
    const { sum, qty } = cartTotals();
    if(qty === 0){
      toast("Koszyk pusty", "Dodaj produkty do koszyka.", "fa-basket-shopping");
      return;
    }

    const name = (el.orderName.value || "").trim();
    const phone = (el.orderPhone.value || "").trim();
    const pickupTime = (el.orderPickupTime.value || "").trim();
    const place = (el.orderPickupPlace.value || "Słupsk").trim();
    const note = (el.orderNote.value || "").trim();

    if(!name || name.length < 3){
      toast("Uzupełnij dane", "Podaj imię i nazwisko.", "fa-triangle-exclamation");
      return;
    }
    if(!phone || phone.length < 7){
      toast("Uzupełnij dane", "Podaj numer telefonu.", "fa-triangle-exclamation");
      return;
    }
    if(place === "Rowy"){
      toast("Rowy niedostępne", "Na razie odbiór dostępny tylko w Słupsku.", "fa-triangle-exclamation");
      return;
    }

    const vt = validatePickupTime(pickupTime);
    if(!vt.ok){
      toast("Godzina odbioru", vt.msg, "fa-clock");
      return;
    }

    const payload = {
      createdAt: nowISO(),
      customer: { name, phone, email: state.profile.loggedIn ? state.profile.email : "" },
      pickup: { time: pickupTime, place, note },
      items: (state.cart || []).map(l => ({
        title: l.title,
        variant: l.variantLabel || "",
        price: l.price,
        qty: l.qty
      })),
      total: sum,
      currency: MENU.currency || "PLN"
    };

    // Try server API (optional). If fails, keep locally.
    let sent = false;
    try{
      const res = await fetch("/api/orders", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(res.ok) sent = true;
    }catch{}

    if(sent){
      toast("Zamówienie wysłane", `Suma: ${sum.toFixed(0)} PLN`, "fa-check");
    } else {
      // local fallback
      const localOrders = LS.get("milk_orders_local", []);
      localOrders.unshift({ id: crypto?.randomUUID?.() ?? String(Math.random()).slice(2), ...payload, _local:true });
      LS.set("milk_orders_local", localOrders);
      toast("Zapisano lokalnie", "Brak połączenia z serwerem — zamówienie zapisane na urządzeniu.", "fa-wifi");
    }

    // Optional: award points based on order value (simple rule)
    // If you already have your own points rules on backend, you can remove this.
    const earned = Math.max(0, Math.floor(sum / 10)); // 1 pkt per 10 PLN
    if(earned > 0){
      state.points += earned;
      addHistory("Punkty za zamówienie", +earned, `Zamówienie: ${sum.toFixed(0)} PLN`);
    }

    clearCart();
    closeCart();
    renderAll();
  }

  /* -------------------------
     Reservations
  ------------------------- */
  async function submitReservation(){
    if(!state.profile.loggedIn){
      toast("Zaloguj się", "Rezerwacje wymagają konta (Milk ID).", "fa-user");
      go("account");
      return;
    }

    const name = (el.resName.value || "").trim();
    const phone = (el.resPhone.value || "").trim();
    const date = el.resDate.value;
    const time = el.resTime.value;
    const people = parseInt(el.resPeople.value || "0", 10);
    const place = el.resPlace.value || "Słupsk";
    const note = (el.resNote.value || "").trim();

    if(!name || name.length < 3) return toast("Uzupełnij dane", "Podaj imię i nazwisko.", "fa-triangle-exclamation");
    if(!phone || phone.length < 7) return toast("Uzupełnij dane", "Podaj numer telefonu.", "fa-triangle-exclamation");
    if(!date) return toast("Data", "Wybierz datę.", "fa-calendar");
    if(!time) return toast("Godzina", "Wybierz godzinę.", "fa-clock");
    if(!people || people < 1) return toast("Liczba osób", "Wpisz liczbę osób.", "fa-users");

    const payload = {
      createdAt: nowISO(),
      name,
      phone,
      date,
      time,
      people,
      place,
      note,
      email: state.profile.email,
      milkId: ensureMilkId()
    };

    let sent = false;
    try{
      const res = await fetch("/api/rezerwacje", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(res.ok) sent = true;
    }catch{}

    if(sent){
      toast("Rezerwacja wysłana", `${date} ${time} • ${people} os.`, "fa-calendar-check");
    } else {
      state.reservations.unshift({ id: crypto?.randomUUID?.() ?? String(Math.random()).slice(2), ...payload, _local:true });
      saveAll();
      toast("Zapisano lokalnie", "Brak połączenia z serwerem — rezerwacja zapisana na urządzeniu.", "fa-wifi");
    }

    // clear form
    el.resNote.value = "";
    renderReservations();
  }

  function renderReservations(){
    const list = state.reservations || [];
    el.resCount.textContent = String(list.length);
    el.resList.innerHTML = "";
    if(list.length === 0){
      el.resList.innerHTML = `<div class="muted" style="font-size:12px;">Brak rezerwacji.</div>`;
      return;
    }
    list.slice(0, 20).forEach(r => {
      const box = document.createElement("div");
      box.className = "reward";
      box.innerHTML = `
        <div class="rewardIcon"><i class="fa-solid fa-calendar"></i></div>
        <div class="rewardMain">
          <b>${escapeHtml(r.date)} ${escapeHtml(r.time)} • ${escapeHtml(r.place || "—")}</b>
          <span>${escapeHtml(r.people)} os. • ${escapeHtml(r.name)} ${r._local ? "• (lokalnie)" : ""}</span>
        </div>
        <div class="rewardRight">
          <button class="btn small" data-res-del="${escapeHtml(r.id)}"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;
      el.resList.appendChild(box);
    });
  }

  function deleteReservationLocal(id){
    const idx = (state.reservations || []).findIndex(x => x.id === id);
    if(idx !== -1){
      state.reservations.splice(idx, 1);
      saveAll();
      renderReservations();
      toast("Usunięto", "Rezerwacja usunięta lokalnie.", "fa-trash");
    }
  }

  /* -------------------------
     Account (mock login)
  ------------------------- */
  function renderAccount(){
    el.accHint.textContent = state.profile.loggedIn
      ? `Zalogowano jako: ${state.profile.email}`
      : "Zaloguj się, aby mieć Milk ID";

    el.accountBox.innerHTML = "";

    if(!state.profile.loggedIn){
      const b1 = document.createElement("button");
      b1.className = "btn primary full";
      b1.id = "btnOpenLogin";
      b1.innerHTML = `<i class="fa-brands fa-google"></i> Zaloguj (Google)`;
      b1.onclick = () => quickLoginGoogle();

      const b2 = document.createElement("button");
      b2.className = "btn ghost full";
      b2.id = "btnOpenEmailLogin";
      b2.innerHTML = `<i class="fa-solid fa-envelope"></i> Zaloguj e-mail`;
      b2.onclick = () => quickLoginEmail();

      el.accountBox.appendChild(b1);
      el.accountBox.appendChild(b2);
    } else {
      const card = document.createElement("div");
      card.className = "card";
      card.style.boxShadow = "none";
      card.innerHTML = `
        <div class="cardPad">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <b style="font-size:13px;">Profil</b><br>
              <span class="muted" style="font-size:12px;">${escapeHtml(state.profile.email)}</span>
            </div>
            <button class="btn small" id="btnShowMilkId2"><i class="fa-solid fa-id-card"></i> Milk ID</button>
          </div>
          <div class="sep"></div>
          <div class="grid2">
            <input class="input" id="profName" placeholder="Imię (opcjonalnie)" value="${escapeHtml(state.profile.name || "")}">
            <button class="btn primary" id="profSave"><i class="fa-solid fa-floppy-disk"></i> Zapisz</button>
          </div>
        </div>
      `;
      el.accountBox.appendChild(card);

      $("#btnShowMilkId2").onclick = openMilkIdModal;
      $("#profSave").onclick = () => {
        state.profile.name = ($("#profName").value || "").trim();
        saveAll();
        toast("Zapisano", "Dane profilu zapisane.", "fa-check");
      };
    }
  }

  function quickLoginGoogle(){
    const email = prompt("Podaj e-mail (Google):");
    if(!email) return;
    state.profile.loggedIn = true;
    state.profile.email = String(email).trim();
    if(!state.profile.name) state.profile.name = "";
    ensureMilkId();
    saveAll();
    toast("Zalogowano", state.profile.email, "fa-user-check");
    renderAll();
  }

  function quickLoginEmail(){
    const email = prompt("Podaj e-mail:");
    if(!email) return;
    state.profile.loggedIn = true;
    state.profile.email = String(email).trim();
    ensureMilkId();
    saveAll();
    toast("Zalogowano", state.profile.email, "fa-user-check");
    renderAll();
  }

  function logout(){
    state.profile = { loggedIn:false, email:"", name:"" };
    saveAll();
    toast("Wylogowano", "", "fa-right-from-bracket");
    renderAll();
  }

  /* -------------------------
     Navigation
  ------------------------- */
  function go(name){
    state.activeNav = name;
    Object.entries(el.pages).forEach(([k, node]) => node.classList.toggle("show", k === name));
    el.navBtns.forEach(b => b.classList.toggle("active", b.dataset.nav === name));
    renderCartFab();
    // small UX
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  /* -------------------------
     Install guide (PWA)
  ------------------------- */
  function setupInstall(){
    // beforeinstallprompt (Android / Chromium)
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      state.install.deferredPrompt = e;
      el.installBtn.classList.remove("hide");
    });

    // show install overlay if not standalone (simple heuristic)
    const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    if(!isStandalone){
      // do not force show; leave hidden unless user triggers (you can uncomment to auto show once)
      // if(!LS.get("milk_install_seen", false)){
      //   LS.set("milk_install_seen", true);
      //   el.installOverlay.classList.add("show");
      // }
    }
  }

  function setInstallPlatform(p){
    state.install.platform = p;
    el.installAndroid.classList.toggle("primary", p === "android");
    el.installIos.classList.toggle("primary", p === "ios");
    el.installSteps.innerHTML = "";

    if(p === "ios"){
      el.installBtn.classList.add("hide");
      el.installSteps.innerHTML = `
        <div class="step"><i class="fa-solid fa-share"></i> Otwórz „Udostępnij” w Safari</div>
        <div class="step"><i class="fa-solid fa-square-plus"></i> Wybierz „Dodaj do ekranu początkowego”</div>
        <div class="step"><i class="fa-solid fa-check"></i> Potwierdź</div>
      `;
    } else {
      // android
      el.installSteps.innerHTML = `
        <div class="step"><i class="fa-solid fa-ellipsis-vertical"></i> Otwórz menu przeglądarki</div>
        <div class="step"><i class="fa-solid fa-download"></i> Kliknij „Zainstaluj aplikację”</div>
        <div class="step"><i class="fa-solid fa-check"></i> Potwierdź instalację</div>
      `;
      if(state.install.deferredPrompt) el.installBtn.classList.remove("hide");
    }
  }

  async function doInstall(){
    if(!state.install.deferredPrompt){
      toast("Instalacja", "Twoja przeglądarka nie udostępniła przycisku instalacji.", "fa-circle-info");
      return;
    }
    state.install.deferredPrompt.prompt();
    try{ await state.install.deferredPrompt.userChoice; }catch{}
    state.install.deferredPrompt = null;
    el.installBtn.classList.add("hide");
    toast("Gotowe", "Jeśli zaakceptowałeś, aplikacja pojawi się na ekranie głównym.", "fa-check");
  }

  /* -------------------------
     Events wiring
  ------------------------- */
  function wire(){
    // nav
    el.navBtns.forEach(btn => {
      btn.addEventListener("click", () => go(btn.dataset.nav));
    });
    // quick nav buttons in points page
    $$("[data-nav]").forEach(b => {
      b.addEventListener("click", () => {
        const target = b.getAttribute("data-nav");
        go(target === "res" ? "res" : target);
      });
    });

    // hours toggle
    el.hoursToggle.addEventListener("click", () => {
      el.hoursList.classList.toggle("show");
    });

    // milk id access
    el.pointsPill.addEventListener("click", openMilkIdModal);
    el.btnShowMilkId.addEventListener("click", openMilkIdModal);
    el.milkIdClose.addEventListener("click", closeMilkIdModal);
    el.milkIdGoLogin.addEventListener("click", () => { closeMilkIdModal(); go("account"); });
    el.milkIdOverlay.addEventListener("click", (e) => { if(e.target === el.milkIdOverlay) closeMilkIdModal(); });
    el.milkIdCopy.addEventListener("click", async () => {
      const v = el.milkIdValue.value || "";
      if(!v || v.includes("-")) return;
      try{
        await navigator.clipboard.writeText(v);
        toast("Skopiowano", "Milk ID w schowku.", "fa-copy");
      }catch{
        toast("Nie udało się", "Przytrzymaj i skopiuj ręcznie.", "fa-triangle-exclamation");
      }
    });

    // account shortcuts
    el.btnLogin.addEventListener("click", () => go("account"));
    el.btnOpenEatmi.addEventListener("click", () => {
      window.open("https://eatmi.pl", "_blank");
    });

    // order categories
    el.orderCategories.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;
      setActiveCategory(chip.dataset.cat);
    });

    // add to cart from menu grid
    el.menuGrid.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-add]");
      if(!btn) return;
      const id = btn.getAttribute("data-add");
      const item = MENU_ITEMS.find(x => x._id === id);
      if(!item) return;
      openVariantPicker(item);
    });

    // cart fab
    el.cartFab.addEventListener("click", openCart);

    // cart modal interactions
    el.cartClose.addEventListener("click", closeCart);
    el.cartOverlay.addEventListener("click", (e) => { if(e.target === el.cartOverlay) closeCart(); });
    el.cartList.addEventListener("click", (e) => {
      const inc = e.target.closest("[data-inc]");
      const dec = e.target.closest("[data-dec]");
      if(inc) return incLine(inc.getAttribute("data-inc"));
      if(dec) return decLine(dec.getAttribute("data-dec"));
    });
    el.cartClear.addEventListener("click", clearCart);
    el.cartCheckout.addEventListener("click", checkout);

    // order info
    el.btnOrderInfo.addEventListener("click", () => {
      const minM = minPickupMinutes();
      toast("Info", `Minimalny czas przygotowania: ${minM} min. Odbiór: Słupsk.`, "fa-circle-info");
    });

    // reservations
    el.btnResSubmit.addEventListener("click", submitReservation);
    el.resList.addEventListener("click", (e) => {
      const del = e.target.closest("[data-res-del]");
      if(!del) return;
      deleteReservationLocal(del.getAttribute("data-res-del"));
    });

    // account login buttons
    el.btnOpenLogin?.addEventListener("click", quickLoginGoogle);
    el.btnOpenEmailLogin?.addEventListener("click", quickLoginEmail);

    // settings (simple toasts)
    el.btnSettingsPersonal.addEventListener("click", () => toast("Dane osobowe", "Edytuj dane w profilu (Konto).", "fa-user-gear"));
    el.btnSettingsLang.addEventListener("click", () => toast("Język", "PL (domyślnie).", "fa-language"));
    el.btnSettingsHelp.addEventListener("click", () => toast("Pomoc", "Napisz do obsługi lub pokaż Milk ID w barze.", "fa-circle-question"));
    el.btnSettingsAbout.addEventListener("click", () => toast("Milk", "Wersja PWA • tryb offline dla koszyka i rezerwacji.", "fa-circle-info"));

    // logout
    el.btnLogout.addEventListener("click", logout);

    // install guide events
    el.installClose.addEventListener("click", () => el.installOverlay.classList.remove("show"));
    el.installAndroid.addEventListener("click", () => setInstallPlatform("android"));
    el.installIos.addEventListener("click", () => setInstallPlatform("ios"));
    el.installBtn.addEventListener("click", doInstall);

    // optional: open install overlay via long press logo
    $(".logo")?.addEventListener("dblclick", () => {
      el.installOverlay.classList.add("show");
      setInstallPlatform("android");
    });
  }

  /* -------------------------
     Render all
  ------------------------- */
  function renderAll(){
    renderHours();
    renderPoints();
    renderHistory();
    renderRewards();
    renderMenuGrid();
    renderCartFab();
    renderReservations();
    renderAccount();
  }

  /* -------------------------
     Service Worker
  ------------------------- */
  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    try{
      await navigator.serviceWorker.register("sw.js");
    }catch{}
  }

  /* -------------------------
     Boot
  ------------------------- */
  function boot(){
    // default nav
    go(state.activeNav || "points");
    // default category
    setActiveCategory(state.activeCategory || "kawa-herbata");
    renderAll();
    wire();
    setupInstall();
    setInstallPlatform("android");
    registerSW();
  }

  // Start
  document.addEventListener("DOMContentLoaded", boot);
})();
</script>

  </script>
</body>
</html>
